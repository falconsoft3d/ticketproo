{% extends 'base.html' %}
{% load static %}
{% load tickets_tags %}

{% block title %}Red Social - TicketProo{% endblock %}

{% block content %}
<div class="container-fluid mt-4">
    <div class="row">
        <!-- Panel izquierdo - Hashtags -->
        <div class="col-lg-2 d-none d-lg-block">
            <div class="sticky-sidebar">
                <div class="card">
                    <div class="card-header bg-primary text-white d-flex justify-content-between align-items-center">
                        <h6 class="mb-0"><i class="bi bi-hash"></i> Hashtags</h6>
                        {% if search_query and '#' in search_query %}
                        <a href="/social/" class="btn btn-sm btn-light" title="Limpiar filtro">
                            <i class="bi bi-x"></i>
                        </a>
                        {% endif %}
                    </div>
                    <div class="card-body p-2" id="hashtagsList">
                        <div class="d-flex justify-content-center py-3">
                            <div class="spinner-border spinner-border-sm text-primary" role="status">
                                <span class="visually-hidden">Cargando...</span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Contenido central -->
        <div class="col-lg-8">
            <!-- Header -->
            <div class="d-flex justify-content-between align-items-center mb-4">
                <h2><i class="bi bi-people-fill"></i> Red Social Interna</h2>
                <div class="d-flex gap-2">
                    <button class="btn btn-primary" type="button" data-bs-toggle="collapse" data-bs-target="#createPostCollapse" aria-expanded="false" aria-controls="createPostCollapse">
                        <i class="bi bi-plus-circle"></i> Publicar
                    </button>
                    <button class="btn btn-outline-primary" type="button" data-bs-toggle="collapse" data-bs-target="#searchCollapse" aria-expanded="false" aria-controls="searchCollapse">
                        <i class="bi bi-search"></i> Buscar
                    </button>
                </div>
            </div>

            <!-- Buscador (Colapsable) -->
            <div class="collapse mb-4" id="searchCollapse">
                <div class="card">
                    <div class="card-body">
                        <form method="get" action="{% url 'social_feed' %}" id="searchForm">
                            <div class="input-group mb-2">
                                <input 
                                    type="text" 
                                    class="form-control" 
                                    name="q" 
                                    placeholder="Buscar publicaciones por contenido o usuario..." 
                                    value="{{ search_query }}"
                                >
                                <button type="submit" class="btn btn-primary">
                                    <i class="bi bi-search"></i> Buscar
                                </button>
                                {% if search_query or show_favorites or show_loved %}
                                <a href="{% url 'social_feed' %}" class="btn btn-outline-secondary">
                                    <i class="bi bi-x"></i> Limpiar
                                </a>
                                {% endif %}
                            </div>
                            <div class="d-flex gap-2">
                                <a href="?favorites=1" class="btn btn-sm {% if show_favorites %}btn-warning{% else %}btn-outline-warning{% endif %}">
                                    <i class="bi bi-star-fill"></i> Mis Favoritos
                                </a>
                                <a href="?loved=1" class="btn btn-sm {% if show_loved %}btn-danger{% else %}btn-outline-danger{% endif %}">
                                    <i class="bi bi-heart-fill"></i> Me encantan
                                </a>
                                {% if show_favorites %}
                                <span class="badge bg-warning text-dark align-self-center">
                                    Mostrando solo favoritos
                                </span>
                                {% endif %}
                                {% if show_loved %}
                                <span class="badge bg-danger align-self-center">
                                    Mostrando publicaciones que me encantan
                                </span>
                                {% endif %}
                            </div>
                        </form>
                    </div>
                </div>
            </div>

            <!-- Crear nueva publicaciÃ³n (Colapsable) -->
            <div class="collapse mb-4" id="createPostCollapse">
                <div class="card">
                <div class="card-body">
                    <div class="d-flex align-items-start">
                        <div class="avatar-circle me-3">
                            <i class="bi bi-person-circle" style="font-size: 40px; color: #6c757d;"></i>
                        </div>
                        <div class="flex-grow-1">
                            <form id="createPostForm" enctype="multipart/form-data">
                                {% csrf_token %}
                                <div class="position-relative">
                                    <textarea 
                                        class="form-control mb-2" 
                                        id="postContent" 
                                        rows="3" 
                                        placeholder="Â¿QuÃ© estÃ¡s pensando, {{ user.get_full_name|default:user.username }}?"
                                        oninput="handleMentionInput(this)"
                                    ></textarea>
                                    <button type="button" class="btn btn-sm btn-outline-secondary position-absolute" 
                                            style="bottom: 10px; right: 10px;" 
                                            onclick="toggleEmojiPicker('postContent')">
                                        ğŸ˜Š
                                    </button>
                                    <!-- Dropdown de autocompletado de menciones -->
                                    <div id="mentionDropdown-postContent" class="mention-dropdown" style="display: none;"></div>
                                </div>
                                
                                <!-- Selector de emojis para publicaciÃ³n -->
                                <div id="emojiPickerPost" class="emoji-picker mb-3" style="display: none;">
                                    <div class="emoji-grid"></div>
                                </div>
                                
                                <!-- URL de YouTube -->
                                <input 
                                    type="url" 
                                    class="form-control mb-3" 
                                    id="youtubeUrl" 
                                    placeholder="URL de video de YouTube (opcional)"
                                >
                                
                                <!-- Preview de imagen -->
                                <div id="imagePreview" class="mb-3" style="display: none;">
                                    <img id="previewImg" src="" class="img-fluid rounded" style="max-height: 300px;">
                                    <button type="button" class="btn btn-sm btn-danger mt-2" onclick="removeImage()">
                                        <i class="bi bi-x"></i> Quitar imagen
                                    </button>
                                </div>
                                
                                <div class="d-flex justify-content-between align-items-center">
                                    <div class="d-flex gap-2 align-items-center">
                                        <label for="postImage" class="btn btn-outline-primary btn-sm mb-0">
                                            <i class="bi bi-image"></i> Foto
                                        </label>
                                        <input type="file" id="postImage" accept="image/*" style="display: none;" onchange="previewImage(this)">
                                        
                                        <div class="form-check mb-0 me-2">
                                            <input type="checkbox" class="form-check-input" id="isPrivate">
                                            <label class="form-check-label" for="isPrivate">
                                                <i class="bi bi-lock"></i> Privado
                                            </label>
                                        </div>
                                        
                                        <div class="form-check mb-0">
                                            <input type="checkbox" class="form-check-input" id="companyOnly" checked>
                                            <label class="form-check-label" for="companyOnly">
                                                <i class="bi bi-building"></i> Solo mi empresa
                                            </label>
                                        </div>
                                    </div>
                                    <button type="submit" class="btn btn-primary">
                                        <i class="bi bi-send"></i> Publicar
                                    </button>
                                </div>
                            </form>
                        </div>
                    </div>
                </div>
                </div>
            </div>

            <!-- Feed de publicaciones -->
            <div id="postsContainer">
                {% if posts %}
                    {% include 'tickets/social_post_items.html' with posts=posts user=user is_agent=is_agent user_favorites=user_favorites %}
                {% else %}
                    <div class="card">
                        <div class="card-body text-center py-5">
                            <i class="bi bi-chat-left-text" style="font-size: 4rem; color: #ccc;"></i>
                            <h4 class="mt-3 text-muted">No hay publicaciones aÃºn</h4>
                            <p class="text-muted">Â¡SÃ© el primero en compartir algo!</p>
                        </div>
                    </div>
                {% endif %}
            </div>
            
            <!-- Loading spinner -->
            <div id="loadingSpinner" class="text-center py-4" style="display: none;">
                <div class="spinner-border text-primary" role="status">
                    <span class="visually-hidden">Cargando...</span>
                </div>
                <p class="text-muted mt-2">Cargando mÃ¡s publicaciones...</p>
            </div>
            
            <!-- Mensaje de fin -->
            <div id="endMessage" class="text-center py-4" style="display: none;">
                <p class="text-muted">No hay mÃ¡s publicaciones para mostrar</p>
            </div>
        </div>
        
        <!-- Panel derecho - Usuarios mencionados -->
        <div class="col-lg-2 d-none d-lg-block">
            <div class="sticky-sidebar">
                <div class="card">
                    <div class="card-header bg-success text-white d-flex justify-content-between align-items-center">
                        <h6 class="mb-0 d-flex align-items-center gap-2">
                            <i class="bi bi-at"></i> Menciones
                            <span id="myMentionsCount" class="badge bg-danger text-white" style="display: none; font-size: 0.85rem; padding: 0.35rem 0.6rem; font-weight: bold;">0</span>
                        </h6>
                        {% if search_query and '@' in search_query %}
                        <a href="/social/" class="btn btn-sm btn-light" title="Limpiar filtro">
                            <i class="bi bi-x"></i>
                        </a>
                        {% endif %}
                    </div>
                    <div class="card-body p-2" id="mentionsList">
                        <div class="d-flex justify-content-center py-3">
                            <div class="spinner-border spinner-border-sm text-success" role="status">
                                <span class="visually-hidden">Cargando...</span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Modal de EdiciÃ³n de PublicaciÃ³n -->
<div class="modal fade" id="editPostModal" tabindex="-1" aria-labelledby="editPostModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="editPostModalLabel">
                    <i class="bi bi-pencil"></i> Editar PublicaciÃ³n
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <form id="editPostForm">
                    <input type="hidden" id="editPostId" name="post_id">
                    
                    <!-- Contenido -->
                    <div class="mb-3">
                        <label for="editContent" class="form-label">
                            <i class="bi bi-chat-left-text"></i> Contenido
                        </label>
                        <textarea class="form-control" id="editContent" name="content" rows="4" placeholder="Â¿QuÃ© estÃ¡s pensando?"></textarea>
                    </div>
                    
                    <!-- Vista previa de imagen actual -->
                    <div id="editCurrentImagePreview" class="mb-3" style="display: none;">
                        <label class="form-label">
                            <i class="bi bi-image"></i> Imagen actual
                        </label>
                        <div class="position-relative d-inline-block">
                            <img id="editCurrentImage" src="" class="img-thumbnail" style="max-width: 200px;">
                            <button type="button" class="btn btn-sm btn-danger position-absolute top-0 end-0 m-1" 
                                    onclick="removeCurrentImage()" title="Eliminar imagen">
                                <i class="bi bi-x-lg"></i>
                            </button>
                        </div>
                    </div>
                    
                    <!-- Nueva imagen -->
                    <div class="mb-3">
                        <label for="editImage" class="form-label">
                            <i class="bi bi-image"></i> Cambiar imagen
                        </label>
                        <input type="file" class="form-control" id="editImage" name="image" accept="image/*">
                        <small class="text-muted">Selecciona una nueva imagen para reemplazar la actual</small>
                    </div>
                    
                    <!-- URL de YouTube -->
                    <div class="mb-3">
                        <label for="editYoutubeUrl" class="form-label">
                            <i class="bi bi-youtube"></i> URL de YouTube
                        </label>
                        <input type="url" class="form-control" id="editYoutubeUrl" name="youtube_url" 
                               placeholder="https://www.youtube.com/watch?v=...">
                        <small class="text-muted">Deja vacÃ­o para eliminar el video</small>
                    </div>
                    
                    <!-- Opciones de privacidad -->
                    <div class="mb-3">
                        <div class="form-check">
                            <input class="form-check-input" type="checkbox" id="editIsPrivate" name="is_private">
                            <label class="form-check-label" for="editIsPrivate">
                                <i class="bi bi-lock"></i> PublicaciÃ³n privada (solo tÃº puedes verla)
                            </label>
                        </div>
                    </div>
                    
                    <div class="mb-3">
                        <div class="form-check">
                            <input class="form-check-input" type="checkbox" id="editCompanyOnly" name="company_only">
                            <label class="form-check-label" for="editCompanyOnly">
                                <i class="bi bi-building"></i> Solo para mi empresa
                            </label>
                        </div>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                    <i class="bi bi-x-circle"></i> Cancelar
                </button>
                <button type="button" class="btn btn-primary" onclick="saveEditPost()">
                    <i class="bi bi-check-circle"></i> Guardar cambios
                </button>
            </div>
        </div>
    </div>
</div>

<style>
    .post-card {
        transition: box-shadow 0.2s;
    }
    .post-card:hover {
        box-shadow: 0 4px 12px rgba(0,0,0,0.1);
    }
    .post-content {
        white-space: pre-wrap;
        word-wrap: break-word;
    }
    .reaction-btn {
        color: #6c757d;
        transition: all 0.2s;
    }
    .reaction-btn:hover {
        transform: scale(1.05);
    }
    .reaction-btn.active-like {
        color: #0d6efd;
        font-weight: bold;
    }
    .reaction-btn.active-love {
        color: #dc3545;
        font-weight: bold;
    }
    .reaction-btn.active-dislike {
        color: #ffc107;
        font-weight: bold;
    }
    .favorite-btn.active-favorite {
        color: #ffc107;
        font-weight: bold;
    }
    .comment-item {
        animation: fadeIn 0.3s;
    }
    @keyframes fadeIn {
        from { opacity: 0; transform: translateY(-10px); }
        to { opacity: 1; transform: translateY(0); }
    }
    .comment-reaction-counts {
        font-weight: 500;
        padding: 2px 8px;
        background: #f8f9fa;
        border-radius: 10px;
        font-size: 0.85em;
    }
    .comment-reactions a {
        font-size: 0.85em;
        transition: color 0.2s;
    }
    .comment-reactions a:hover {
        color: #0d6efd !important;
        text-decoration: underline !important;
    }
    
    /* Estilos para paneles laterales */
    .sticky-sidebar {
        position: sticky;
        top: 80px;
        max-height: calc(100vh - 100px);
        overflow-y: auto;
    }
    
    .hashtag-item, .mention-item {
        padding: 8px 12px;
        border-bottom: 1px solid #f0f0f0;
        cursor: pointer;
        transition: background-color 0.2s;
        display: flex;
        align-items: center;
        gap: 8px;
    }
    
    .hashtag-item:hover, .mention-item:hover {
        background-color: #f8f9fa;
    }
    
    .hashtag-item:last-child, .mention-item:last-child {
        border-bottom: none;
    }
    
    .hashtag-count, .mention-count {
        margin-left: auto;
        font-size: 0.85em;
        color: #6c757d;
        background: #e9ecef;
        padding: 2px 8px;
        border-radius: 10px;
    }
    
    .hashtag-link {
        color: #0d6efd;
        text-decoration: none;
        font-weight: 500;
    }
    
    .mention-link {
        color: #198754;
        text-decoration: none;
        font-weight: 500;
    }
    
    .active-filter {
        background-color: #e7f3ff !important;
        border-left: 3px solid #0d6efd;
        font-weight: 600;
    }
    
    .card-header .btn-light {
        padding: 2px 8px;
        font-size: 0.875rem;
    }
    
    .card-header .btn-light:hover {
        background-color: #fff;
    }
    
    /* Estilos para selector de emojis */
    .emoji-picker {
        background: white;
        border: 1px solid #dee2e6;
        border-radius: 8px;
        padding: 10px;
        box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        max-height: 200px;
        overflow-y: auto;
        position: absolute;
        z-index: 1000;
        width: 100%;
        margin-bottom: 10px;
    }
    
    .emoji-grid {
        display: grid;
        grid-template-columns: repeat(auto-fill, minmax(35px, 1fr));
        gap: 5px;
    }
    
    .emoji-item {
        font-size: 24px;
        cursor: pointer;
        padding: 5px;
        text-align: center;
        border-radius: 4px;
        transition: background-color 0.2s;
    }
    
    .emoji-item:hover {
        background-color: #f0f0f0;
        transform: scale(1.1);
    }
    
    /* Estilos para dropdown de menciones */
    .mention-dropdown {
        position: absolute;
        bottom: 100%;
        left: 0;
        width: 100%;
        max-height: 200px;
        overflow-y: auto;
        background: white;
        border: 1px solid #ddd;
        border-radius: 4px;
        box-shadow: 0 -2px 10px rgba(0,0,0,0.1);
        z-index: 1050;
        margin-bottom: 5px;
    }
    
    .mention-item {
        padding: 10px 15px;
        cursor: pointer;
        border-bottom: 1px solid #f0f0f0;
        transition: background-color 0.2s;
    }
    
    .mention-item:last-child {
        border-bottom: none;
    }
    
    .mention-item:hover {
        background-color: #f8f9fa;
    }
    
    .mention-item .username {
        font-weight: bold;
        color: #198754;
    }
    
    .mention-item .fullname {
        color: #6c757d;
        font-size: 0.9em;
    }
</style>

<script>
function getCookie(name) {
    let cookieValue = null;
    if (document.cookie && document.cookie !== '') {
        const cookies = document.cookie.split(';');
        for (let i = 0; i < cookies.length; i++) {
            const cookie = cookies[i].trim();
            if (cookie.substring(0, name.length + 1) === (name + '=')) {
                cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                break;
            }
        }
    }
    return cookieValue;
}

// Mostrar fallback de YouTube si el iframe falla
function showYoutubeFallback(postId) {
    const fallback = document.querySelector(`.youtube-fallback-${postId}`);
    if (fallback) {
        fallback.classList.remove('d-none');
    }
}

// Preview de imagen
function previewImage(input) {
    if (input.files && input.files[0]) {
        const reader = new FileReader();
        reader.onload = function(e) {
            document.getElementById('previewImg').src = e.target.result;
            document.getElementById('imagePreview').style.display = 'block';
        };
        reader.readAsDataURL(input.files[0]);
    }
}

function removeImage() {
    document.getElementById('postImage').value = '';
    document.getElementById('imagePreview').style.display = 'none';
}

// Crear publicaciÃ³n
document.getElementById('createPostForm').addEventListener('submit', async function(e) {
    e.preventDefault();
    
    const content = document.getElementById('postContent').value.trim();
    const imageFile = document.getElementById('postImage').files[0];
    const youtubeUrl = document.getElementById('youtubeUrl').value.trim();
    const isPrivate = document.getElementById('isPrivate').checked;
    const companyOnly = document.getElementById('companyOnly').checked;
    
    if (!content && !imageFile && !youtubeUrl) {
        alert('Debes escribir algo, subir una imagen o agregar un video');
        return;
    }
    
    const formData = new FormData();
    formData.append('content', content);
    formData.append('is_private', isPrivate);
    formData.append('company_only', companyOnly);
    if (imageFile) {
        formData.append('image', imageFile);
    }
    if (youtubeUrl) {
        formData.append('youtube_url', youtubeUrl);
    }
    
    try {
        const response = await fetch('{% url "social_post_create" %}', {
            method: 'POST',
            headers: {
                'X-CSRFToken': getCookie('csrftoken')
            },
            body: formData
        });
        
        const data = await response.json();
        
        if (data.status === 'success') {
            location.reload();
        } else {
            alert(data.message);
        }
    } catch (error) {
        console.error('Error:', error);
        alert('Error al crear la publicaciÃ³n');
    }
});

// Toggle reaction
async function toggleReaction(postId, reactionType) {
    try {
        const response = await fetch(`/social/post/${postId}/like/`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/x-www-form-urlencoded',
                'X-CSRFToken': getCookie('csrftoken')
            },
            body: `reaction_type=${reactionType}`
        });
        
        const data = await response.json();
        
        if (data.status === 'success') {
            // Actualizar contadores
            document.getElementById(`likes-count-${postId}`).textContent = data.likes_count;
            document.getElementById(`loves-count-${postId}`).textContent = data.loves_count;
            document.getElementById(`dislikes-count-${postId}`).textContent = data.dislikes_count;
            
            // Actualizar botones
            const likeBtn = document.getElementById(`like-btn-${postId}`);
            const loveBtn = document.getElementById(`love-btn-${postId}`);
            const dislikeBtn = document.getElementById(`dislike-btn-${postId}`);
            
            // Remover todas las clases activas
            likeBtn.classList.remove('active-like');
            loveBtn.classList.remove('active-love');
            dislikeBtn.classList.remove('active-dislike');
            
            // Agregar clase activa si hay reacciÃ³n
            if (data.reaction === 'like') {
                likeBtn.classList.add('active-like');
            } else if (data.reaction === 'love') {
                loveBtn.classList.add('active-love');
            } else if (data.reaction === 'dislike') {
                dislikeBtn.classList.add('active-dislike');
            }
        }
    } catch (error) {
        console.error('Error:', error);
    }
}

// Toggle comments section
function toggleComments(postId) {
    const section = document.getElementById(`comments-${postId}`);
    section.style.display = section.style.display === 'none' ? 'block' : 'none';
}

// Agregar comentario
async function addComment(event, postId) {
    event.preventDefault();
    
    const input = document.getElementById(`comment-input-${postId}`);
    const content = input.value.trim();
    
    if (!content) return;
    
    try {
        const response = await fetch(`/social/post/${postId}/comment/`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/x-www-form-urlencoded',
                'X-CSRFToken': getCookie('csrftoken')
            },
            body: `content=${encodeURIComponent(content)}`
        });
        
        const data = await response.json();
        
        if (data.status === 'success') {
            // Agregar comentario a la lista
            const commentsList = document.getElementById(`comments-list-${postId}`);
            const commentHTML = `
                <div class="d-flex mb-2 comment-item" id="comment-${data.comment.id}">
                    <i class="bi bi-person-circle me-2" style="font-size: 30px; color: #6c757d;"></i>
                    <div class="flex-grow-1">
                        <div class="bg-light rounded p-2">
                            <strong>${data.comment.user}</strong>
                            <p class="mb-0">${data.comment.content}</p>
                        </div>
                        <small class="text-muted">
                            ${data.comment.created_at}
                            <a href="#" class="text-danger ms-2" onclick="deleteComment(${data.comment.id}); return false;">
                                <i class="bi bi-trash"></i> Eliminar
                            </a>
                        </small>
                    </div>
                </div>
            `;
            commentsList.insertAdjacentHTML('beforeend', commentHTML);
            
            // Actualizar contador
            const count = document.getElementById(`comments-count-${postId}`);
            count.textContent = parseInt(count.textContent) + 1;
            
            // Limpiar input
            input.value = '';
        } else {
            alert(data.message);
        }
    } catch (error) {
        console.error('Error:', error);
        alert('Error al agregar comentario');
    }
}

// Eliminar publicaciÃ³n
async function deletePost(postId) {
    if (!confirm('Â¿Eliminar esta publicaciÃ³n?')) return;
    
    try {
        const response = await fetch(`/social/post/${postId}/delete/`, {
            method: 'POST',
            headers: {
                'X-CSRFToken': getCookie('csrftoken')
            }
        });
        
        const data = await response.json();
        
        if (data.status === 'success') {
            document.getElementById(`post-${postId}`).remove();
        }
    } catch (error) {
        console.error('Error:', error);
    }
}

// Editar publicaciÃ³n
// Abrir modal de ediciÃ³n
async function editPost(postId) {
    try {
        // Obtener datos del post desde el backend
        const response = await fetch(`/social/post/${postId}/get-data/`, {
            method: 'GET',
            headers: {
                'X-CSRFToken': getCookie('csrftoken')
            }
        });
        
        const data = await response.json();
        
        if (data.status === 'success') {
            const post = data.post;
            
            // Llenar el formulario con los datos del post
            document.getElementById('editPostId').value = postId;
            document.getElementById('editContent').value = post.content || '';
            document.getElementById('editYoutubeUrl').value = post.youtube_url || '';
            document.getElementById('editIsPrivate').checked = post.is_private;
            document.getElementById('editCompanyOnly').checked = post.company_only;
            
            // Mostrar imagen actual si existe
            if (post.image_url) {
                document.getElementById('editCurrentImage').src = post.image_url;
                document.getElementById('editCurrentImagePreview').style.display = 'block';
            } else {
                document.getElementById('editCurrentImagePreview').style.display = 'none';
            }
            
            // Limpiar input de nueva imagen
            document.getElementById('editImage').value = '';
            
            // Abrir modal
            const modal = new bootstrap.Modal(document.getElementById('editPostModal'));
            modal.show();
        } else {
            alert('Error al cargar los datos del post');
        }
    } catch (error) {
        console.error('Error:', error);
        alert('Error al cargar los datos del post');
    }
}

// Guardar ediciÃ³n
async function saveEditPost() {
    const postId = document.getElementById('editPostId').value;
    const content = document.getElementById('editContent').value;
    const youtubeUrl = document.getElementById('editYoutubeUrl').value;
    const isPrivate = document.getElementById('editIsPrivate').checked;
    const companyOnly = document.getElementById('editCompanyOnly').checked;
    const imageInput = document.getElementById('editImage');
    
    const formData = new FormData();
    formData.append('content', content);
    formData.append('youtube_url', youtubeUrl);
    formData.append('is_private', isPrivate);
    formData.append('company_only', companyOnly);
    
    // Agregar imagen si se seleccionÃ³ una nueva
    if (imageInput.files.length > 0) {
        formData.append('image', imageInput.files[0]);
    }
    
    try {
        const response = await fetch(`/social/post/${postId}/edit/`, {
            method: 'POST',
            headers: {
                'X-CSRFToken': getCookie('csrftoken')
            },
            body: formData
        });
        
        const data = await response.json();
        
        if (data.status === 'success') {
            // Cerrar modal
            const modal = bootstrap.Modal.getInstance(document.getElementById('editPostModal'));
            modal.hide();
            
            // Recargar pÃ¡gina para mostrar cambios
            location.reload();
        } else {
            alert(data.message || 'Error al editar la publicaciÃ³n');
        }
    } catch (error) {
        console.error('Error:', error);
        alert('Error al editar la publicaciÃ³n');
    }
}

// Remover imagen actual (marcar para eliminaciÃ³n)
function removeCurrentImage() {
    // Ocultar preview
    document.getElementById('editCurrentImagePreview').style.display = 'none';
    // Nota: La imagen se eliminarÃ¡ en el backend si no se proporciona una nueva
}

// Eliminar comentario
async function deleteComment(commentId) {
    if (!confirm('Â¿Eliminar este comentario?')) return;
    
    try {
        const response = await fetch(`/social/comment/${commentId}/delete/`, {
            method: 'POST',
            headers: {
                'X-CSRFToken': getCookie('csrftoken')
            }
        });
        
        const data = await response.json();
        
        if (data.status === 'success') {
            document.getElementById(`comment-${commentId}`).remove();
        }
    } catch (error) {
        console.error('Error:', error);
    }
}

// Mostrar todos los comentarios
function showAllComments(postId, button) {
    const commentsList = document.getElementById(`comments-list-${postId}`);
    const extraComments = commentsList.querySelectorAll('.extra-comment');
    
    extraComments.forEach(comment => {
        comment.style.display = 'flex';
    });
    
    button.style.display = 'none';
}

// Cambiar privacidad
async function togglePrivacy(postId, isPrivate) {
    try {
        const response = await fetch(`/social/post/${postId}/toggle-privacy/`, {
            method: 'POST',
            headers: {
                'X-CSRFToken': getCookie('csrftoken')
            }
        });
        
        const data = await response.json();
        
        if (data.status === 'success') {
            location.reload();
        } else {
            alert(data.message);
        }
    } catch (error) {
        console.error('Error:', error);
        alert('Error al cambiar privacidad');
    }
}

// Compartir publicaciÃ³n
async function sharePost(postId) {
    try {
        const response = await fetch(`/social/post/${postId}/share/`, {
            method: 'GET',
            headers: {
                'X-CSRFToken': getCookie('csrftoken')
            }
        });
        
        const data = await response.json();
        
        if (data.status === 'success') {
            // Copiar al portapapeles
            navigator.clipboard.writeText(data.share_url).then(() => {
                alert('Â¡Link copiado al portapapeles!\n\n' + data.share_url);
            }).catch(() => {
                // Fallback si no funciona el clipboard
                prompt('Copia este link:', data.share_url);
            });
        } else {
            alert('Error al generar link de compartir');
        }
    } catch (error) {
        console.error('Error:', error);
        alert('Error al compartir');
    }
}

// Reaccionar a comentario
async function reactToComment(commentId, reactionType) {
    try {
        const response = await fetch(`/social/comment/${commentId}/react/`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/x-www-form-urlencoded',
                'X-CSRFToken': getCookie('csrftoken')
            },
            body: `reaction_type=${reactionType}`
        });
        
        const data = await response.json();
        
        if (data.status === 'success') {
            // Actualizar contadores
            document.getElementById(`comment-likes-${commentId}`).textContent = data.likes_count;
            document.getElementById(`comment-loves-${commentId}`).textContent = data.loves_count;
            document.getElementById(`comment-dislikes-${commentId}`).textContent = data.dislikes_count;
        }
    } catch (error) {
        console.error('Error:', error);
    }
}

// Toggle favorito
async function toggleFavorite(postId) {
    try {
        const response = await fetch(`/social/post/${postId}/favorite/`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': getCookie('csrftoken')
            }
        });
        
        const data = await response.json();
        
        if (data.status === 'success') {
            const btn = document.getElementById(`favorite-btn-${postId}`);
            const icon = btn.querySelector('i');
            
            if (data.favorited) {
                btn.classList.add('active-favorite');
                icon.classList.remove('bi-star');
                icon.classList.add('bi-star-fill');
            } else {
                btn.classList.remove('active-favorite');
                icon.classList.remove('bi-star-fill');
                icon.classList.add('bi-star');
            }
        }
    } catch (error) {
        console.error('Error:', error);
        alert('Error al guardar favorito');
    }
}

// ============= SCROLL INFINITO =============
let currentPage = 1;
let isLoading = false;
let hasMorePosts = {{ has_next|yesno:"true,false" }};

function loadMorePosts() {
    if (isLoading || !hasMorePosts) return;
    
    isLoading = true;
    document.getElementById('loadingSpinner').style.display = 'block';
    
    currentPage++;
    
    // Construir URL con parÃ¡metros de filtro actuales
    const urlParams = new URLSearchParams(window.location.search);
    urlParams.set('page', currentPage);
    
    fetch(`/social/load-more/?${urlParams.toString()}`)
        .then(response => response.json())
        .then(data => {
            if (data.html) {
                // Insertar nuevos posts al final del container
                const postsContainer = document.getElementById('postsContainer');
                const tempDiv = document.createElement('div');
                tempDiv.innerHTML = data.html;
                
                // Agregar cada post individualmente para mantener los event listeners
                while (tempDiv.firstChild) {
                    postsContainer.appendChild(tempDiv.firstChild);
                }
                
                hasMorePosts = data.has_next;
                
                if (!hasMorePosts) {
                    document.getElementById('endMessage').style.display = 'block';
                }
            }
        })
        .catch(error => {
            console.error('Error cargando mÃ¡s posts:', error);
            alert('Error al cargar mÃ¡s publicaciones');
        })
        .finally(() => {
            isLoading = false;
            document.getElementById('loadingSpinner').style.display = 'none';
        });
}

// Detectar scroll al final de la pÃ¡gina
window.addEventListener('scroll', function() {
    // Calcular si estamos cerca del final (200px antes del final)
    const scrollPosition = window.innerHeight + window.scrollY;
    const pageHeight = document.documentElement.scrollHeight;
    
    if (scrollPosition >= pageHeight - 200) {
        loadMorePosts();
    }
});

// TambiÃ©n detectar scroll dentro del container si tiene scroll propio
const mainContent = document.querySelector('.col-lg-8');
if (mainContent) {
    mainContent.addEventListener('scroll', function() {
        const scrollPosition = this.scrollTop + this.clientHeight;
        const scrollHeight = this.scrollHeight;
        
        if (scrollPosition >= scrollHeight - 200) {
            loadMorePosts();
        }
    });
}

// ============= CARGAR HASHTAGS Y MENCIONES =============
function loadHashtags() {
    fetch('/social/hashtags/')
        .then(response => response.json())
        .then(data => {
            const container = document.getElementById('hashtagsList');
            if (data.hashtags && data.hashtags.length > 0) {
                const currentSearch = new URLSearchParams(window.location.search).get('q') || '';
                
                container.innerHTML = data.hashtags.map(item => {
                    const isActive = currentSearch.toLowerCase() === ('#' + item.tag).toLowerCase();
                    return `
                    <div class="hashtag-item ${isActive ? 'active-filter' : ''}" onclick="searchByHashtag('${item.tag}')">
                        <i class="bi bi-hash text-primary"></i>
                        <span class="hashtag-link">${item.tag}</span>
                        <span class="hashtag-count">${item.count}</span>
                        ${isActive ? '<i class="bi bi-check-circle-fill text-primary ms-1"></i>' : ''}
                    </div>
                    `;
                }).join('');
            } else {
                container.innerHTML = '<p class="text-muted text-center py-2 mb-0 small">No hay hashtags aÃºn</p>';
            }
        })
        .catch(error => {
            console.error('Error cargando hashtags:', error);
            document.getElementById('hashtagsList').innerHTML = 
                '<p class="text-danger text-center py-2 mb-0 small">Error al cargar</p>';
        });
}

function loadMentions() {
    fetch('/social/mentions/')
        .then(response => response.json())
        .then(data => {
            console.log('Datos de menciones recibidos:', data);
            const container = document.getElementById('mentionsList');
            const myMentionsCountBadge = document.getElementById('myMentionsCount');
            
            // Actualizar contador de mis menciones
            console.log('Contador de mis menciones:', data.my_mentions_count);
            if (data.my_mentions_count !== undefined && data.my_mentions_count > 0) {
                myMentionsCountBadge.textContent = data.my_mentions_count;
                myMentionsCountBadge.style.display = 'inline-block';
                console.log('Badge mostrado con valor:', data.my_mentions_count);
            } else {
                myMentionsCountBadge.style.display = 'none';
                console.log('Badge oculto, valor:', data.my_mentions_count);
            }
            
            if (data.mentions && data.mentions.length > 0) {
                const currentSearch = new URLSearchParams(window.location.search).get('q') || '';
                
                container.innerHTML = data.mentions.map(item => {
                    const isActive = currentSearch.toLowerCase() === ('@' + item.username).toLowerCase();
                    return `
                    <div class="mention-item ${isActive ? 'active-filter' : ''}" onclick="searchByMention('${item.username}')">
                        <i class="bi bi-person-circle text-success"></i>
                        <div style="flex: 1; min-width: 0;">
                            <div class="mention-link text-truncate">${item.full_name}</div>
                            <small class="text-muted">@${item.username}</small>
                        </div>
                        <span class="mention-count">${item.count}</span>
                        ${isActive ? '<i class="bi bi-check-circle-fill text-success ms-1"></i>' : ''}
                    </div>
                    `;
                }).join('');
            } else {
                container.innerHTML = '<p class="text-muted text-center py-2 mb-0 small">No hay menciones aÃºn</p>';
            }
        })
        .catch(error => {
            console.error('Error cargando menciones:', error);
            document.getElementById('mentionsList').innerHTML = 
                '<p class="text-danger text-center py-2 mb-0 small">Error al cargar</p>';
        });
}

function searchByHashtag(tag) {
    window.location.href = `/social/?q=${encodeURIComponent('#' + tag)}`;
}

function searchByMention(username) {
    window.location.href = `/social/?q=${encodeURIComponent('@' + username)}`;
}

// ============= AUTOCOMPLETADO DE MENCIONES =============
let mentionSearchTimeout = null;
let currentMentionField = null;
let mentionStartPos = 0;

function handleMentionInput(element) {
    const value = element.value;
    const cursorPos = element.selectionStart;
    
    // Buscar el Ãºltimo @ antes del cursor
    const textBeforeCursor = value.substring(0, cursorPos);
    const lastAtIndex = textBeforeCursor.lastIndexOf('@');
    
    // Verificar si hay un @ y no hay espacio despuÃ©s
    if (lastAtIndex !== -1) {
        const textAfterAt = textBeforeCursor.substring(lastAtIndex + 1);
        
        // Si hay espacio despuÃ©s del @, cerrar dropdown
        if (textAfterAt.includes(' ')) {
            closeMentionDropdown(element.id);
            return;
        }
        
        // Si hay texto despuÃ©s del @ (al menos 2 caracteres), buscar usuarios
        if (textAfterAt.length >= 2) {
            currentMentionField = element;
            mentionStartPos = lastAtIndex;
            searchUsers(textAfterAt, element.id);
        } else if (textAfterAt.length === 0) {
            // Si acabamos de escribir @, mostrar dropdown vacÃ­o o mensaje
            closeMentionDropdown(element.id);
        }
    } else {
        closeMentionDropdown(element.id);
    }
}

function searchUsers(query, fieldId) {
    clearTimeout(mentionSearchTimeout);
    
    mentionSearchTimeout = setTimeout(() => {
        fetch(`/social/search-users/?q=${encodeURIComponent(query)}`)
            .then(response => response.json())
            .then(data => {
                showMentionDropdown(data.users, fieldId);
            })
            .catch(error => {
                console.error('Error buscando usuarios:', error);
            });
    }, 300); // Debounce de 300ms
}

function showMentionDropdown(users, fieldId) {
    const dropdown = document.getElementById('mentionDropdown-' + fieldId);
    
    if (!dropdown) return;
    
    if (users.length === 0) {
        dropdown.style.display = 'none';
        return;
    }
    
    dropdown.innerHTML = users.map(user => `
        <div class="mention-item" onclick="insertMention('${user.username}', '${fieldId}')">
            <div class="username">@${user.username}</div>
            <div class="fullname">${user.full_name}</div>
        </div>
    `).join('');
    
    dropdown.style.display = 'block';
}

function insertMention(username, fieldId) {
    const field = document.getElementById(fieldId);
    if (!field) return;
    
    const value = field.value;
    const cursorPos = field.selectionStart;
    
    // Encontrar el inicio de la menciÃ³n (Ãºltimo @)
    const textBeforeCursor = value.substring(0, cursorPos);
    const lastAtIndex = textBeforeCursor.lastIndexOf('@');
    
    // Reemplazar desde el @ hasta el cursor con @username
    const newValue = value.substring(0, lastAtIndex) + '@' + username + ' ' + value.substring(cursorPos);
    field.value = newValue;
    
    // Colocar cursor despuÃ©s de la menciÃ³n
    const newCursorPos = lastAtIndex + username.length + 2; // +2 por @ y espacio
    field.setSelectionRange(newCursorPos, newCursorPos);
    field.focus();
    
    // Cerrar dropdown
    closeMentionDropdown(fieldId);
}

function closeMentionDropdown(fieldId) {
    const dropdown = document.getElementById('mentionDropdown-' + fieldId);
    if (dropdown) {
        dropdown.style.display = 'none';
    }
}

// Cerrar dropdown al hacer clic fuera
document.addEventListener('click', function(e) {
    if (!e.target.closest('.mention-dropdown') && !e.target.closest('input, textarea')) {
        document.querySelectorAll('.mention-dropdown').forEach(d => d.style.display = 'none');
    }
});

// ============= SELECTOR DE EMOJIS =============
const emojis = [
    'ğŸ˜€', 'ğŸ˜ƒ', 'ğŸ˜„', 'ğŸ˜', 'ğŸ˜†', 'ğŸ˜…', 'ğŸ¤£', 'ğŸ˜‚', 'ğŸ™‚', 'ğŸ™ƒ',
    'ğŸ˜‰', 'ğŸ˜Š', 'ğŸ˜‡', 'ğŸ¥°', 'ğŸ˜', 'ğŸ¤©', 'ğŸ˜˜', 'ğŸ˜—', 'ğŸ˜š', 'ğŸ˜™',
    'ğŸ˜‹', 'ğŸ˜›', 'ğŸ˜œ', 'ğŸ¤ª', 'ğŸ˜', 'ğŸ¤‘', 'ğŸ¤—', 'ğŸ¤­', 'ğŸ¤«', 'ğŸ¤”',
    'ğŸ¤', 'ğŸ¤¨', 'ğŸ˜', 'ğŸ˜‘', 'ğŸ˜¶', 'ğŸ˜', 'ğŸ˜’', 'ğŸ™„', 'ğŸ˜¬', 'ğŸ¤¥',
    'ğŸ˜Œ', 'ğŸ˜”', 'ğŸ˜ª', 'ğŸ¤¤', 'ğŸ˜´', 'ğŸ˜·', 'ğŸ¤’', 'ğŸ¤•', 'ğŸ¤¢', 'ğŸ¤®',
    'ğŸ¤§', 'ğŸ¥µ', 'ğŸ¥¶', 'ğŸ˜¶â€ğŸŒ«ï¸', 'ğŸ¥´', 'ğŸ˜µ', 'ğŸ¤¯', 'ğŸ¤ ', 'ğŸ¥³', 'ğŸ˜',
    'ğŸ¤“', 'ğŸ§', 'ğŸ˜•', 'ğŸ˜Ÿ', 'ğŸ™', 'â˜¹ï¸', 'ğŸ˜®', 'ğŸ˜¯', 'ğŸ˜²', 'ğŸ˜³',
    'ğŸ¥º', 'ğŸ˜¦', 'ğŸ˜§', 'ğŸ˜¨', 'ğŸ˜°', 'ğŸ˜¥', 'ğŸ˜¢', 'ğŸ˜­', 'ğŸ˜±', 'ğŸ˜–',
    'ğŸ˜£', 'ğŸ˜', 'ğŸ˜“', 'ğŸ˜©', 'ğŸ˜«', 'ğŸ¥±', 'ğŸ˜¤', 'ğŸ˜¡', 'ğŸ˜ ', 'ğŸ¤¬',
    'ğŸ‘', 'ğŸ‘', 'ğŸ‘Š', 'âœŠ', 'ğŸ¤›', 'ğŸ¤œ', 'ğŸ¤', 'âœŒï¸', 'ğŸ¤Ÿ', 'ğŸ¤˜',
    'ğŸ‘Œ', 'ğŸ¤Œ', 'ğŸ¤', 'ğŸ‘ˆ', 'ğŸ‘‰', 'ğŸ‘†', 'ğŸ‘‡', 'â˜ï¸', 'ğŸ‘‹', 'ğŸ¤š',
    'ğŸ–ï¸', 'âœ‹', 'ğŸ––', 'ğŸ‘', 'ğŸ™Œ', 'ğŸ‘', 'ğŸ¤²', 'ğŸ¤', 'ğŸ™', 'âœï¸',
    'ğŸ’ª', 'ğŸ¦¾', 'ğŸ¦¿', 'ğŸ¦µ', 'ğŸ¦¶', 'ğŸ‘‚', 'ğŸ¦»', 'ğŸ‘ƒ', 'ğŸ§ ', 'ğŸ«€',
    'ğŸ«', 'ğŸ¦·', 'ğŸ¦´', 'ğŸ‘€', 'ğŸ‘ï¸', 'ğŸ‘…', 'ğŸ‘„', 'ğŸ’‹', 'ğŸ©¸', 'â¤ï¸',
    'ğŸ§¡', 'ğŸ’›', 'ğŸ’š', 'ğŸ’™', 'ğŸ’œ', 'ğŸ–¤', 'ğŸ¤', 'ğŸ¤', 'ğŸ’”', 'â¤ï¸â€ğŸ”¥',
    'â¤ï¸â€ğŸ©¹', 'ğŸ’•', 'ğŸ’', 'ğŸ’“', 'ğŸ’—', 'ğŸ’–', 'ğŸ’˜', 'ğŸ’', 'ğŸ’Ÿ', 'â˜®ï¸',
    'âœï¸', 'â˜ªï¸', 'ğŸ•‰ï¸', 'â˜¸ï¸', 'âœ¡ï¸', 'ğŸ”¯', 'ğŸ•', 'â˜¯ï¸', 'â˜¦ï¸', 'ğŸ›',
    'âš›ï¸', 'ğŸ†”', 'âšœï¸', 'ğŸ”±', 'ğŸ“›', 'ğŸ”°', 'â­', 'ğŸŒŸ', 'âœ¨', 'âš¡',
    'ğŸ’¥', 'ğŸ’«', 'ğŸ’¦', 'ğŸ’¨', 'ğŸ•Šï¸', 'ğŸ¦…', 'ğŸ¦†', 'ğŸ¦‰', 'ğŸ¦', 'ğŸ§',
    'ğŸ¥', 'ğŸ£', 'ğŸ¤', 'ğŸ¦ƒ', 'ğŸ”', 'ğŸ“', 'ğŸ¦œ', 'ğŸ¦š', 'ğŸ¦©', 'ğŸ¦¢'
];

let currentEmojiTarget = null;

function initEmojiPicker() {
    // Crear grids de emojis para todos los selectores
    document.querySelectorAll('.emoji-grid').forEach(grid => {
        grid.innerHTML = emojis.map(emoji => 
            `<span class="emoji-item" onclick="insertEmoji('${emoji}')">${emoji}</span>`
        ).join('');
    });
}

function toggleEmojiPicker(targetId) {
    const target = document.getElementById(targetId);
    const picker = document.getElementById('emojiPicker-' + targetId) || 
                   document.getElementById('emojiPickerPost');
    
    if (!picker) return;
    
    currentEmojiTarget = target;
    
    // Cerrar otros pickers
    document.querySelectorAll('.emoji-picker').forEach(p => {
        if (p !== picker) p.style.display = 'none';
    });
    
    // Toggle actual picker
    picker.style.display = picker.style.display === 'none' ? 'block' : 'none';
}

function insertEmoji(emoji) {
    if (!currentEmojiTarget) return;
    
    const start = currentEmojiTarget.selectionStart;
    const end = currentEmojiTarget.selectionEnd;
    const text = currentEmojiTarget.value;
    
    currentEmojiTarget.value = text.substring(0, start) + emoji + text.substring(end);
    currentEmojiTarget.focus();
    
    // Colocar cursor despuÃ©s del emoji
    const newPos = start + emoji.length;
    currentEmojiTarget.setSelectionRange(newPos, newPos);
    
    // Cerrar picker
    document.querySelectorAll('.emoji-picker').forEach(p => p.style.display = 'none');
}

// Cerrar picker al hacer clic fuera
document.addEventListener('click', function(e) {
    if (!e.target.closest('.emoji-picker') && !e.target.closest('[onclick*="toggleEmojiPicker"]')) {
        document.querySelectorAll('.emoji-picker').forEach(p => p.style.display = 'none');
    }
});

// Cargar al inicio
document.addEventListener('DOMContentLoaded', function() {
    loadHashtags();
    loadMentions();
    initEmojiPicker();
});

// Recargar cuando se crea un nuevo post
const originalCreatePost = document.getElementById('createPostForm').onsubmit;
document.getElementById('createPostForm').addEventListener('submit', async function(e) {
    // Esperar a que se complete el envÃ­o del formulario
    setTimeout(() => {
        loadHashtags();
        loadMentions();
    }, 1000);
});
</script>
{% endblock %}
