{% extends 'base.html' %}
{% load static %}

{% block title %}Editar URL Corta{% endblock %}

{% block content %}
<div class="container-fluid">
    <div class="row">
        <div class="col-12">
            <div class="card">
                <div class="card-header d-flex justify-content-between align-items-center">
                    <h5 class="mb-0">
                        <i class="bi bi-pencil"></i> Editar URL Corta
                    </h5>
                    <a href="{% url 'short_url_list' %}" class="btn btn-outline-secondary btn-sm">
                        <i class="bi bi-arrow-left"></i> Volver
                    </a>
                </div>
                <div class="card-body">
                    <div class="row">
                        <div class="col-md-8">
                            <form method="post">
                                {% csrf_token %}
                                
                                <div class="mb-3">
                                    <label for="id_original_url" class="form-label">
                                        <i class="bi bi-link"></i> URL Original
                                    </label>
                                    <input type="url" 
                                           class="form-control {% if form.original_url.errors %}is-invalid{% endif %}" 
                                           id="id_original_url" 
                                           name="original_url" 
                                           value="{{ form.original_url.value|default:'' }}"
                                           placeholder="https://ejemplo.com/url-muy-larga"
                                           required>
                                    {% if form.original_url.errors %}
                                        <div class="invalid-feedback">
                                            {{ form.original_url.errors.0 }}
                                        </div>
                                    {% endif %}
                                    <div class="form-text">
                                        Ingresa la URL completa que quieres acortar.
                                    </div>
                                </div>

                                <div class="mb-3">
                                    <label for="id_short_code" class="form-label">
                                        <i class="bi bi-scissors"></i> Código Corto
                                    </label>
                                    <div class="input-group">
                                        <span class="input-group-text">{{ request.scheme }}://{{ request.get_host }}/s/</span>
                                        <input type="text" 
                                               class="form-control {% if form.short_code.errors %}is-invalid{% endif %}" 
                                               id="id_short_code" 
                                               name="short_code" 
                                               value="{{ form.short_code.value|default:'' }}"
                                               placeholder="ABC123"
                                               pattern="[A-Za-z0-9\-]+"
                                               maxlength="10"
                                               required>
                                        <button class="btn btn-outline-secondary" 
                                                type="button" 
                                                onclick="generateRandomCode()"
                                                title="Generar código aleatorio">
                                            <i class="bi bi-arrow-clockwise"></i>
                                        </button>
                                    </div>
                                    {% if form.short_code.errors %}
                                        <div class="invalid-feedback">
                                            {{ form.short_code.errors.0 }}
                                        </div>
                                    {% endif %}
                                    <div class="form-text">
                                        Puedes configurarlo manualmente o generar uno aleatorio. Solo letras, números y guiones.
                                    </div>
                                </div>

                                <div class="mb-3">
                                    <label for="id_expires_at" class="form-label">
                                        <i class="bi bi-calendar-event"></i> Fecha de Expiración (Opcional)
                                    </label>
                                    <input type="datetime-local" 
                                           class="form-control {% if form.expires_at.errors %}is-invalid{% endif %}" 
                                           id="id_expires_at" 
                                           name="expires_at" 
                                           value="{{ form.expires_at.value|date:'Y-m-d\TH:i'|default:'' }}">
                                    {% if form.expires_at.errors %}
                                        <div class="invalid-feedback">
                                            {{ form.expires_at.errors.0 }}
                                        </div>
                                    {% endif %}
                                    <div class="form-text">
                                        Si no especificas una fecha, la URL no expirará nunca.
                                    </div>
                                </div>

                                {% if form.non_field_errors %}
                                    <div class="alert alert-danger">
                                        {% for error in form.non_field_errors %}
                                            <i class="bi bi-exclamation-triangle"></i> {{ error }}
                                        {% endfor %}
                                    </div>
                                {% endif %}

                                <div class="d-flex justify-content-between">
                                    <a href="{% url 'short_url_list' %}" class="btn btn-secondary">
                                        <i class="bi bi-x-circle"></i> Cancelar
                                    </a>
                                    <button type="submit" class="btn btn-primary">
                                        <i class="bi bi-check-circle"></i> Actualizar URL
                                    </button>
                                </div>
                            </form>
                        </div>
                        
                        <div class="col-md-4">
                            <div class="card bg-light">
                                <div class="card-body">
                                    <h6 class="card-title">
                                        <i class="bi bi-info-circle"></i> Información Actual
                                    </h6>
                                    <table class="table table-sm table-borderless mb-0">
                                        <tr>
                                            <td><strong>Creada:</strong></td>
                                            <td>{{ object.created_at|date:"d/m/Y H:i" }}</td>
                                        </tr>
                                        <tr>
                                            <td><strong>Clics:</strong></td>
                                            <td>
                                                <span class="badge bg-info">{{ object.clicks }}</span>
                                            </td>
                                        </tr>
                                        <tr>
                                            <td><strong>Último clic:</strong></td>
                                            <td>
                                                {% if object.last_accessed %}
                                                    {{ object.last_accessed|date:"d/m/Y H:i" }}
                                                {% else %}
                                                    <span class="text-muted">Nunca</span>
                                                {% endif %}
                                            </td>
                                        </tr>
                                        <tr>
                                            <td><strong>Estado:</strong></td>
                                            <td>
                                                {% if object.is_expired %}
                                                    <span class="badge bg-danger">Expirada</span>
                                                {% else %}
                                                    <span class="badge bg-success">Activa</span>
                                                {% endif %}
                                            </td>
                                        </tr>
                                    </table>
                                </div>
                            </div>
                            
                            <div class="card bg-light mt-3">
                                <div class="card-body">
                                    <h6 class="card-title">
                                        <i class="bi bi-link-45deg"></i> URL Corta
                                    </h6>
                                    <div class="input-group mb-2">
                                        <input type="text" 
                                               class="form-control form-control-sm" 
                                               value="{{ request.scheme }}://{{ request.get_host }}/s/{{ object.short_code }}" 
                                               readonly 
                                               id="currentUrl">
                                        <button class="btn btn-outline-secondary btn-sm" 
                                                type="button" 
                                                onclick="copyToClipboard('currentUrl')"
                                                title="Copiar URL">
                                            <i class="bi bi-clipboard"></i>
                                        </button>
                                    </div>
                                    <a href="{{ request.scheme }}://{{ request.get_host }}/s/{{ object.short_code }}" 
                                       target="_blank" 
                                       class="btn btn-primary btn-sm w-100">
                                        <i class="bi bi-box-arrow-up-right"></i> Ir a la URL
                                    </a>
                                    <small class="text-muted d-block mt-2">Esta es tu URL corta actual</small>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Sección de Estadísticas -->
                    {% if object.clicks > 0 %}
                    <div class="row mt-4">
                        <div class="col-12">
                            <h5 class="mb-3">
                                <i class="bi bi-graph-up"></i> Estadísticas de Clics
                            </h5>
                        </div>
                        
                        <!-- Gráficos -->
                        <div class="col-md-4 mb-3">
                            <div class="card">
                                <div class="card-header bg-primary text-white">
                                    <h6 class="mb-0"><i class="bi bi-calendar-month"></i> Clics por Mes</h6>
                                </div>
                                <div class="card-body">
                                    <canvas id="clicksByMonthChart" height="250"></canvas>
                                </div>
                            </div>
                        </div>
                        
                        <div class="col-md-4 mb-3">
                            <div class="card">
                                <div class="card-header bg-success text-white">
                                    <h6 class="mb-0"><i class="bi bi-calendar-day"></i> Clics por Día</h6>
                                </div>
                                <div class="card-body">
                                    <canvas id="clicksByDayChart" height="250"></canvas>
                                </div>
                            </div>
                        </div>
                        
                        <div class="col-md-4 mb-3">
                            <div class="card">
                                <div class="card-header bg-info text-white">
                                    <h6 class="mb-0"><i class="bi bi-clock"></i> Clics por Hora</h6>
                                </div>
                                <div class="card-body">
                                    <canvas id="clicksByHourChart" height="250"></canvas>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Tabla de Estadísticas -->
                        <div class="col-md-6 mb-3">
                            <div class="card">
                                <div class="card-header bg-warning">
                                    <h6 class="mb-0"><i class="bi bi-flag"></i> Top Países</h6>
                                </div>
                                <div class="card-body">
                                    <div class="table-responsive" style="max-height: 300px; overflow-y: auto;">
                                        <table class="table table-sm table-hover mb-0">
                                            <thead class="table-light sticky-top">
                                                <tr>
                                                    <th>País</th>
                                                    <th class="text-end">Clics</th>
                                                    <th class="text-end">%</th>
                                                </tr>
                                            </thead>
                                            <tbody id="countryStats">
                                                <tr>
                                                    <td colspan="3" class="text-center text-muted">Cargando...</td>
                                                </tr>
                                            </tbody>
                                        </table>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <div class="col-md-6 mb-3">
                            <div class="card">
                                <div class="card-header bg-secondary text-white">
                                    <h6 class="mb-0"><i class="bi bi-building"></i> Top Ciudades</h6>
                                </div>
                                <div class="card-body">
                                    <div class="table-responsive" style="max-height: 300px; overflow-y: auto;">
                                        <table class="table table-sm table-hover mb-0">
                                            <thead class="table-light sticky-top">
                                                <tr>
                                                    <th>Ciudad</th>
                                                    <th class="text-end">Clics</th>
                                                    <th class="text-end">%</th>
                                                </tr>
                                            </thead>
                                            <tbody id="cityStats">
                                                <tr>
                                                    <td colspan="3" class="text-center text-muted">Cargando...</td>
                                                </tr>
                                            </tbody>
                                        </table>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Tabla de IPs y Detalles -->
                        <div class="col-12 mb-3">
                            <div class="card">
                                <div class="card-header bg-dark text-white">
                                    <h6 class="mb-0"><i class="bi bi-list-ul"></i> Registro Detallado de Clics</h6>
                                </div>
                                <div class="card-body">
                                    <div class="table-responsive" style="max-height: 400px; overflow-y: auto;">
                                        <table class="table table-sm table-striped table-hover mb-0">
                                            <thead class="table-dark sticky-top">
                                                <tr>
                                                    <th>Fecha y Hora</th>
                                                    <th>IP</th>
                                                    <th>País</th>
                                                    <th>Ciudad</th>
                                                    <th>Referer</th>
                                                </tr>
                                            </thead>
                                            <tbody id="clickDetails">
                                                <tr>
                                                    <td colspan="5" class="text-center text-muted">Cargando...</td>
                                                </tr>
                                            </tbody>
                                        </table>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
function copyToClipboard(elementId) {
    const element = document.getElementById(elementId);
    element.select();
    element.setSelectionRange(0, 99999);
    navigator.clipboard.writeText(element.value).then(function() {
        // Cambiar temporalmente el ícono
        const button = element.nextElementSibling;
        const icon = button.querySelector('i');
        const originalClass = icon.className;
        icon.className = 'bi bi-check';
        setTimeout(() => {
            icon.className = originalClass;
        }, 2000);
    });
}

function generateRandomCode() {
    const chars = 'ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789';
    let code = '';
    for (let i = 0; i < 6; i++) {
        code += chars.charAt(Math.floor(Math.random() * chars.length));
    }
    document.getElementById('id_short_code').value = code;
}

// Cargar estadísticas si hay clics
{% if object.clicks > 0 %}
document.addEventListener('DOMContentLoaded', function() {
    // Cargar estadísticas desde la API
    fetch('/api/short-urls/{{ object.pk }}/stats/')
        .then(response => response.json())
        .then(data => {
            // Gráfico por mes
            const ctxMonth = document.getElementById('clicksByMonthChart').getContext('2d');
            new Chart(ctxMonth, {
                type: 'bar',
                data: {
                    labels: data.by_month.labels,
                    datasets: [{
                        label: 'Clics',
                        data: data.by_month.values,
                        backgroundColor: 'rgba(54, 162, 235, 0.5)',
                        borderColor: 'rgba(54, 162, 235, 1)',
                        borderWidth: 1
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        y: {
                            beginAtZero: true,
                            ticks: { stepSize: 1 }
                        }
                    }
                }
            });
            
            // Gráfico por día
            const ctxDay = document.getElementById('clicksByDayChart').getContext('2d');
            new Chart(ctxDay, {
                type: 'line',
                data: {
                    labels: data.by_day.labels,
                    datasets: [{
                        label: 'Clics',
                        data: data.by_day.values,
                        backgroundColor: 'rgba(75, 192, 192, 0.2)',
                        borderColor: 'rgba(75, 192, 192, 1)',
                        borderWidth: 2,
                        tension: 0.3,
                        fill: true
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        y: {
                            beginAtZero: true,
                            ticks: { stepSize: 1 }
                        }
                    }
                }
            });
            
            // Gráfico por hora
            const ctxHour = document.getElementById('clicksByHourChart').getContext('2d');
            new Chart(ctxHour, {
                type: 'bar',
                data: {
                    labels: data.by_hour.labels,
                    datasets: [{
                        label: 'Clics',
                        data: data.by_hour.values,
                        backgroundColor: 'rgba(255, 159, 64, 0.5)',
                        borderColor: 'rgba(255, 159, 64, 1)',
                        borderWidth: 1
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        y: {
                            beginAtZero: true,
                            ticks: { stepSize: 1 }
                        }
                    }
                }
            });
            
            // Tabla de países
            const countryStatsHtml = data.by_country.map(item => `
                <tr>
                    <td>${item.country || 'Desconocido'}</td>
                    <td class="text-end">${item.count}</td>
                    <td class="text-end">${item.percentage}%</td>
                </tr>
            `).join('');
            document.getElementById('countryStats').innerHTML = countryStatsHtml || '<tr><td colspan="3" class="text-center text-muted">Sin datos</td></tr>';
            
            // Tabla de ciudades
            const cityStatsHtml = data.by_city.map(item => `
                <tr>
                    <td>${item.city || 'Desconocido'}</td>
                    <td class="text-end">${item.count}</td>
                    <td class="text-end">${item.percentage}%</td>
                </tr>
            `).join('');
            document.getElementById('cityStats').innerHTML = cityStatsHtml || '<tr><td colspan="3" class="text-center text-muted">Sin datos</td></tr>';
            
            // Tabla de detalles de clics
            const clickDetailsHtml = data.click_details.map(item => `
                <tr>
                    <td>${item.clicked_at}</td>
                    <td><code>${item.ip_address || 'N/A'}</code></td>
                    <td>${item.country || '-'}</td>
                    <td>${item.city || '-'}</td>
                    <td>${item.referer ? '<small>' + item.referer.substring(0, 50) + '...</small>' : '-'}</td>
                </tr>
            `).join('');
            document.getElementById('clickDetails').innerHTML = clickDetailsHtml || '<tr><td colspan="5" class="text-center text-muted">Sin datos</td></tr>';
        })
        .catch(error => {
            console.error('Error loading stats:', error);
            document.getElementById('countryStats').innerHTML = '<tr><td colspan="3" class="text-center text-danger">Error al cargar datos</td></tr>';
            document.getElementById('cityStats').innerHTML = '<tr><td colspan="3" class="text-center text-danger">Error al cargar datos</td></tr>';
            document.getElementById('clickDetails').innerHTML = '<tr><td colspan="5" class="text-center text-danger">Error al cargar datos</td></tr>';
        });
});
{% endif %}
</script>
{% endblock %}