<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Mis Tareas - {{ user.get_full_name|default:user.username }}</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.7.2/font/bootstrap-icons.css">
    <style>
        .task-row:hover {
            background-color: #f8f9fa;
        }
        .priority-high { color: #dc3545; }
        .priority-medium { color: #fd7e14; }
        .priority-low { color: #6c757d; }
    </style>
</head>
<body class="bg-light">
    <nav class="navbar navbar-dark bg-success">
        <div class="container">
            <span class="navbar-brand mb-0 h1">
                <i class="bi bi-list-task"></i> 
                Gestión de Tareas - {{ user.get_full_name|default:user.username }}
            </span>
        </div>
    </nav>

    <div class="container py-4">
        {% if error_message %}
            <div class="alert alert-danger">
                <i class="bi bi-exclamation-triangle"></i> {{ error_message }}
            </div>
        {% endif %}

        {% if tasks %}
            <form method="post">
                {% csrf_token %}
                
                <div class="card">
                    <div class="card-header">
                        <h5 class="mb-0">
                            <i class="bi bi-check-square"></i> 
                            Marca las tareas que completaste hoy
                        </h5>
                        <small class="text-muted">
                            Se creará una gestión con TODAS tus tareas asignadas. 
                            Las que marques se registrarán como completadas.
                        </small>
                    </div>
                    <div class="card-body p-0">
                        <div class="table-responsive">
                            <table class="table table-hover mb-0">
                                <thead class="table-light">
                                    <tr>
                                        <th width="60">
                                            <input type="checkbox" class="form-check-input" id="selectAll">
                                        </th>
                                        <th>Nombre de la Tarea</th>
                                        <th width="120">Prioridad</th>
                                        <th width="100">Estado</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    {% for task in tasks %}
                                    <tr class="task-row">
                                        <td>
                                            <input type="checkbox" 
                                                   class="form-check-input task-checkbox" 
                                                   name="selected_tasks" 
                                                   value="{{ task.id }}"
                                                   id="task_{{ task.id }}">
                                        </td>
                                        <td>
                                            <label for="task_{{ task.id }}" class="form-label mb-0 w-100" style="cursor: pointer;">
                                                <strong>{{ task.title }}</strong>
                                                {% if task.description %}
                                                    <br><small class="text-muted">{{ task.description|truncatechars:100 }}</small>
                                                {% endif %}
                                                {% if task.due_date %}
                                                    <br><small class="text-info">
                                                        <i class="bi bi-calendar"></i> Vence: {{ task.due_date|date:"d/m/Y" }}
                                                    </small>
                                                {% endif %}
                                            </label>
                                        </td>
                                        <td>
                                            <span class="priority-{{ task.priority }}">
                                                <i class="bi bi-flag-fill"></i>
                                                {{ task.get_priority_display }}
                                            </span>
                                        </td>
                                        <td>
                                            <span class="badge 
                                                {% if task.status == 'completed' %}bg-success
                                                {% elif task.status == 'in_progress' %}bg-warning
                                                {% elif task.status == 'pending' %}bg-secondary
                                                {% else %}bg-info{% endif %}">
                                                {{ task.get_status_display }}
                                            </span>
                                        </td>
                                    </tr>
                                    {% endfor %}
                                </tbody>
                            </table>
                        </div>
                    </div>
                    <div class="card-footer bg-light">
                        <div class="d-flex justify-content-between align-items-center">
                            <div>
                                <small class="text-muted">
                                    <span id="selectedCount">0</span> de {{ tasks|length }} tareas marcadas como completadas
                                </small>
                            </div>
                            <button type="submit" class="btn btn-success" id="submitBtn">
                                <i class="bi bi-journal-plus"></i> 
                                Crear Gestión Diaria
                            </button>
                        </div>
                    </div>
                </div>
            </form>
        {% else %}
            <div class="card">
                <div class="card-body text-center py-5">
                    <i class="bi bi-list-task display-1 text-muted"></i>
                    <h4 class="mt-3">No tienes tareas asignadas</h4>
                    <p class="text-muted">
                        Actualmente no tienes tareas asignadas para crear una gestión diaria.
                        Contacta a tu supervisor para que te asigne tareas.
                    </p>
                </div>
            </div>
        {% endif %}
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        // Seleccionar/deseleccionar todas las tareas
        document.getElementById('selectAll').addEventListener('change', function() {
            const checkboxes = document.querySelectorAll('.task-checkbox');
            checkboxes.forEach(checkbox => {
                checkbox.checked = this.checked;
            });
            updateSelectedCount();
        });

        // Actualizar contador
        function updateSelectedCount() {
            const checkboxes = document.querySelectorAll('.task-checkbox:checked');
            const count = checkboxes.length;
            const countElement = document.getElementById('selectedCount');
            
            countElement.textContent = count;
        }

        // Escuchar cambios en los checkboxes
        document.addEventListener('change', function(e) {
            if (e.target.classList.contains('task-checkbox')) {
                updateSelectedCount();
                
                // Actualizar estado del "Seleccionar todo"
                const allCheckboxes = document.querySelectorAll('.task-checkbox');
                const checkedCheckboxes = document.querySelectorAll('.task-checkbox:checked');
                const selectAllCheckbox = document.getElementById('selectAll');
                
                if (checkedCheckboxes.length === 0) {
                    selectAllCheckbox.indeterminate = false;
                    selectAllCheckbox.checked = false;
                } else if (checkedCheckboxes.length === allCheckboxes.length) {
                    selectAllCheckbox.indeterminate = false;
                    selectAllCheckbox.checked = true;
                } else {
                    selectAllCheckbox.indeterminate = true;
                }
            }
        });
    </script>
</body>
</html>