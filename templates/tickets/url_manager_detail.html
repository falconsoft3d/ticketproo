{% extends 'base.html' %}
{% load django_bootstrap5 %}

{% block title %}{{ page_title }} - TicketProo{% endblock %}

{% block content %}
<div class="container-fluid py-4">
    <div class="row justify-content-center">
        <div class="col-lg-8">
            <!-- Header -->
            <div class="d-flex justify-content-between align-items-center mb-4">
                <div>
                    <h2 class="h3 mb-1">
                        <i class="bi bi-link-45deg text-primary"></i>
                        {{ page_title }}
                    </h2>
                    <p class="text-muted mb-0">Información detallada y credenciales de acceso</p>
                </div>
                <div>
                    <a href="{% url 'url_manager_edit' url_manager.id %}" class="btn btn-outline-primary me-2">
                        <i class="bi bi-pencil"></i> Editar
                    </a>
                    <a href="{% url 'url_manager_list' %}" class="btn btn-outline-secondary">
                        <i class="bi bi-arrow-left"></i> Volver
                    </a>
                </div>
            </div>

            <!-- Información básica -->
            <div class="card mb-4">
                <div class="card-header bg-light">
                    <h5 class="mb-0">
                        <i class="bi bi-info-circle text-primary"></i>
                        Información Básica
                    </h5>
                </div>
                <div class="card-body">
                    <div class="row">
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label class="form-label fw-bold">Título:</label>
                                <p class="mb-0">{{ url_manager.title }}</p>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label class="form-label fw-bold">Estado:</label>
                                <p class="mb-0">
                                    {% if url_manager.is_active %}
                                        <span class="badge bg-success">
                                            <i class="bi bi-check-circle"></i> Activo
                                        </span>
                                    {% else %}
                                        <span class="badge bg-secondary">
                                            <i class="bi bi-x-circle"></i> Inactivo
                                        </span>
                                    {% endif %}
                                </p>
                            </div>
                        </div>
                        <div class="col-12">
                            <div class="mb-3">
                                <label class="form-label fw-bold">URL:</label>
                                <p class="mb-0">
                                    <a href="{{ url_manager.url }}" target="_blank" class="text-decoration-none">
                                        {{ url_manager.url }}
                                        <i class="bi bi-box-arrow-up-right ms-1"></i>
                                    </a>
                                </p>
                            </div>
                        </div>
                        {% if url_manager.category %}
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label class="form-label fw-bold">Categoría:</label>
                                <p class="mb-0">
                                    <span class="badge bg-info">
                                        <i class="bi bi-tag"></i> {{ url_manager.category }}
                                    </span>
                                </p>
                            </div>
                        </div>
                        {% endif %}
                        {% if url_manager.domain %}
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label class="form-label fw-bold">Dominio:</label>
                                <p class="mb-0">{{ url_manager.domain }}</p>
                            </div>
                        </div>
                        {% endif %}
                        {% if url_manager.description %}
                        <div class="col-12">
                            <div class="mb-3">
                                <label class="form-label fw-bold">Descripción:</label>
                                <p class="mb-0">{{ url_manager.description }}</p>
                            </div>
                        </div>
                        {% endif %}
                    </div>
                </div>
            </div>

            <!-- Credenciales de acceso -->
            <div class="card mb-4">
                <div class="card-header bg-warning bg-opacity-10">
                    <h5 class="mb-0">
                        <i class="bi bi-shield-lock text-warning"></i>
                        Credenciales de Acceso
                    </h5>
                </div>
                <div class="card-body">
                    <div class="row">
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label class="form-label fw-bold">Usuario:</label>
                                <div class="input-group">
                                    <input type="text" class="form-control" value="{{ url_manager.username }}" readonly>
                                    <button class="btn btn-outline-secondary" type="button" onclick="copyToClipboard('{{ url_manager.username }}', this)">
                                        <i class="bi bi-clipboard"></i>
                                    </button>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label class="form-label fw-bold">Contraseña:</label>
                                <div class="input-group">
                                    <input type="password" id="passwordField" class="form-control" value="••••••••••" readonly>
                                    <button class="btn btn-outline-secondary" type="button" id="togglePassword">
                                        <i class="bi bi-eye" id="passwordIcon"></i>
                                    </button>
                                    <button class="btn btn-outline-secondary" type="button" id="copyPassword" onclick="copyPassword()">
                                        <i class="bi bi-clipboard"></i>
                                    </button>
                                </div>
                                <small class="form-text text-muted">
                                    <i class="bi bi-shield-check text-success"></i>
                                    Contraseña almacenada de forma segura
                                </small>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Información del sistema -->
            <div class="card mb-4">
                <div class="card-header bg-light">
                    <h5 class="mb-0">
                        <i class="bi bi-gear text-secondary"></i>
                        Información del Sistema
                    </h5>
                </div>
                <div class="card-body">
                    <div class="row">
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label class="form-label fw-bold">Creado por:</label>
                                <p class="mb-0">{{ url_manager.created_by.get_full_name|default:url_manager.created_by.username }}</p>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label class="form-label fw-bold">Fecha de creación:</label>
                                <p class="mb-0">{{ url_manager.created_at|date:"d/m/Y H:i" }}</p>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label class="form-label fw-bold">Última actualización:</label>
                                <p class="mb-0">{{ url_manager.updated_at|date:"d/m/Y H:i" }}</p>
                            </div>
                        </div>
                        {% if url_manager.last_accessed %}
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label class="form-label fw-bold">Último acceso:</label>
                                <p class="mb-0">{{ url_manager.last_accessed|date:"d/m/Y H:i" }}</p>
                            </div>
                        </div>
                        {% endif %}
                    </div>
                </div>
            </div>

            <!-- Acciones -->
            <div class="card">
                <div class="card-body">
                    <h6 class="card-title">Acciones Rápidas</h6>
                    <div class="d-flex flex-wrap gap-2">
                        <a href="{{ url_manager.url }}" target="_blank" class="btn btn-primary">
                            <i class="bi bi-box-arrow-up-right"></i> Abrir URL
                        </a>
                        <a href="{% url 'url_manager_edit' url_manager.id %}" class="btn btn-outline-primary">
                            <i class="bi bi-pencil"></i> Editar
                        </a>
                        <button type="button" class="btn btn-outline-secondary" onclick="copyUrlToClipboard()">
                            <i class="bi bi-clipboard"></i> Copiar URL
                        </button>
                        <a href="{% url 'url_manager_delete' url_manager.id %}" class="btn btn-outline-danger">
                            <i class="bi bi-trash"></i> Eliminar
                        </a>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
let realPassword = '';
let passwordVisible = false;

document.addEventListener('DOMContentLoaded', function() {
    const togglePassword = document.getElementById('togglePassword');
    const passwordField = document.getElementById('passwordField');
    const passwordIcon = document.getElementById('passwordIcon');
    
    // Toggle password visibility
    togglePassword.addEventListener('click', function() {
        if (passwordVisible) {
            // Ocultar contraseña
            passwordField.type = 'password';
            passwordField.value = '••••••••••';
            passwordIcon.className = 'bi bi-eye';
            passwordVisible = false;
        } else {
            // Mostrar contraseña - obtener del servidor
            fetch('{% url "url_manager_password" url_manager.id %}', {
                method: 'GET',
                headers: {
                    'X-Requested-With': 'XMLHttpRequest',
                    'X-CSRFToken': '{{ csrf_token }}',
                }
            })
            .then(response => {
                console.log('Response status:', response.status);
                return response.json();
            })
            .then(data => {
                console.log('Response data:', data);
                if (data.success) {
                    realPassword = data.password;
                    passwordField.type = 'text';  // Cambiar a texto para mostrar la contraseña
                    passwordField.value = realPassword;
                    passwordIcon.className = 'bi bi-eye-slash';
                    passwordVisible = true;
                } else {
                    console.error('Error from server:', data.error);
                    alert('Error al obtener la contraseña: ' + data.error);
                }
            })
            .catch(error => {
                console.error('Fetch error:', error);
                alert('Error al obtener la contraseña: ' + error.message);
            });
        }
    });
});

function copyToClipboard(text, button) {
    navigator.clipboard.writeText(text).then(function() {
        const originalHtml = button.innerHTML;
        button.innerHTML = '<i class="bi bi-check"></i>';
        button.classList.add('btn-success');
        button.classList.remove('btn-outline-secondary');
        
        setTimeout(function() {
            button.innerHTML = originalHtml;
            button.classList.remove('btn-success');
            button.classList.add('btn-outline-secondary');
        }, 2000);
    });
}

function copyPassword() {
    if (passwordVisible && realPassword) {
        copyToClipboard(realPassword, document.getElementById('copyPassword'));
    } else {
        alert('Primero debe mostrar la contraseña para copiarla');
    }
}

function copyUrlToClipboard() {
    copyToClipboard('{{ url_manager.url }}', event.target);
}
</script>
{% endblock %}