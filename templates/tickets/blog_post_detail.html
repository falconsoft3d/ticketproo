{% extends "blog_base.html" %}

{% block title %}{{ post.title }} - Blog TicketProo{% endblock %}

{% block content %}
<div class="row">
    <div class="col-md-8">
        <!-- Navegación -->
        <nav aria-label="breadcrumb" class="mb-4">
            <ol class="breadcrumb">
                <li class="breadcrumb-item"><a href="{% url 'blog_list' %}">Blog</a></li>
                <li class="breadcrumb-item"><a href="?category={{ post.category.slug }}">{{ post.category.name }}</a></li>
                <li class="breadcrumb-item active" aria-current="page">{{ post.title|truncatewords:5 }}</li>
            </ol>
        </nav>
        
        <!-- Artículo -->
        <article class="blog-post">
            <header class="mb-4">
                <span class="badge bg-primary mb-2">{{ post.category.name }}</span>
                <h1 class="mb-3">{{ post.title }}</h1>
                
                <div class="d-flex flex-wrap align-items-center text-muted mb-3">
                    <span class="me-3">
                        <i class="fas fa-user"></i> 
                        {{ post.created_by.get_full_name|default:post.created_by.username }}
                    </span>
                    <span class="me-3">
                        <i class="fas fa-calendar"></i> 
                        {{ post.created_at|date:"d M Y, H:i" }}
                    </span>
                    <span class="me-3">
                        <i class="fas fa-eye"></i> 
                        {{ post.views }} vistas
                    </span>
                    <span>
                        <i class="fas fa-comments"></i> 
                        {{ comments.count }} comentarios
                    </span>
                </div>
                
                {% if post.tags %}
                <div class="mb-3">
                    {% for tag in post.tags.split %}
                    <span class="badge bg-light text-dark me-1">#{{ tag }}</span>
                    {% endfor %}
                </div>
                {% endif %}
            </header>
            
            {% if post.featured_image %}
            <div class="mb-4">
                <img src="{{ post.featured_image.url }}" 
                     class="img-fluid rounded" 
                     alt="{{ post.title }}"
                     style="width: 100%; max-height: 400px; object-fit: cover;">
            </div>
            {% endif %}
            
            {% if post.excerpt %}
            <div class="lead mb-4">
                {{ post.excerpt }}
            </div>
            {% endif %}
            
            <div class="blog-content">
                {{ post.content|linebreaks }}
            </div>
            
            {% if user.is_authenticated and user.is_staff %}
            <div class="mt-4 p-3 bg-light rounded">
                <h6><i class="fas fa-cog"></i> Administración</h6>
                <a href="{% url 'blog_post_detail_admin' post.pk %}" class="btn btn-outline-primary btn-sm me-2">
                    <i class="fas fa-edit"></i> Editar Artículo
                </a>
                <a href="{% url 'blog_post_list_admin' %}" class="btn btn-outline-secondary btn-sm">
                    <i class="fas fa-list"></i> Gestionar Blog
                </a>
            </div>
            {% endif %}
        </article>
        
        <hr class="my-5">
        
        <!-- Comentarios -->
        <section id="comments">
            <h3 class="mb-4">
                <i class="fas fa-comments"></i> 
                Comentarios ({{ comments.count }})
            </h3>
            
            <!-- Formulario de comentarios -->
            <div class="card mb-4">
                <div class="card-header">
                    <h5 class="mb-0">Dejar un comentario</h5>
                </div>
                <div class="card-body">
                    <form method="POST">
                        {% csrf_token %}
                        <div class="row">
                            <div class="col-md-6 mb-3">
                                <label for="{{ comment_form.name.id_for_label }}" class="form-label">Nombre *</label>
                                {{ comment_form.name }}
                                {% if comment_form.name.errors %}
                                <div class="text-danger small">{{ comment_form.name.errors.0 }}</div>
                                {% endif %}
                            </div>
                            <div class="col-md-6 mb-3">
                                <label for="{{ comment_form.email.id_for_label }}" class="form-label">Email *</label>
                                {{ comment_form.email }}
                                <small class="form-text text-muted">No se publicará tu email</small>
                                {% if comment_form.email.errors %}
                                <div class="text-danger small">{{ comment_form.email.errors.0 }}</div>
                                {% endif %}
                            </div>
                        </div>
                        <div class="mb-3">
                            <label for="{{ comment_form.content.id_for_label }}" class="form-label">Comentario *</label>
                            {{ comment_form.content }}
                            {% if comment_form.content.errors %}
                            <div class="text-danger small">{{ comment_form.content.errors.0 }}</div>
                            {% endif %}
                        </div>
                        <button type="submit" class="btn btn-primary">
                            <i class="fas fa-paper-plane"></i> Enviar Comentario
                        </button>
                        <small class="form-text text-muted d-block mt-2">
                            Los comentarios están sujetos a aprobación antes de ser publicados.
                        </small>
                    </form>
                </div>
            </div>
            
            <!-- Lista de comentarios -->
            {% for comment in comments %}
            <div class="card mb-3">
                <div class="card-body">
                    <div class="d-flex justify-content-between align-items-start mb-2">
                        <h6 class="mb-0">
                            <i class="fas fa-user-circle"></i> {{ comment.name }}
                        </h6>
                        <small class="text-muted">
                            {{ comment.created_at|date:"d M Y, H:i" }}
                        </small>
                    </div>
                    <p class="mb-0">{{ comment.content|linebreaks }}</p>
                </div>
            </div>
            {% empty %}
            <div class="alert alert-info">
                <i class="fas fa-info-circle"></i>
                Sé el primero en comentar este artículo.
            </div>
            {% endfor %}
        </section>
    </div>
    
    <!-- Sidebar -->
    <div class="col-md-4">
        <!-- Artículos relacionados -->
        {% if related_posts %}
        <div class="card mb-4">
            <div class="card-header">
                <h5><i class="fas fa-newspaper"></i> Artículos Relacionados</h5>
            </div>
            <div class="card-body">
                {% for related in related_posts %}
                <div class="mb-3 pb-3 {% if not forloop.last %}border-bottom{% endif %}">
                    {% if related.featured_image %}
                    <img src="{{ related.featured_image.url }}" 
                         class="img-fluid rounded mb-2" 
                         alt="{{ related.title }}"
                         style="width: 100%; height: 100px; object-fit: cover;">
                    {% endif %}
                    <h6>
                        <a href="{% url 'blog_post_detail' related.slug %}" class="text-decoration-none">
                            {{ related.title }}
                        </a>
                    </h6>
                    <small class="text-muted">
                        <i class="fas fa-calendar"></i> {{ related.created_at|date:"d M Y" }}
                        <i class="fas fa-eye ml-2"></i> {{ related.views }}
                    </small>
                </div>
                {% endfor %}
            </div>
        </div>
        {% endif %}
        
        <!-- Navegación -->
        <div class="card">
            <div class="card-header">
                <h6><i class="fas fa-navigation"></i> Navegación</h6>
            </div>
            <div class="card-body">
                <a href="{% url 'blog_list' %}" class="btn btn-outline-primary btn-sm d-block mb-2">
                    <i class="fas fa-arrow-left"></i> Volver al Blog
                </a>
                <a href="?category={{ post.category.slug }}" class="btn btn-outline-secondary btn-sm d-block">
                    <i class="fas fa-tags"></i> Más de {{ post.category.name }}
                </a>
            </div>
        </div>
    </div>
</div>

<!-- Schema.org structured data -->
<script type="application/ld+json">
{
  "@context": "https://schema.org",
  "@type": "BlogPosting",
  "headline": "{{ post.title }}",
  "description": "{{ post.meta_description|default:post.excerpt|truncatewords:25 }}",
  "image": {% if post.featured_image %}"{{ request.scheme }}://{{ request.get_host }}{{ post.featured_image.url }}"{% else %}""{% endif %},
  "author": {
    "@type": "Person",
    "name": "{{ post.created_by.get_full_name|default:post.created_by.username }}"
  },
  "publisher": {
    "@type": "Organization",
    "name": "{{ request.get_host }}"
  },
  "datePublished": "{{ post.created_at|date:'c' }}",
  "dateModified": "{{ post.updated_at|date:'c' }}",
  "mainEntityOfPage": {
    "@type": "WebPage",
    "@id": "{{ request.build_absolute_uri }}"
  }
}
</script>
{% endblock %}