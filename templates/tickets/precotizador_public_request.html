{% extends 'public_base.html' %}
{% load static %}

{% block title %}Solicitar Cotizaci√≥n - {{ precotizador.title }}{% endblock %}

{% block extra_css %}
<style>
    .request-header {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        border-radius: 15px;
        color: white;
        padding: 2rem;
        text-align: center;
        margin-bottom: 2rem;
    }
    
    .request-form {
        background: #f8f9fa;
        border: 1px solid #dee2e6;
        border-radius: 15px;
        padding: 2rem;
        box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
    }
    
    .form-control {
        border: 2px solid #e9ecef;
        border-radius: 10px;
        padding: 0.75rem 1rem;
        transition: all 0.3s ease;
    }
    
    .form-control:focus {
        border-color: #667eea;
        box-shadow: 0 0 0 0.2rem rgba(102, 126, 234, 0.25);
        transform: translateY(-1px);
    }
    
    .btn-submit {
        background: linear-gradient(135deg, #667eea, #764ba2);
        border: none;
        border-radius: 10px;
        padding: 1rem 2rem;
        font-weight: 600;
        font-size: 1.1rem;
        transition: all 0.3s ease;
    }
    
    .btn-submit:hover {
        transform: translateY(-2px);
        box-shadow: 0 8px 15px rgba(102, 126, 234, 0.3);
    }
    
    .character-count {
        font-size: 0.875rem;
        color: #6c757d;
        text-align: right;
        margin-top: 0.25rem;
    }
    
    .info-card {
        background: #e7f3ff;
        border: 1px solid #b3d9ff;
        border-radius: 10px;
        padding: 1.5rem;
        margin-bottom: 2rem;
    }
    
    .process-steps {
        background: #f0f9ff;
        border-left: 4px solid #667eea;
        border-radius: 0 10px 10px 0;
        padding: 1.5rem;
        margin-bottom: 2rem;
    }
    
    .step {
        display: flex;
        align-items: center;
        margin-bottom: 1rem;
    }
    
    .step-number {
        background: #667eea;
        color: white;
        width: 30px;
        height: 30px;
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        font-weight: bold;
        margin-right: 1rem;
        font-size: 0.875rem;
    }
    
    .hourly-rate-display {
        background: linear-gradient(45deg, #28a745, #20c997);
        color: white;
        border-radius: 10px;
        padding: 1rem;
        text-align: center;
        margin-bottom: 1.5rem;
    }
    
    @media (max-width: 768px) {
        .request-header {
            padding: 1.5rem;
        }
        
        .request-form {
            padding: 1.5rem;
        }
    }
</style>
{% endblock %}

{% block content %}
<div class="container mt-4">
    <!-- Encabezado -->
    <div class="request-header">
        <h1 class="mb-3">
            <i class="bi bi-calculator"></i>
            {{ precotizador.title }}
        </h1>
        <p class="lead mb-0">
            Cu√©ntanos sobre tu proyecto y recibe una cotizaci√≥n personalizada
        </p>
    </div>

    <div class="row">
        <div class="col-lg-8 mx-auto">
            <!-- Informaci√≥n del proceso -->
            <div class="process-steps">
                <h5 class="text-primary mb-3">
                    <i class="bi bi-info-circle"></i>
                    ¬øC√≥mo funciona?
                </h5>
                <div class="step">
                    <div class="step-number">1</div>
                    <div>Describe tu proyecto con el mayor detalle posible</div>
                </div>
                <div class="step">
                    <div class="step-number">2</div>
                    <div>Nuestro sistema de IA analiza tu solicitud</div>
                </div>
                <div class="step">
                    <div class="step-number">3</div>
                    <div>Recibes una cotizaci√≥n detallada instant√°neamente</div>
                </div>
                <div class="step mb-0">
                    <div class="step-number">4</div>
                    <div>Puedes aceptar o rechazar la propuesta</div>
                </div>
            </div>

            <!-- Tarifa por hora -->
            <div class="hourly-rate-display">
                <h6 class="mb-2">üí∞ Tarifa por Hora</h6>
                <div class="fs-4 fw-bold">{{ precotizador.get_formatted_hourly_rate }}</div>
            </div>

            <!-- Informaci√≥n sobre el tipo de cliente -->
            {% if precotizador.client_description %}
            <div class="info-card">
                <h6 class="text-primary mb-2">
                    <i class="bi bi-person-check"></i>
                    Especializaci√≥n
                </h6>
                <p class="mb-0">{{ precotizador.client_description }}</p>
            </div>
            {% endif %}

            <!-- Formulario de solicitud -->
            <div class="request-form">
                <form method="post" id="requestForm">
                    {% csrf_token %}
                    
                    <h4 class="text-center mb-4 text-primary">
                        <i class="bi bi-chat-dots"></i>
                        Solicita tu Cotizaci√≥n
                    </h4>

                    <!-- Informaci√≥n del cliente (opcional) -->
                    <div class="row mb-3">
                        <div class="col-md-6">
                            <label for="client_name" class="form-label">
                                <i class="bi bi-person"></i>
                                Tu nombre (opcional)
                            </label>
                            <input type="text" 
                                   class="form-control" 
                                   id="client_name" 
                                   name="client_name"
                                   value="{{ client_name|default:'' }}"
                                   placeholder="Ej: Juan P√©rez">
                        </div>
                        <div class="col-md-6">
                            <label for="client_email" class="form-label">
                                <i class="bi bi-envelope"></i>
                                Tu email (opcional)
                            </label>
                            <input type="email" 
                                   class="form-control" 
                                   id="client_email" 
                                   name="client_email"
                                   value="{{ client_email|default:'' }}"
                                   placeholder="Ej: juan@empresa.com">
                        </div>
                    </div>

                    <!-- Descripci√≥n del proyecto -->
                    <div class="mb-4">
                        <label for="client_request" class="form-label">
                            <i class="bi bi-file-text"></i>
                            Describe tu proyecto <span class="text-danger">*</span>
                        </label>
                        <textarea class="form-control" 
                                  id="client_request" 
                                  name="client_request" 
                                  rows="8"
                                  required
                                  maxlength="3000"
                                  placeholder="Describe detalladamente tu proyecto:

‚Ä¢ ¬øQu√© tipo de aplicaci√≥n necesitas? (web, m√≥vil, sistema, etc.)
‚Ä¢ ¬øCu√°les son las funcionalidades principales?
‚Ä¢ ¬øHay integraciones con otros sistemas?
‚Ä¢ ¬øTienes preferencias de tecnolog√≠a?
‚Ä¢ ¬øCu√°l es el plazo estimado?
‚Ä¢ ¬øHay alg√∫n requerimiento especial?

Ejemplo: 'Necesito una plataforma web para gestionar inventarios de mi tienda. Debe permitir registrar productos, controlar stock, generar reportes de ventas, y tener un m√≥dulo para proveedores. Me gustar√≠a que se integre con mi sistema de facturaci√≥n actual...'">{{ client_request|default:'' }}</textarea>
                        <div class="character-count">
                            <span id="client_request_count">{{ client_request|length|default:0 }}</span>/3000 caracteres
                            <span id="minimum_warning" class="text-warning ms-2" style="display: none;">
                                (M√≠nimo 50 caracteres)
                            </span>
                        </div>
                        <div class="form-text">
                            <small class="text-muted">
                                <i class="bi bi-lightbulb"></i>
                                <strong>Tip:</strong> Mientras m√°s detalles proporciones, m√°s precisa ser√° tu cotizaci√≥n.
                            </small>
                        </div>
                    </div>

                    <!-- Bot√≥n de env√≠o -->
                    <div class="text-center">
                        <button type="submit" class="btn btn-primary btn-submit" id="submitBtn">
                            <i class="bi bi-send"></i>
                            Generar Mi Cotizaci√≥n
                        </button>
                        <div class="mt-3">
                            <small class="text-muted">
                                <i class="bi bi-shield-check"></i>
                                Tu informaci√≥n es confidencial y solo ser√° usada para generar la cotizaci√≥n.
                            </small>
                        </div>
                    </div>
                </form>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    const textarea = document.getElementById('client_request');
    const counter = document.getElementById('client_request_count');
    const warning = document.getElementById('minimum_warning');
    const submitBtn = document.getElementById('submitBtn');
    const form = document.getElementById('requestForm');
    
    // Actualizar contador de caracteres
    function updateCharacterCount() {
        const currentLength = textarea.value.length;
        counter.textContent = currentLength;
        
        // Mostrar advertencia si es menos de 50 caracteres
        if (currentLength < 50) {
            warning.style.display = 'inline';
            counter.style.color = '#ffc107';
        } else {
            warning.style.display = 'none';
            counter.style.color = '#6c757d';
        }
        
        // Cambiar color seg√∫n proximidad al l√≠mite
        if (currentLength > 2700) {
            counter.style.color = '#dc3545'; // Rojo
        } else if (currentLength > 2400) {
            counter.style.color = '#ffc107'; // Amarillo
        }
    }
    
    textarea.addEventListener('input', updateCharacterCount);
    updateCharacterCount(); // Actualizar al cargar
    
    // Auto-resize textarea
    function autoResize() {
        textarea.style.height = 'auto';
        textarea.style.height = textarea.scrollHeight + 'px';
    }
    
    textarea.addEventListener('input', autoResize);
    autoResize(); // Ajustar tama√±o inicial
    
    // Validaci√≥n antes de enviar
    form.addEventListener('submit', function(e) {
        e.preventDefault(); // Prevenir env√≠o normal
        
        const text = textarea.value.trim();
        
        if (text.length < 50) {
            alert('‚ö†Ô∏è Por favor, proporciona m√°s detalles sobre tu proyecto.\n\nPara generar una cotizaci√≥n precisa, necesitamos al menos 50 caracteres describiendo lo que necesitas.');
            textarea.focus();
            return;
        }
        
        // Deshabilitar bot√≥n para evitar doble env√≠o
        submitBtn.disabled = true;
        submitBtn.innerHTML = '<span class="spinner-border spinner-border-sm me-2"></span>Generando cotizaci√≥n...';
        
        // Crear overlay de carga
        showLoadingOverlay();
        
        // Enviar via AJAX
        const formData = new FormData(form);
        
        fetch(form.action, {
            method: 'POST',
            headers: {
                'X-Requested-With': 'XMLHttpRequest'
            },
            body: formData
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                // Mostrar √©xito y redirigir
                showSuccessAndRedirect(data.quote_url, data);
            } else {
                // Mostrar error
                hideLoadingOverlay();
                submitBtn.disabled = false;
                submitBtn.innerHTML = '<i class="bi bi-send"></i> Generar Mi Cotizaci√≥n';
                alert('‚ùå ' + (data.error || 'Hubo un error al generar la cotizaci√≥n'));
            }
        })
        .catch(error => {
            console.error('Error:', error);
            hideLoadingOverlay();
            submitBtn.disabled = false;
            submitBtn.innerHTML = '<i class="bi bi-send"></i> Generar Mi Cotizaci√≥n';
            alert('‚ùå Error de conexi√≥n. Por favor, int√©ntalo de nuevo.');
        });
    });
    
    function showLoadingOverlay() {
        const overlay = document.createElement('div');
        overlay.id = 'loadingOverlay';
        overlay.innerHTML = `
            <div style="position: fixed; top: 0; left: 0; width: 100%; height: 100%; 
                        background: rgba(0,0,0,0.8); z-index: 9999; 
                        display: flex; align-items: center; justify-content: center;">
                <div style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); 
                           border-radius: 20px; color: white; padding: 3rem; text-align: center; 
                           max-width: 500px; margin: 1rem;">
                    <div style="font-size: 3rem; margin-bottom: 1rem;">ü§ñ</div>
                    <h3>Generando tu Cotizaci√≥n con IA</h3>
                    <p>Analizando tu proyecto y calculando estimaciones...</p>
                    <div style="width: 50px; height: 50px; border: 5px solid rgba(255,255,255,0.3); 
                               border-top: 5px solid white; border-radius: 50%; 
                               animation: spin 1s linear infinite; margin: 2rem auto;"></div>
                    <small style="opacity: 0.8;">Esto puede tardar 10-30 segundos</small>
                </div>
            </div>
            <style>
                @keyframes spin {
                    0% { transform: rotate(0deg); }
                    100% { transform: rotate(360deg); }
                }
            </style>
        `;
        document.body.appendChild(overlay);
    }
    
    function hideLoadingOverlay() {
        const overlay = document.getElementById('loadingOverlay');
        if (overlay) {
            overlay.remove();
        }
    }
    
    function showSuccessAndRedirect(url, data) {
        const overlay = document.getElementById('loadingOverlay');
        if (overlay) {
            overlay.innerHTML = `
                <div style="position: fixed; top: 0; left: 0; width: 100%; height: 100%; 
                            background: rgba(0,0,0,0.8); z-index: 9999; 
                            display: flex; align-items: center; justify-content: center;">
                    <div style="background: linear-gradient(135deg, #28a745 0%, #20c997 100%); 
                               border-radius: 20px; color: white; padding: 3rem; text-align: center; 
                               max-width: 500px; margin: 1rem;">
                        <div style="font-size: 3rem; margin-bottom: 1rem;">‚úÖ</div>
                        <h3>¬°Cotizaci√≥n Generada!</h3>
                        <p><strong>${data.estimated_hours} horas</strong> estimadas</p>
                        <p>Costo total: <strong>${data.estimated_cost}</strong></p>
                        <div style="margin: 2rem 0;">
                            <div class="spinner-border" role="status">
                                <span class="visually-hidden">Cargando...</span>
                            </div>
                        </div>
                        <small>Redirigiendo a tu cotizaci√≥n...</small>
                    </div>
                </div>
            `;
            
            setTimeout(() => {
                window.location.href = url;
            }, 2000);
        }
    }
});
</script>
{% endblock %}