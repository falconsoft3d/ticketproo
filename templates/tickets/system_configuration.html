{% extends 'base.html' %}
{% load static %}
{% load markdown_tags %}

{% block title %}{{ page_title }}{% endblock %}

{% block extra_css %}
<style>
    .config-section {
        background: #f8f9fa;
        border-left: 4px solid #007bff;
        padding: 1.5rem;
        margin-bottom: 1.5rem;
        border-radius: 0.375rem;
    }
    
    .config-section h5 {
        color: #007bff;
        font-weight: 600;
        margin-bottom: 1rem;
    }
    
    .form-check {
        margin-bottom: 1rem;
    }
    
    .form-check-label {
        font-weight: 500;
    }
    
    .config-icon {
        color: #007bff;
        margin-right: 0.5rem;
    }
    
    /* Estilos para la documentación API */
    #api-documentation-content {
        font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
        line-height: 1.6;
        color: #333;
    }
    
    #api-documentation-content code {
        background-color: #f5f5f5;
        padding: 2px 6px;
        border-radius: 3px;
        font-family: 'Courier New', Courier, monospace;
        font-size: 0.9em;
        color: #d63384;
    }
    
    #api-documentation-content pre {
        background-color: #282c34;
        color: #abb2bf;
        padding: 1rem;
        border-radius: 5px;
        overflow-x: auto;
        margin: 1rem 0;
    }
    
    #api-documentation-content pre code {
        background-color: transparent;
        color: #abb2bf;
        padding: 0;
    }
    
    #api-documentation-content h1 {
        color: #0d6efd;
        border-bottom: 2px solid #0d6efd;
        padding-bottom: 0.5rem;
        margin-top: 2rem;
        margin-bottom: 1rem;
    }
    
    #api-documentation-content h2 {
        color: #198754;
        margin-top: 2rem;
        margin-bottom: 1rem;
        border-bottom: 1px solid #dee2e6;
        padding-bottom: 0.5rem;
    }
    
    #api-documentation-content h3 {
        color: #0dcaf0;
        margin-top: 1.5rem;
        margin-bottom: 0.75rem;
    }
    
    #api-documentation-content ul, 
    #api-documentation-content ol {
        margin-left: 1.5rem;
        margin-bottom: 1rem;
    }
    
    #api-documentation-content li {
        margin-bottom: 0.5rem;
    }
    
    #api-documentation-content table {
        width: 100%;
        margin-bottom: 1rem;
        border-collapse: collapse;
    }
    
    #api-documentation-content table th,
    #api-documentation-content table td {
        border: 1px solid #dee2e6;
        padding: 0.75rem;
        text-align: left;
    }
    
    #api-documentation-content table th {
        background-color: #f8f9fa;
        font-weight: 600;
    }
    
    #api-documentation-content blockquote {
        border-left: 4px solid #0d6efd;
        padding-left: 1rem;
        margin-left: 0;
        color: #6c757d;
        font-style: italic;
    }
    
    .markdown-content hr {
        border: 0;
        border-top: 2px solid #dee2e6;
        margin: 2rem 0;
    }
</style>
{% endblock %}

{% block content %}
<div class="container-fluid">
    <div class="row">
        <div class="col-12">
            <!-- Header -->
            <div class="d-flex justify-content-between align-items-center mb-4">
                <div>
                    <h1 class="h3 mb-0">
                        <i class="bi bi-gear-fill config-icon"></i>
                        {{ page_title }}
                    </h1>
                    <p class="text-muted mb-0">
                        Configura los parámetros generales del sistema y consulta la documentación de la API
                    </p>
                </div>
                <div>
                    <a href="{% url 'dashboard' %}" class="btn btn-secondary">
                        <i class="bi bi-arrow-left me-1"></i>
                        Volver al Dashboard
                    </a>
                </div>
            </div>

            <!-- Tabs de navegación -->
            <ul class="nav nav-tabs mb-4" id="configTabs" role="tablist">
                <li class="nav-item" role="presentation">
                    <button class="nav-link active" id="config-tab" data-bs-toggle="tab" data-bs-target="#config-panel" type="button" role="tab">
                        <i class="bi bi-gear me-1"></i>
                        Configuración
                    </button>
                </li>
                <li class="nav-item" role="presentation">
                    <button class="nav-link" id="api-doc-tab" data-bs-toggle="tab" data-bs-target="#api-doc-panel" type="button" role="tab">
                        <i class="bi bi-code-slash me-1"></i>
                        Documentación API REST
                    </button>
                </li>
                <li class="nav-item" role="presentation">
                    <button class="nav-link" id="api-test-tab" data-bs-toggle="tab" data-bs-target="#api-test-panel" type="button" role="tab">
                        <i class="bi bi-play-circle me-1"></i>
                        Probar API
                    </button>
                </li>
            </ul>

            <!-- Contenido de los tabs -->
            <div class="tab-content" id="configTabsContent">
                <!-- Tab de Configuración -->
                <div class="tab-pane fade show active" id="config-panel" role="tabpanel">
                    <!-- Formulario de configuración -->
                    <div class="row">
                <div class="col-lg-8 col-xl-6">
                    <form method="post" class="needs-validation" novalidate>
                        {% csrf_token %}
                        
                        <!-- Configuración General -->
                        <div class="config-section">
                            <h5>
                                <i class="bi bi-info-circle me-2"></i>
                                Configuración General
                            </h5>
                            
                            <div class="mb-3">
                                <label for="{{ form.site_name.id_for_label }}" class="form-label">
                                    <i class="bi bi-house-door me-1"></i>
                                    {{ form.site_name.label }}
                                </label>
                                {{ form.site_name }}
                                {% if form.site_name.help_text %}
                                    <small class="form-text text-muted">{{ form.site_name.help_text }}</small>
                                {% endif %}
                                {% if form.site_name.errors %}
                                    <div class="text-danger mt-1">
                                        {% for error in form.site_name.errors %}
                                            <small>{{ error }}</small>
                                        {% endfor %}
                                    </div>
                                {% endif %}
                            </div>
                        </div>

                        <!-- Configuración de Usuarios -->
                        <div class="config-section">
                            <h5>
                                <i class="bi bi-people me-2"></i>
                                Configuración de Usuarios
                            </h5>
                            
                            <div class="form-check">
                                {{ form.allow_user_registration }}
                                <label class="form-check-label" for="{{ form.allow_user_registration.id_for_label }}">
                                    <i class="bi bi-person-plus me-1"></i>
                                    {{ form.allow_user_registration.label }}
                                </label>
                                {% if form.allow_user_registration.help_text %}
                                    <div class="form-text">{{ form.allow_user_registration.help_text }}</div>
                                {% endif %}
                                {% if form.allow_user_registration.errors %}
                                    <div class="text-danger mt-1">
                                        {% for error in form.allow_user_registration.errors %}
                                            <small>{{ error }}</small>
                                        {% endfor %}
                                    </div>
                                {% endif %}
                            </div>
                        </div>

                        <!-- Configuración de Tickets -->
                        <div class="config-section">
                            <h5>
                                <i class="bi bi-ticket-perforated me-2"></i>
                                Configuración de Tickets
                            </h5>
                            
                            <div class="mb-3">
                                <label for="{{ form.default_ticket_priority.id_for_label }}" class="form-label">
                                    <i class="bi bi-flag me-1"></i>
                                    {{ form.default_ticket_priority.label }}
                                </label>
                                {{ form.default_ticket_priority }}
                                {% if form.default_ticket_priority.help_text %}
                                    <small class="form-text text-muted">{{ form.default_ticket_priority.help_text }}</small>
                                {% endif %}
                                {% if form.default_ticket_priority.errors %}
                                    <div class="text-danger mt-1">
                                        {% for error in form.default_ticket_priority.errors %}
                                            <small>{{ error }}</small>
                                        {% endfor %}
                                    </div>
                                {% endif %}
                            </div>
                        </div>

                        <!-- Configuración Financiera -->
                        <div class="config-section">
                            <h5>
                                <i class="bi bi-currency-exchange me-2"></i>
                                Configuración Financiera
                            </h5>
                            
                            <div class="mb-3">
                                <label for="{{ form.default_currency.id_for_label }}" class="form-label">
                                    <i class="bi bi-cash me-1"></i>
                                    {{ form.default_currency.label }}
                                </label>
                                {{ form.default_currency }}
                                {% if form.default_currency.help_text %}
                                    <small class="form-text text-muted">{{ form.default_currency.help_text }}</small>
                                {% endif %}
                                {% if form.default_currency.errors %}
                                    <div class="text-danger mt-1">
                                        {% for error in form.default_currency.errors %}
                                            <small>{{ error }}</small>
                                        {% endfor %}
                                    </div>
                                {% endif %}
                            </div>
                        </div>

                        <!-- Configuración de Inteligencia Artificial -->
                        <div class="config-section">
                            <h5>
                                <i class="bi bi-robot me-2"></i>
                                Configuración de IA
                            </h5>
                            
                            <div class="form-check mb-3">
                                {{ form.ai_chat_enabled }}
                                <label class="form-check-label" for="{{ form.ai_chat_enabled.id_for_label }}">
                                    <i class="bi bi-chat-dots me-1"></i>
                                    {{ form.ai_chat_enabled.label }}
                                </label>
                                {% if form.ai_chat_enabled.help_text %}
                                    <div class="form-text">{{ form.ai_chat_enabled.help_text }}</div>
                                {% endif %}
                                {% if form.ai_chat_enabled.errors %}
                                    <div class="text-danger mt-1">
                                        {% for error in form.ai_chat_enabled.errors %}
                                            <small>{{ error }}</small>
                                        {% endfor %}
                                    </div>
                                {% endif %}
                            </div>

                            <div id="ai-config-fields" style="{% if not config.ai_chat_enabled %}display: none;{% endif %}">
                                <div class="mb-3">
                                    <label for="{{ form.openai_api_key.id_for_label }}" class="form-label">
                                        <i class="bi bi-key me-1"></i>
                                        {{ form.openai_api_key.label }}
                                    </label>
                                    {{ form.openai_api_key }}
                                    {% if form.openai_api_key.help_text %}
                                        <small class="form-text text-muted">{{ form.openai_api_key.help_text }}</small>
                                    {% endif %}
                                    {% if form.openai_api_key.errors %}
                                        <div class="text-danger mt-1">
                                            {% for error in form.openai_api_key.errors %}
                                                <small>{{ error }}</small>
                                            {% endfor %}
                                        </div>
                                    {% endif %}
                                </div>

                                <div class="mb-3">
                                    <label for="{{ form.openai_model.id_for_label }}" class="form-label">
                                        <i class="bi bi-cpu me-1"></i>
                                        {{ form.openai_model.label }}
                                    </label>
                                    {{ form.openai_model }}
                                    {% if form.openai_model.help_text %}
                                        <small class="form-text text-muted">{{ form.openai_model.help_text }}</small>
                                    {% endif %}
                                    {% if form.openai_model.errors %}
                                        <div class="text-danger mt-1">
                                            {% for error in form.openai_model.errors %}
                                                <small>{{ error }}</small>
                                            {% endfor %}
                                        </div>
                                    {% endif %}
                                </div>
                            </div>

                            <!-- Prompt para análisis de empleados -->
                            <div class="col-md-12">
                                <div class="mb-3">
                                    <label for="{{ form.ai_employee_analysis_prompt.id_for_label }}" class="form-label">
                                        <i class="bi bi-chat-text me-1"></i>
                                        {{ form.ai_employee_analysis_prompt.label }}
                                    </label>
                                    {{ form.ai_employee_analysis_prompt }}
                                    {% if form.ai_employee_analysis_prompt.help_text %}
                                        <small class="form-text text-muted">{{ form.ai_employee_analysis_prompt.help_text }}</small>
                                    {% endif %}
                                    {% if form.ai_employee_analysis_prompt.errors %}
                                        <div class="text-danger mt-1">
                                            {% for error in form.ai_employee_analysis_prompt.errors %}
                                                <small>{{ error }}</small>
                                            {% endfor %}
                                        </div>
                                    {% endif %}
                                </div>
                            </div>

                            <div class="alert alert-info">
                                <i class="bi bi-info-circle me-2"></i>
                                <strong>Información:</strong> Para habilitar el chat con IA, necesitas configurar una API key válida de OpenAI. 
                                Puedes obtenerla en <a href="https://platform.openai.com/api-keys" target="_blank" class="alert-link">platform.openai.com</a>.
                            </div>
                        </div>

                        <!-- Configuración de PayPal -->
                        <div class="config-section">
                            <h5>
                                <i class="bi bi-paypal me-2"></i>
                                Configuración de PayPal
                            </h5>
                            
                            <div class="form-check mb-3">
                                {{ form.paypal_enabled }}
                                <label class="form-check-label" for="{{ form.paypal_enabled.id_for_label }}">
                                    <i class="bi bi-credit-card me-1"></i>
                                    {{ form.paypal_enabled.label }}
                                </label>
                                {% if form.paypal_enabled.help_text %}
                                    <div class="form-text">{{ form.paypal_enabled.help_text }}</div>
                                {% endif %}
                                {% if form.paypal_enabled.errors %}
                                    <div class="text-danger mt-1">
                                        {% for error in form.paypal_enabled.errors %}
                                            <small>{{ error }}</small>
                                        {% endfor %}
                                    </div>
                                {% endif %}
                            </div>

                            <div id="paypal-config-fields" style="{% if not config.paypal_enabled %}display: none;{% endif %}">
                                <div class="mb-3">
                                    <label for="{{ form.paypal_mode.id_for_label }}" class="form-label">
                                        <i class="bi bi-toggles me-1"></i>
                                        {{ form.paypal_mode.label }}
                                    </label>
                                    {{ form.paypal_mode }}
                                    {% if form.paypal_mode.help_text %}
                                        <small class="form-text text-muted">{{ form.paypal_mode.help_text }}</small>
                                    {% endif %}
                                    {% if form.paypal_mode.errors %}
                                        <div class="text-danger mt-1">
                                            {% for error in form.paypal_mode.errors %}
                                                <small>{{ error }}</small>
                                            {% endfor %}
                                        </div>
                                    {% endif %}
                                </div>

                                <div class="mb-3">
                                    <label for="{{ form.paypal_client_id.id_for_label }}" class="form-label">
                                        <i class="bi bi-key me-1"></i>
                                        {{ form.paypal_client_id.label }}
                                    </label>
                                    {{ form.paypal_client_id }}
                                    {% if form.paypal_client_id.help_text %}
                                        <small class="form-text text-muted">{{ form.paypal_client_id.help_text }}</small>
                                    {% endif %}
                                    {% if form.paypal_client_id.errors %}
                                        <div class="text-danger mt-1">
                                            {% for error in form.paypal_client_id.errors %}
                                                <small>{{ error }}</small>
                                            {% endfor %}
                                        </div>
                                    {% endif %}
                                </div>

                                <div class="mb-3">
                                    <label for="{{ form.paypal_client_secret.id_for_label }}" class="form-label">
                                        <i class="bi bi-shield-lock me-1"></i>
                                        {{ form.paypal_client_secret.label }}
                                    </label>
                                    {{ form.paypal_client_secret }}
                                    {% if form.paypal_client_secret.help_text %}
                                        <small class="form-text text-muted">{{ form.paypal_client_secret.help_text }}</small>
                                    {% endif %}
                                    {% if form.paypal_client_secret.errors %}
                                        <div class="text-danger mt-1">
                                            {% for error in form.paypal_client_secret.errors %}
                                                <small>{{ error }}</small>
                                            {% endfor %}
                                        </div>
                                    {% endif %}
                                </div>

                                <div class="mb-3">
                                    <label for="{{ form.paypal_webhook_id.id_for_label }}" class="form-label">
                                        <i class="bi bi-webhook me-1"></i>
                                        {{ form.paypal_webhook_id.label }}
                                        <span class="badge bg-secondary">Opcional</span>
                                    </label>
                                    {{ form.paypal_webhook_id }}
                                    {% if form.paypal_webhook_id.help_text %}
                                        <small class="form-text text-muted">{{ form.paypal_webhook_id.help_text }}</small>
                                    {% endif %}
                                    {% if form.paypal_webhook_id.errors %}
                                        <div class="text-danger mt-1">
                                            {% for error in form.paypal_webhook_id.errors %}
                                                <small>{{ error }}</small>
                                            {% endfor %}
                                        </div>
                                    {% endif %}
                                </div>
                            </div>

                            <div class="alert alert-info">
                                <i class="bi bi-info-circle me-2"></i>
                                <strong>Información:</strong> Para habilitar los pagos con PayPal, necesitas crear una aplicación en 
                                <a href="https://developer.paypal.com" target="_blank" class="alert-link">PayPal Developer</a>.
                                <br><br>
                                <strong>Pasos rápidos:</strong>
                                <ol class="mb-0 mt-2">
                                    <li>Ve a <a href="https://developer.paypal.com/dashboard/applications/sandbox" target="_blank" class="alert-link">PayPal Developer Dashboard</a></li>
                                    <li>Crea una nueva App (o usa una existente)</li>
                                    <li>Copia el <strong>Client ID</strong> y <strong>Secret</strong></li>
                                    <li>Pégalos en los campos de arriba</li>
                                    <li>Usa modo <strong>"sandbox"</strong> para pruebas y <strong>"live"</strong> para producción</li>
                                </ol>
                                <br>
                                <a href="/GUIA_PAYPAL.md" target="_blank" class="alert-link">
                                    <i class="bi bi-book me-1"></i>Ver guía completa de configuración
                                </a>
                            </div>
                        </div>

                        <!-- Configuración de Telegram -->
                        <div class="config-section">
                            <h5>
                                <i class="bi bi-telegram me-2"></i>
                                Configuración de Telegram
                            </h5>
                            
                            <div class="form-check mb-3">
                                {{ form.enable_telegram_notifications }}
                                <label class="form-check-label" for="{{ form.enable_telegram_notifications.id_for_label }}">
                                    <i class="bi bi-bell me-1"></i>
                                    {{ form.enable_telegram_notifications.label }}
                                </label>
                                {% if form.enable_telegram_notifications.help_text %}
                                    <div class="form-text">{{ form.enable_telegram_notifications.help_text }}</div>
                                {% endif %}
                                {% if form.enable_telegram_notifications.errors %}
                                    <div class="text-danger mt-1">
                                        {% for error in form.enable_telegram_notifications.errors %}
                                            <small>{{ error }}</small>
                                        {% endfor %}
                                    </div>
                                {% endif %}
                            </div>

                            <div id="telegram-config-fields" style="{% if not config.enable_telegram_notifications %}display: none;{% endif %}">
                                <div class="mb-3">
                                    <label for="{{ form.telegram_bot_token.id_for_label }}" class="form-label">
                                        <i class="bi bi-robot me-1"></i>
                                        {{ form.telegram_bot_token.label }}
                                    </label>
                                    {{ form.telegram_bot_token }}
                                    {% if form.telegram_bot_token.help_text %}
                                        <small class="form-text text-muted">{{ form.telegram_bot_token.help_text }}</small>
                                    {% endif %}
                                    {% if form.telegram_bot_token.errors %}
                                        <div class="text-danger mt-1">
                                            {% for error in form.telegram_bot_token.errors %}
                                                <small>{{ error }}</small>
                                            {% endfor %}
                                        </div>
                                    {% endif %}
                                </div>

                                <div class="mb-3">
                                    <label for="{{ form.telegram_chat_id.id_for_label }}" class="form-label">
                                        <i class="bi bi-chat-square-text me-1"></i>
                                        {{ form.telegram_chat_id.label }}
                                    </label>
                                    {{ form.telegram_chat_id }}
                                    {% if form.telegram_chat_id.help_text %}
                                        <small class="form-text text-muted">{{ form.telegram_chat_id.help_text }}</small>
                                    {% endif %}
                                    {% if form.telegram_chat_id.errors %}
                                        <div class="text-danger mt-1">
                                            {% for error in form.telegram_chat_id.errors %}
                                                <small>{{ error }}</small>
                                            {% endfor %}
                                        </div>
                                    {% endif %}
                                </div>

                                <!-- Botón de prueba -->
                                <div class="d-flex gap-2 mb-3">
                                    <button type="button" class="btn btn-outline-info btn-sm" id="test-telegram-btn">
                                        <i class="bi bi-lightning me-1"></i>
                                        Probar Conexión
                                    </button>
                                </div>
                            </div>

                            <div class="alert alert-info">
                                <i class="bi bi-info-circle me-2"></i>
                                <strong>Cómo configurar Telegram:</strong>
                                <ol class="mt-2 mb-0">
                                    <li>Crea un bot en Telegram hablando con <a href="https://t.me/BotFather" target="_blank" class="alert-link">@BotFather</a></li>
                                    <li>Usa el comando <code>/newbot</code> y sigue las instrucciones</li>
                                    <li>Copia el token del bot y pégalo arriba</li>
                                    <li>Agrega el bot a tu grupo y hazlo administrador</li>
                                    <li>Obtén el ID del grupo usando <a href="https://t.me/getidsbot" target="_blank" class="alert-link">@getidsbot</a></li>
                                </ol>
                            </div>
                        </div>

                        <!-- Configuración de Email -->
                        <div class="config-section">
                            <h5>
                                <i class="bi bi-envelope me-2"></i>
                                Notificaciones por Email
                            </h5>
                            
                            <div class="form-check mb-3">
                                {{ form.enable_email_notifications }}
                                <label class="form-check-label" for="{{ form.enable_email_notifications.id_for_label }}">
                                    <i class="bi bi-bell me-1"></i>
                                    {{ form.enable_email_notifications.label }}
                                </label>
                                {% if form.enable_email_notifications.help_text %}
                                    <div class="form-text">{{ form.enable_email_notifications.help_text }}</div>
                                {% endif %}
                                {% if form.enable_email_notifications.errors %}
                                    <div class="text-danger mt-1">
                                        {% for error in form.enable_email_notifications.errors %}
                                            <small>{{ error }}</small>
                                        {% endfor %}
                                    </div>
                                {% endif %}
                            </div>

                            <div id="email-config-fields" style="{% if not config.enable_email_notifications %}display: none;{% endif %}">
                                <div class="mb-3">
                                    <label for="{{ form.notification_emails.id_for_label }}" class="form-label">
                                        <i class="bi bi-people me-1"></i>
                                        {{ form.notification_emails.label }}
                                    </label>
                                    {{ form.notification_emails }}
                                    {% if form.notification_emails.help_text %}
                                        <small class="form-text text-muted">{{ form.notification_emails.help_text }}</small>
                                    {% endif %}
                                    {% if form.notification_emails.errors %}
                                        <div class="text-danger mt-1">
                                            {% for error in form.notification_emails.errors %}
                                                <small>{{ error }}</small>
                                            {% endfor %}
                                        </div>
                                    {% endif %}
                                </div>

                                <div class="row">
                                    <div class="col-md-8">
                                        <div class="mb-3">
                                            <label for="{{ form.email_host.id_for_label }}" class="form-label">
                                                <i class="bi bi-server me-1"></i>
                                                {{ form.email_host.label }}
                                            </label>
                                            {{ form.email_host }}
                                            {% if form.email_host.help_text %}
                                                <small class="form-text text-muted">{{ form.email_host.help_text }}</small>
                                            {% endif %}
                                            {% if form.email_host.errors %}
                                                <div class="text-danger mt-1">
                                                    {% for error in form.email_host.errors %}
                                                        <small>{{ error }}</small>
                                                    {% endfor %}
                                                </div>
                                            {% endif %}
                                        </div>
                                    </div>
                                    <div class="col-md-4">
                                        <div class="mb-3">
                                            <label for="{{ form.email_port.id_for_label }}" class="form-label">
                                                <i class="bi bi-router me-1"></i>
                                                {{ form.email_port.label }}
                                            </label>
                                            {{ form.email_port }}
                                            {% if form.email_port.help_text %}
                                                <small class="form-text text-muted">{{ form.email_port.help_text }}</small>
                                            {% endif %}
                                            {% if form.email_port.errors %}
                                                <div class="text-danger mt-1">
                                                    {% for error in form.email_port.errors %}
                                                        <small>{{ error }}</small>
                                                    {% endfor %}
                                                </div>
                                            {% endif %}
                                        </div>
                                    </div>
                                </div>

                                <div class="mb-3">
                                    <label for="{{ form.email_host_user.id_for_label }}" class="form-label">
                                        <i class="bi bi-person me-1"></i>
                                        {{ form.email_host_user.label }}
                                    </label>
                                    {{ form.email_host_user }}
                                    {% if form.email_host_user.help_text %}
                                        <small class="form-text text-muted">{{ form.email_host_user.help_text }}</small>
                                    {% endif %}
                                    {% if form.email_host_user.errors %}
                                        <div class="text-danger mt-1">
                                            {% for error in form.email_host_user.errors %}
                                                <small>{{ error }}</small>
                                            {% endfor %}
                                        </div>
                                    {% endif %}
                                </div>

                                <div class="mb-3">
                                    <label for="{{ form.email_host_password.id_for_label }}" class="form-label">
                                        <i class="bi bi-key me-1"></i>
                                        {{ form.email_host_password.label }}
                                    </label>
                                    {{ form.email_host_password }}
                                    {% if form.email_host_password.help_text %}
                                        <small class="form-text text-muted">{{ form.email_host_password.help_text }}</small>
                                    {% endif %}
                                    {% if form.email_host_password.errors %}
                                        <div class="text-danger mt-1">
                                            {% for error in form.email_host_password.errors %}
                                                <small>{{ error }}</small>
                                            {% endfor %}
                                        </div>
                                    {% endif %}
                                </div>

                                <div class="mb-3">
                                    <label for="{{ form.email_from.id_for_label }}" class="form-label">
                                        <i class="bi bi-envelope-at me-1"></i>
                                        {{ form.email_from.label }}
                                    </label>
                                    {{ form.email_from }}
                                    {% if form.email_from.help_text %}
                                        <small class="form-text text-muted">{{ form.email_from.help_text }}</small>
                                    {% endif %}
                                    {% if form.email_from.errors %}
                                        <div class="text-danger mt-1">
                                            {% for error in form.email_from.errors %}
                                                <small>{{ error }}</small>
                                            {% endfor %}
                                        </div>
                                    {% endif %}
                                </div>

                                <div class="row">
                                    <div class="col-md-6">
                                        <div class="form-check mb-3">
                                            {{ form.email_use_tls }}
                                            <label class="form-check-label" for="{{ form.email_use_tls.id_for_label }}">
                                                <i class="bi bi-shield-lock me-1"></i>
                                                {{ form.email_use_tls.label }}
                                            </label>
                                            {% if form.email_use_tls.help_text %}
                                                <div class="form-text">{{ form.email_use_tls.help_text }}</div>
                                            {% endif %}
                                        </div>
                                    </div>
                                    <div class="col-md-6">
                                        <div class="form-check mb-3">
                                            {{ form.email_use_ssl }}
                                            <label class="form-check-label" for="{{ form.email_use_ssl.id_for_label }}">
                                                <i class="bi bi-shield-check me-1"></i>
                                                {{ form.email_use_ssl.label }}
                                            </label>
                                            {% if form.email_use_ssl.help_text %}
                                                <div class="form-text">{{ form.email_use_ssl.help_text }}</div>
                                            {% endif %}
                                        </div>
                                    </div>
                                </div>

                                <!-- Botón de prueba de email -->
                                <div class="d-flex gap-2 mb-3">
                                    <button type="button" class="btn btn-outline-info btn-sm" id="test-email-btn">
                                        <i class="bi bi-lightning me-1"></i>
                                        Probar Email
                                    </button>
                                </div>
                            </div>

                            <div class="alert alert-info">
                                <i class="bi bi-info-circle me-2"></i>
                                <strong>Configuración recomendada para Gmail:</strong>
                                <ul class="mt-2 mb-0">
                                    <li><strong>Servidor SMTP:</strong> smtp.gmail.com</li>
                                    <li><strong>Puerto:</strong> 587</li>
                                    <li><strong>TLS:</strong> Activado</li>
                                    <li><strong>Contraseña:</strong> Usar contraseña de aplicación (no la contraseña normal)</li>
                                </ul>
                                <div class="mt-2">
                                    <small>
                                        Para crear una contraseña de aplicación: 
                                        <a href="https://support.google.com/accounts/answer/185833" target="_blank" class="alert-link">
                                            Guía de Google
                                        </a>
                                    </small>
                                </div>
                            </div>
                        </div>

                        <!-- Botones -->
                        <div class="d-flex gap-2 mt-4">
                            <button type="submit" class="btn btn-primary">
                                <i class="bi bi-check-lg me-1"></i>
                                Guardar Configuración
                            </button>
                            <a href="{% url 'dashboard' %}" class="btn btn-secondary">
                                <i class="bi bi-x-lg me-1"></i>
                                Cancelar
                            </a>
                        </div>
                    </form>
                </div>
                
                <!-- Panel de información -->
                <div class="col-lg-4 col-xl-6">
                    <div class="card">
                        <div class="card-header">
                            <h6 class="card-title mb-0">
                                <i class="bi bi-info-circle me-1"></i>
                                Información del Sistema
                            </h6>
                        </div>
                        <div class="card-body">
                            <dl class="row mb-0">
                                <dt class="col-6">Nombre actual:</dt>
                                <dd class="col-6">{{ config.site_name }}</dd>
                                
                                <dt class="col-6">Registro de usuarios:</dt>
                                <dd class="col-6">
                                    {% if config.allow_user_registration %}
                                        <span class="badge bg-success">Habilitado</span>
                                    {% else %}
                                        <span class="badge bg-danger">Deshabilitado</span>
                                    {% endif %}
                                </dd>
                                
                                <dt class="col-6">Prioridad por defecto:</dt>
                                <dd class="col-6">
                                    <span class="badge bg-info">{{ config.get_default_ticket_priority_display }}</span>
                                </dd>
                                
                                <dt class="col-6">Moneda por defecto:</dt>
                                <dd class="col-6">
                                    <span class="badge bg-success">{{ config.get_default_currency_display }}</span>
                                </dd>

                                <dt class="col-6">Chat IA:</dt>
                                <dd class="col-6">
                                    {% if config.ai_chat_enabled %}
                                        <span class="badge bg-success">
                                            <i class="bi bi-check-circle me-1"></i>Habilitado
                                        </span>
                                    {% else %}
                                        <span class="badge bg-secondary">
                                            <i class="bi bi-x-circle me-1"></i>Deshabilitado
                                        </span>
                                    {% endif %}
                                </dd>

                                {% if config.ai_chat_enabled and config.openai_model %}
                                <dt class="col-6">Modelo IA:</dt>
                                <dd class="col-6">
                                    <span class="badge bg-primary">{{ config.openai_model }}</span>
                                </dd>
                                {% endif %}

                                <dt class="col-6">Notificaciones Telegram:</dt>
                                <dd class="col-6">
                                    {% if config.enable_telegram_notifications %}
                                        <span class="badge bg-success">
                                            <i class="bi bi-check-circle me-1"></i>Habilitado
                                        </span>
                                    {% else %}
                                        <span class="badge bg-secondary">
                                            <i class="bi bi-x-circle me-1"></i>Deshabilitado
                                        </span>
                                    {% endif %}
                                </dd>

                                <dt class="col-6">Notificaciones Email:</dt>
                                <dd class="col-6">
                                    {% if config.enable_email_notifications %}
                                        <span class="badge bg-success">
                                            <i class="bi bi-check-circle me-1"></i>Habilitado
                                        </span>
                                    {% else %}
                                        <span class="badge bg-secondary">
                                            <i class="bi bi-x-circle me-1"></i>Deshabilitado
                                        </span>
                                    {% endif %}
                                </dd>
                                
                                <dt class="col-6">Última actualización:</dt>
                                <dd class="col-6">{{ config.updated_at|date:"d/m/Y H:i" }}</dd>
                            </dl>
                        </div>
                    </div>
                    
                    <!-- Ayuda -->
                    <div class="card mt-3">
                        <div class="card-header">
                            <h6 class="card-title mb-0">
                                <i class="bi bi-question-circle me-1"></i>
                                Ayuda
                            </h6>
                        </div>
                        <div class="card-body">
                            <ul class="list-unstyled mb-0">
                                <li class="mb-2">
                                    <strong>Permitir registro:</strong> Si está deshabilitado, solo los agentes pueden crear nuevos usuarios.
                                </li>
                                <li class="mb-2">
                                    <strong>Prioridad por defecto:</strong> Prioridad asignada automáticamente a nuevos tickets.
                                </li>
                                <li class="mb-2">
                                    <strong>Chat IA:</strong> Habilita la funcionalidad de chat con inteligencia artificial usando OpenAI.
                                </li>
                                <li class="mb-0">
                                    <strong>API Key:</strong> Clave de acceso a la API de OpenAI necesaria para el funcionamiento del chat.
                                </li>
                            </ul>
                        </div>
                    </div>
                </div>
            </div>
                </div> <!-- Fin tab de configuración -->
                
                <!-- Tab de Documentación API -->
                <div class="tab-pane fade" id="api-doc-panel" role="tabpanel">
                    <div class="card">
                        <div class="card-header bg-primary text-white">
                            <h5 class="card-title mb-0">
                                <i class="bi bi-code-slash me-2"></i>
                                Documentación de la API REST
                            </h5>
                        </div>
                        <div class="card-body">
                            <div class="alert alert-info" role="alert">
                                <i class="bi bi-info-circle me-2"></i>
                                <strong>URL Base:</strong> <code>{{ request.scheme }}://{{ request.get_host }}/api/</code>
                            </div>
                            
                            {% if api_documentation %}
                                <div id="api-documentation-content" class="markdown-content">
                                    <!-- Contenido de la documentación -->
                                    <div style="max-width: 100%; overflow-x: auto;">
                                        {{ api_documentation|markdown_to_html }}
                                    </div>
                                </div>
                            {% else %}
                                <div class="alert alert-warning" role="alert">
                                    <i class="bi bi-exclamation-triangle me-2"></i>
                                    La documentación de la API no está disponible en este momento.
                                </div>
                            {% endif %}
                        </div>
                    </div>
                </div> <!-- Fin tab de documentación API -->
                
                <!-- Tab de Probar API -->
                <div class="tab-pane fade" id="api-test-panel" role="tabpanel">
                    <div class="row">
                        <!-- Panel de prueba -->
                        <div class="col-lg-6">
                            <!-- Login -->
                            <div class="card mb-4">
                                <div class="card-header bg-primary text-white">
                                    <h5 class="card-title mb-0">
                                        <i class="bi bi-key me-2"></i>
                                        1. Autenticación - Obtener Token
                                    </h5>
                                </div>
                                <div class="card-body">
                                    <form id="loginForm">
                                        <div class="mb-3">
                                            <label for="loginUsername" class="form-label">Usuario</label>
                                            <input type="text" class="form-control" id="loginUsername" placeholder="tu_usuario" required>
                                        </div>
                                        <div class="mb-3">
                                            <label for="loginPassword" class="form-label">Contraseña</label>
                                            <input type="password" class="form-control" id="loginPassword" placeholder="tu_contraseña" required>
                                        </div>
                                        <button type="submit" class="btn btn-primary">
                                            <i class="bi bi-box-arrow-in-right me-1"></i>
                                            Obtener Token
                                        </button>
                                    </form>
                                    <div id="tokenResult" class="mt-3" style="display: none;">
                                        <div class="alert alert-success">
                                            <strong>Token obtenido:</strong>
                                            <div class="input-group mt-2">
                                                <input type="text" class="form-control" id="apiToken" readonly>
                                                <button class="btn btn-outline-secondary" type="button" onclick="copyToken()">
                                                    <i class="bi bi-clipboard"></i> Copiar
                                                </button>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <!-- Listar Tickets -->
                            <div class="card mb-4">
                                <div class="card-header bg-success text-white">
                                    <h5 class="card-title mb-0">
                                        <i class="bi bi-list-ul me-2"></i>
                                        2. Listar Tickets
                                    </h5>
                                </div>
                                <div class="card-body">
                                    <div class="mb-3">
                                        <label for="listToken" class="form-label">Token de API</label>
                                        <input type="text" class="form-control" id="listToken" placeholder="Pega aquí tu token">
                                    </div>
                                    <div class="row mb-3">
                                        <div class="col-md-6">
                                            <label for="filterStatus" class="form-label">Filtrar por Estado</label>
                                            <select class="form-select" id="filterStatus">
                                                <option value="">Todos</option>
                                                <option value="open">Abierto</option>
                                                <option value="in_progress">En Progreso</option>
                                                <option value="resolved">Resuelto</option>
                                                <option value="closed">Cerrado</option>
                                            </select>
                                        </div>
                                        <div class="col-md-6">
                                            <label for="filterPriority" class="form-label">Filtrar por Prioridad</label>
                                            <select class="form-select" id="filterPriority">
                                                <option value="">Todas</option>
                                                <option value="low">Baja</option>
                                                <option value="medium">Media</option>
                                                <option value="high">Alta</option>
                                                <option value="urgent">Urgente</option>
                                            </select>
                                        </div>
                                    </div>
                                    <button type="button" class="btn btn-success" onclick="listTickets()">
                                        <i class="bi bi-search me-1"></i>
                                        Listar Tickets
                                    </button>
                                </div>
                            </div>

                            <!-- Crear Ticket -->
                            <div class="card mb-4">
                                <div class="card-header bg-info text-white">
                                    <h5 class="card-title mb-0">
                                        <i class="bi bi-plus-circle me-2"></i>
                                        3. Crear Ticket
                                    </h5>
                                </div>
                                <div class="card-body">
                                    <form id="createTicketForm">
                                        <div class="mb-3">
                                            <label for="createToken" class="form-label">Token de API</label>
                                            <input type="text" class="form-control" id="createToken" placeholder="Pega aquí tu token" required>
                                        </div>
                                        <div class="mb-3">
                                            <label for="ticketTitle" class="form-label">Título</label>
                                            <input type="text" class="form-control" id="ticketTitle" placeholder="Título del ticket" required>
                                        </div>
                                        <div class="mb-3">
                                            <label for="ticketDescription" class="form-label">Descripción</label>
                                            <textarea class="form-control" id="ticketDescription" rows="3" placeholder="Descripción detallada" required></textarea>
                                        </div>
                                        <div class="row mb-3">
                                            <div class="col-md-6">
                                                <label for="ticketPriority" class="form-label">Prioridad</label>
                                                <select class="form-select" id="ticketPriority">
                                                    <option value="low">Baja</option>
                                                    <option value="medium" selected>Media</option>
                                                    <option value="high">Alta</option>
                                                    <option value="urgent">Urgente</option>
                                                </select>
                                            </div>
                                            <div class="col-md-6">
                                                <label for="ticketType" class="form-label">Tipo</label>
                                                <select class="form-select" id="ticketType">
                                                    <option value="desarrollo" selected>Desarrollo</option>
                                                    <option value="error">Error</option>
                                                </select>
                                            </div>
                                        </div>
                                        <button type="submit" class="btn btn-info">
                                            <i class="bi bi-plus-lg me-1"></i>
                                            Crear Ticket
                                        </button>
                                    </form>
                                </div>
                            </div>

                            <!-- Obtener Ticket Específico -->
                            <div class="card mb-4">
                                <div class="card-header bg-warning text-dark">
                                    <h5 class="card-title mb-0">
                                        <i class="bi bi-file-text me-2"></i>
                                        4. Obtener Ticket Específico
                                    </h5>
                                </div>
                                <div class="card-body">
                                    <div class="mb-3">
                                        <label for="getToken" class="form-label">Token de API</label>
                                        <input type="text" class="form-control" id="getToken" placeholder="Pega aquí tu token">
                                    </div>
                                    <div class="mb-3">
                                        <label for="ticketId" class="form-label">ID del Ticket</label>
                                        <input type="number" class="form-control" id="ticketId" placeholder="Ej: 1">
                                    </div>
                                    <button type="button" class="btn btn-warning" onclick="getTicket()">
                                        <i class="bi bi-search me-1"></i>
                                        Obtener Ticket
                                    </button>
                                </div>
                            </div>
                        </div>

                        <!-- Panel de respuestas -->
                        <div class="col-lg-6">
                            <div class="card sticky-top" style="top: 20px;">
                                <div class="card-header bg-dark text-white">
                                    <h5 class="card-title mb-0">
                                        <i class="bi bi-terminal me-2"></i>
                                        Respuesta de la API
                                    </h5>
                                </div>
                                <div class="card-body">
                                    <div id="apiResponse" style="min-height: 400px; max-height: 80vh; overflow-y: auto;">
                                        <div class="text-muted text-center py-5">
                                            <i class="bi bi-code-square" style="font-size: 3rem;"></i>
                                            <p class="mt-3">Ejecuta una operación para ver la respuesta aquí</p>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div> <!-- Fin tab de probar API -->
            </div> <!-- Fin tab-content -->
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
    // Validación del formulario
    (function() {
        'use strict';
        window.addEventListener('load', function() {
            var forms = document.getElementsByClassName('needs-validation');
            var validation = Array.prototype.filter.call(forms, function(form) {
                form.addEventListener('submit', function(event) {
                    if (form.checkValidity() === false) {
                        event.preventDefault();
                        event.stopPropagation();
                    }
                    form.classList.add('was-validated');
                }, false);
            });
        }, false);
    })();

    // Mostrar/ocultar campos de IA según el checkbox
    document.addEventListener('DOMContentLoaded', function() {
        const aiEnabledCheckbox = document.querySelector('#id_ai_chat_enabled');
        const aiConfigFields = document.querySelector('#ai-config-fields');
        
        if (aiEnabledCheckbox && aiConfigFields) {
            function toggleAIFields() {
                if (aiEnabledCheckbox.checked) {
                    aiConfigFields.style.display = 'block';
                } else {
                    aiConfigFields.style.display = 'none';
                }
            }
            
            aiEnabledCheckbox.addEventListener('change', toggleAIFields);
            toggleAIFields(); // Ejecutar al cargar la página
        }

        // Mostrar/ocultar campos de PayPal según el checkbox
        const paypalEnabledCheckbox = document.querySelector('#id_paypal_enabled');
        const paypalConfigFields = document.querySelector('#paypal-config-fields');
        
        if (paypalEnabledCheckbox && paypalConfigFields) {
            function togglePayPalFields() {
                if (paypalEnabledCheckbox.checked) {
                    paypalConfigFields.style.display = 'block';
                } else {
                    paypalConfigFields.style.display = 'none';
                }
            }
            
            paypalEnabledCheckbox.addEventListener('change', togglePayPalFields);
            togglePayPalFields(); // Ejecutar al cargar la página
        }

        // Mostrar/ocultar campos de Telegram según el checkbox
        const telegramEnabledCheckbox = document.querySelector('#id_enable_telegram_notifications');
        const telegramConfigFields = document.querySelector('#telegram-config-fields');
        
        if (telegramEnabledCheckbox && telegramConfigFields) {
            function toggleTelegramFields() {
                if (telegramEnabledCheckbox.checked) {
                    telegramConfigFields.style.display = 'block';
                } else {
                    telegramConfigFields.style.display = 'none';
                }
            }
            
            telegramEnabledCheckbox.addEventListener('change', toggleTelegramFields);
            toggleTelegramFields(); // Ejecutar al cargar la página
        }

        // Mostrar/ocultar campos de Email según el checkbox
        const emailEnabledCheckbox = document.querySelector('#id_enable_email_notifications');
        const emailConfigFields = document.querySelector('#email-config-fields');
        
        if (emailEnabledCheckbox && emailConfigFields) {
            function toggleEmailFields() {
                if (emailEnabledCheckbox.checked) {
                    emailConfigFields.style.display = 'block';
                } else {
                    emailConfigFields.style.display = 'none';
                }
            }
            
            emailEnabledCheckbox.addEventListener('change', toggleEmailFields);
            toggleEmailFields(); // Ejecutar al cargar la página
        }

        // Función para probar conexión de Telegram
        const testTelegramBtn = document.querySelector('#test-telegram-btn');
        if (testTelegramBtn) {
            testTelegramBtn.addEventListener('click', function() {
                const botToken = document.querySelector('#id_telegram_bot_token').value;
                const chatId = document.querySelector('#id_telegram_chat_id').value;

                if (!botToken || !chatId) {
                    alert('Por favor, completa el token del bot y el Chat ID antes de probar la conexión.');
                    return;
                }

                // Cambiar estado del botón
                const originalText = this.innerHTML;
                this.innerHTML = '<i class="bi bi-hourglass-split me-1"></i>Probando...';
                this.disabled = true;

                // Crear formulario temporal para enviar datos
                const form = document.createElement('form');
                form.method = 'POST';
                form.style.display = 'none';
                
                // Agregar CSRF token
                const csrfToken = document.querySelector('[name=csrfmiddlewaretoken]').value;
                const csrfInput = document.createElement('input');
                csrfInput.type = 'hidden';
                csrfInput.name = 'csrfmiddlewaretoken';
                csrfInput.value = csrfToken;
                form.appendChild(csrfInput);

                // Agregar datos de prueba
                const testInput = document.createElement('input');
                testInput.type = 'hidden';
                testInput.name = 'test_telegram';
                testInput.value = '1';
                form.appendChild(testInput);

                const tokenInput = document.createElement('input');
                tokenInput.type = 'hidden';
                tokenInput.name = 'telegram_bot_token';
                tokenInput.value = botToken;
                form.appendChild(tokenInput);

                const chatInput = document.createElement('input');
                chatInput.type = 'hidden';
                chatInput.name = 'telegram_chat_id';
                chatInput.value = chatId;
                form.appendChild(chatInput);

                document.body.appendChild(form);
                form.submit();
            });
        }

        // Función para probar email
        const testEmailBtn = document.querySelector('#test-email-btn');
        if (testEmailBtn) {
            testEmailBtn.addEventListener('click', function() {
                const emailHost = document.querySelector('#id_email_host').value;
                const emailPort = document.querySelector('#id_email_port').value;
                const emailUser = document.querySelector('#id_email_host_user').value;
                const notificationEmails = document.querySelector('#id_notification_emails').value;

                if (!emailHost || !emailPort || !emailUser || !notificationEmails) {
                    alert('Por favor, completa todos los campos de configuración de email antes de probar.');
                    return;
                }

                // Cambiar estado del botón
                const originalText = this.innerHTML;
                this.innerHTML = '<i class="bi bi-hourglass-split me-1"></i>Enviando...';
                this.disabled = true;

                // Crear formulario temporal para enviar datos
                const form = document.createElement('form');
                form.method = 'POST';
                form.style.display = 'none';
                
                // Agregar CSRF token
                const csrfToken = document.querySelector('[name=csrfmiddlewaretoken]').value;
                const csrfInput = document.createElement('input');
                csrfInput.type = 'hidden';
                csrfInput.name = 'csrfmiddlewaretoken';
                csrfInput.value = csrfToken;
                form.appendChild(csrfInput);

                // Agregar datos de prueba
                const testInput = document.createElement('input');
                testInput.type = 'hidden';
                testInput.name = 'test_email';
                testInput.value = '1';
                form.appendChild(testInput);

                document.body.appendChild(form);
                form.submit();
            });
        }
        
        // ========================================
        // FUNCIONES PARA PROBAR LA API
        // ========================================
        
        const API_BASE_URL = window.location.origin + '/api';
        
        // Obtener el token CSRF
        function getCookie(name) {
            let cookieValue = null;
            if (document.cookie && document.cookie !== '') {
                const cookies = document.cookie.split(';');
                for (let i = 0; i < cookies.length; i++) {
                    const cookie = cookies[i].trim();
                    if (cookie.substring(0, name.length + 1) === (name + '=')) {
                        cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                        break;
                    }
                }
            }
            return cookieValue;
        }
        const csrftoken = getCookie('csrftoken');
        
        // Función para mostrar respuesta
        function displayResponse(title, status, data, isError = false) {
            const responseDiv = document.getElementById('apiResponse');
            const statusClass = isError ? 'danger' : 'success';
            const statusIcon = isError ? 'x-circle' : 'check-circle';
            
            const html = `
                <div class="alert alert-${statusClass} mb-3">
                    <h6><i class="bi bi-${statusIcon} me-2"></i>${title}</h6>
                    <small>Status: ${status}</small>
                </div>
                <div class="bg-dark text-light p-3 rounded" style="font-family: monospace; font-size: 0.9em; overflow-x: auto;">
                    <pre class="mb-0" style="color: #abb2bf;">${JSON.stringify(data, null, 2)}</pre>
                </div>
            `;
            
            responseDiv.innerHTML = html;
        }
        
        // Función para copiar token
        window.copyToken = function() {
            const tokenInput = document.getElementById('apiToken');
            tokenInput.select();
            document.execCommand('copy');
            
            // También copiar a los otros campos de token
            const token = tokenInput.value;
            document.getElementById('listToken').value = token;
            document.getElementById('createToken').value = token;
            document.getElementById('getToken').value = token;
            
            alert('Token copiado al portapapeles y pegado en todos los campos!');
        };
        
        // 1. Login
        document.getElementById('loginForm').addEventListener('submit', async function(e) {
            e.preventDefault();
            
            const username = document.getElementById('loginUsername').value;
            const password = document.getElementById('loginPassword').value;
            
            try {
                const response = await fetch(`${API_BASE_URL}/auth/login/`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-CSRFToken': csrftoken
                    },
                    body: JSON.stringify({ username, password })
                });
                
                const data = await response.json();
                
                if (response.ok) {
                    displayResponse('✅ Login Exitoso', response.status, data);
                    document.getElementById('apiToken').value = data.token;
                    document.getElementById('tokenResult').style.display = 'block';
                    
                    // Auto-llenar los campos de token
                    document.getElementById('listToken').value = data.token;
                    document.getElementById('createToken').value = data.token;
                    document.getElementById('getToken').value = data.token;
                } else {
                    displayResponse('❌ Error de Login', response.status, data, true);
                }
            } catch (error) {
                displayResponse('❌ Error de Conexión', 'Error', { error: error.message }, true);
            }
        });
        
        // 2. Listar Tickets
        window.listTickets = async function() {
            const token = document.getElementById('listToken').value;
            
            if (!token) {
                alert('Por favor, ingresa un token de API');
                return;
            }
            
            const status = document.getElementById('filterStatus').value;
            const priority = document.getElementById('filterPriority').value;
            
            let url = `${API_BASE_URL}/tickets/`;
            const params = new URLSearchParams();
            if (status) params.append('status', status);
            if (priority) params.append('priority', priority);
            if (params.toString()) url += '?' + params.toString();
            
            try {
                const response = await fetch(url, {
                    method: 'GET',
                    headers: {
                        'Authorization': `Bearer ${token}`,
                        'Content-Type': 'application/json',
                    }
                });
                
                // Intentar parsear como JSON
                let data;
                const contentType = response.headers.get("content-type");
                if (contentType && contentType.indexOf("application/json") !== -1) {
                    data = await response.json();
                } else {
                    // Si no es JSON, obtener el texto para mostrar el error real
                    const text = await response.text();
                    data = { error: 'Respuesta no es JSON', html: text.substring(0, 500) };
                }
                
                if (response.ok) {
                    displayResponse('✅ Tickets Obtenidos', response.status, data);
                } else {
                    displayResponse('❌ Error al Listar Tickets', response.status, data, true);
                }
            } catch (error) {
                displayResponse('❌ Error de Conexión', 'Error', { error: error.message }, true);
            }
        };
        
        // 3. Crear Ticket
        document.getElementById('createTicketForm').addEventListener('submit', async function(e) {
            e.preventDefault();
            
            const token = document.getElementById('createToken').value;
            const title = document.getElementById('ticketTitle').value;
            const description = document.getElementById('ticketDescription').value;
            const priority = document.getElementById('ticketPriority').value;
            const ticket_type = document.getElementById('ticketType').value;
            
            if (!token) {
                alert('Por favor, ingresa un token de API');
                return;
            }
            
            try {
                const response = await fetch(`${API_BASE_URL}/tickets/`, {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${token}`,
                        'Content-Type': 'application/json',
                        'X-CSRFToken': csrftoken
                    },
                    body: JSON.stringify({
                        title,
                        description,
                        priority,
                        ticket_type
                    })
                });
                
                const data = await response.json();
                
                if (response.ok) {
                    displayResponse('✅ Ticket Creado', response.status, data);
                    // Limpiar formulario
                    document.getElementById('ticketTitle').value = '';
                    document.getElementById('ticketDescription').value = '';
                } else {
                    displayResponse('❌ Error al Crear Ticket', response.status, data, true);
                }
            } catch (error) {
                displayResponse('❌ Error de Conexión', 'Error', { error: error.message }, true);
            }
        });
        
        // 4. Obtener Ticket Específico
        window.getTicket = async function() {
            const token = document.getElementById('getToken').value;
            const ticketId = document.getElementById('ticketId').value;
            
            if (!token) {
                alert('Por favor, ingresa un token de API');
                return;
            }
            
            if (!ticketId) {
                alert('Por favor, ingresa un ID de ticket');
                return;
            }
            
            try {
                const response = await fetch(`${API_BASE_URL}/tickets/${ticketId}/`, {
                    method: 'GET',
                    headers: {
                        'Authorization': `Bearer ${token}`,
                        'Content-Type': 'application/json',
                    }
                });
                
                // Intentar parsear como JSON
                let data;
                const contentType = response.headers.get("content-type");
                if (contentType && contentType.indexOf("application/json") !== -1) {
                    data = await response.json();
                } else {
                    const text = await response.text();
                    data = { error: 'Respuesta no es JSON', html: text.substring(0, 500) };
                }
                
                if (response.ok) {
                    displayResponse('✅ Ticket Obtenido', response.status, data);
                } else {
                    displayResponse('❌ Error al Obtener Ticket', response.status, data, true);
                }
            } catch (error) {
                displayResponse('❌ Error de Conexión', 'Error', { error: error.message }, true);
            }
        };
    });
</script>
{% endblock %}