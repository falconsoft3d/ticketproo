{% extends 'base.html' %}

{% block content %}
<div class="container-fluid py-4">
    <div class="row">
        <!-- Formulario principal (lado izquierdo) -->
        <div class="col-lg-8">
            <!-- Header -->
            <div class="d-flex align-items-center mb-4">
                <a href="{% url 'quotation_list' %}" class="btn btn-outline-secondary me-3">
                    <i class="bi bi-arrow-left"></i>
                </a>
                <div>
                    <h1 class="h3 mb-0">
                        <i class="bi bi-file-earmark-text text-primary"></i>
                        {{ page_title }}
                    </h1>
                    <p class="text-muted mb-0">Complete la información de la cotización</p>
                </div>
            </div>

            <!-- Formulario -->
            <div class="card">
                <div class="card-header bg-primary text-white">
                    <h5 class="mb-0">
                        <i class="bi bi-file-earmark-plus"></i>
                        Datos de la Cotización
                    </h5>
                </div>
                <div class="card-body">
                    <form method="post" id="quotationForm">
                        {% csrf_token %}
                        
                        <div class="row">
                            <!-- Empresa -->
                            <div class="col-md-6 mb-3">
                                <label for="company" class="form-label">
                                    <i class="bi bi-building text-primary"></i>
                                    Empresa <span class="text-danger">*</span>
                                </label>
                                <select class="form-select" id="company" name="company" required>
                                    <option value="">Seleccionar empresa...</option>
                                    {% for company in companies %}
                                        <option value="{{ company.id }}" 
                                                {% if quotation and quotation.company.id == company.id %}selected{% endif %}>
                                            {{ company.name }}
                                        </option>
                                    {% endfor %}
                                </select>
                            </div>

                            <!-- Vendedor -->
                            <div class="col-md-6 mb-3">
                                <label for="salesperson" class="form-label">
                                    <i class="bi bi-person text-primary"></i>
                                    Vendedor <span class="text-danger">*</span>
                                </label>
                                <select class="form-select" id="salesperson" name="salesperson" required>
                                    <option value="">Seleccionar vendedor...</option>
                                    {% for person in salespeople %}
                                        <option value="{{ person.id }}" 
                                                {% if quotation and quotation.salesperson.id == person.id %}selected{% elif not quotation and person == user %}selected{% endif %}>
                                            {{ person.get_full_name|default:person.username }}
                                        </option>
                                    {% endfor %}
                                </select>
                            </div>
                        </div>

                        <div class="row">
                            <!-- Fecha -->
                            <div class="col-md-4 mb-3">
                                <label for="date" class="form-label">
                                    <i class="bi bi-calendar text-primary"></i>
                                    Fecha <span class="text-danger">*</span>
                                </label>
                                <input type="date" class="form-control" id="date" name="date" 
                                       value="{% if quotation %}{{ quotation.date|date:'Y-m-d' }}{% else %}{{ today|date:'Y-m-d' }}{% endif %}" required>
                            </div>

                            <!-- Fecha de Vencimiento -->
                            <div class="col-md-4 mb-3">
                                <label for="expiry_date" class="form-label">
                                    <i class="bi bi-hourglass-split text-warning"></i>
                                    Fecha de Vencimiento
                                </label>
                                <input type="date" class="form-control" id="expiry_date" name="expiry_date" 
                                       value="{% if quotation.expiry_date %}{{ quotation.expiry_date|date:'Y-m-d' }}{% endif %}">
                                <div class="form-text">
                                    <small class="text-muted">Si se deja vacía, se calculará automáticamente (30 días después de la fecha)</small>
                                </div>
                            </div>

                            <!-- Estado -->
                            <div class="col-md-4 mb-3">
                                <label for="status" class="form-label">
                                    <i class="bi bi-flag text-primary"></i>
                                    Estado Interno <span class="text-danger">*</span>
                                </label>
                                <select class="form-select" id="status" name="status" required>
                                    <option value="draft" {% if not quotation or quotation.status == 'draft' %}selected{% endif %}>
                                        Borrador
                                    </option>
                                    <option value="sent" {% if quotation and quotation.status == 'sent' %}selected{% endif %}>
                                        Enviada
                                    </option>
                                    <option value="approved" {% if quotation and quotation.status == 'approved' %}selected{% endif %}>
                                        Aprobada
                                    </option>
                                    <option value="rejected" {% if quotation and quotation.status == 'rejected' %}selected{% endif %}>
                                        Rechazada
                                    </option>
                                    <option value="expired" {% if quotation and quotation.status == 'expired' %}selected{% endif %}>
                                        Expirada
                                    </option>
                                </select>
                            </div>
                        </div>

                        <div class="row">
                            <!-- Estado del Cliente -->
                            <div class="col-md-6 mb-3">
                                <label for="client_status" class="form-label">
                                    <i class="bi bi-person-check text-primary"></i>
                                    Estado del Cliente
                                </label>
                                <select class="form-select" id="client_status" name="client_status">
                                    <option value="pending" {% if not quotation or quotation.client_status == 'pending' %}selected{% endif %}>
                                        Pendiente de Respuesta
                                    </option>
                                    <option value="accepted" {% if quotation and quotation.client_status == 'accepted' %}selected{% endif %}>
                                        Aceptada por Cliente
                                    </option>
                                    <option value="rejected" {% if quotation and quotation.client_status == 'rejected' %}selected{% endif %}>
                                        Rechazada por Cliente
                                    </option>
                                </select>
                            </div>

                            <!-- Descripción -->
                            <div class="col-md-6 mb-3">
                                <label for="description" class="form-label">
                                    <i class="bi bi-text-paragraph text-primary"></i>
                                    Descripción
                                </label>
                                <textarea class="form-control" id="description" name="description" rows="3" 
                                          placeholder="Descripción adicional de la cotización...">{% if quotation %}{{ quotation.description }}{% endif %}</textarea>
                            </div>
                        </div>

                        <!-- Fechas de servicio -->
                        <div class="row">
                            <div class="col-md-6 mb-3">
                                <label for="service_start_date" class="form-label">
                                    <i class="bi bi-calendar-check text-success"></i>
                                    Fecha de Inicio del Servicio
                                </label>
                                <input type="date" class="form-control" id="service_start_date" name="service_start_date" 
                                       value="{% if quotation.service_start_date %}{{ quotation.service_start_date|date:'Y-m-d' }}{% endif %}">
                                <div class="form-text">
                                    <small class="text-muted">Fecha en que comenzará el servicio (opcional)</small>
                                </div>
                            </div>

                            <div class="col-md-6 mb-3">
                                <label for="service_end_date" class="form-label">
                                    <i class="bi bi-calendar-x text-danger"></i>
                                    Fecha de Fin del Servicio
                                </label>
                                <input type="date" class="form-control" id="service_end_date" name="service_end_date" 
                                       value="{% if quotation.service_end_date %}{{ quotation.service_end_date|date:'Y-m-d' }}{% endif %}">
                                <div class="form-text">
                                    <small class="text-muted">Fecha estimada de finalización del servicio (opcional)</small>
                                </div>
                            </div>
                        </div>

                        <!-- Botones -->
                        <div class="d-flex gap-2">
                            <button type="submit" class="btn btn-primary">
                                <i class="bi bi-check-circle"></i>
                                {% if quotation %}Actualizar{% else %}Crear{% endif %} Cotización
                            </button>
                            <a href="{% url 'quotation_list' %}" class="btn btn-outline-secondary">
                                <i class="bi bi-x-circle"></i>
                                Cancelar
                            </a>
                        </div>
                    </form>
                </div>
            </div>

            {% if quotation and quotation.client_response_name %}
            <!-- Información de respuesta del cliente -->
            <div class="card mt-4">
                <div class="card-header bg-info text-white">
                    <h6 class="mb-0">
                        <i class="bi bi-person-check"></i>
                        Información de Respuesta del Cliente
                    </h6>
                </div>
                <div class="card-body">
                    <div class="row">
                        <div class="col-md-6">
                            <strong>Cliente:</strong> {{ quotation.client_response_name }}<br>
                            {% if quotation.client_response_email %}
                                <strong>Email:</strong> {{ quotation.client_response_email }}<br>
                            {% endif %}
                            <strong>Fecha de Respuesta:</strong> {{ quotation.client_response_date|date:"d/m/Y H:i" }}
                        </div>
                        <div class="col-md-6">
                            {% if quotation.client_response_comments %}
                                <strong>Comentarios:</strong><br>
                                <div class="border p-2 rounded bg-light">
                                    <small>{{ quotation.client_response_comments }}</small>
                                </div>
                            {% endif %}
                        </div>
                    </div>
                </div>
            </div>
            {% endif %}

            {% if quotation %}
            <!-- Líneas de cotización existentes -->
            <div class="card mt-4">
                <div class="card-header d-flex justify-content-between align-items-center">
                    <h6 class="mb-0">
                        <i class="bi bi-list-ul"></i>
                        Líneas de Cotización
                    </h6>
                    <span class="badge bg-primary" id="totalAmount">
                        Total: {{ currency_symbol }}<span id="totalValue">{{ quotation.get_total_amount|floatformat:2 }}</span>
                    </span>
                </div>
                <div class="card-body p-0">
                    <div id="quotationLines">
                        <!-- Las líneas se cargarán aquí vía AJAX -->
                    </div>
                </div>
            </div>
            {% endif %}
        </div>

        <!-- Panel lateral para productos (lado derecho) -->
        <div class="col-lg-4">
            {% if quotation %}
            <div class="card sticky-top" style="top: 20px;">
                <div class="card-header bg-primary text-white">
                    <h6 class="mb-0">
                        <i class="bi bi-plus-circle"></i>
                        Agregar Productos
                    </h6>
                </div>
                <div class="card-body">
                    <!-- Selección de productos -->
                    <div class="mb-3">
                        <label for="productSelect" class="form-label">Producto</label>
                        <select class="form-select" id="productSelect" onchange="selectProduct()">
                            <option value="">-- Seleccionar producto --</option>
                            {% for product in products %}
                            <option value="{{ product.id }}" data-price="{{ product.price|default:'0' }}">
                                {{ product.name }} - {{ currency_symbol }}{{ product.price|default:'0'|floatformat:2 }}
                            </option>
                            {% endfor %}
                        </select>
                    </div>

                    <!-- Formulario para agregar línea -->
                    <div id="addLineForm" style="display: none;">
                        <div class="border-top pt-3">
                            <h6 class="mb-3">Agregar Línea</h6>
                            
                            <input type="hidden" id="selectedProductId">
                            
                            <div class="mb-2">
                                <label class="form-label">Producto Seleccionado</label>
                                <div id="selectedProductName" class="fw-bold text-primary"></div>
                            </div>

                            <div class="row">
                                <div class="col-6 mb-2">
                                    <label for="lineQuantity" class="form-label">Cantidad</label>
                                    <input type="number" class="form-control form-control-sm" 
                                           id="lineQuantity" min="0.01" step="0.01" value="1">
                                </div>
                                <div class="col-6 mb-2">
                                    <label for="lineUnitPrice" class="form-label">Precio Unit.</label>
                                    <input type="number" class="form-control form-control-sm" 
                                           id="lineUnitPrice" min="0" step="0.01">
                                </div>
                            </div>

                            <div class="mb-2">
                                <label for="lineDiscount" class="form-label">Descuento (%)</label>
                                <input type="number" class="form-control form-control-sm" 
                                       id="lineDiscount" min="0" max="100" step="0.01" value="0">
                            </div>

                            <div class="mb-3">
                                <label for="lineDescription" class="form-label">Descripción</label>
                                <textarea class="form-control form-control-sm" 
                                          id="lineDescription" rows="2" 
                                          placeholder="Descripción adicional (opcional)"></textarea>
                            </div>

                            <div class="d-grid gap-2">
                                <button type="button" class="btn btn-success btn-sm" onclick="addLineToQuotation()">
                                    <i class="bi bi-plus-circle"></i>
                                    Agregar Línea
                                </button>
                                <button type="button" class="btn btn-outline-secondary btn-sm" onclick="cancelAddLine()">
                                    <i class="bi bi-x-circle"></i>
                                    Cancelar
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            {% else %}
            <!-- Mensaje para nueva cotización -->
            <div class="card">
                <div class="card-body text-center">
                    <i class="bi bi-info-circle display-4 text-muted"></i>
                    <h5 class="mt-3">Agregar Productos</h5>
                    <p class="text-muted">
                        Primero cree la cotización para poder agregar productos y líneas.
                    </p>
                </div>
            </div>
            {% endif %}

            <!-- Información de ayuda -->
            <div class="card mt-4">
                <div class="card-header">
                    <h6 class="mb-0">
                        <i class="bi bi-info-circle"></i>
                        Información
                    </h6>
                </div>
                <div class="card-body">
                    <ul class="mb-0">
                        <li><strong>Secuencia:</strong> Se genera automáticamente al crear la cotización</li>
                        <li><strong>Líneas:</strong> Agregue productos usando el panel lateral</li>
                        <li><strong>Total:</strong> Se calcula automáticamente sumando las líneas</li>
                        <li><strong>Estados:</strong>
                            <ul>
                                <li><span class="badge bg-secondary">Borrador</span> - En preparación</li>
                                <li><span class="badge bg-primary">Enviada</span> - Enviada al cliente</li>
                                <li><span class="badge bg-success">Aprobada</span> - Aceptada por el cliente</li>
                                <li><span class="badge bg-danger">Rechazada</span> - Rechazada por el cliente</li>
                                <li><span class="badge bg-warning">Expirada</span> - Tiempo de validez vencido</li>
                            </ul>
                        </li>
                    </ul>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
{% if quotation %}
const quotationId = {{ quotation.id }};
const currencySymbol = '{{ currency_symbol|escapejs }}';

// Variables globales
let selectedProduct = null;

document.addEventListener('DOMContentLoaded', function() {
    // Establecer fecha actual por defecto
    const dateInput = document.getElementById('date');
    if (!dateInput.value) {
        const today = new Date().toISOString().split('T')[0];
        dateInput.value = today;
    }
    
    // Cargar líneas existentes
    loadQuotationLines();
});

function selectProduct() {
    const select = document.getElementById('productSelect');
    const selectedOption = select.options[select.selectedIndex];
    
    if (selectedOption.value) {
        const productId = selectedOption.value;
        const productName = selectedOption.text.split(' - ' + currencySymbol)[0]; // Extraer solo el nombre
        const productPrice = selectedOption.getAttribute('data-price') || 0;
        
        selectedProduct = {
            id: productId,
            name: productName,
            price: productPrice
        };
        
        // Mostrar información del producto seleccionado
        document.getElementById('selectedProductName').textContent = productName;
        document.getElementById('lineUnitPrice').value = productPrice;
        
        // Mostrar formulario para agregar línea
        document.getElementById('addLineForm').style.display = 'block';
    } else {
        // Ocultar formulario si no hay producto seleccionado
        document.getElementById('addLineForm').style.display = 'none';
        document.getElementById('selectedProductName').textContent = '';
        selectedProduct = null;
    }
}

function cancelAddLine() {
    document.getElementById('addLineForm').style.display = 'none';
    document.getElementById('productSelect').value = '';
    clearLineForm();
}

function clearLineForm() {
    document.getElementById('selectedProductName').textContent = '';
    document.getElementById('lineQuantity').value = '1';
    document.getElementById('lineUnitPrice').value = '';
    document.getElementById('lineDiscount').value = '0';
    document.getElementById('lineDescription').value = '';
}

function addLineToQuotation() {
    if (!selectedProduct) {
        showNotification('Error: Debe seleccionar un producto', 'danger');
        return;
    }
    
    const formData = new FormData();
    formData.append('csrfmiddlewaretoken', document.querySelector('[name=csrfmiddlewaretoken]').value);
    formData.append('product_id', selectedProduct.id);
    formData.append('quantity', document.getElementById('lineQuantity').value);
    formData.append('unit_price', document.getElementById('lineUnitPrice').value);
    formData.append('discount_percentage', document.getElementById('lineDiscount').value);
    formData.append('description', document.getElementById('lineDescription').value);
    
    fetch(`/quotations/${quotationId}/add-line/`, {
        method: 'POST',
        body: formData
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            loadQuotationLines();
            updateTotal(data.quotation_total);
            cancelAddLine();
            
            // Mostrar mensaje de éxito
            showNotification('Línea agregada correctamente', 'success');
        } else {
            showNotification('Error: ' + data.message, 'danger');
        }
    })
    .catch(error => {
        console.error('Error:', error);
        showNotification('Error al agregar la línea', 'danger');
    });
}

function loadQuotationLines() {
    fetch(`/quotations/${quotationId}/lines/`)
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                displayQuotationLines(data.lines);
                updateTotal(data.quotation_total);
            }
        })
        .catch(error => {
            console.error('Error:', error);
        });
}

function displayQuotationLines(lines) {
    const container = document.getElementById('quotationLines');
    
    if (lines.length === 0) {
        container.innerHTML = '<p class="text-muted text-center p-3">No hay líneas agregadas</p>';
        return;
    }
    
    let html = '<div class="table-responsive"><table class="table table-sm mb-0">';
    html += '<thead class="table-light">';
    html += '<tr><th>Producto</th><th>Descripción</th><th>Cant.</th><th>Precio Unit.</th><th>Desc.</th><th>Total</th><th></th></tr>';
    html += '</thead><tbody>';
    
    lines.forEach(line => {
        html += `
            <tr id="line-${line.id}">
                <td>
                    <div class="fw-bold">${line.product_name}</div>
                </td>
                <td>
                    <div id="description-${line.id}">
                        ${line.description ? '<span class="text-muted">' + line.description + '</span>' : '<em class="text-muted">Sin descripción</em>'}
                    </div>
                </td>
                <td>
                    <div id="quantity-${line.id}">${line.quantity}</div>
                </td>
                <td>
                    <div id="unit_price-${line.id}">${currencySymbol}${line.unit_price.toFixed(2)}</div>
                </td>
                <td>
                    <div id="discount-${line.id}">${line.discount_percentage}%</div>
                </td>
                <td class="fw-bold">
                    <div id="total-${line.id}">${currencySymbol}${line.total.toFixed(2)}</div>
                </td>
                <td>
                    <div class="btn-group btn-group-sm">
                        <button class="btn btn-outline-primary" 
                                onclick="editLineById(${line.id})"
                                data-product-name="${line.product_name}"
                                data-quantity="${line.quantity}"
                                data-unit-price="${line.unit_price}"
                                data-discount="${line.discount_percentage}"
                                data-description="${line.description || ''}">
                            <i class="bi bi-pencil"></i>
                        </button>
                        <button class="btn btn-outline-danger" onclick="removeLine(${line.id})">
                            <i class="bi bi-trash"></i>
                        </button>
                    </div>
                </td>
            </tr>
        `;
    });
    
    html += '</tbody></table></div>';
    container.innerHTML = html;
}

function removeLine(lineId) {
    if (!confirm('¿Está seguro de eliminar esta línea?')) {
        return;
    }
    
    const formData = new FormData();
    formData.append('csrfmiddlewaretoken', document.querySelector('[name=csrfmiddlewaretoken]').value);
    
    fetch(`/quotations/${quotationId}/remove-line/${lineId}/`, {
        method: 'POST',
        body: formData
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            loadQuotationLines();
            updateTotal(data.quotation_total);
            showNotification('Línea eliminada correctamente', 'success');
        } else {
            showNotification('Error: ' + data.message, 'danger');
        }
    })
    .catch(error => {
        console.error('Error:', error);
        showNotification('Error al eliminar la línea', 'danger');
    });
}

function editLineById(lineId) {
    // Buscar el botón de edición para obtener los datos
    const editButton = document.querySelector(`button[onclick="editLineById(${lineId})"]`);
    if (!editButton) {
        console.error('No se encontró el botón de edición para la línea:', lineId);
        return;
    }
    
    const productName = editButton.getAttribute('data-product-name');
    const quantity = parseFloat(editButton.getAttribute('data-quantity'));
    const unitPrice = parseFloat(editButton.getAttribute('data-unit-price'));
    const discountPercentage = parseFloat(editButton.getAttribute('data-discount'));
    const description = editButton.getAttribute('data-description') || '';
    
    console.log('editLineById called:', {lineId, productName, quantity, unitPrice, discountPercentage, description});
    
    // Llamar a la función original de edición
    editLine(lineId, productName, quantity, unitPrice, discountPercentage, description);
}

function editLine(lineId, productName, quantity, unitPrice, discountPercentage, description) {
    console.log('editLine called:', {lineId, productName, quantity, unitPrice, discountPercentage, description});
    
    // Cancelar cualquier edición anterior
    if (window.currentEditingLine) {
        cancelEditLine(window.currentEditingLine.lineId);
    }
    
    // Verificar que los elementos existen
    const quantityEl = document.getElementById(`quantity-${lineId}`);
    const unitPriceEl = document.getElementById(`unit_price-${lineId}`);
    const discountEl = document.getElementById(`discount-${lineId}`);
    const descriptionEl = document.getElementById(`description-${lineId}`);
    
    if (!quantityEl || !unitPriceEl || !discountEl || !descriptionEl) {
        console.error('No se encontraron todos los elementos para la línea:', lineId);
        return;
    }
    
    // Guardar el contenido original
    const originalContent = {
        quantity: quantityEl.innerHTML,
        unit_price: unitPriceEl.innerHTML,
        discount: discountEl.innerHTML,
        description: descriptionEl.innerHTML,
        total: document.getElementById(`total-${lineId}`).innerHTML
    };
    
    console.log('Original content:', originalContent);
    
    // Crear formularios inline para editar
    quantityEl.innerHTML = 
        `<input type="number" class="form-control form-control-sm" id="edit-quantity-${lineId}" value="${quantity}" min="0.01" step="0.01">`;
    
    unitPriceEl.innerHTML = 
        `<input type="number" class="form-control form-control-sm" id="edit-unit-price-${lineId}" value="${unitPrice}" min="0" step="0.01">`;
    
    discountEl.innerHTML = 
        `<input type="number" class="form-control form-control-sm" id="edit-discount-${lineId}" value="${discountPercentage}" min="0" max="100" step="0.01">`;
    
    descriptionEl.innerHTML = 
        `<textarea class="form-control form-control-sm" id="edit-description-${lineId}" rows="1">${description}</textarea>`;
    
    // Cambiar los botones de acción
    const actionCell = document.querySelector(`#line-${lineId} td:last-child`);
    actionCell.innerHTML = `
        <div class="btn-group btn-group-sm">
            <button class="btn btn-success" onclick="saveLineEdit(${lineId})">
                <i class="bi bi-check"></i>
            </button>
            <button class="btn btn-secondary" onclick="cancelEditLine(${lineId})">
                <i class="bi bi-x"></i>
            </button>
        </div>
    `;
    
    // Marcar que estamos editando esta línea
    window.currentEditingLine = { lineId, originalContent };
}

function saveLineEdit(lineId) {
    const quantity = document.getElementById(`edit-quantity-${lineId}`).value;
    const unitPrice = document.getElementById(`edit-unit-price-${lineId}`).value;
    const discountPercentage = document.getElementById(`edit-discount-${lineId}`).value;
    const description = document.getElementById(`edit-description-${lineId}`).value;
    
    const formData = new FormData();
    formData.append('csrfmiddlewaretoken', document.querySelector('[name=csrfmiddlewaretoken]').value);
    formData.append('quantity', quantity);
    formData.append('unit_price', unitPrice);
    formData.append('discount_percentage', discountPercentage);
    formData.append('description', description);
    
    fetch(`/quotations/${quotationId}/edit-line/${lineId}/`, {
        method: 'POST',
        body: formData
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            loadQuotationLines();
            updateTotal(data.quotation_total);
            showNotification('Línea actualizada correctamente', 'success');
            window.currentEditingLine = null;
        } else {
            showNotification('Error: ' + data.message, 'danger');
        }
    })
    .catch(error => {
        console.error('Error:', error);
        showNotification('Error al actualizar la línea', 'danger');
    });
}

function cancelEditLine(lineId) {
    if (window.currentEditingLine && window.currentEditingLine.lineId === lineId) {
        // Restaurar contenido original
        const content = window.currentEditingLine.originalContent;
        document.getElementById(`quantity-${lineId}`).innerHTML = content.quantity;
        document.getElementById(`unit_price-${lineId}`).innerHTML = content.unit_price;
        document.getElementById(`discount-${lineId}`).innerHTML = content.discount;
        document.getElementById(`description-${lineId}`).innerHTML = content.description;
        document.getElementById(`total-${lineId}`).innerHTML = content.total;
        
        // Restaurar botones originales
        const actionCell = document.querySelector(`#line-${lineId} td:last-child`);
        actionCell.innerHTML = `
            <div class="btn-group btn-group-sm">
                <button class="btn btn-outline-primary" onclick="editLine(${lineId}, '', 0, 0, 0, '')">
                    <i class="bi bi-pencil"></i>
                </button>
                <button class="btn btn-outline-danger" onclick="removeLine(${lineId})">
                    <i class="bi bi-trash"></i>
                </button>
            </div>
        `;
        
        window.currentEditingLine = null;
    } else {
        // Si no tenemos los datos originales, recargar las líneas
        loadQuotationLines();
    }
}

function updateTotal(total) {
    document.getElementById('totalValue').textContent = total.toFixed(2);
}

function showNotification(message, type) {
    // Crear notificación
    const notification = document.createElement('div');
    notification.className = `alert alert-${type} alert-dismissible fade show position-fixed`;
    notification.style.top = '20px';
    notification.style.right = '20px';
    notification.style.zIndex = '9999';
    notification.innerHTML = `
        ${message}
        <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
    `;
    
    document.body.appendChild(notification);
    
    // Auto-hide después de 3 segundos
    setTimeout(() => {
        if (notification.parentNode) {
            notification.parentNode.removeChild(notification);
        }
    }, 3000);
}

{% else %}
// Establecer fecha actual por defecto para nueva cotización
document.addEventListener('DOMContentLoaded', function() {
    const dateInput = document.getElementById('date');
    if (!dateInput.value) {
        const today = new Date().toISOString().split('T')[0];
        dateInput.value = today;
    }
});
{% endif %}
</script>
{% endblock %}