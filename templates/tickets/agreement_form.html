{% extends 'base.html' %}
{% load static %}

{% block extra_css %}
<style>
.agreement-form-header {
    background: linear-gradient(135deg, #17a2b8 0%, #138496 100%);
    color: white;
    padding: 2rem 0;
    margin-bottom: 2rem;
}
.form-card {
    border: none;
    box-shadow: 0 4px 15px rgba(0,0,0,0.1);
    border-radius: 15px;
}
.ai-section {
    background: linear-gradient(135deg, #6f42c1 0%, #563d7c 100%);
    color: white;
    border-radius: 10px;
    padding: 1.5rem;
    margin-bottom: 2rem;
}
.ai-section .form-check-input:checked {
    background-color: white;
    border-color: white;
}
.ai-section .form-check-label {
    color: white;
}
.form-section {
    background: #f8f9fa;
    border-radius: 10px;
    padding: 1.5rem;
    margin-bottom: 2rem;
}
.char-counter {
    font-size: 0.85rem;
    color: #6c757d;
}
.preview-section {
    background: white;
    border: 2px solid #e9ecef;
    border-radius: 10px;
    padding: 1.5rem;
    max-height: 400px;
    overflow-y: auto;
}
.btn-generate-ai {
    background: linear-gradient(135deg, #6f42c1 0%, #563d7c 100%);
    border: none;
    color: white;
}
.btn-generate-ai:hover {
    background: linear-gradient(135deg, #563d7c 0%, #495057 100%);
    color: white;
}
</style>
{% endblock %}

{% block title %}{{ page_title }}{% endblock %}

{% block content %}
<div class="container-fluid">
    <!-- Header -->
    <div class="agreement-form-header rounded">
        <div class="container">
            <div class="row align-items-center">
                <div class="col-md-8">
                    <h1>
                        <i class="bi bi-file-earmark-plus"></i> 
                        {% if agreement %}Editar Acuerdo{% else %}Nuevo Acuerdo{% endif %}
                    </h1>
                    <p class="mb-0">
                        {% if agreement %}
                            Modifica el acuerdo "{{ agreement.title }}"
                        {% else %}
                            Crea un nuevo acuerdo o contrato con firma digital
                        {% endif %}
                    </p>
                </div>
                <div class="col-md-4 text-end">
                    <a href="{% url 'agreement_list' %}" class="btn btn-light">
                        <i class="bi bi-arrow-left"></i> Volver a Acuerdos
                    </a>
                </div>
            </div>
        </div>
    </div>

    <div class="row">
        <!-- Formulario -->
        <div class="col-lg-8">
            <div class="form-card card">
                <div class="card-header">
                    <h5 class="mb-0">
                        <i class="bi bi-pencil-square"></i> 
                        {% if agreement %}Editar Información{% else %}Información del Acuerdo{% endif %}
                    </h5>
                </div>
                <div class="card-body">
                    <form method="post" id="agreement-form">
                        {% csrf_token %}
                        
                        <!-- Sección de IA -->
                        {% if not agreement %}
                        <div class="ai-section">
                            <div class="row align-items-center">
                                <div class="col-md-8">
                                    <h5><i class="bi bi-robot"></i> Generación con Inteligencia Artificial</h5>
                                    <p class="mb-0">Deja que la IA genere automáticamente el contenido del acuerdo basándose en el título</p>
                                </div>
                                <div class="col-md-4 text-end">
                                    <div class="form-check form-switch">
                                        {{ form.generate_ai_content }}
                                        <label class="form-check-label" for="{{ form.generate_ai_content.id_for_label }}">
                                            Usar IA
                                        </label>
                                    </div>
                                </div>
                            </div>
                            
                            <div id="ai-prompt-section" style="display: none;" class="mt-3">
                                <label for="{{ form.ai_prompt_addition.id_for_label }}" class="form-label">
                                    {{ form.ai_prompt_addition.label }}
                                </label>
                                {{ form.ai_prompt_addition }}
                                <div class="form-text text-light">
                                    {{ form.ai_prompt_addition.help_text }}
                                </div>
                            </div>
                        </div>
                        {% endif %}
                        
                        <!-- Información básica -->
                        <div class="form-section">
                            <h6><i class="bi bi-info-circle"></i> Información Básica</h6>
                            
                            <div class="mb-3">
                                <label for="{{ form.title.id_for_label }}" class="form-label">
                                    {{ form.title.label }} <span class="text-danger">*</span>
                                </label>
                                {{ form.title }}
                                <div class="form-text">{{ form.title.help_text }}</div>
                                <div class="char-counter">
                                    <span id="title-count">0</span> / 200 caracteres
                                </div>
                            </div>
                            
                            <div class="mb-3" id="body-section">
                                <label for="{{ form.body.id_for_label }}" class="form-label">
                                    {{ form.body.label }} <span class="text-danger" id="body-required">*</span>
                                </label>
                                {{ form.body }}
                                <div class="form-text">{{ form.body.help_text }}</div>
                                <div class="char-counter">
                                    <span id="body-count">0</span> caracteres
                                </div>
                            </div>
                        </div>
                        
                        <!-- Configuración -->
                        <div class="form-section">
                            <h6><i class="bi bi-gear"></i> Configuración del Acuerdo</h6>
                            
                            <div class="row">
                                <div class="col-md-6">
                                    <div class="mb-3">
                                        <label for="{{ form.status.id_for_label }}" class="form-label">
                                            {{ form.status.label }}
                                        </label>
                                        {{ form.status }}
                                        <div class="form-text">{{ form.status.help_text }}</div>
                                    </div>
                                </div>
                                <div class="col-md-6">
                                    <div class="mb-3">
                                        <label for="{{ form.max_signers.id_for_label }}" class="form-label">
                                            {{ form.max_signers.label }}
                                        </label>
                                        {{ form.max_signers }}
                                        <div class="form-text">{{ form.max_signers.help_text }}</div>
                                    </div>
                                </div>
                            </div>
                            
                            <div class="row">
                                <div class="col-md-6">
                                    <div class="mb-3">
                                        <label for="{{ form.expires_at.id_for_label }}" class="form-label">
                                            {{ form.expires_at.label }}
                                        </label>
                                        {{ form.expires_at }}
                                        <div class="form-text">{{ form.expires_at.help_text }}</div>
                                    </div>
                                </div>
                                <div class="col-md-6">
                                    <div class="mb-3">
                                        <div class="form-check mt-4">
                                            {{ form.requires_approval }}
                                            <label class="form-check-label" for="{{ form.requires_approval.id_for_label }}">
                                                {{ form.requires_approval.label }}
                                            </label>
                                        </div>
                                        <div class="form-text">{{ form.requires_approval.help_text }}</div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Botones -->
                        <div class="d-flex gap-2 justify-content-end">
                            <a href="{% url 'agreement_list' %}" class="btn btn-outline-secondary">
                                <i class="bi bi-x-circle"></i> Cancelar
                            </a>
                            {% if not agreement %}
                                <button type="button" id="generate-ai-btn" class="btn btn-generate-ai" style="display: none;">
                                    <i class="bi bi-robot"></i> Generar con IA
                                </button>
                            {% endif %}
                            <button type="submit" class="btn btn-primary">
                                <i class="bi bi-check-circle"></i> 
                                {% if agreement %}Actualizar{% else %}Crear{% endif %} Acuerdo
                            </button>
                        </div>
                    </form>
                </div>
            </div>
        </div>
        
        <!-- Vista previa -->
        <div class="col-lg-4">
            <div class="sticky-top" style="top: 2rem;">
                <div class="card form-card">
                    <div class="card-header">
                        <h5 class="mb-0"><i class="bi bi-eye"></i> Vista Previa</h5>
                    </div>
                    <div class="card-body">
                        <div class="preview-section">
                            <div id="preview-content">
                                <div class="text-center text-muted">
                                    <i class="bi bi-file-earmark display-4"></i>
                                    <p class="mt-2">Escribe el título y contenido para ver la vista previa</p>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                
                {% if agreement %}
                <div class="card form-card mt-3">
                    <div class="card-header">
                        <h5 class="mb-0"><i class="bi bi-info-circle"></i> Estado Actual</h5>
                    </div>
                    <div class="card-body">
                        <div class="mb-2">
                            <strong>Estado:</strong> 
                            <span class="badge bg-secondary">{{ agreement.get_status_display }}</span>
                        </div>
                        <div class="mb-2">
                            <strong>Firmas:</strong> {{ agreement.signature_count }} / {{ agreement.max_signers }}
                        </div>
                        <div class="mb-2">
                            <strong>Editable:</strong>
                            {% if agreement.is_editable %}
                                <span class="text-success">Sí</span>
                            {% else %}
                                <span class="text-danger">No (tiene firmas)</span>
                            {% endif %}
                        </div>
                        {% if agreement.public_token %}
                            <div class="mb-2">
                                <strong>Token:</strong>
                                <code class="small">{{ agreement.public_token|truncatechars:20 }}</code>
                            </div>
                        {% endif %}
                    </div>
                </div>
                {% endif %}
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
$(document).ready(function() {
    // Control de IA
    $('#{{ form.generate_ai_content.id_for_label }}').change(function() {
        const isChecked = $(this).is(':checked');
        $('#ai-prompt-section').toggle(isChecked);
        $('#generate-ai-btn').toggle(isChecked);
        $('#body-required').toggle(!isChecked);
        
        if (isChecked) {
            $('#{{ form.body.id_for_label }}').prop('required', false);
        } else {
            $('#{{ form.body.id_for_label }}').prop('required', true);
        }
    });
    
    // Generar contenido con IA
    $('#generate-ai-btn').click(function() {
        const title = $('#{{ form.title.id_for_label }}').val();
        const prompt = $('#{{ form.ai_prompt_addition.id_for_label }}').val();
        
        if (!title.trim()) {
            alert('Por favor, escribe un título antes de generar contenido con IA.');
            return;
        }
        
        $(this).prop('disabled', true).html('<i class="bi bi-hourglass-split"></i> Generando...');
        
        // Simular generación (en la implementación real, harías una llamada AJAX)
        setTimeout(() => {
            const generatedContent = `
ACUERDO DE ${title.toUpperCase()}

Por medio del presente documento, las partes que se mencionan a continuación acuerdan los siguientes términos y condiciones:

1. OBJETO DEL ACUERDO
El presente acuerdo tiene por objeto establecer las condiciones y términos bajo los cuales se desarrollará ${title.toLowerCase()}.

2. OBLIGACIONES DE LAS PARTES
Cada parte se compromete a cumplir con las obligaciones establecidas en este documento de manera diligente y oportuna.

3. VIGENCIA
Este acuerdo entrará en vigor a partir de la fecha de firma y tendrá una duración indefinida, salvo que las partes acuerden lo contrario.

4. RESOLUCIÓN DE CONFLICTOS
Cualquier controversia derivada del presente acuerdo será resuelta mediante negociación directa entre las partes.

5. FIRMAS
Las partes manifiestan su conformidad firmando el presente documento.

${prompt ? `\nNOTAS ADICIONALES:\n${prompt}` : ''}

FIRMA: ________________________
NOMBRE: _______________________
FECHA: ________________________
            `;
            
            $('#{{ form.body.id_for_label }}').val(generatedContent.trim());
            updatePreview();
            
            $(this).prop('disabled', false).html('<i class="bi bi-robot"></i> Generar con IA');
        }, 2000);
    });
    
    // Contadores de caracteres
    function updateCharCount(input, counter) {
        $(counter).text($(input).val().length);
    }
    
    $('#{{ form.title.id_for_label }}').on('input', function() {
        updateCharCount(this, '#title-count');
        updatePreview();
    });
    
    $('#{{ form.body.id_for_label }}').on('input', function() {
        updateCharCount(this, '#body-count');
        updatePreview();
    });
    
    // Vista previa
    function updatePreview() {
        const title = $('#{{ form.title.id_for_label }}').val();
        const body = $('#{{ form.body.id_for_label }}').val();
        
        if (title || body) {
            const preview = `
                ${title ? `<h5>${title}</h5><hr>` : ''}
                ${body ? `<div style="white-space: pre-wrap; font-size: 0.9rem;">${body}</div>` : ''}
            `;
            $('#preview-content').html(preview);
        } else {
            $('#preview-content').html(`
                <div class="text-center text-muted">
                    <i class="bi bi-file-earmark display-4"></i>
                    <p class="mt-2">Escribe el título y contenido para ver la vista previa</p>
                </div>
            `);
        }
    }
    
    // Inicializar contadores
    updateCharCount('#{{ form.title.id_for_label }}', '#title-count');
    updateCharCount('#{{ form.body.id_for_label }}', '#body-count');
    updatePreview();
});
</script>
{% endblock %}