{% extends 'base.html' %}

{% block title %}{{ page_title }}{% endblock %}

{% block content %}
{% csrf_token %}
<div class="container-fluid">
    <div class="row">
        <div class="col-12">
            <div class="d-flex justify-content-between align-items-center mb-4">
                <h1>
                    <i class="fas fa-rocket text-primary"></i> 
                    {{ landing_page.nombre_producto }}
                </h1>
                <div class="btn-group" role="group">
                    <a href="{% url 'landing_page_list' %}" class="btn btn-outline-secondary">
                        <i class="fas fa-arrow-left"></i> Volver
                    </a>
                    <a href="{% url 'landing_page_public' landing_page.slug %}" class="btn btn-success" target="_blank">
                        <i class="fas fa-globe"></i> Ver Landing Pública
                    </a>
                    <a href="{% url 'landing_page_edit' landing_page.pk %}" class="btn btn-outline-primary">
                        <i class="fas fa-edit"></i> Editar
                    </a>
                </div>
            </div>

            <div class="row">
                <!-- Información Principal -->
                <div class="col-lg-8">
                    <div class="card mb-4">
                        <div class="card-body">
                            <div class="row">

<div class="col-md-6">
                                    <h3>{{ landing_page.nombre_producto }}</h3>
                                    <p class="text-muted">{{ landing_page.descripcion|linebreaks }}</p>
                                    
                                
                                    
                                    
                                    
                                    
                                </div>


                                <div class="col-md-6">
                                    <div class="mb-3">
                                        <strong>Estado:</strong>
                                        {% if landing_page.is_active %}
                                            <span class="badge bg-success ms-2">Activa</span>
                                        {% else %}
                                            <span class="badge bg-secondary ms-2">Inactiva</span>
                                        {% endif %}
                                    </div>


                                    {% if landing_page.imagen %}
                                        <img src="{{ landing_page.imagen.url }}" class="img-fluid rounded mb-3" alt="{{ landing_page.nombre_producto }}">
                                    {% else %}
                                        <div class="bg-light rounded d-flex align-items-center justify-content-center mb-3" style="height: 200px;">
                                            <i class="fas fa-image fa-3x text-muted"></i>
                                        </div>
                                    {% endif %}


                                    <hr/>


                                    <!-- KPIs Principales -->
                                    <div class="row text-center mb-4">
                                        <div class="col-6 col-md-3 mb-3">
                                            <div class="card h-100 shadow-sm">
                                                <div class="card-body text-center py-3">
                                                    <i class="fas fa-eye fa-2x text-primary mb-2"></i>
                                                    <div class="fw-bold text-primary h4 mb-0">{{ landing_page.total_views }}</div>
                                                    <small class="text-muted">Vistas Totales</small>
                                                </div>
                                            </div>
                                        </div>
                                        <div class="col-6 col-md-3 mb-3">
                                            <div class="card h-100 shadow-sm">
                                                <div class="card-body text-center py-3">
                                                    <i class="fas fa-paper-plane fa-2x text-success mb-2"></i>
                                                    <div class="fw-bold text-success h4 mb-0">{{ landing_page.total_submissions }}</div>
                                                    <small class="text-muted">Envíos Totales</small>
                                                </div>
                                            </div>
                                        </div>
                                        <div class="col-6 col-md-3 mb-3">
                                            <div class="card h-100 shadow-sm">
                                                <div class="card-body text-center py-3">
                                                    <i class="fas fa-calendar-plus fa-2x text-warning mb-2"></i>
                                                    <div class="fw-bold text-warning h4 mb-0">{{ landing_page.meeting_button_clicks }}</div>
                                                    <small class="text-muted">Clics Reunión</small>
                                                </div>
                                            </div>
                                        </div>
                                        <div class="col-6 col-md-3 mb-3">
                                            <div class="card h-100 shadow-sm">
                                                <div class="card-body text-center py-3">
                                                    <i class="fas fa-mouse-pointer fa-2x text-secondary mb-2"></i>
                                                    <div class="fw-bold text-secondary h4 mb-0">{{ landing_page.contact_button_clicks }}</div>
                                                    <small class="text-muted">Clics Contactar</small>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                    
                                    <!-- Tasas de Conversión -->
                                    <h6 class="mb-3 text-center"><i class="fas fa-chart-line me-2"></i>Tasas de Conversión</h6>
                                    <div class="row text-center">
                                        <div class="col-4">
                                            <div class="fw-bold text-info h5">{{ landing_page.conversion_rate|floatformat:1 }}%</div>
                                            <small class="text-muted">Tasa de Envío</small>
                                        </div>
                                        <div class="col-4">
                                            {% if landing_page.total_views > 0 %}
                                                {% widthratio landing_page.meeting_button_clicks landing_page.total_views 100 as meeting_click_rate %}
                                                <div class="fw-bold text-success h5">{{ meeting_click_rate|floatformat:1 }}%</div>
                                                <small class="text-muted">Tasa de Interés</small>
                                            {% else %}
                                                <div class="fw-bold text-muted h5">0%</div>
                                                <small class="text-muted">Tasa de Interés</small>
                                            {% endif %}
                                        </div>
                                        <div class="col-4">
                                            {% if landing_page.total_views > 0 %}
                                                {% widthratio landing_page.contact_button_clicks landing_page.total_views 100 as contact_click_rate %}
                                                <div class="fw-bold text-info h5">{{ contact_click_rate|floatformat:1 }}%</div>
                                                <small class="text-muted">Tasa de Contacto</small>
                                            {% else %}
                                                <div class="fw-bold text-muted h5">0%</div>
                                                <small class="text-muted">Tasa de Contacto</small>
                                            {% endif %}
                                        </div>
                                    </div>

                                </div>
                                
                            </div>
                        </div>
                    </div>
                    
                    <!-- Envíos Recientes -->
                    <div class="card">
                        <div class="card-header d-flex justify-content-between align-items-center">
                            <div>
                                <h5><i class="fas fa-clock text-warning"></i> Contactos Pendientes</h5>
                                <small class="text-muted">Solo se muestran los contactos que aún no han sido contactados</small>
                            </div>
                            <a href="{% url 'landing_page_submissions' landing_page.pk %}" class="btn btn-sm btn-outline-primary">
                                Ver Todos
                            </a>
                        </div>
                        <div class="card-body">
                            {% if submissions %}
                                <div class="table-responsive">
                                    <table class="table table-hover">
                                        <thead>
                                            <tr>
                                                <th>Contactado</th>
                                                <th>Nombre</th>
                                                <th>Email</th>
                                                <th>Teléfono</th>
                                                <th>Empresa</th>
                                                <th>Fecha</th>
                                                <th>Acciones</th>
                                            </tr>
                                        </thead>
                                        <tbody>
                                            {% for submission in submissions %}
                                                <tr id="submission-{{ submission.id }}">
                                                    <td class="text-center">
                                                        <input 
                                                            class="form-check-input submission-processed" 
                                                            type="checkbox" 
                                                            id="processed-{{ submission.id }}"
                                                            data-submission-id="{{ submission.id }}"
                                                            onchange="toggleProcessed(this, {{ submission.id }})">
                                                    </td>
                                                    <td>{{ submission.nombre }} {{ submission.apellido }}</td>
                                                    <td>
                                                        <a href="mailto:{{ submission.email }}">{{ submission.email }}</a>
                                                    </td>
                                                    <td>
                                                        {% if submission.telefono %}
                                                            <a href="tel:{{ submission.telefono }}">{{ submission.telefono }}</a>
                                                        {% else %}
                                                            <span class="text-muted">-</span>
                                                        {% endif %}
                                                    </td>
                                                    <td>{{ submission.empresa|default:"-" }}</td>
                                                    <td>
                                                        <span title="{{ submission.created_at }}">
                                                            {{ submission.created_at|timesince }} ago
                                                        </span>
                                                    </td>
                                                    <td>
                                                        <a href="{% url 'landing_page_submission_detail' submission.id %}" class="btn btn-outline-primary btn-sm" title="Ver detalle">
                                                            <i class="fas fa-eye"></i>
                                                        </a>
                                                    </td>
                                                </tr>
                                            {% endfor %}
                                        </tbody>
                                    </table>
                                </div>
                            {% else %}
                                <div class="text-center py-4">
                                    <i class="fas fa-check-circle fa-3x text-success mb-3"></i>
                                    <h5 class="text-success">¡Todos los contactos han sido contactados!</h5>
                                    <p class="text-muted">No hay contactos pendientes por contactar en este momento.</p>
                                    <a href="{% url 'landing_page_submissions' landing_page.pk %}" class="btn btn-outline-primary">
                                        Ver Todos los Contactos
                                    </a>
                                </div>
                            {% endif %}
                        </div>
                    </div>
                </div>
                
                <!-- Panel Lateral -->
                <div class="col-lg-4">
                    <!-- Acciones Rápidas -->
                    <div class="card mb-4">
                        <div class="card-header">
                            <h5><i class="fas fa-tools"></i> Acciones Rápidas</h5>
                        </div>
                        <div class="card-body">
                            <div class="d-grid gap-2">
                                <a href="{% url 'landing_page_public' landing_page.slug %}" class="btn btn-success" target="_blank">
                                    <i class="fas fa-globe"></i> Ver Landing Pública
                                </a>
                                <a href="{% url 'landing_page_edit' landing_page.pk %}" class="btn btn-outline-primary">
                                    <i class="fas fa-edit"></i> Editar Landing Page
                                </a>
                                <a href="{% url 'landing_page_submissions' landing_page.pk %}" class="btn btn-outline-info">
                                    <i class="fas fa-list"></i> Ver Todos los Envíos
                                </a>
                                <button class="btn btn-outline-warning" onclick="copyToClipboard('{{ request.build_absolute_uri }}{% url 'landing_page_public' landing_page.slug %}')">
                                    <i class="fas fa-copy"></i> Copiar URL
                                </button>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Información Técnica -->
                    <div class="card">
                        <div class="card-header">
                            <h5><i class="fas fa-info-circle"></i> Información</h5>
                        </div>
                        <div class="card-body">
                            <div class="mb-3">
                                <strong>Creado por:</strong><br>
                                <span class="text-muted">{{ landing_page.created_by.get_full_name|default:landing_page.created_by.username }}</span>
                            </div>
                            
                            <div class="mb-3">
                                <strong>Fecha de creación:</strong><br>
                                <span class="text-muted">{{ landing_page.created_at }}</span>
                            </div>
                            
                            <div class="mb-3">
                                <strong>Última actualización:</strong><br>
                                <span class="text-muted">{{ landing_page.updated_at }}</span>
                            </div>
                            
                            <div class="mb-3">
                                <strong>Slug:</strong><br>
                                <code>{{ landing_page.slug }}</code>
                            </div>
                            
                            <!-- Documentación de API para integraciones -->
                            <div class="card mb-3">
                                <div class="card-header">
                                    <h6 class="mb-0"><i class="fas fa-code"></i> API: Envío via JSON</h6>
                                </div>
                                <div class="card-body small">
                                    <p class="mb-2">Puedes enviar envíos (submissions) a esta landing mediante una petición <strong>POST</strong> en JSON.</p>
                                    <p class="mb-1"><strong>Endpoint:</strong></p>
                                    <pre class="p-2 bg-light rounded">{{ request.scheme }}://{{ request.get_host }}{% url 'landing_page_api_submit' landing_page.pk %}</pre>

                                    <div class="alert alert-warning py-2 px-3 mb-2">
                                        <strong><i class="fas fa-key"></i> Token de API:</strong>
                                        <code class="text-dark">{{ landing_page.api_token }}</code>
                                        <button class="btn btn-sm btn-outline-secondary ms-2" onclick="copyToClipboard('{{ landing_page.api_token }}')">
                                            <i class="fas fa-copy"></i>
                                        </button>
                                    </div>

                                    <p class="mb-1"><strong>Headers:</strong></p>
                                    <ul>
                                        <li><code>Content-Type: application/json</code></li>
                                        <li><code>Authorization: Bearer {{ landing_page.api_token }}</code></li>
                                    </ul>

                                    <p class="mb-1"><strong>Ejemplo (curl):</strong></p>
                                    <pre class="p-2 bg-dark text-white rounded">curl -X POST \
  -H "Content-Type: application/json" \
  -H "Authorization: Bearer {{ landing_page.api_token }}" \
  -d '{"nombre":"Juan","apellido":"Pérez","email":"juan@example.com","telefono":"+34123456789","empresa":"Mi Empresa","mensaje":"Interesado"}' \
  {{ request.scheme }}://{{ request.get_host }}{% url 'landing_page_api_submit' landing_page.pk %}</pre>

                                                <p class="mb-1"><strong>Ejemplo (Python - httpx):</strong></p>
                                    <pre class="p-2 bg-dark text-white rounded"># Requiere instalar: pip install httpx
import httpx

url = "{{ request.scheme }}://{{ request.get_host }}{% url 'landing_page_api_submit' landing_page.pk %}"
api_token = "{{ landing_page.api_token }}"

payload = {
    "nombre": "Juan",
    "apellido": "Pérez",
    "email": "juan@example.com",
    "telefono": "+34123456789",
    "empresa": "Mi Empresa",
    "cargo": "CTO",
    "mensaje": "Interesado",
    "utm_source": "newsletter",
    "utm_medium": "email",
    "utm_campaign": "campania_noviembre"
}

headers = {
    "Content-Type": "application/json",
    "Authorization": f"Bearer {api_token}"
}

with httpx.Client() as client:
    resp = client.post(url, json=payload, headers=headers)
    print(resp.status_code)
    print(resp.json())</pre>                                                                        <p class="mb-1"><strong>Ejemplo (Next.js - cliente):</strong></p>
                                    <pre class="p-2 bg-dark text-white rounded">// Ejemplo de componente React en Next.js (client-side)
import { useState } from 'react'

export default function SubmitExample() {
  const [result, setResult] = useState(null)
  const API_TOKEN = '{{ landing_page.api_token }}'

  async function handleSubmit() {
    const url = "{{ request.scheme }}://{{ request.get_host }}{% url 'landing_page_api_submit' landing_page.pk %}"
    const payload = {
      nombre: 'Juan',
      apellido: 'Pérez',
      email: 'juan@example.com',
      telefono: '+34123456789',
      empresa: 'Mi Empresa',
      cargo: 'CTO',
      mensaje: 'Interesado'
    }

    const res = await fetch(url, {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
        'Authorization': `Bearer ${API_TOKEN}`
      },
      body: JSON.stringify(payload)
    })

    const data = await res.json()
    setResult(data)
    console.log(data)
  }

  return (
    <div>
      <button onClick={handleSubmit} className="btn btn-primary btn-sm">Enviar Ejemplo</button>
      {result && <pre className="mt-2">{JSON.stringify(result, null, 2)}</pre>}
    </div>
  )
}
</pre>                                                                        <p class="mb-0 text-muted"><i class="fas fa-shield-alt text-warning me-1"></i> <strong>Seguridad:</strong> El endpoint requiere el token de API para autenticar las peticiones. Guarda el token de forma segura y nunca lo expongas en el código del cliente (frontend público). Úsalo solo en llamadas server-side o servicios backend seguros.</p>
                                            </div>
                                        </div>

                            {% if landing_page.total_views > 0 %}
                                <div class="mb-3">
                                    <strong>Mejor día:</strong><br>
                                    <span class="text-muted">Próximamente estadísticas avanzadas</span>
                                </div>
                            {% endif %}
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
function copyToClipboard(text) {
    navigator.clipboard.writeText(text).then(function() {
        // Mostrar mensaje de éxito con alert simple
        alert('URL copiada al portapapeles');
    }, function(err) {
        console.error('Error copiando al portapapeles: ', err);
        // Fallback para navegadores que no soportan navigator.clipboard
        const textArea = document.createElement("textarea");
        textArea.value = text;
        document.body.appendChild(textArea);
        textArea.focus();
        textArea.select();
        try {
            document.execCommand('copy');
            alert('URL copiada al portapapeles');
        } catch (err) {
            console.error('Fallback: Error copiando al portapapeles', err);
        }
        document.body.removeChild(textArea);
    });
}

        function toggleProcessed(checkbox, submissionId) {
            const isChecked = checkbox.checked;
            const csrfToken = document.querySelector('[name=csrfmiddlewaretoken]').value;
            
            // Mostrar indicador de carga
            checkbox.disabled = true;
            
            fetch(`/landing-pages/submissions/${submissionId}/toggle-processed/`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/x-www-form-urlencoded',
                    'X-CSRFToken': csrfToken,
                    'X-Requested-With': 'XMLHttpRequest',
                },
                body: `processed=${isChecked}`
            })
            .then(response => {
                if (!response.ok) {
                    return response.json().then(data => Promise.reject(data));
                }
                return response.json();
            })
            .then(data => {
                if (data.success) {
                    console.log('Estado actualizado:', data);
                    
                    const row = checkbox.closest('tr');
                    if (row) {
                        if (data.processed) {
                            // Si se marca como procesado, ocultar la fila con animación
                            row.style.transition = 'opacity 0.5s ease-out';
                            row.style.opacity = '0.5';
                            
                            setTimeout(() => {
                                row.style.display = 'none';
                                // Verificar si quedan filas en la tabla
                                const tbody = row.parentElement;
                                const remainingRows = tbody.querySelectorAll('tr:not([style*="display: none"])');
                                
                                if (remainingRows.length === 0) {
                                    // Si no quedan más filas, mostrar mensaje de "todos contactados"
                                    const tableContainer = tbody.closest('.table-responsive');
                                    if (tableContainer) {
                                        tableContainer.innerHTML = `
                                            <div class="text-center py-4">
                                                <i class="fas fa-check-circle fa-3x text-success mb-3"></i>
                                                <h5 class="text-success">¡Todos los contactos han sido contactados!</h5>
                                                <p class="text-muted">No hay contactos pendientes por contactar en este momento.</p>
                                                <a href="/landing-pages/${submissionId.split('/')[0]}/submissions/" class="btn btn-outline-primary">
                                                    Ver Todos los Contactos
                                                </a>
                                            </div>
                                        `;
                                    }
                                }
                            }, 500);
                        } else {
                            // Si se desmarca como procesado, hacer la fila visible de nuevo
                            row.style.display = '';
                            row.style.opacity = '1';
                            row.classList.remove('table-success');
                        }
                    }
                } else {
                    console.error('Error del servidor:', data.error);
                    alert('Error: ' + data.error);
                    checkbox.checked = !isChecked; // Revertir el estado
                }
            })
            .catch(error => {
                console.error('Error de conexión:', error);
                
                if (error.status === 401) {
                    alert('Error: Debe iniciar sesión para realizar esta acción.');
                    window.location.href = '/login/';
                } else if (error.status === 403) {
                    alert('Error: No tiene permisos para realizar esta acción.');
                } else if (error.error) {
                    alert('Error: ' + error.error);
                } else {
                    alert('Error de conexión: No se pudo conectar con el servidor');
                }
                
                checkbox.checked = !isChecked; // Revertir el estado
                
                // Revertir el color de la fila también
                const row = checkbox.closest('tr');
                if (row) {
                    if (!isChecked) {
                        row.classList.add('table-success');
                    } else {
                        row.classList.remove('table-success');
                    }
                }
            })
            .finally(() => {
                checkbox.disabled = false;
            });
        }
</script>
{% endblock %}