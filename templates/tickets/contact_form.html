{% extends 'base.html' %}
{% load project_extras %}

{% block title %}{% if contact %}Editar{% else %}Nuevo{% endif %} Contacto - TicketProo{% endblock %}

{% block content %}
<div class="container">
    <div class="row justify-content-center">
        <div class="col-md-8">
            <div class="card">
                <div class="card-header d-flex justify-content-between align-items-center">
                    <h4 class="mb-0">
                        <i class="bi bi-{% if contact %}pencil{% else %}plus-circle{% endif %} text-primary"></i>
                        {% if contact %}Editar Contacto{% else %}Nuevo Contacto{% endif %}
                    </h4>
                    {% if contact %}
                    <button type="button" class="btn btn-outline-primary btn-sm" onclick="enhanceContactWithAI()">
                        <i class="bi bi-robot"></i> Mejorar con IA
                    </button>
                    {% endif %}
                </div>
                <div class="card-body">
                    <form method="POST">
                        {% csrf_token %}
                        
                        <div class="row">
                            <div class="col-md-6 mb-3">
                                <label for="{{ form.name.id_for_label }}" class="form-label">
                                    <i class="bi bi-person"></i> {{ form.name.label }} *
                                </label>
                                {{ form.name }}
                                {% if form.name.errors %}
                                    <div class="text-danger small">{{ form.name.errors }}</div>
                                {% endif %}
                            </div>
                            <div class="col-md-6 mb-3">
                                <label for="{{ form.position.id_for_label }}" class="form-label">
                                    <i class="bi bi-briefcase"></i> {{ form.position.label }}
                                </label>
                                {{ form.position }}
                                {% if form.position.errors %}
                                    <div class="text-danger small">{{ form.position.errors }}</div>
                                {% endif %}
                            </div>
                        </div>

                        <div class="row">
                            <div class="col-md-6 mb-3">
                                <label for="{{ form.email.id_for_label }}" class="form-label">
                                    <i class="bi bi-envelope"></i> {{ form.email.label }}
                                </label>
                                {{ form.email }}
                                {% if form.email.errors %}
                                    <div class="text-danger small">{{ form.email.errors }}</div>
                                {% endif %}
                            </div>
                            <div class="col-md-6 mb-3">
                                <label for="{{ form.phone.id_for_label }}" class="form-label">
                                    <i class="bi bi-telephone"></i> {{ form.phone.label }}
                                </label>
                                {{ form.phone }}
                                {% if form.phone.errors %}
                                    <div class="text-danger small">{{ form.phone.errors }}</div>
                                {% endif %}
                            </div>
                        </div>

                        <div class="row">
                            <div class="col-md-6 mb-3">
                                <label for="{{ form.company.id_for_label }}" class="form-label">
                                    <i class="bi bi-building"></i> {{ form.company.label }}
                                </label>
                                {{ form.company }}
                                {% if form.company.errors %}
                                    <div class="text-danger small">{{ form.company.errors }}</div>
                                {% endif %}
                            </div>
                            <div class="col-md-6 mb-3">
                                <label for="{{ form.country.id_for_label }}" class="form-label">
                                    <i class="bi bi-globe"></i> {{ form.country.label }}
                                </label>
                                {{ form.country }}
                                {% if form.country.errors %}
                                    <div class="text-danger small">{{ form.country.errors }}</div>
                                {% endif %}
                            </div>
                        </div>

                        <div class="row">
                            <div class="col-md-6 mb-3">
                                <label for="{{ form.erp.id_for_label }}" class="form-label">
                                    <i class="bi bi-cpu"></i> {{ form.erp.label }}
                                </label>
                                {{ form.erp }}
                                {% if form.erp.errors %}
                                    <div class="text-danger small">{{ form.erp.errors }}</div>
                                {% endif %}
                                <small class="text-muted">Sistema ERP que utiliza (SAP, Odoo, Navision, etc.)</small>
                            </div>
                            <div class="col-md-6 mb-3">
                                <label for="{{ form.status.id_for_label }}" class="form-label">
                                    <i class="bi bi-flag"></i> {{ form.status.label }} *
                                </label>
                                {{ form.status }}
                                {% if form.status.errors %}
                                    <div class="text-danger small">{{ form.status.errors }}</div>
                                {% endif %}
                            </div>
                            <div class="col-md-6 mb-3">
                                <label for="{{ form.source.id_for_label }}" class="form-label">
                                    <i class="bi bi-arrow-down-circle"></i> {{ form.source.label }}
                                </label>
                                {{ form.source }}
                                {% if form.source.errors %}
                                    <div class="text-danger small">{{ form.source.errors }}</div>
                                {% endif %}
                            </div>
                        </div>

                        <div class="row">
                            <div class="col-md-6 mb-3">
                                <label for="{{ form.contact_date.id_for_label }}" class="form-label">
                                    <i class="bi bi-calendar-event"></i> {{ form.contact_date.label }} *
                                </label>
                                {{ form.contact_date }}
                                {% if form.contact_date.errors %}
                                    <div class="text-danger small">{{ form.contact_date.errors }}</div>
                                {% endif %}
                            </div>
                        </div>

                        <div class="row">
                            <div class="col-md-12 mb-3">
                                <label for="{{ form.notes.id_for_label }}" class="form-label">
                                    <i class="bi bi-sticky"></i> {{ form.notes.label }}
                                </label>
                                {{ form.notes }}
                                {% if form.notes.errors %}
                                    <div class="text-danger small">{{ form.notes.errors }}</div>
                                {% endif %}
                            </div>
                        </div>

                        <!-- Sección de Seguimiento de Contacto -->
                        <div class="card bg-light mb-3">
                            <div class="card-header">
                                <h6 class="mb-0">
                                    <i class="bi bi-telephone-forward text-success"></i> 
                                    Seguimiento de Contacto
                                </h6>
                            </div>
                            <div class="card-body">
                                <div class="row mb-3">
                                    <div class="col-md-6">
                                        <div class="form-check">
                                            {{ form.contacted_by_phone }}
                                            <label class="form-check-label" for="{{ form.contacted_by_phone.id_for_label }}">
                                                <i class="bi bi-telephone text-success"></i> {{ form.contacted_by_phone.label }}
                                            </label>
                                        </div>
                                        {% if form.contacted_by_phone.errors %}
                                            <div class="text-danger small">{{ form.contacted_by_phone.errors }}</div>
                                        {% endif %}
                                    </div>
                                    <div class="col-md-6">
                                        <div class="form-check">
                                            {{ form.contacted_by_web }}
                                            <label class="form-check-label" for="{{ form.contacted_by_web.id_for_label }}">
                                                <i class="bi bi-envelope text-primary"></i> {{ form.contacted_by_web.label }}
                                            </label>
                                        </div>
                                        {% if form.contacted_by_web.errors %}
                                            <div class="text-danger small">{{ form.contacted_by_web.errors }}</div>
                                        {% endif %}
                                    </div>
                                </div>

                                <div class="row mb-3">
                                    <div class="col-md-6">
                                        <div class="form-check">
                                            {{ form.had_meeting }}
                                            <label class="form-check-label" for="{{ form.had_meeting.id_for_label }}">
                                                <i class="bi bi-calendar-check text-purple"></i> {{ form.had_meeting.label }}
                                            </label>
                                        </div>
                                        {% if form.had_meeting.errors %}
                                            <div class="text-danger small">{{ form.had_meeting.errors }}</div>
                                        {% endif %}
                                    </div>
                                    <div class="col-md-6">
                                        <label for="{{ form.meeting_date.id_for_label }}" class="form-label">
                                            <i class="bi bi-calendar-event"></i> {{ form.meeting_date.label }}
                                        </label>
                                        {{ form.meeting_date }}
                                        {% if form.meeting_date.errors %}
                                            <div class="text-danger small">{{ form.meeting_date.errors }}</div>
                                        {% endif %}
                                    </div>
                                </div>

                                <div class="row mb-3">
                                    <div class="col-md-6">
                                        <label for="{{ form.last_contact_date.id_for_label }}" class="form-label">
                                            <i class="bi bi-calendar-check"></i> {{ form.last_contact_date.label }}
                                        </label>
                                        {{ form.last_contact_date }}
                                        {% if form.last_contact_date.errors %}
                                            <div class="text-danger small">{{ form.last_contact_date.errors }}</div>
                                        {% endif %}
                                    </div>
                                </div>

                                <div class="row">
                                    <div class="col-md-12">
                                        <label for="{{ form.contact_tracking_notes.id_for_label }}" class="form-label">
                                            <i class="bi bi-chat-dots"></i> {{ form.contact_tracking_notes.label }}
                                        </label>
                                        {{ form.contact_tracking_notes }}
                                        {% if form.contact_tracking_notes.errors %}
                                            <div class="text-danger small">{{ form.contact_tracking_notes.errors }}</div>
                                        {% endif %}
                                    </div>
                                </div>
                            </div>
                        </div>

                        <div class="d-flex justify-content-between">
                            <a href="{% if contact %}{% url 'contact_detail' contact.pk %}{% else %}{% url 'contact_list' %}{% endif %}" 
                               class="btn btn-secondary">
                                <i class="bi bi-arrow-left"></i> Cancelar
                            </a>
                            <button type="submit" class="btn btn-primary">
                                <i class="bi bi-check-circle"></i>
                                {% if contact %}Actualizar{% else %}Crear{% endif %} Contacto
                            </button>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Loading Modal -->
<div class="modal fade" id="loadingModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-body text-center">
                <div class="spinner-border text-primary" role="status">
                    <span class="visually-hidden">Cargando...</span>
                </div>
                <p class="mt-3 mb-0">Mejorando contacto con IA...</p>
                <small class="text-muted">Buscando información adicional basada en los datos existentes</small>
            </div>
        </div>
    </div>
</div>

<!-- Results Modal -->
<div class="modal fade" id="resultsModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-lg modal-dialog-centered modal-dialog-scrollable">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">
                    <i class="bi bi-robot text-primary me-2"></i>
                    Información Adicional Encontrada
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body" id="modalResults">
                <!-- Results will be loaded here -->
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                <button type="button" class="btn btn-primary" onclick="applyContactInfo()">
                    <i class="bi bi-check-lg me-2"></i>
                    Aplicar Mejoras
                </button>
            </div>
        </div>
    </div>
</div>

<script>
let currentContactData = null;

function showLoading() {
    const modal = new bootstrap.Modal(document.getElementById('loadingModal'));
    modal.show();
}

function hideLoading() {
    const modal = bootstrap.Modal.getInstance(document.getElementById('loadingModal'));
    if (modal) modal.hide();
}

function showResults(data) {
    currentContactData = data;
    
    let html = '<div class="alert alert-info">';
    html += '<i class="bi bi-info-circle me-2"></i>';
    html += 'La IA ha analizado los datos existentes y encontró la siguiente información adicional:';
    html += '</div>';
    
    html += '<div class="row">';
    
    // Información de contacto
    html += `
        <div class="col-md-6">
            <h6 class="text-primary"><i class="bi bi-person me-2"></i>Información Personal</h6>
            <table class="table table-sm">
                <tr><td><strong>Nombre Completo:</strong></td><td>${data.full_name || 'No disponible'}</td></tr>
                <tr><td><strong>Posición Sugerida:</strong></td><td>${data.position || 'No disponible'}</td></tr>
                <tr><td><strong>Título Profesional:</strong></td><td>${data.professional_title || 'No disponible'}</td></tr>
            </table>
        </div>
        
        <div class="col-md-6">
            <h6 class="text-primary"><i class="bi bi-envelope me-2"></i>Contacto</h6>
            <table class="table table-sm">
                <tr><td><strong>Email Profesional:</strong></td><td>${data.email || 'No disponible'}</td></tr>
                <tr><td><strong>Teléfono:</strong></td><td>${data.phone || 'No disponible'}</td></tr>
                <tr><td><strong>LinkedIn:</strong></td><td>${data.linkedin || 'No disponible'}</td></tr>
            </table>
        </div>
    `;
    
    // Información de la empresa
    if (data.company_info) {
        html += `
            <div class="col-12">
                <h6 class="text-primary"><i class="bi bi-building me-2"></i>Información de la Empresa</h6>
                <table class="table table-sm">
                    <tr><td><strong>Empresa:</strong></td><td>${data.company_info.name || 'No disponible'}</td></tr>
                    <tr><td><strong>Industria:</strong></td><td>${data.company_info.industry || 'No disponible'}</td></tr>
                    <tr><td><strong>Tamaño:</strong></td><td>${data.company_info.size || 'No disponible'}</td></tr>
                    <tr><td><strong>Ubicación:</strong></td><td>${data.company_info.location || 'No disponible'}</td></tr>
                </table>
            </div>
        `;
    }
    
    // Información adicional
    if (data.additional_info && data.additional_info !== 'No disponible') {
        html += `
            <div class="col-12">
                <h6 class="text-primary"><i class="bi bi-star me-2"></i>Información Adicional</h6>
                <div class="bg-light p-3 rounded">
                    ${data.additional_info}
                </div>
            </div>
        `;
    }
    
    // Sugerencias de notas
    if (data.suggested_notes && data.suggested_notes !== 'No disponible') {
        html += `
            <div class="col-12">
                <h6 class="text-primary"><i class="bi bi-lightbulb me-2"></i>Notas Sugeridas</h6>
                <div class="bg-warning bg-opacity-10 p-3 rounded border border-warning">
                    ${data.suggested_notes}
                </div>
            </div>
        `;
    }
    
    html += '</div>';
    
    document.getElementById('modalResults').innerHTML = html;
    
    const modal = new bootstrap.Modal(document.getElementById('resultsModal'));
    modal.show();
}

function enhanceContactWithAI() {
    // Recopilar los datos actuales del formulario
    const currentData = {
        name: document.getElementById('{{ form.name.id_for_label }}').value.trim(),
        email: document.getElementById('{{ form.email.id_for_label }}').value.trim(),
        phone: document.getElementById('{{ form.phone.id_for_label }}').value.trim(),
        position: document.getElementById('{{ form.position.id_for_label }}').value.trim(),
        company: document.getElementById('{{ form.company.id_for_label }}').value.trim(),
        notes: document.getElementById('{{ form.notes.id_for_label }}').value.trim()
    };
    
    // Verificar que tengamos al menos algo de información
    if (!currentData.name && !currentData.email && !currentData.company) {
        alert('Por favor completa al menos el nombre, email o empresa antes de usar la mejora con IA.');
        return;
    }
    
    if (!confirm('¿Deseas que la IA busque información adicional basada en los datos actuales del contacto?')) {
        return;
    }
    
    {% if not contact %}
    alert('La mejora con IA solo está disponible para contactos existentes. Primero guarda el contacto y luego podrás usar esta función.');
    return;
    {% endif %}
    
    showLoading();
    
    {% if contact and contact.id %}
    const enhanceUrl = `{% url 'enhance_contact_with_ai' contact.id %}`;
    
    fetch(enhanceUrl, {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value
        },
        body: JSON.stringify(currentData)
    })
    .then(response => response.json())
    .then(data => {
        hideLoading();
        if (data.success) {
            showResults(data.data);
        } else {
            alert('Error al mejorar contacto: ' + (data.error || 'Error desconocido'));
        }
    })
    .catch(error => {
        hideLoading();
        alert('Error de conexión: ' + error.message);
    });
    {% else %}
    // Esta línea nunca debería ejecutarse debido a la validación anterior
    alert('Error: No se puede mejorar un contacto sin ID');
    hideLoading();
    {% endif %}
}

function applyContactInfo() {
    if (!currentContactData) return;
    
    // Aplicar información a los campos del formulario solo si están vacíos o la nueva info es mejor
    if (currentContactData.position && currentContactData.position !== 'No disponible') {
        const currentPosition = document.getElementById('{{ form.position.id_for_label }}').value.trim();
        if (!currentPosition || currentContactData.position.length > currentPosition.length) {
            document.getElementById('{{ form.position.id_for_label }}').value = currentContactData.position;
        }
    }
    
    if (currentContactData.email && currentContactData.email !== 'No disponible') {
        const currentEmail = document.getElementById('{{ form.email.id_for_label }}').value.trim();
        if (!currentEmail) {
            document.getElementById('{{ form.email.id_for_label }}').value = currentContactData.email;
        }
    }
    
    if (currentContactData.phone && currentContactData.phone !== 'No disponible') {
        const currentPhone = document.getElementById('{{ form.phone.id_for_label }}').value.trim();
        if (!currentPhone) {
            document.getElementById('{{ form.phone.id_for_label }}').value = currentContactData.phone;
        }
    }
    
    if (currentContactData.company_info && currentContactData.company_info.name && currentContactData.company_info.name !== 'No disponible') {
        const currentCompany = document.getElementById('{{ form.company.id_for_label }}').value.trim();
        if (!currentCompany) {
            document.getElementById('{{ form.company.id_for_label }}').value = currentContactData.company_info.name;
        }
    }
    
    // Mejorar las notas agregando información adicional
    if (currentContactData.suggested_notes && currentContactData.suggested_notes !== 'No disponible') {
        const currentNotes = document.getElementById('{{ form.notes.id_for_label }}').value.trim();
        const additionalInfo = currentContactData.additional_info !== 'No disponible' ? currentContactData.additional_info : '';
        
        let newNotes = currentNotes;
        if (additionalInfo) {
            newNotes += (newNotes ? '\n\n' : '') + '--- Información encontrada por IA ---\n' + additionalInfo;
        }
        if (currentContactData.suggested_notes) {
            newNotes += (newNotes ? '\n\n' : '') + '--- Notas sugeridas por IA ---\n' + currentContactData.suggested_notes;
        }
        
        if (newNotes !== currentNotes) {
            document.getElementById('{{ form.notes.id_for_label }}').value = newNotes;
        }
    }
    
    // Cerrar modal
    const modal = bootstrap.Modal.getInstance(document.getElementById('resultsModal'));
    if (modal) modal.hide();
    
    // Mostrar notificación de éxito
    const alert = document.createElement('div');
    alert.className = 'alert alert-success alert-dismissible fade show mt-3';
    alert.innerHTML = `
        <i class="bi bi-check-circle"></i> Información del contacto mejorada exitosamente con IA
        <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
    `;
    document.querySelector('.card-body').insertBefore(alert, document.querySelector('form'));
    
    // Auto-hide after 5 seconds
    setTimeout(() => {
        if (alert.parentNode) alert.remove();
    }, 5000);
}

// Actualizar el indicador visual del estado
document.getElementById('{{ form.status.id_for_label }}').addEventListener('change', function() {
    const select = this;
    const parentDiv = select.closest('.mb-3');
    const label = parentDiv.querySelector('label');
    
    // Remover clases anteriores
    label.classList.remove('text-success', 'text-danger');
    
    // Agregar clase según el estado
    if (select.value === 'positive') {
        label.classList.add('text-success');
    } else if (select.value === 'negative') {
        label.classList.add('text-danger');
    }
});

// Ejecutar al cargar la página para estado inicial
document.addEventListener('DOMContentLoaded', function() {
    const statusSelect = document.getElementById('{{ form.status.id_for_label }}');
    if (statusSelect.value) {
        statusSelect.dispatchEvent(new Event('change'));
    }
    
    // Manejar campos de fecha por defecto
    initializeDateFields();
});

// Función para inicializar campos de fecha con valores por defecto
function initializeDateFields() {
    const contactDateField = document.getElementById('{{ form.contact_date.id_for_label }}');
    const lastContactDateField = document.getElementById('{{ form.last_contact_date.id_for_label }}');
    
    // Si los campos están vacíos, establecer fecha actual
    if (contactDateField && !contactDateField.value) {
        const now = new Date();
        const timestamp = now.getFullYear() + '-' + 
                        String(now.getMonth() + 1).padStart(2, '0') + '-' + 
                        String(now.getDate()).padStart(2, '0') + 'T' + 
                        String(now.getHours()).padStart(2, '0') + ':' + 
                        String(now.getMinutes()).padStart(2, '0');
        contactDateField.value = timestamp;
    }
    
    // Para el campo de último contacto, solo sugerir si ambos checkboxes están marcados
    if (lastContactDateField && !lastContactDateField.value) {
        const phoneChecked = document.getElementById('{{ form.contacted_by_phone.id_for_label }}').checked;
        const webChecked = document.getElementById('{{ form.contacted_by_web.id_for_label }}').checked;
        
        if (phoneChecked || webChecked) {
            const now = new Date();
            const timestamp = now.getFullYear() + '-' + 
                            String(now.getMonth() + 1).padStart(2, '0') + '-' + 
                            String(now.getDate()).padStart(2, '0') + 'T' + 
                            String(now.getHours()).padStart(2, '0') + ':' + 
                            String(now.getMinutes()).padStart(2, '0');
            lastContactDateField.value = timestamp;
        }
    }
}

// Actualizar fecha de último contacto cuando se marcan los checkboxes
document.getElementById('{{ form.contacted_by_phone.id_for_label }}').addEventListener('change', function() {
    updateLastContactDate();
});

document.getElementById('{{ form.contacted_by_web.id_for_label }}').addEventListener('change', function() {
    updateLastContactDate();
});

function updateLastContactDate() {
    const lastContactDateField = document.getElementById('{{ form.last_contact_date.id_for_label }}');
    const phoneChecked = document.getElementById('{{ form.contacted_by_phone.id_for_label }}').checked;
    const webChecked = document.getElementById('{{ form.contacted_by_web.id_for_label }}').checked;
    
    // Si se marca algún checkbox y no hay fecha, poner fecha actual
    if ((phoneChecked || webChecked) && !lastContactDateField.value) {
        const now = new Date();
        const timestamp = now.getFullYear() + '-' + 
                        String(now.getMonth() + 1).padStart(2, '0') + '-' + 
                        String(now.getDate()).padStart(2, '0') + 'T' + 
                        String(now.getHours()).padStart(2, '0') + ':' + 
                        String(now.getMinutes()).padStart(2, '0');
        lastContactDateField.value = timestamp;
    }
}
</script>
{% endblock %}