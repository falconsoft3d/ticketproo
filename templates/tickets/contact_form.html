{% extends 'base.html' %}
{% load project_extras %}

{% block title %}{% if contact %}Editar{% else %}Nuevo{% endif %} Contacto - TicketProo{% endblock %}

{% block content %}
<div class="container">
    <div class="row justify-content-center">
        <div class="col-md-8">
            <div class="card">
                <div class="card-header d-flex justify-content-between align-items-center">
                    <h4 class="mb-0">
                        <i class="bi bi-{% if contact %}pencil{% else %}plus-circle{% endif %} text-primary"></i>
                        {% if contact %}Editar Contacto{% else %}Nuevo Contacto{% endif %}
                    </h4>
                    <div class="d-flex gap-2">
                        <a href="{% url 'chatbot_list' %}" class="btn btn-outline-warning btn-sm" title="Gestión de Chatbots">
                            <i class="bi bi-robot"></i> Chatbots
                        </a>
                        {% if contact %}
                        <button type="button" class="btn btn-outline-primary btn-sm" onclick="enhanceContactWithAI()">
                            <i class="bi bi-stars"></i> Mejorar con IA
                        </button>
                        {% endif %}
                        <button type="submit" form="contactForm" class="btn btn-primary btn-sm">
                            <i class="bi bi-check-circle"></i> {% if contact %}Guardar Cambios{% else %}Crear Contacto{% endif %}
                        </button>
                    </div>
                </div>
                <div class="card-body">
                    <form method="POST" id="contactForm">
                        {% csrf_token %}
                        
                        <div class="row">
                            <div class="col-md-6 mb-3">
                                <label for="{{ form.name.id_for_label }}" class="form-label">
                                    <i class="bi bi-person"></i> {{ form.name.label }} *
                                </label>
                                {{ form.name }}
                                {% if form.name.errors %}
                                    <div class="text-danger small">{{ form.name.errors }}</div>
                                {% endif %}
                            </div>
                            <div class="col-md-6 mb-3">
                                <label for="{{ form.position.id_for_label }}" class="form-label">
                                    <i class="bi bi-briefcase"></i> {{ form.position.label }}
                                </label>
                                {{ form.position }}
                                {% if form.position.errors %}
                                    <div class="text-danger small">{{ form.position.errors }}</div>
                                {% endif %}
                            </div>
                        </div>

                        <div class="row">
                            <div class="col-md-6 mb-3">
                                <label for="{{ form.email.id_for_label }}" class="form-label">
                                    <i class="bi bi-envelope"></i> {{ form.email.label }}
                                </label>
                                {{ form.email }}
                                {% if form.email.errors %}
                                    <div class="text-danger small">{{ form.email.errors }}</div>
                                {% endif %}
                            </div>
                            <div class="col-md-6 mb-3">
                                <label for="{{ form.phone.id_for_label }}" class="form-label">
                                    <i class="bi bi-telephone"></i> {{ form.phone.label }}
                                </label>
                                {{ form.phone }}
                                {% if form.phone.errors %}
                                    <div class="text-danger small">{{ form.phone.errors }}</div>
                                {% endif %}
                            </div>
                        </div>

                        <div class="row">
                            <div class="col-md-6 mb-3">
                                <label for="{{ form.company.id_for_label }}" class="form-label">
                                    <i class="bi bi-building"></i> {{ form.company.label }}
                                </label>
                                {{ form.company }}
                                {% if form.company.errors %}
                                    <div class="text-danger small">{{ form.company.errors }}</div>
                                {% endif %}
                            </div>
                            <div class="col-md-6 mb-3">
                                <label for="{{ form.country.id_for_label }}" class="form-label">
                                    <i class="bi bi-globe"></i> {{ form.country.label }}
                                </label>
                                {{ form.country }}
                                {% if form.country.errors %}
                                    <div class="text-danger small">{{ form.country.errors }}</div>
                                {% endif %}
                            </div>
                        </div>

                        <div class="row">
                            <div class="col-md-6 mb-3">
                                <label for="{{ form.erp.id_for_label }}" class="form-label">
                                    <i class="bi bi-cpu"></i> {{ form.erp.label }}
                                </label>
                                {{ form.erp }}
                                {% if form.erp.errors %}
                                    <div class="text-danger small">{{ form.erp.errors }}</div>
                                {% endif %}
                                <small class="text-muted">Sistema ERP que utiliza (SAP, Odoo, Navision, etc.)</small>
                            </div>
                            <div class="col-md-6 mb-3">
                                <label for="{{ form.status.id_for_label }}" class="form-label">
                                    <i class="bi bi-flag"></i> {{ form.status.label }} *
                                </label>
                                {{ form.status }}
                                {% if form.status.errors %}
                                    <div class="text-danger small">{{ form.status.errors }}</div>
                                {% endif %}
                            </div>
                        </div>

                        <div class="row">
                            <div class="col-md-6 mb-3">
                                <label for="{{ form.source.id_for_label }}" class="form-label">
                                    <i class="bi bi-arrow-down-circle"></i> {{ form.source.label }}
                                </label>
                                {{ form.source }}
                                {% if form.source.errors %}
                                    <div class="text-danger small">{{ form.source.errors }}</div>
                                {% endif %}
                                <small class="text-muted">Se usa la última fuente de tus contactos</small>
                            </div>
                            <div class="col-md-6 mb-3">
                                <label for="{{ form.company_size.id_for_label }}" class="form-label">
                                    <i class="bi bi-building"></i> {{ form.company_size.label }}
                                </label>
                                {{ form.company_size }}
                                {% if form.company_size.errors %}
                                    <div class="text-danger small">{{ form.company_size.errors }}</div>
                                {% endif %}
                                <small class="text-muted">Por defecto: Pequeña</small>
                            </div>
                        </div>

                        <div class="row">
                            <div class="col-md-6 mb-3">
                                <label for="{{ form.assigned_to.id_for_label }}" class="form-label">
                                    <i class="bi bi-person-badge"></i> {{ form.assigned_to.label }}
                                </label>
                                {{ form.assigned_to }}
                                {% if form.assigned_to.errors %}
                                    <div class="text-danger small">{{ form.assigned_to.errors }}</div>
                                {% endif %}
                                <small class="text-muted">Usuario responsable del contacto</small>
                            </div>
                            <div class="col-md-6 mb-3">
                                <label for="{{ form.contact_date.id_for_label }}" class="form-label">
                                    <i class="bi bi-calendar-event"></i> {{ form.contact_date.label }} *
                                </label>
                                {{ form.contact_date }}
                                {% if form.contact_date.errors %}
                                    <div class="text-danger small">{{ form.contact_date.errors }}</div>
                                {% endif %}
                            </div>
                        </div>

                        <div class="row">
                            <div class="col-md-12 mb-3">
                                <label class="form-label">
                                    <i class="bi bi-tags"></i> Etiquetas
                                </label>
                                <div id="tags-container" class="border rounded p-3" style="min-height: 60px; background-color: #f8f9fa;">
                                    <div id="selected-tags" class="d-flex flex-wrap gap-2 mb-2">
                                        {% if contact.tags.all %}
                                            {% for tag in contact.tags.all %}
                                                <span class="badge" style="background-color: {{ tag.color }}; font-size: 0.9rem; padding: 6px 10px; cursor: pointer;" 
                                                      data-tag-id="{{ tag.id }}" onclick="removeTag({{ tag.id }})">
                                                    {{ tag.name }}
                                                    <i class="bi bi-x ms-1"></i>
                                                </span>
                                            {% endfor %}
                                        {% endif %}
                                    </div>
                                    <div class="input-group input-group-sm">
                                        <input type="text" id="tag-search" class="form-control" placeholder="Buscar o crear etiqueta..." autocomplete="off">
                                        <button type="button" class="btn btn-outline-secondary" onclick="toggleTagDropdown()">
                                            <i class="bi bi-chevron-down"></i>
                                        </button>
                                    </div>
                                    <div id="tag-dropdown" class="dropdown-menu w-100" style="display: none; max-height: 250px; overflow-y: auto;">
                                        <div id="tag-list">
                                            {% for tag in form.tags.field.queryset %}
                                                <a class="dropdown-item tag-option" href="#" data-tag-id="{{ tag.id }}" data-tag-name="{{ tag.name }}" data-tag-color="{{ tag.color }}" onclick="selectTag(event, {{ tag.id }}, '{{ tag.name }}', '{{ tag.color }}')">
                                                    <span class="badge me-2" style="background-color: {{ tag.color }};">{{ tag.name }}</span>
                                                </a>
                                            {% endfor %}
                                        </div>
                                        <div class="dropdown-divider"></div>
                                        <a class="dropdown-item text-primary" href="#" onclick="showCreateTagForm(event)">
                                            <i class="bi bi-plus-circle me-2"></i>Crear nueva etiqueta
                                        </a>
                                    </div>
                                </div>
                                <!-- Hidden input para enviar las etiquetas seleccionadas -->
                                <select id="id_tags" name="tags" multiple style="display: none;">
                                    {% if contact.tags.all %}
                                        {% for tag in contact.tags.all %}
                                            <option value="{{ tag.id }}" selected>{{ tag.name }}</option>
                                        {% endfor %}
                                    {% endif %}
                                </select>
                                <small class="text-muted d-block mt-1">
                                    <i class="bi bi-info-circle"></i> 
                                    Selecciona etiquetas para categorizar este contacto o crea nuevas
                                </small>
                            </div>
                        </div>

                        <div class="row">
                            <div class="col-md-12 mb-3">
                                <label for="{{ form.notes.id_for_label }}" class="form-label">
                                    <i class="bi bi-sticky"></i> {{ form.notes.label }}
                                </label>
                                
                                <!-- Botones de Notas Rápidas -->
                                <div class="mb-2">
                                    <small class="text-muted d-block mb-1">Notas rápidas:</small>
                                    <div class="btn-group btn-group-sm flex-wrap" role="group">
                                        <button type="button" class="btn btn-outline-info quick-note-btn" data-note="Información enviada por correo">
                                            <i class="bi bi-envelope-check"></i> Info por correo
                                        </button>
                                        <button type="button" class="btn btn-outline-warning quick-note-btn" data-note="No interesado">
                                            <i class="bi bi-hand-thumbs-down"></i> No interesado
                                        </button>
                                        <button type="button" class="btn btn-outline-secondary quick-note-btn" data-note="No contesta el teléfono, le mandé la info por email">
                                            <i class="bi bi-phone-x"></i> No contesta, info enviada
                                        </button>
                                        <button type="button" class="btn btn-outline-danger quick-note-btn" data-note="No contesta">
                                            <i class="bi bi-telephone-x"></i> No contesta
                                        </button>
                                    </div>
                                </div>
                                
                                {{ form.notes }}
                                {% if form.notes.errors %}
                                    <div class="text-danger small">{{ form.notes.errors }}</div>
                                {% endif %}
                            </div>
                        </div>

                        <!-- Sección de Redes Sociales y Web -->
                        <div class="card bg-light mb-3">
                            <div class="card-header d-flex justify-content-between align-items-center">
                                <h6 class="mb-0">
                                    <i class="bi bi-globe text-primary"></i> 
                                    Redes Sociales y Web
                                </h6>
                                <button type="button" class="btn btn-sm btn-primary" onclick="autoCompleteWithAI()" id="aiCompleteBtn">
                                    <i class="bi bi-magic"></i> Completar con IA
                                </button>
                            </div>
                            <div class="card-body">
                                <div class="row mb-3">
                                    <div class="col-md-6">
                                        <label for="{{ form.website.id_for_label }}" class="form-label">
                                            <i class="bi bi-globe2"></i> {{ form.website.label }}
                                        </label>
                                        {{ form.website }}
                                        {% if form.website.errors %}
                                            <div class="text-danger small">{{ form.website.errors }}</div>
                                        {% endif %}
                                    </div>
                                    <div class="col-md-6">
                                        <label for="{{ form.linkedin_url.id_for_label }}" class="form-label">
                                            <i class="bi bi-linkedin text-primary"></i> {{ form.linkedin_url.label }}
                                        </label>
                                        {{ form.linkedin_url }}
                                        {% if form.linkedin_url.errors %}
                                            <div class="text-danger small">{{ form.linkedin_url.errors }}</div>
                                        {% endif %}
                                    </div>
                                </div>

                                <div class="row mb-3">
                                    <div class="col-md-6">
                                        <label for="{{ form.facebook_url.id_for_label }}" class="form-label">
                                            <i class="bi bi-facebook text-primary"></i> {{ form.facebook_url.label }}
                                        </label>
                                        {{ form.facebook_url }}
                                        {% if form.facebook_url.errors %}
                                            <div class="text-danger small">{{ form.facebook_url.errors }}</div>
                                        {% endif %}
                                    </div>
                                    <div class="col-md-6">
                                        <label for="{{ form.twitter_url.id_for_label }}" class="form-label">
                                            <i class="bi bi-twitter text-info"></i> {{ form.twitter_url.label }}
                                        </label>
                                        {{ form.twitter_url }}
                                        {% if form.twitter_url.errors %}
                                            <div class="text-danger small">{{ form.twitter_url.errors }}</div>
                                        {% endif %}
                                    </div>
                                </div>

                                <div class="row mb-3">
                                    <div class="col-md-4">
                                        <label for="{{ form.instagram_url.id_for_label }}" class="form-label">
                                            <i class="bi bi-instagram text-danger"></i> {{ form.instagram_url.label }}
                                        </label>
                                        {{ form.instagram_url }}
                                        {% if form.instagram_url.errors %}
                                            <div class="text-danger small">{{ form.instagram_url.errors }}</div>
                                        {% endif %}
                                    </div>
                                    <div class="col-md-4">
                                        <label for="{{ form.youtube_url.id_for_label }}" class="form-label">
                                            <i class="bi bi-youtube text-danger"></i> {{ form.youtube_url.label }}
                                        </label>
                                        {{ form.youtube_url }}
                                        {% if form.youtube_url.errors %}
                                            <div class="text-danger small">{{ form.youtube_url.errors }}</div>
                                        {% endif %}
                                    </div>
                                    <div class="col-md-4">
                                        <label for="{{ form.tiktok_url.id_for_label }}" class="form-label">
                                            <i class="bi bi-tiktok text-dark"></i> {{ form.tiktok_url.label }}
                                        </label>
                                        {{ form.tiktok_url }}
                                        {% if form.tiktok_url.errors %}
                                            <div class="text-danger small">{{ form.tiktok_url.errors }}</div>
                                        {% endif %}
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Sección de Seguimiento de Contacto -->
                        <div class="card bg-light mb-3">
                            <div class="card-header">
                                <h6 class="mb-0">
                                    <i class="bi bi-telephone-forward text-success"></i> 
                                    Seguimiento de Contacto
                                </h6>
                            </div>
                            <div class="card-body">
                                <div class="row mb-3">
                                    <div class="col-md-6">
                                        <div class="form-check">
                                            {{ form.contacted_by_phone }}
                                            <label class="form-check-label" for="{{ form.contacted_by_phone.id_for_label }}">
                                                <i class="bi bi-telephone text-success"></i> {{ form.contacted_by_phone.label }}
                                            </label>
                                        </div>
                                        {% if form.contacted_by_phone.errors %}
                                            <div class="text-danger small">{{ form.contacted_by_phone.errors }}</div>
                                        {% endif %}
                                    </div>
                                    <div class="col-md-6">
                                        <div class="form-check">
                                            {{ form.contacted_by_web }}
                                            <label class="form-check-label" for="{{ form.contacted_by_web.id_for_label }}">
                                                <i class="bi bi-envelope text-primary"></i> {{ form.contacted_by_web.label }}
                                            </label>
                                        </div>
                                        {% if form.contacted_by_web.errors %}
                                            <div class="text-danger small">{{ form.contacted_by_web.errors }}</div>
                                        {% endif %}
                                    </div>
                                </div>

                                <div class="row mb-3">
                                    <div class="col-md-6">
                                        <div class="form-check">
                                            {{ form.had_meeting }}
                                            <label class="form-check-label" for="{{ form.had_meeting.id_for_label }}">
                                                <i class="bi bi-calendar-check text-purple"></i> {{ form.had_meeting.label }}
                                            </label>
                                        </div>
                                        {% if form.had_meeting.errors %}
                                            <div class="text-danger small">{{ form.had_meeting.errors }}</div>
                                        {% endif %}
                                    </div>
                                    <div class="col-md-6">
                                        <label for="{{ form.meeting_date.id_for_label }}" class="form-label">
                                            <i class="bi bi-calendar-event"></i> {{ form.meeting_date.label }}
                                        </label>
                                        {{ form.meeting_date }}
                                        {% if form.meeting_date.errors %}
                                            <div class="text-danger small">{{ form.meeting_date.errors }}</div>
                                        {% endif %}
                                    </div>
                                </div>

                                <div class="row mb-3">
                                    <div class="col-md-6">
                                        <label for="{{ form.last_contact_date.id_for_label }}" class="form-label">
                                            <i class="bi bi-calendar-check"></i> {{ form.last_contact_date.label }}
                                        </label>
                                        {{ form.last_contact_date }}
                                        {% if form.last_contact_date.errors %}
                                            <div class="text-danger small">{{ form.last_contact_date.errors }}</div>
                                        {% endif %}
                                    </div>
                                </div>

                                <div class="row">
                                    <div class="col-md-12">
                                        <label for="{{ form.contact_tracking_notes.id_for_label }}" class="form-label">
                                            <i class="bi bi-chat-dots"></i> {{ form.contact_tracking_notes.label }}
                                        </label>
                                        {{ form.contact_tracking_notes }}
                                        {% if form.contact_tracking_notes.errors %}
                                            <div class="text-danger small">{{ form.contact_tracking_notes.errors }}</div>
                                        {% endif %}
                                    </div>
                                </div>
                            </div>
                        </div>

                        <div class="d-flex justify-content-between">
                            <a href="{% if contact %}{% url 'contact_detail' contact.pk %}{% else %}{% url 'contact_list' %}{% endif %}" 
                               class="btn btn-secondary">
                                <i class="bi bi-arrow-left"></i> Cancelar
                            </a>
                            <button type="submit" class="btn btn-primary">
                                <i class="bi bi-check-circle"></i>
                                {% if contact %}Actualizar{% else %}Crear{% endif %} Contacto
                            </button>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Loading Modal -->
<div class="modal fade" id="loadingModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-body text-center">
                <div class="spinner-border text-primary" role="status">
                    <span class="visually-hidden">Cargando...</span>
                </div>
                <p class="mt-3 mb-0">Mejorando contacto con IA...</p>
                <small class="text-muted">Buscando información adicional basada en los datos existentes</small>
            </div>
        </div>
    </div>
</div>

<!-- Results Modal -->
<div class="modal fade" id="resultsModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-lg modal-dialog-centered modal-dialog-scrollable">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">
                    <i class="bi bi-robot text-primary me-2"></i>
                    Información Adicional Encontrada
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body" id="modalResults">
                <!-- Results will be loaded here -->
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                <button type="button" class="btn btn-primary" onclick="applyContactInfo()">
                    <i class="bi bi-check-lg me-2"></i>
                    Aplicar Mejoras
                </button>
            </div>
        </div>
    </div>
</div>

<script>
let currentContactData = null;

function showLoading() {
    const modal = new bootstrap.Modal(document.getElementById('loadingModal'));
    modal.show();
}

function hideLoading() {
    const modal = bootstrap.Modal.getInstance(document.getElementById('loadingModal'));
    if (modal) modal.hide();
}

function showResults(data) {
    currentContactData = data;
    
    let html = '<div class="alert alert-info">';
    html += '<i class="bi bi-info-circle me-2"></i>';
    html += 'La IA ha analizado los datos existentes y encontró la siguiente información adicional:';
    html += '</div>';
    
    html += '<div class="row">';
    
    // Información de contacto
    html += `
        <div class="col-md-6">
            <h6 class="text-primary"><i class="bi bi-person me-2"></i>Información Personal</h6>
            <table class="table table-sm">
                <tr><td><strong>Nombre Completo:</strong></td><td>${data.full_name || 'No disponible'}</td></tr>
                <tr><td><strong>Posición Sugerida:</strong></td><td>${data.position || 'No disponible'}</td></tr>
                <tr><td><strong>Título Profesional:</strong></td><td>${data.professional_title || 'No disponible'}</td></tr>
            </table>
        </div>
        
        <div class="col-md-6">
            <h6 class="text-primary"><i class="bi bi-envelope me-2"></i>Contacto</h6>
            <table class="table table-sm">
                <tr><td><strong>Email Profesional:</strong></td><td>${data.email || 'No disponible'}</td></tr>
                <tr><td><strong>Teléfono:</strong></td><td>${data.phone || 'No disponible'}</td></tr>
                <tr><td><strong>LinkedIn:</strong></td><td>${data.linkedin || 'No disponible'}</td></tr>
            </table>
        </div>
    `;
    
    // Información de la empresa
    if (data.company_info) {
        html += `
            <div class="col-12">
                <h6 class="text-primary"><i class="bi bi-building me-2"></i>Información de la Empresa</h6>
                <table class="table table-sm">
                    <tr><td><strong>Empresa:</strong></td><td>${data.company_info.name || 'No disponible'}</td></tr>
                    <tr><td><strong>Industria:</strong></td><td>${data.company_info.industry || 'No disponible'}</td></tr>
                    <tr><td><strong>Tamaño:</strong></td><td>${data.company_info.size || 'No disponible'}</td></tr>
                    <tr><td><strong>Ubicación:</strong></td><td>${data.company_info.location || 'No disponible'}</td></tr>
                </table>
            </div>
        `;
    }
    
    // Información adicional
    if (data.additional_info && data.additional_info !== 'No disponible') {
        html += `
            <div class="col-12">
                <h6 class="text-primary"><i class="bi bi-star me-2"></i>Información Adicional</h6>
                <div class="bg-light p-3 rounded">
                    ${data.additional_info}
                </div>
            </div>
        `;
    }
    
    // Sugerencias de notas
    if (data.suggested_notes && data.suggested_notes !== 'No disponible') {
        html += `
            <div class="col-12">
                <h6 class="text-primary"><i class="bi bi-lightbulb me-2"></i>Notas Sugeridas</h6>
                <div class="bg-warning bg-opacity-10 p-3 rounded border border-warning">
                    ${data.suggested_notes}
                </div>
            </div>
        `;
    }
    
    html += '</div>';
    
    document.getElementById('modalResults').innerHTML = html;
    
    const modal = new bootstrap.Modal(document.getElementById('resultsModal'));
    modal.show();
}

function enhanceContactWithAI() {
    // Recopilar los datos actuales del formulario
    const currentData = {
        name: document.getElementById('{{ form.name.id_for_label }}').value.trim(),
        email: document.getElementById('{{ form.email.id_for_label }}').value.trim(),
        phone: document.getElementById('{{ form.phone.id_for_label }}').value.trim(),
        position: document.getElementById('{{ form.position.id_for_label }}').value.trim(),
        company: document.getElementById('{{ form.company.id_for_label }}').value.trim(),
        notes: document.getElementById('{{ form.notes.id_for_label }}').value.trim()
    };
    
    // Verificar que tengamos al menos algo de información
    if (!currentData.name && !currentData.email && !currentData.company) {
        alert('Por favor completa al menos el nombre, email o empresa antes de usar la mejora con IA.');
        return;
    }
    
    if (!confirm('¿Deseas que la IA busque información adicional basada en los datos actuales del contacto?')) {
        return;
    }
    
    {% if not contact %}
    alert('La mejora con IA solo está disponible para contactos existentes. Primero guarda el contacto y luego podrás usar esta función.');
    return;
    {% endif %}
    
    showLoading();
    
    {% if contact and contact.id %}
    const enhanceUrl = `{% url 'enhance_contact_with_ai' contact.id %}`;
    
    fetch(enhanceUrl, {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value
        },
        body: JSON.stringify(currentData)
    })
    .then(response => response.json())
    .then(data => {
        hideLoading();
        if (data.success) {
            showResults(data.data);
        } else {
            alert('Error al mejorar contacto: ' + (data.error || 'Error desconocido'));
        }
    })
    .catch(error => {
        hideLoading();
        alert('Error de conexión: ' + error.message);
    });
    {% else %}
    // Esta línea nunca debería ejecutarse debido a la validación anterior
    alert('Error: No se puede mejorar un contacto sin ID');
    hideLoading();
    {% endif %}
}

function applyContactInfo() {
    if (!currentContactData) return;
    
    // Aplicar información a los campos del formulario solo si están vacíos o la nueva info es mejor
    if (currentContactData.position && currentContactData.position !== 'No disponible') {
        const currentPosition = document.getElementById('{{ form.position.id_for_label }}').value.trim();
        if (!currentPosition || currentContactData.position.length > currentPosition.length) {
            document.getElementById('{{ form.position.id_for_label }}').value = currentContactData.position;
        }
    }
    
    if (currentContactData.email && currentContactData.email !== 'No disponible') {
        const currentEmail = document.getElementById('{{ form.email.id_for_label }}').value.trim();
        if (!currentEmail) {
            document.getElementById('{{ form.email.id_for_label }}').value = currentContactData.email;
        }
    }
    
    if (currentContactData.phone && currentContactData.phone !== 'No disponible') {
        const currentPhone = document.getElementById('{{ form.phone.id_for_label }}').value.trim();
        if (!currentPhone) {
            document.getElementById('{{ form.phone.id_for_label }}').value = currentContactData.phone;
        }
    }
    
    if (currentContactData.company_info && currentContactData.company_info.name && currentContactData.company_info.name !== 'No disponible') {
        const currentCompany = document.getElementById('{{ form.company.id_for_label }}').value.trim();
        if (!currentCompany) {
            document.getElementById('{{ form.company.id_for_label }}').value = currentContactData.company_info.name;
        }
    }
    
    // Mejorar las notas agregando información adicional
    if (currentContactData.suggested_notes && currentContactData.suggested_notes !== 'No disponible') {
        const currentNotes = document.getElementById('{{ form.notes.id_for_label }}').value.trim();
        const additionalInfo = currentContactData.additional_info !== 'No disponible' ? currentContactData.additional_info : '';
        
        let newNotes = currentNotes;
        if (additionalInfo) {
            newNotes += (newNotes ? '\n\n' : '') + '--- Información encontrada por IA ---\n' + additionalInfo;
        }
        if (currentContactData.suggested_notes) {
            newNotes += (newNotes ? '\n\n' : '') + '--- Notas sugeridas por IA ---\n' + currentContactData.suggested_notes;
        }
        
        if (newNotes !== currentNotes) {
            document.getElementById('{{ form.notes.id_for_label }}').value = newNotes;
        }
    }
    
    // Cerrar modal
    const modal = bootstrap.Modal.getInstance(document.getElementById('resultsModal'));
    if (modal) modal.hide();
    
    // Mostrar notificación de éxito
    const alert = document.createElement('div');
    alert.className = 'alert alert-success alert-dismissible fade show mt-3';
    alert.innerHTML = `
        <i class="bi bi-check-circle"></i> Información del contacto mejorada exitosamente con IA
        <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
    `;
    document.querySelector('.card-body').insertBefore(alert, document.querySelector('form'));
    
    // Auto-hide after 5 seconds
    setTimeout(() => {
        if (alert.parentNode) alert.remove();
    }, 5000);
}

// Actualizar el indicador visual del estado
document.getElementById('{{ form.status.id_for_label }}').addEventListener('change', function() {
    const select = this;
    const parentDiv = select.closest('.mb-3');
    const label = parentDiv.querySelector('label');
    
    // Remover clases anteriores
    label.classList.remove('text-success', 'text-danger', 'text-warning');
    
    // Agregar clase según el estado
    if (select.value === 'positive') {
        label.classList.add('text-success');
    } else if (select.value === 'negative') {
        label.classList.add('text-danger');
    } else if (select.value === 'not_now') {
        label.classList.add('text-warning');
    }
});

// Ejecutar al cargar la página para estado inicial
document.addEventListener('DOMContentLoaded', function() {
    const statusSelect = document.getElementById('{{ form.status.id_for_label }}');
    if (statusSelect.value) {
        statusSelect.dispatchEvent(new Event('change'));
    }
    
    // Manejar campos de fecha por defecto
    initializeDateFields();
});

// Función para inicializar campos de fecha con valores por defecto
function initializeDateFields() {
    const contactDateField = document.getElementById('{{ form.contact_date.id_for_label }}');
    const lastContactDateField = document.getElementById('{{ form.last_contact_date.id_for_label }}');
    
    // Si los campos están vacíos, establecer fecha actual
    if (contactDateField && !contactDateField.value) {
        const now = new Date();
        const timestamp = now.getFullYear() + '-' + 
                        String(now.getMonth() + 1).padStart(2, '0') + '-' + 
                        String(now.getDate()).padStart(2, '0') + 'T' + 
                        String(now.getHours()).padStart(2, '0') + ':' + 
                        String(now.getMinutes()).padStart(2, '0');
        contactDateField.value = timestamp;
    }
    
    // Para el campo de último contacto, solo sugerir si ambos checkboxes están marcados
    if (lastContactDateField && !lastContactDateField.value) {
        const phoneChecked = document.getElementById('{{ form.contacted_by_phone.id_for_label }}').checked;
        const webChecked = document.getElementById('{{ form.contacted_by_web.id_for_label }}').checked;
        
        if (phoneChecked || webChecked) {
            const now = new Date();
            const timestamp = now.getFullYear() + '-' + 
                            String(now.getMonth() + 1).padStart(2, '0') + '-' + 
                            String(now.getDate()).padStart(2, '0') + 'T' + 
                            String(now.getHours()).padStart(2, '0') + ':' + 
                            String(now.getMinutes()).padStart(2, '0');
            lastContactDateField.value = timestamp;
        }
    }
}

// Actualizar fecha de último contacto cuando se marcan los checkboxes
document.getElementById('{{ form.contacted_by_phone.id_for_label }}').addEventListener('change', function() {
    updateLastContactDate();
});

document.getElementById('{{ form.contacted_by_web.id_for_label }}').addEventListener('change', function() {
    updateLastContactDate();
});

function updateLastContactDate() {
    const lastContactDateField = document.getElementById('{{ form.last_contact_date.id_for_label }}');
    const phoneChecked = document.getElementById('{{ form.contacted_by_phone.id_for_label }}').checked;
    const webChecked = document.getElementById('{{ form.contacted_by_web.id_for_label }}').checked;
    
    // Si se marca algún checkbox y no hay fecha, poner fecha actual
    if ((phoneChecked || webChecked) && !lastContactDateField.value) {
        const now = new Date();
        const timestamp = now.getFullYear() + '-' + 
                        String(now.getMonth() + 1).padStart(2, '0') + '-' + 
                        String(now.getDate()).padStart(2, '0') + 'T' + 
                        String(now.getHours()).padStart(2, '0') + ':' + 
                        String(now.getMinutes()).padStart(2, '0');
        lastContactDateField.value = timestamp;
    }
}

// Funcionalidad de botones de notas rápidas
document.querySelectorAll('.quick-note-btn').forEach(function(button) {
    button.addEventListener('click', function() {
        const noteText = this.getAttribute('data-note');
        const notesField = document.getElementById('{{ form.notes.id_for_label }}');
        const currentValue = notesField.value.trim();
        
        // Obtener fecha y hora actual formateada
        const now = new Date();
        const dateStr = String(now.getDate()).padStart(2, '0') + '/' + 
                       String(now.getMonth() + 1).padStart(2, '0') + '/' + 
                       now.getFullYear() + ' ' +
                       String(now.getHours()).padStart(2, '0') + ':' + 
                       String(now.getMinutes()).padStart(2, '0');
        
        // Agregar nota con fecha
        const newNote = '[' + dateStr + '] ' + noteText;
        
        if (currentValue) {
            notesField.value = currentValue + '\n' + newNote;
        } else {
            notesField.value = newNote;
        }
        
        // Feedback visual
        this.classList.add('active');
        setTimeout(() => {
            this.classList.remove('active');
        }, 200);
    });
});

// Función para autocompletar con IA
function autoCompleteWithAI() {
    // Recopilar datos actuales del formulario
    const formData = {
        name: document.getElementById('{{ form.name.id_for_label }}').value.trim(),
        email: document.getElementById('{{ form.email.id_for_label }}').value.trim(),
        phone: document.getElementById('{{ form.phone.id_for_label }}').value.trim(),
        position: document.getElementById('{{ form.position.id_for_label }}').value.trim(),
        company: document.getElementById('{{ form.company.id_for_label }}').value.trim(),
        country: document.getElementById('{{ form.country.id_for_label }}').value.trim(),
        notes: document.getElementById('{{ form.notes.id_for_label }}').value.trim(),
        website: document.getElementById('{{ form.website.id_for_label }}').value.trim(),
        linkedin_url: document.getElementById('{{ form.linkedin_url.id_for_label }}').value.trim(),
        facebook_url: document.getElementById('{{ form.facebook_url.id_for_label }}').value.trim(),
        twitter_url: document.getElementById('{{ form.twitter_url.id_for_label }}').value.trim(),
        instagram_url: document.getElementById('{{ form.instagram_url.id_for_label }}').value.trim(),
        youtube_url: document.getElementById('{{ form.youtube_url.id_for_label }}').value.trim(),
        tiktok_url: document.getElementById('{{ form.tiktok_url.id_for_label }}').value.trim()
    };
    
    // Validar que tengamos al menos algo de información
    if (!formData.name && !formData.company && !formData.email) {
        alert('Por favor completa al menos el nombre, empresa o email antes de usar el autocompletado con IA.');
        return;
    }
    
    // Mostrar indicador de carga en el botón
    const btn = document.getElementById('aiCompleteBtn');
    const originalHTML = btn.innerHTML;
    btn.innerHTML = '<span class="spinner-border spinner-border-sm me-2"></span>Completando...';
    btn.disabled = true;
    
    // Llamada AJAX
    fetch('{% url "contact_autocomplete_ai" %}', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value
        },
        body: JSON.stringify(formData)
    })
    .then(response => response.json())
    .then(data => {
        btn.innerHTML = originalHTML;
        btn.disabled = false;
        
        if (data.success) {
            // Aplicar datos sugeridos
            const suggestions = data.suggestions;
            let appliedCount = 0;
            
            // Completar campos solo si están vacíos
            if (suggestions.website && !formData.website) {
                document.getElementById('{{ form.website.id_for_label }}').value = suggestions.website;
                appliedCount++;
            }
            if (suggestions.linkedin_url && !formData.linkedin_url) {
                document.getElementById('{{ form.linkedin_url.id_for_label }}').value = suggestions.linkedin_url;
                appliedCount++;
            }
            if (suggestions.facebook_url && !formData.facebook_url) {
                document.getElementById('{{ form.facebook_url.id_for_label }}').value = suggestions.facebook_url;
                appliedCount++;
            }
            if (suggestions.twitter_url && !formData.twitter_url) {
                document.getElementById('{{ form.twitter_url.id_for_label }}').value = suggestions.twitter_url;
                appliedCount++;
            }
            if (suggestions.instagram_url && !formData.instagram_url) {
                document.getElementById('{{ form.instagram_url.id_for_label }}').value = suggestions.instagram_url;
                appliedCount++;
            }
            if (suggestions.youtube_url && !formData.youtube_url) {
                document.getElementById('{{ form.youtube_url.id_for_label }}').value = suggestions.youtube_url;
                appliedCount++;
            }
            if (suggestions.tiktok_url && !formData.tiktok_url) {
                document.getElementById('{{ form.tiktok_url.id_for_label }}').value = suggestions.tiktok_url;
                appliedCount++;
            }
            
            // Si hay notas sugeridas, agregarlas
            if (suggestions.additional_notes) {
                const notesField = document.getElementById('{{ form.notes.id_for_label }}');
                const currentNotes = notesField.value.trim();
                if (currentNotes) {
                    notesField.value = currentNotes + '\n\n--- Información adicional de IA ---\n' + suggestions.additional_notes;
                } else {
                    notesField.value = suggestions.additional_notes;
                }
            }
            
            // Mostrar mensaje de éxito
            if (appliedCount > 0) {
                const alert = document.createElement('div');
                alert.className = 'alert alert-success alert-dismissible fade show';
                alert.innerHTML = `
                    <i class="bi bi-check-circle"></i> 
                    Se completaron ${appliedCount} campo(s) automáticamente con IA.
                    <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
                `;
                document.querySelector('.card-body form').insertBefore(
                    alert, 
                    document.querySelector('.card-body form .row')
                );
                
                // Auto-cerrar después de 5 segundos
                setTimeout(() => {
                    if (alert.parentNode) alert.remove();
                }, 5000);
            } else {
                alert('No se encontró información adicional para completar. Los campos ya estaban llenos o no se encontraron datos relevantes.');
            }
        } else {
            alert('Error al completar con IA: ' + (data.error || 'Error desconocido'));
        }
    })
    .catch(error => {
        btn.innerHTML = originalHTML;
        btn.disabled = false;
        alert('Error de conexión: ' + error.message);
    });
}

// ==================== TAG MANAGEMENT ====================

let selectedTags = new Set();
let allTags = [];

// Inicializar tags seleccionados al cargar la página
document.addEventListener('DOMContentLoaded', function() {
    const hiddenSelect = document.getElementById('id_tags');
    if (hiddenSelect) {
        Array.from(hiddenSelect.options).forEach(option => {
            if (option.selected) {
                selectedTags.add(parseInt(option.value));
            }
        });
    }
    
    // Cargar todas las etiquetas disponibles
    loadAllTags();
    
    // Filtro de búsqueda
    document.getElementById('tag-search').addEventListener('input', filterTags);
    
    // Cerrar dropdown al hacer clic fuera
    document.addEventListener('click', function(e) {
        const container = document.getElementById('tags-container');
        const dropdown = document.getElementById('tag-dropdown');
        if (!container.contains(e.target)) {
            dropdown.style.display = 'none';
        }
    });
});

function loadAllTags() {
    fetch('/api/contact-tags/')
        .then(response => response.json())
        .then(data => {
            allTags = data;
        })
        .catch(error => console.error('Error loading tags:', error));
}

function toggleTagDropdown() {
    const dropdown = document.getElementById('tag-dropdown');
    dropdown.style.display = dropdown.style.display === 'none' ? 'block' : 'none';
}

function filterTags() {
    const search = document.getElementById('tag-search').value.toLowerCase();
    const tagOptions = document.querySelectorAll('.tag-option');
    
    tagOptions.forEach(option => {
        const tagName = option.dataset.tagName.toLowerCase();
        option.style.display = tagName.includes(search) ? 'block' : 'none';
    });
    
    // Mostrar dropdown si hay texto
    if (search.length > 0) {
        document.getElementById('tag-dropdown').style.display = 'block';
    }
}

function selectTag(event, tagId, tagName, tagColor) {
    event.preventDefault();
    
    if (selectedTags.has(tagId)) {
        return; // Ya está seleccionado
    }
    
    selectedTags.add(tagId);
    
    // Agregar badge visual
    const badge = document.createElement('span');
    badge.className = 'badge';
    badge.style.backgroundColor = tagColor;
    badge.style.fontSize = '0.9rem';
    badge.style.padding = '6px 10px';
    badge.style.cursor = 'pointer';
    badge.dataset.tagId = tagId;
    badge.onclick = () => removeTag(tagId);
    badge.innerHTML = `${tagName} <i class="bi bi-x ms-1"></i>`;
    
    document.getElementById('selected-tags').appendChild(badge);
    
    // Actualizar campo oculto
    updateHiddenField();
    
    // Limpiar búsqueda y cerrar dropdown
    document.getElementById('tag-search').value = '';
    document.getElementById('tag-dropdown').style.display = 'none';
}

function removeTag(tagId) {
    selectedTags.delete(tagId);
    
    // Remover badge visual
    const badge = document.querySelector(`#selected-tags [data-tag-id="${tagId}"]`);
    if (badge) {
        badge.remove();
    }
    
    // Actualizar campo oculto
    updateHiddenField();
}

function updateHiddenField() {
    const hiddenSelect = document.getElementById('id_tags');
    hiddenSelect.innerHTML = '';
    
    selectedTags.forEach(tagId => {
        const option = document.createElement('option');
        option.value = tagId;
        option.selected = true;
        hiddenSelect.appendChild(option);
    });
}

function showCreateTagForm(event) {
    event.preventDefault();
    
    const tagName = document.getElementById('tag-search').value.trim();
    
    if (!tagName) {
        alert('Por favor, ingresa un nombre para la etiqueta');
        return;
    }
    
    // Abrir modal de Bootstrap
    const modalHTML = `
        <div class="modal fade" id="createTagModal" tabindex="-1">
            <div class="modal-dialog">
                <div class="modal-content">
                    <div class="modal-header">
                        <h5 class="modal-title">
                            <i class="bi bi-tag-fill me-2"></i>Crear Nueva Etiqueta
                        </h5>
                        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                    </div>
                    <div class="modal-body">
                        <div class="mb-3">
                            <label class="form-label">Nombre de la Etiqueta</label>
                            <input type="text" id="new-tag-name" class="form-control" value="${tagName}" required>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Color</label>
                            <div class="d-flex align-items-center gap-2">
                                <input type="color" id="new-tag-color" class="form-control form-control-color" value="#0d6efd" style="width: 60px;">
                                <span id="color-preview" class="badge" style="background-color: #0d6efd; font-size: 0.9rem; padding: 6px 12px;">
                                    Vista previa
                                </span>
                            </div>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Descripción (opcional)</label>
                            <textarea id="new-tag-description" class="form-control" rows="2"></textarea>
                        </div>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                        <button type="button" class="btn btn-primary" onclick="createNewTag()">
                            <i class="bi bi-check-lg me-1"></i>Crear Etiqueta
                        </button>
                    </div>
                </div>
            </div>
        </div>
    `;
    
    // Eliminar modal anterior si existe
    const existingModal = document.getElementById('createTagModal');
    if (existingModal) {
        existingModal.remove();
    }
    
    // Agregar modal al body
    document.body.insertAdjacentHTML('beforeend', modalHTML);
    
    // Mostrar modal
    const modal = new bootstrap.Modal(document.getElementById('createTagModal'));
    modal.show();
    
    // Actualizar vista previa del color
    document.getElementById('new-tag-color').addEventListener('input', function() {
        document.getElementById('color-preview').style.backgroundColor = this.value;
    });
}

function createNewTag() {
    const name = document.getElementById('new-tag-name').value.trim();
    const color = document.getElementById('new-tag-color').value;
    const description = document.getElementById('new-tag-description').value.trim();
    
    if (!name) {
        alert('El nombre de la etiqueta es obligatorio');
        return;
    }
    
    // Mostrar indicador de carga
    const btn = event.target;
    const originalHTML = btn.innerHTML;
    btn.innerHTML = '<span class="spinner-border spinner-border-sm me-1"></span>Creando...';
    btn.disabled = true;
    
    // Enviar petición AJAX
    fetch('/api/contact-tags/create/', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value
        },
        body: JSON.stringify({ name, color, description })
    })
    .then(response => response.json())
    .then(data => {
        btn.innerHTML = originalHTML;
        btn.disabled = false;
        
        if (data.success) {
            // Cerrar modal
            const modal = bootstrap.Modal.getInstance(document.getElementById('createTagModal'));
            modal.hide();
            
            // Agregar nueva etiqueta a la lista
            const newTag = data.tag;
            allTags.push(newTag);
            
            // Agregar opción al dropdown
            const tagList = document.getElementById('tag-list');
            const newOption = document.createElement('a');
            newOption.className = 'dropdown-item tag-option';
            newOption.href = '#';
            newOption.dataset.tagId = newTag.id;
            newOption.dataset.tagName = newTag.name;
            newOption.dataset.tagColor = newTag.color;
            newOption.onclick = (e) => selectTag(e, newTag.id, newTag.name, newTag.color);
            newOption.innerHTML = `<span class="badge me-2" style="background-color: ${newTag.color};">${newTag.name}</span>`;
            tagList.appendChild(newOption);
            
            // Seleccionar automáticamente la nueva etiqueta
            selectTag({ preventDefault: () => {} }, newTag.id, newTag.name, newTag.color);
            
            // Limpiar búsqueda
            document.getElementById('tag-search').value = '';
        } else {
            alert('Error al crear etiqueta: ' + (data.error || 'Error desconocido'));
        }
    })
    .catch(error => {
        btn.innerHTML = originalHTML;
        btn.disabled = false;
        alert('Error de conexión: ' + error.message);
    });
}
</script>
{% endblock %}