{% extends 'base.html' %}
{% load static %}

{% block title %}{{ page_title }} - TicketProo{% endblock %}

{% block content %}
<div class="d-flex justify-content-between align-items-center mb-4">
    <div>
        <nav aria-label="breadcrumb">
            <ol class="breadcrumb">
                <li class="breadcrumb-item">
                    <a href="{% url 'company_protocol_list' %}">
                        <i class="bi bi-file-text"></i> Protocolos
                    </a>
                </li>
                <li class="breadcrumb-item">
                    <a href="{% url 'company_protocol_detail' protocol.pk %}">
                        {{ protocol.title|truncatechars:30 }}
                    </a>
                </li>
                <li class="breadcrumb-item active">Eliminar</li>
            </ol>
        </nav>
        <h2>
            <i class="bi bi-exclamation-triangle text-danger"></i> {{ page_title }}
        </h2>
    </div>
</div>

<div class="row justify-content-center">
    <div class="col-md-8">
        <div class="card border-danger">
            <div class="card-header bg-danger text-white">
                <h5 class="mb-0">
                    <i class="bi bi-trash"></i> Confirmar Eliminación
                </h5>
            </div>
            <div class="card-body">
                <div class="alert alert-danger d-flex align-items-center" role="alert">
                    <i class="bi bi-exclamation-triangle-fill me-2" style="font-size: 1.5rem;"></i>
                    <div>
                        <strong>¡Atención!</strong> Esta acción no se puede deshacer. 
                        El protocolo será eliminado permanentemente del sistema.
                    </div>
                </div>
                
                <!-- Información del protocolo a eliminar -->
                <div class="row mb-4">
                    <div class="col-md-6">
                        <h6 class="text-primary">Información del Protocolo:</h6>
                        <div class="bg-light p-3 rounded">
                            {% if protocol.company %}
                            <div class="mb-2">
                                <strong>Empresa:</strong> {{ protocol.company.name }}
                            </div>
                            {% endif %}
                            <div class="mb-2">
                                <strong>Título:</strong> {{ protocol.title }}
                            </div>
                            <div class="mb-2">
                                <strong>Versión:</strong> {{ protocol.version }}
                            </div>
                            <div class="mb-2">
                                <strong>Estado:</strong> 
                                <span class="badge {% if protocol.is_active %}bg-success{% else %}bg-secondary{% endif %}">
                                    {% if protocol.is_active %}Activo{% else %}Inactivo{% endif %}
                                </span>
                            </div>
                            <div class="mb-2">
                                <strong>Creado por:</strong> {{ protocol.created_by.get_full_name|default:protocol.created_by.username }}
                            </div>
                            <div class="mb-2">
                                <strong>Fecha:</strong> {{ protocol.created_at|date:"d/m/Y H:i" }}
                            </div>
                            <div>
                                <strong>Palabras:</strong> {{ protocol.get_word_count }}
                            </div>
                        </div>
                    </div>
                    
                    <div class="col-md-6">
                        <h6 class="text-primary">Vista Previa del Contenido:</h6>
                        <div class="bg-light p-3 rounded" style="max-height: 200px; overflow-y: auto;">
                            <small>{{ protocol.content|truncatechars:300 }}</small>
                        </div>
                    </div>
                </div>
                
                <!-- Checkbox de confirmación -->
                <div class="form-check mb-4">
                    <input class="form-check-input" type="checkbox" id="confirmDelete" required>
                    <label class="form-check-label" for="confirmDelete">
                        <strong>Confirmo que deseo eliminar este protocolo permanentemente</strong>
                    </label>
                </div>
                
                <!-- Sugerencias antes de eliminar -->
                <div class="alert alert-info">
                    <h6><i class="bi bi-lightbulb"></i> Antes de eliminar, considera:</h6>
                    <ul class="mb-0">
                        <li>¿Es realmente necesario eliminar el protocolo o podrías marcarlo como inactivo?</li>
                        <li>¿Hay otros empleados que podrían necesitar consultar este protocolo?</li>
                        <li>¿Has guardado una copia de respaldo si fuera necesaria?</li>
                        <li>¿Este protocolo forma parte de procesos de certificación o auditoría?</li>
                    </ul>
                </div>
                
                <!-- Botones de acción -->
                <div class="d-flex gap-2 justify-content-end">
                    <a href="{% url 'company_protocol_detail' protocol.pk %}" class="btn btn-secondary">
                        <i class="bi bi-arrow-left"></i> Cancelar
                    </a>
                    <a href="{% url 'company_protocol_edit' protocol.pk %}" class="btn btn-outline-warning">
                        <i class="bi bi-toggle-off"></i> Mejor Desactivar
                    </a>
                    <a href="{% url 'company_protocol_print_pdf' protocol.pk %}" class="btn btn-outline-primary">
                        <i class="bi bi-download"></i> Descargar Copia
                    </a>
                    <form method="post" class="d-inline">
                        {% csrf_token %}
                        <button type="submit" class="btn btn-danger" id="deleteBtn" disabled>
                            <i class="bi bi-trash"></i> Eliminar Definitivamente
                        </button>
                    </form>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
    const confirmCheckbox = document.getElementById('confirmDelete');
    const deleteBtn = document.getElementById('deleteBtn');
    
    // Habilitar/deshabilitar botón según checkbox
    confirmCheckbox.addEventListener('change', function() {
        deleteBtn.disabled = !this.checked;
    });
    
    // Confirmar eliminación al enviar formulario
    document.querySelector('form').addEventListener('submit', function(e) {
        if (!confirmCheckbox.checked) {
            e.preventDefault();
            alert('Debes confirmar que deseas eliminar el protocolo.');
            return;
        }
        
        const confirmed = confirm(
            '¿Estás completamente seguro de eliminar el protocolo "{{ protocol.title|escapejs }}"?\n\n' +
            'Esta acción NO se puede deshacer.'
        );
        
        if (!confirmed) {
            e.preventDefault();
        }
    });
});
</script>

<style>
.card {
    border: none;
    box-shadow: 0 4px 8px rgba(0,0,0,0.1);
}

.card.border-danger {
    border: 2px solid #dc3545 !important;
}

.btn:disabled {
    opacity: 0.5;
    cursor: not-allowed;
}
</style>
{% endblock %}