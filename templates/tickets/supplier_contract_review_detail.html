{% extends 'base.html' %}
{% load static %}

{% block title %}{{ page_title }}{% endblock %}

{% block content %}
<div class="container-fluid mt-4">
    <!-- Breadcrumb -->
    <nav aria-label="breadcrumb">
        <ol class="breadcrumb">
            <li class="breadcrumb-item"><a href="{% url 'dashboard' %}">Dashboard</a></li>
            <li class="breadcrumb-item"><a href="{% url 'supplier_contract_review_list' %}">Revisión de Contratos</a></li>
            <li class="breadcrumb-item active">{{ review.name }}</li>
        </ol>
    </nav>

    <!-- Header con acciones -->
    <div class="d-flex justify-content-between align-items-center mb-4 flex-wrap gap-2">
        <h2><i class="bi bi-shield-check"></i> {{ review.name }}</h2>
        <div class="d-flex gap-2 flex-wrap">
            {% if not review.ai_review %}
            <form method="POST" action="{% url 'supplier_contract_review_generate' review.pk %}" class="d-inline">
                {% csrf_token %}
                <button type="submit" class="btn btn-success">
                    <i class="bi bi-magic"></i> Generar Revisión con IA
                </button>
            </form>
            {% else %}
            <a href="{% url 'supplier_contract_review_download_pdf' review.pk %}" class="btn btn-primary">
                <i class="bi bi-file-pdf"></i> Descargar PDF
            </a>
            {% endif %}
            <a href="{% url 'supplier_contract_review_edit' review.pk %}" class="btn btn-warning">
                <i class="bi bi-pencil"></i> Editar
            </a>
            <a href="{% url 'supplier_contract_review_delete' review.pk %}" class="btn btn-danger">
                <i class="bi bi-trash"></i> Eliminar
            </a>
        </div>
    </div>

    <div class="row">
        <!-- Columna Principal -->
        <div class="col-lg-8">
            <!-- Información Básica -->
            <div class="card shadow-sm mb-4">
                <div class="card-header bg-primary text-white">
                    <h5 class="mb-0"><i class="bi bi-info-circle"></i> Información del Contrato</h5>
                </div>
                <div class="card-body">
                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <h6 class="text-muted mb-2">Proveedor</h6>
                            <p class="mb-0"><strong>{{ review.supplier_name }}</strong></p>
                        </div>
                        <div class="col-md-6 mb-3">
                            <h6 class="text-muted mb-2">Empresa Revisora</h6>
                            <p class="mb-0"><strong>{{ review.company.name }}</strong></p>
                        </div>
                        <div class="col-md-6 mb-3">
                            <h6 class="text-muted mb-2">Estado</h6>
                            <div>
                                {{ review.get_status_badge|safe }}
                                <button type="button" class="btn btn-sm btn-outline-secondary ms-2" data-bs-toggle="modal" data-bs-target="#statusModal">
                                    <i class="bi bi-pencil"></i> Cambiar
                                </button>
                            </div>
                        </div>
                        <div class="col-md-6 mb-3">
                            <h6 class="text-muted mb-2">Nivel de Riesgo</h6>
                            {{ review.get_risk_badge|safe }}
                        </div>
                        <div class="col-md-6 mb-3">
                            <h6 class="text-muted mb-2">Creado por</h6>
                            <p class="mb-0">{{ review.user.get_full_name|default:review.user.username }}</p>
                        </div>
                        <div class="col-md-6 mb-3">
                            <h6 class="text-muted mb-2">Fecha de Creación</h6>
                            <p class="mb-0">{{ review.created_at|date:"d/m/Y H:i" }}</p>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Contenido del Contrato Original -->
            <div class="card shadow-sm mb-4">
                <div class="card-header bg-secondary text-white d-flex justify-content-between align-items-center">
                    <h5 class="mb-0"><i class="bi bi-file-text"></i> Contrato Original</h5>
                    <button class="btn btn-sm btn-light" type="button" data-bs-toggle="collapse" data-bs-target="#contractContent">
                        <i class="bi bi-eye"></i> Ver/Ocultar
                    </button>
                </div>
                <div class="collapse" id="contractContent">
                    <div class="card-body">
                        <div class="contract-original">
                            {% if review.contract_text %}
                                {{ review.contract_text|linebreaks }}
                            {% elif review.contract_file %}
                                <div class="alert alert-info">
                                    <i class="bi bi-file-earmark"></i> Archivo: {{ review.contract_file.name }}
                                    <a href="{{ review.contract_file.url }}" class="btn btn-sm btn-primary ms-2" target="_blank">
                                        <i class="bi bi-download"></i> Descargar
                                    </a>
                                </div>
                                <p class="text-muted">El contenido se extraerá automáticamente al generar la revisión.</p>
                            {% else %}
                                <p class="text-muted">No hay contenido disponible</p>
                            {% endif %}
                        </div>
                    </div>
                </div>
            </div>

            <!-- Revisión de IA -->
            {% if review.ai_review %}
            <div class="card shadow-sm mb-4">
                <div class="card-header bg-success text-white">
                    <h5 class="mb-0"><i class="bi bi-magic"></i> Análisis Completo con IA</h5>
                </div>
                <div class="card-body">
                    <div class="ai-review-content" id="aiReviewContent"></div>
                    {% if review.reviewed_at %}
                    <hr>
                    <small class="text-muted">
                        <i class="bi bi-clock"></i> Revisado el {{ review.reviewed_at|date:"d/m/Y H:i" }}
                    </small>
                    {% endif %}
                </div>
            </div>

            <!-- Cláusulas Clave -->
            {% if review.key_clauses %}
            <div class="card shadow-sm mb-4">
                <div class="card-header bg-info text-white">
                    <h5 class="mb-0"><i class="bi bi-list-check"></i> Cláusulas Clave</h5>
                </div>
                <div class="card-body">
                    <div id="keyClausesContent"></div>
                </div>
            </div>
            {% endif %}

            <!-- Evaluación de Riesgos -->
            {% if review.risk_assessment %}
            <div class="card shadow-sm mb-4">
                <div class="card-header bg-warning text-dark">
                    <h5 class="mb-0"><i class="bi bi-exclamation-triangle"></i> Evaluación de Riesgos</h5>
                </div>
                <div class="card-body">
                    <div id="riskAssessmentContent"></div>
                </div>
            </div>
            {% endif %}

            <!-- Recomendaciones -->
            {% if review.recommendations %}
            <div class="card shadow-sm mb-4">
                <div class="card-header bg-primary text-white">
                    <h5 class="mb-0"><i class="bi bi-lightbulb"></i> Recomendaciones</h5>
                </div>
                <div class="card-body">
                    <div id="recommendationsContent"></div>
                </div>
            </div>
            {% endif %}
            
            {% else %}
            <!-- Alert si no hay revisión -->
            <div class="alert alert-info">
                <h5><i class="bi bi-info-circle"></i> Revisión Pendiente</h5>
                <p>Este contrato aún no ha sido revisado con IA. Haga clic en el botón "Generar Revisión con IA" para obtener un análisis completo del contrato.</p>
                <form method="POST" action="{% url 'supplier_contract_review_generate' review.pk %}">
                    {% csrf_token %}
                    <button type="submit" class="btn btn-success">
                        <i class="bi bi-magic"></i> Generar Revisión Ahora
                    </button>
                </form>
            </div>
            {% endif %}
        </div>

        <!-- Sidebar -->
        <div class="col-lg-4">
            <!-- Notas Internas -->
            {% if review.internal_notes %}
            <div class="card shadow-sm mb-4">
                <div class="card-header bg-light">
                    <h6 class="mb-0"><i class="bi bi-journal-text"></i> Notas Internas</h6>
                </div>
                <div class="card-body">
                    {{ review.internal_notes|linebreaks }}
                </div>
            </div>
            {% endif %}

            <!-- Historial -->
            <div class="card shadow-sm mb-4">
                <div class="card-header bg-light">
                    <h6 class="mb-0"><i class="bi bi-clock-history"></i> Historial</h6>
                </div>
                <div class="card-body">
                    <div class="timeline">
                        <div class="timeline-item">
                            <i class="bi bi-circle-fill text-primary"></i>
                            <div class="ms-3">
                                <strong>Creado</strong><br>
                                <small class="text-muted">{{ review.created_at|date:"d/m/Y H:i" }}</small>
                            </div>
                        </div>
                        {% if review.updated_at != review.created_at %}
                        <div class="timeline-item">
                            <i class="bi bi-circle-fill text-warning"></i>
                            <div class="ms-3">
                                <strong>Última actualización</strong><br>
                                <small class="text-muted">{{ review.updated_at|date:"d/m/Y H:i" }}</small>
                            </div>
                        </div>
                        {% endif %}
                        {% if review.reviewed_at %}
                        <div class="timeline-item">
                            <i class="bi bi-circle-fill text-success"></i>
                            <div class="ms-3">
                                <strong>Revisado con IA</strong><br>
                                <small class="text-muted">{{ review.reviewed_at|date:"d/m/Y H:i" }}</small>
                            </div>
                        </div>
                        {% endif %}
                    </div>
                </div>
            </div>

            <!-- Acciones Rápidas -->
            <div class="card shadow-sm mb-4">
                <div class="card-header bg-light">
                    <h6 class="mb-0"><i class="bi bi-lightning"></i> Acciones Rápidas</h6>
                </div>
                <div class="card-body">
                    <div class="d-grid gap-2">
                        {% if review.ai_review %}
                        <a href="{% url 'supplier_contract_review_download_pdf' review.pk %}" class="btn btn-sm btn-primary">
                            <i class="bi bi-file-pdf"></i> Descargar Revisión (PDF)
                        </a>
                        {% endif %}
                        <a href="{% url 'supplier_contract_review_edit' review.pk %}" class="btn btn-sm btn-warning">
                            <i class="bi bi-pencil"></i> Editar Contrato
                        </a>
                        {% if not review.ai_review %}
                        <form method="POST" action="{% url 'supplier_contract_review_generate' review.pk %}">
                            {% csrf_token %}
                            <button type="submit" class="btn btn-sm btn-success w-100">
                                <i class="bi bi-magic"></i> Generar Revisión
                            </button>
                        </form>
                        {% endif %}
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Modal para cambiar estado -->
<div class="modal fade" id="statusModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Cambiar Estado</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <form method="POST" action="{% url 'supplier_contract_review_update_status' review.pk %}">
                {% csrf_token %}
                <div class="modal-body">
                    <div class="mb-3">
                        <label class="form-label">Nuevo Estado</label>
                        <select name="status" class="form-select" required>
                            <option value="pending" {% if review.status == 'pending' %}selected{% endif %}>Pendiente</option>
                            <option value="reviewed" {% if review.status == 'reviewed' %}selected{% endif %}>Revisado</option>
                            <option value="approved" {% if review.status == 'approved' %}selected{% endif %}>Aprobado</option>
                            <option value="rejected" {% if review.status == 'rejected' %}selected{% endif %}>Rechazado</option>
                        </select>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                    <button type="submit" class="btn btn-primary">Guardar</button>
                </div>
            </form>
        </div>
    </div>
</div>

<style>
.contract-original {
    max-height: 400px;
    overflow-y: auto;
    padding: 15px;
    background-color: #f8f9fa;
    border-radius: 5px;
    font-family: 'Courier New', monospace;
    font-size: 0.9em;
}

.ai-review-content {
    line-height: 1.8;
    font-size: 1.05em;
}

.ai-review-content h2,
.ai-review-content h3 {
    color: #0d6efd;
    margin-top: 1.5rem;
    margin-bottom: 1rem;
}

.timeline {
    position: relative;
    padding-left: 0;
}

.timeline-item {
    display: flex;
    padding-bottom: 1rem;
    position: relative;
}

.timeline-item:not(:last-child)::before {
    content: '';
    position: absolute;
    left: 4px;
    top: 20px;
    bottom: -5px;
    width: 2px;
    background-color: #dee2e6;
}

.timeline-item i {
    font-size: 10px;
    margin-top: 5px;
}

.ai-review-content h2 {
    font-size: 1.5rem;
    color: #198754;
    margin-top: 1.5rem;
    margin-bottom: 1rem;
    font-weight: bold;
    border-bottom: 2px solid #198754;
    padding-bottom: 0.5rem;
}

.ai-review-content h3 {
    font-size: 1.3rem;
    color: #0d6efd;
    margin-top: 1.2rem;
    margin-bottom: 0.8rem;
    font-weight: 600;
}

.ai-review-content ul {
    list-style-type: none;
    padding-left: 0;
}

.ai-review-content ul li {
    padding-left: 1.5rem;
    margin-bottom: 0.5rem;
    position: relative;
}

.ai-review-content ul li:before {
    content: "✓";
    position: absolute;
    left: 0;
    color: #198754;
    font-weight: bold;
}

.ai-review-content p {
    margin-bottom: 1rem;
    line-height: 1.8;
}

.ai-review-content strong {
    color: #0d6efd;
}
</style>

<script>
// Función para formatear el contenido sin markdown
function formatContent(text) {
    if (!text) return '';
    
    // Eliminar los ## de títulos y convertirlos en h2
    text = text.replace(/## ([^\n]+)/g, '<h2>$1</h2>');
    
    // Eliminar los ### y convertirlos en h3
    text = text.replace(/### ([^\n]+)/g, '<h3>$1</h3>');
    
    // Convertir negritas **texto** en <strong>
    text = text.replace(/\*\*([^\*]+)\*\*/g, '<strong>$1</strong>');
    
    // Convertir listas numeradas
    text = text.replace(/^\d+\.\s+(.+)$/gm, '<li>$1</li>');
    
    // Convertir listas con guiones
    text = text.replace(/^[-•]\s+(.+)$/gm, '<li>$1</li>');
    
    // Agrupar listas consecutivas
    text = text.replace(/(<li>.*?<\/li>\s*)+/gs, '<ul>$&</ul>');
    
    // Convertir saltos de línea dobles en párrafos
    text = text.split('\n\n').map(para => {
        if (para.trim() && !para.includes('<h2>') && !para.includes('<h3>') && !para.includes('<ul>')) {
            return '<p>' + para.replace(/\n/g, '<br>') + '</p>';
        }
        return para;
    }).join('\n');
    
    // Limpiar espacios extra
    text = text.replace(/\n{3,}/g, '\n\n');
    
    return text;
}

// Aplicar formato cuando cargue la página
document.addEventListener('DOMContentLoaded', function() {
    {% if review.ai_review %}
    const aiReviewText = `{{ review.ai_review|escapejs }}`;
    const aiReviewElement = document.getElementById('aiReviewContent');
    if (aiReviewElement) {
        aiReviewElement.innerHTML = formatContent(aiReviewText);
    }
    {% endif %}
    
    {% if review.key_clauses %}
    const keyClausesText = `{{ review.key_clauses|escapejs }}`;
    const keyClausesElement = document.getElementById('keyClausesContent');
    if (keyClausesElement) {
        keyClausesElement.innerHTML = formatContent(keyClausesText);
    }
    {% endif %}
    
    {% if review.risk_assessment %}
    const riskAssessmentText = `{{ review.risk_assessment|escapejs }}`;
    const riskAssessmentElement = document.getElementById('riskAssessmentContent');
    if (riskAssessmentElement) {
        riskAssessmentElement.innerHTML = formatContent(riskAssessmentText);
    }
    {% endif %}
    
    {% if review.recommendations %}
    const recommendationsText = `{{ review.recommendations|escapejs }}`;
    const recommendationsElement = document.getElementById('recommendationsContent');
    if (recommendationsElement) {
        recommendationsElement.innerHTML = formatContent(recommendationsText);
    }
    {% endif %}
});
</script>
{% endblock %}
