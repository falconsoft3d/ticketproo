{% extends 'base.html' %}
{% load static %}

{% block title %}{{ page_title }}{% endblock %}

{% block content %}
<div class="row">
    <div class="col-12">
        <div class="d-flex justify-content-between align-items-center mb-4">
            <div>
                <h1 class="h3 mb-0 text-primary">
                    <i class="bi bi-grid-3x3-gap"></i> Tetris
                </h1>
                <p class="text-muted mb-0">Juego clÃ¡sico de bloques</p>
            </div>
            <div class="text-end">
                <span class="badge bg-info fs-6">Herramientas</span>
            </div>
        </div>
    </div>
</div>

<div class="row justify-content-center">
    <div class="col-lg-10">
        <div class="card shadow-sm">
            <div class="card-body p-4">
                <!-- Panel de Control Superior -->
                <div class="row mb-4">
                    <div class="col-md-3">
                        <div class="card bg-primary text-white">
                            <div class="card-body text-center">
                                <h6 class="card-title mb-1">PuntuaciÃ³n</h6>
                                <h3 class="mb-0" id="score">0</h3>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="card bg-success text-white">
                            <div class="card-body text-center">
                                <h6 class="card-title mb-1">LÃ­neas</h6>
                                <h3 class="mb-0" id="lines">0</h3>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="card bg-warning text-white">
                            <div class="card-body text-center">
                                <h6 class="card-title mb-1">Nivel</h6>
                                <h3 class="mb-0" id="level">1</h3>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="card bg-info text-white">
                            <div class="card-body text-center">
                                <h6 class="card-title mb-1">Siguiente</h6>
                                <canvas id="nextCanvas" width="80" height="80" style="background: rgba(255,255,255,0.2); border-radius: 8px;"></canvas>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Ãrea del Juego -->
                <div class="row">
                    <div class="col-md-8 order-md-1 order-2">
                        <div class="text-center mb-3">
                            <canvas id="gameCanvas" width="320" height="640" 
                                    style="border: 3px solid #dee2e6; border-radius: 10px; background: #f8f9fa;"></canvas>
                        </div>
                        
                        <!-- Controles -->
                        <div class="text-center">
                            <button id="startBtn" class="btn btn-success btn-lg mx-2">
                                <i class="bi bi-play-fill"></i> Iniciar
                            </button>
                            <button id="pauseBtn" class="btn btn-warning btn-lg mx-2" disabled>
                                <i class="bi bi-pause-fill"></i> Pausar
                            </button>
                            <button id="resetBtn" class="btn btn-danger btn-lg mx-2">
                                <i class="bi bi-arrow-clockwise"></i> Reiniciar
                            </button>
                        </div>
                    </div>

                    <div class="col-md-4 order-md-2 order-1">
                        <!-- Instrucciones -->
                        <div class="card mb-4">
                            <div class="card-header bg-secondary text-white">
                                <h6 class="mb-0"><i class="bi bi-question-circle"></i> Instrucciones</h6>
                            </div>
                            <div class="card-body">
                                <div class="row text-center">
                                    <div class="col-6 mb-3">
                                        <div class="border rounded p-2">
                                            <i class="bi bi-arrow-left fs-4 text-primary"></i>
                                            <small class="d-block">Izquierda</small>
                                        </div>
                                    </div>
                                    <div class="col-6 mb-3">
                                        <div class="border rounded p-2">
                                            <i class="bi bi-arrow-right fs-4 text-primary"></i>
                                            <small class="d-block">Derecha</small>
                                        </div>
                                    </div>
                                    <div class="col-6 mb-3">
                                        <div class="border rounded p-2">
                                            <i class="bi bi-arrow-down fs-4 text-success"></i>
                                            <small class="d-block">Bajar</small>
                                        </div>
                                    </div>
                                    <div class="col-6 mb-3">
                                        <div class="border rounded p-2">
                                            <i class="bi bi-arrow-up fs-4 text-warning"></i>
                                            <small class="d-block">Rotar</small>
                                        </div>
                                    </div>
                                </div>
                                <hr>
                                <p class="small mb-0">
                                    <strong>Objetivo:</strong> Completa lÃ­neas horizontales para eliminarlas y ganar puntos.
                                </p>
                            </div>
                        </div>

                        <!-- Mejores Puntuaciones -->
                        <div class="card">
                            <div class="card-header bg-dark text-white">
                                <h6 class="mb-0"><i class="bi bi-trophy"></i> Mejores Puntuaciones</h6>
                            </div>
                            <div class="card-body">
                                <div id="highScores">
                                    <div class="text-center text-muted">
                                        <small>No hay puntuaciones guardadas</small>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Game Over Modal -->
                <div class="modal fade" id="gameOverModal" tabindex="-1" aria-hidden="true">
                    <div class="modal-dialog modal-dialog-centered">
                        <div class="modal-content">
                            <div class="modal-header bg-danger text-white">
                                <h5 class="modal-title">
                                    <i class="bi bi-x-circle"></i> Â¡Juego Terminado!
                                </h5>
                            </div>
                            <div class="modal-body text-center">
                                <h4>PuntuaciÃ³n Final: <span id="finalScore" class="text-primary">0</span></h4>
                                <p>LÃ­neas completadas: <span id="finalLines" class="text-success">0</span></p>
                                <p>Nivel alcanzado: <span id="finalLevel" class="text-warning">1</span></p>
                                <div id="newRecord" class="alert alert-success d-none">
                                    <i class="bi bi-trophy"></i> Â¡Nueva mejor puntuaciÃ³n!
                                </div>
                            </div>
                            <div class="modal-footer">
                                <button type="button" class="btn btn-success" onclick="startNewGame()">
                                    <i class="bi bi-play-fill"></i> Jugar de Nuevo
                                </button>
                                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                                    Cerrar
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<style>
    #gameCanvas {
        box-shadow: 0 8px 16px rgba(0,0,0,0.1);
        transition: all 0.3s ease;
    }
    
    #gameCanvas:hover {
        box-shadow: 0 12px 24px rgba(0,0,0,0.15);
    }
    
    .card {
        transition: transform 0.2s ease;
    }
    
    .card:hover {
        transform: translateY(-2px);
    }
    
    .btn:hover {
        transform: translateY(-1px);
    }
    
    .game-stats {
        background: linear-gradient(45deg, #667eea 0%, #764ba2 100%);
    }
</style>

<script>
class TetrisGame {
    constructor() {
        this.canvas = document.getElementById('gameCanvas');
        this.ctx = this.canvas.getContext('2d');
        this.nextCanvas = document.getElementById('nextCanvas');
        this.nextCtx = this.nextCanvas.getContext('2d');
        
        this.BOARD_WIDTH = 10;
        this.BOARD_HEIGHT = 20;
        this.BLOCK_SIZE = 32;
        
        this.board = Array(this.BOARD_HEIGHT).fill().map(() => Array(this.BOARD_WIDTH).fill(0));
        this.score = 0;
        this.lines = 0;
        this.level = 1;
        this.gameRunning = false;
        this.currentPiece = null;
        this.nextPiece = null;
        
        this.colors = [
            '#000000', // 0 - VacÃ­o
            '#FF6B6B', // 1 - I pieza (rojo)
            '#4ECDC4', // 2 - O pieza (turquesa)
            '#45B7D1', // 3 - T pieza (azul)
            '#96CEB4', // 4 - S pieza (verde)
            '#FFEAA7', // 5 - Z pieza (amarillo)
            '#DDA0DD', // 6 - J pieza (morado)
            '#FFB74D'  // 7 - L pieza (naranja)
        ];
        
        this.pieces = {
            I: [
                [[1,1,1,1]],
                [[1],[1],[1],[1]]
            ],
            O: [
                [[2,2],[2,2]]
            ],
            T: [
                [[0,3,0],[3,3,3]],
                [[3,0],[3,3],[3,0]],
                [[3,3,3],[0,3,0]],
                [[0,3],[3,3],[0,3]]
            ],
            S: [
                [[0,4,4],[4,4,0]],
                [[4,0],[4,4],[0,4]]
            ],
            Z: [
                [[5,5,0],[0,5,5]],
                [[0,5],[5,5],[5,0]]
            ],
            J: [
                [[6,0,0],[6,6,6]],
                [[6,6],[6,0],[6,0]],
                [[6,6,6],[0,0,6]],
                [[0,6],[0,6],[6,6]]
            ],
            L: [
                [[0,0,7],[7,7,7]],
                [[7,0],[7,0],[7,7]],
                [[7,7,7],[7,0,0]],
                [[7,7],[0,7],[0,7]]
            ]
        };
        
        this.pieceTypes = Object.keys(this.pieces);
        this.fallTime = 0;
        this.fallSpeed = 1000; // milisegundos
        
        this.init();
    }
    
    init() {
        this.loadHighScores();
        this.drawBoard();
        this.setupEventListeners();
    }
    
    setupEventListeners() {
        document.getElementById('startBtn').onclick = () => this.startGame();
        document.getElementById('pauseBtn').onclick = () => this.pauseGame();
        document.getElementById('resetBtn').onclick = () => this.resetGame();
        
        document.addEventListener('keydown', (e) => this.handleKeyPress(e));
    }
    
    startGame() {
        if (!this.gameRunning) {
            this.gameRunning = true;
            this.currentPiece = this.createPiece();
            this.nextPiece = this.createPiece();
            this.drawNextPiece();
            this.gameLoop();
            
            document.getElementById('startBtn').disabled = true;
            document.getElementById('pauseBtn').disabled = false;
        }
    }
    
    pauseGame() {
        this.gameRunning = false;
        document.getElementById('startBtn').disabled = false;
        document.getElementById('pauseBtn').disabled = true;
    }
    
    resetGame() {
        this.gameRunning = false;
        this.board = Array(this.BOARD_HEIGHT).fill().map(() => Array(this.BOARD_WIDTH).fill(0));
        this.score = 0;
        this.lines = 0;
        this.level = 1;
        this.currentPiece = null;
        this.nextPiece = null;
        this.fallSpeed = 1000;
        
        this.updateStats();
        this.drawBoard();
        this.clearNextCanvas();
        
        document.getElementById('startBtn').disabled = false;
        document.getElementById('pauseBtn').disabled = true;
    }
    
    createPiece() {
        const type = this.pieceTypes[Math.floor(Math.random() * this.pieceTypes.length)];
        return {
            type: type,
            shape: this.pieces[type][0],
            x: Math.floor(this.BOARD_WIDTH / 2) - Math.floor(this.pieces[type][0][0].length / 2),
            y: 0,
            rotation: 0
        };
    }
    
    handleKeyPress(e) {
        if (!this.gameRunning || !this.currentPiece) return;
        
        switch(e.code) {
            case 'ArrowLeft':
                e.preventDefault();
                this.movePiece(-1, 0);
                break;
            case 'ArrowRight':
                e.preventDefault();
                this.movePiece(1, 0);
                break;
            case 'ArrowDown':
                e.preventDefault();
                this.movePiece(0, 1);
                break;
            case 'ArrowUp':
                e.preventDefault();
                this.rotatePiece();
                break;
        }
    }
    
    movePiece(dx, dy) {
        const newX = this.currentPiece.x + dx;
        const newY = this.currentPiece.y + dy;
        
        if (this.isValidPosition(this.currentPiece.shape, newX, newY)) {
            this.currentPiece.x = newX;
            this.currentPiece.y = newY;
            this.drawBoard();
        } else if (dy > 0) {
            // Pieza no puede bajar mÃ¡s, fijarla al tablero
            this.placePiece();
        }
    }
    
    rotatePiece() {
        const rotations = this.pieces[this.currentPiece.type];
        const nextRotation = (this.currentPiece.rotation + 1) % rotations.length;
        const rotatedShape = rotations[nextRotation];
        
        if (this.isValidPosition(rotatedShape, this.currentPiece.x, this.currentPiece.y)) {
            this.currentPiece.rotation = nextRotation;
            this.currentPiece.shape = rotatedShape;
            this.drawBoard();
        }
    }
    
    isValidPosition(shape, x, y) {
        for (let row = 0; row < shape.length; row++) {
            for (let col = 0; col < shape[row].length; col++) {
                if (shape[row][col] !== 0) {
                    const newX = x + col;
                    const newY = y + row;
                    
                    if (newX < 0 || newX >= this.BOARD_WIDTH || 
                        newY >= this.BOARD_HEIGHT || 
                        (newY >= 0 && this.board[newY][newX] !== 0)) {
                        return false;
                    }
                }
            }
        }
        return true;
    }
    
    placePiece() {
        // Colocar la pieza en el tablero
        for (let row = 0; row < this.currentPiece.shape.length; row++) {
            for (let col = 0; col < this.currentPiece.shape[row].length; col++) {
                if (this.currentPiece.shape[row][col] !== 0) {
                    const x = this.currentPiece.x + col;
                    const y = this.currentPiece.y + row;
                    
                    if (y >= 0) {
                        this.board[y][x] = this.currentPiece.shape[row][col];
                    }
                }
            }
        }
        
        // Verificar lÃ­neas completas
        this.clearLines();
        
        // Crear nueva pieza
        this.currentPiece = this.nextPiece;
        this.nextPiece = this.createPiece();
        this.drawNextPiece();
        
        // Verificar game over
        if (!this.isValidPosition(this.currentPiece.shape, this.currentPiece.x, this.currentPiece.y)) {
            this.gameOver();
        }
    }
    
    clearLines() {
        let linesCleared = 0;
        
        for (let row = this.BOARD_HEIGHT - 1; row >= 0; row--) {
            if (this.board[row].every(cell => cell !== 0)) {
                this.board.splice(row, 1);
                this.board.unshift(Array(this.BOARD_WIDTH).fill(0));
                linesCleared++;
                row++; // Verificar la misma fila otra vez
            }
        }
        
        if (linesCleared > 0) {
            this.lines += linesCleared;
            this.score += linesCleared * 100 * this.level;
            this.level = Math.floor(this.lines / 10) + 1;
            this.fallSpeed = Math.max(100, 1000 - (this.level - 1) * 100);
            this.updateStats();
        }
    }
    
    gameOver() {
        this.gameRunning = false;
        this.saveHighScore();
        this.showGameOverModal();
        
        document.getElementById('startBtn').disabled = false;
        document.getElementById('pauseBtn').disabled = true;
    }
    
    showGameOverModal() {
        document.getElementById('finalScore').textContent = this.score;
        document.getElementById('finalLines').textContent = this.lines;
        document.getElementById('finalLevel').textContent = this.level;
        
        const modal = new bootstrap.Modal(document.getElementById('gameOverModal'));
        modal.show();
    }
    
    updateStats() {
        document.getElementById('score').textContent = this.score;
        document.getElementById('lines').textContent = this.lines;
        document.getElementById('level').textContent = this.level;
    }
    
    drawBoard() {
        // Limpiar canvas
        this.ctx.fillStyle = '#f8f9fa';
        this.ctx.fillRect(0, 0, this.canvas.width, this.canvas.height);
        
        // Dibujar grid
        this.ctx.strokeStyle = '#e9ecef';
        this.ctx.lineWidth = 1;
        
        for (let x = 0; x <= this.BOARD_WIDTH; x++) {
            this.ctx.beginPath();
            this.ctx.moveTo(x * this.BLOCK_SIZE, 0);
            this.ctx.lineTo(x * this.BLOCK_SIZE, this.canvas.height);
            this.ctx.stroke();
        }
        
        for (let y = 0; y <= this.BOARD_HEIGHT; y++) {
            this.ctx.beginPath();
            this.ctx.moveTo(0, y * this.BLOCK_SIZE);
            this.ctx.lineTo(this.canvas.width, y * this.BLOCK_SIZE);
            this.ctx.stroke();
        }
        
        // Dibujar bloques del tablero
        for (let row = 0; row < this.BOARD_HEIGHT; row++) {
            for (let col = 0; col < this.BOARD_WIDTH; col++) {
                if (this.board[row][col] !== 0) {
                    this.drawBlock(col * this.BLOCK_SIZE, row * this.BLOCK_SIZE, this.colors[this.board[row][col]]);
                }
            }
        }
        
        // Dibujar pieza actual
        if (this.currentPiece) {
            for (let row = 0; row < this.currentPiece.shape.length; row++) {
                for (let col = 0; col < this.currentPiece.shape[row].length; col++) {
                    if (this.currentPiece.shape[row][col] !== 0) {
                        const x = (this.currentPiece.x + col) * this.BLOCK_SIZE;
                        const y = (this.currentPiece.y + row) * this.BLOCK_SIZE;
                        this.drawBlock(x, y, this.colors[this.currentPiece.shape[row][col]]);
                    }
                }
            }
        }
    }
    
    drawBlock(x, y, color) {
        // Bloque principal
        this.ctx.fillStyle = color;
        this.ctx.fillRect(x + 1, y + 1, this.BLOCK_SIZE - 2, this.BLOCK_SIZE - 2);
        
        // Efecto 3D
        this.ctx.fillStyle = this.lightenColor(color, 20);
        this.ctx.fillRect(x + 1, y + 1, this.BLOCK_SIZE - 2, 6);
        this.ctx.fillRect(x + 1, y + 1, 6, this.BLOCK_SIZE - 2);
        
        this.ctx.fillStyle = this.darkenColor(color, 20);
        this.ctx.fillRect(x + this.BLOCK_SIZE - 7, y + 1, 6, this.BLOCK_SIZE - 2);
        this.ctx.fillRect(x + 1, y + this.BLOCK_SIZE - 7, this.BLOCK_SIZE - 2, 6);
    }
    
    drawNextPiece() {
        this.nextCtx.fillStyle = 'rgba(255,255,255,0.2)';
        this.nextCtx.fillRect(0, 0, this.nextCanvas.width, this.nextCanvas.height);
        
        if (this.nextPiece) {
            const blockSize = 16;
            const offsetX = (this.nextCanvas.width - this.nextPiece.shape[0].length * blockSize) / 2;
            const offsetY = (this.nextCanvas.height - this.nextPiece.shape.length * blockSize) / 2;
            
            for (let row = 0; row < this.nextPiece.shape.length; row++) {
                for (let col = 0; col < this.nextPiece.shape[row].length; col++) {
                    if (this.nextPiece.shape[row][col] !== 0) {
                        const x = offsetX + col * blockSize;
                        const y = offsetY + row * blockSize;
                        
                        this.nextCtx.fillStyle = this.colors[this.nextPiece.shape[row][col]];
                        this.nextCtx.fillRect(x, y, blockSize - 1, blockSize - 1);
                    }
                }
            }
        }
    }
    
    clearNextCanvas() {
        this.nextCtx.fillStyle = 'rgba(255,255,255,0.2)';
        this.nextCtx.fillRect(0, 0, this.nextCanvas.width, this.nextCanvas.height);
    }
    
    lightenColor(color, amount) {
        const num = parseInt(color.replace("#",""), 16);
        const amt = Math.round(2.55 * amount);
        const R = (num >> 16) + amt;
        const G = (num >> 8 & 0x00FF) + amt;
        const B = (num & 0x0000FF) + amt;
        return "#" + (0x1000000 + (R < 255 ? R < 1 ? 0 : R : 255) * 0x10000 +
            (G < 255 ? G < 1 ? 0 : G : 255) * 0x100 +
            (B < 255 ? B < 1 ? 0 : B : 255)).toString(16).slice(1);
    }
    
    darkenColor(color, amount) {
        const num = parseInt(color.replace("#",""), 16);
        const amt = Math.round(2.55 * amount);
        const R = (num >> 16) - amt;
        const G = (num >> 8 & 0x00FF) - amt;
        const B = (num & 0x0000FF) - amt;
        return "#" + (0x1000000 + (R > 255 ? 255 : R < 0 ? 0 : R) * 0x10000 +
            (G > 255 ? 255 : G < 0 ? 0 : G) * 0x100 +
            (B > 255 ? 255 : B < 0 ? 0 : B)).toString(16).slice(1);
    }
    
    gameLoop() {
        if (!this.gameRunning) return;
        
        const now = Date.now();
        if (now - this.fallTime > this.fallSpeed) {
            this.movePiece(0, 1);
            this.fallTime = now;
        }
        
        requestAnimationFrame(() => this.gameLoop());
    }
    
    saveHighScore() {
        let highScores = JSON.parse(localStorage.getItem('tetrisHighScores') || '[]');
        
        const newScore = {
            score: this.score,
            lines: this.lines,
            level: this.level,
            date: new Date().toLocaleDateString('es-ES')
        };
        
        highScores.push(newScore);
        highScores.sort((a, b) => b.score - a.score);
        highScores = highScores.slice(0, 5); // Solo las mejores 5
        
        localStorage.setItem('tetrisHighScores', JSON.stringify(highScores));
        this.displayHighScores();
        
        // Verificar si es nuevo rÃ©cord
        if (highScores[0].score === this.score) {
            document.getElementById('newRecord').classList.remove('d-none');
        }
    }
    
    loadHighScores() {
        this.displayHighScores();
    }
    
    displayHighScores() {
        const highScores = JSON.parse(localStorage.getItem('tetrisHighScores') || '[]');
        const container = document.getElementById('highScores');
        
        if (highScores.length === 0) {
            container.innerHTML = '<div class="text-center text-muted"><small>No hay puntuaciones guardadas</small></div>';
            return;
        }
        
        let html = '';
        highScores.forEach((score, index) => {
            const medal = index === 0 ? 'ðŸ¥‡' : index === 1 ? 'ðŸ¥ˆ' : index === 2 ? 'ðŸ¥‰' : '';
            html += `
                <div class="d-flex justify-content-between align-items-center mb-2 ${index === 0 ? 'text-warning fw-bold' : ''}">
                    <span>${medal} ${score.score.toLocaleString()}</span>
                    <small class="text-muted">${score.date}</small>
                </div>
            `;
        });
        
        container.innerHTML = html;
    }
}

// Inicializar el juego cuando se carga la pÃ¡gina
let game;
document.addEventListener('DOMContentLoaded', function() {
    game = new TetrisGame();
});

function startNewGame() {
    const modal = bootstrap.Modal.getInstance(document.getElementById('gameOverModal'));
    modal.hide();
    game.resetGame();
    setTimeout(() => game.startGame(), 300);
}
</script>
{% endblock %}