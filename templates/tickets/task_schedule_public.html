{% extends 'public_base.html' %}

{% block title %}{{ page_title }}{% endblock %}

{% block content %}
<div class="container-fluid">
    <!-- Header -->
    <div class="text-center mb-5">
        <h1 class="display-4">
            <i class="fas fa-tasks"></i> {{ schedule.title }}
        </h1>
        <p class="lead text-muted">
            <i class="fas fa-building"></i> {{ schedule.company.name }}
        </p>
        <p class="text-muted">
            <i class="fas fa-calendar-alt"></i> {{ schedule.start_date|date:"d/m/Y" }} - {{ schedule.end_date|date:"d/m/Y" }}
        </p>
        
        <!-- Botón para Vista Gantt -->
        <div class="mt-3">
            <a href="{% url 'task_schedule_public_gantt' schedule.public_token %}" class="btn btn-primary btn-lg">
                <i class="fas fa-chart-gantt"></i> Ver Diagrama Gantt
            </a>
        </div>
    </div>

    <!-- Descripción -->
    {% if schedule.description %}
    <div class="alert alert-info mb-4">
        <strong>Descripción:</strong> {{ schedule.description }}
    </div>
    {% endif %}

    <!-- KPIs -->
    <div class="row mb-5">
        <div class="col-md-2 mb-3">
            <div class="card text-center shadow-sm">
                <div class="card-body">
                    <h3 class="text-primary mb-0">{{ kpis.total_tasks }}</h3>
                    <small class="text-muted">Total Tareas</small>
                </div>
            </div>
        </div>
        <div class="col-md-2 mb-3">
            <div class="card text-center shadow-sm">
                <div class="card-body">
                    <h3 class="text-success mb-0">{{ kpis.completed_tasks }}</h3>
                    <small class="text-muted">Completadas</small>
                </div>
            </div>
        </div>
        <div class="col-md-2 mb-3">
            <div class="card text-center shadow-sm">
                <div class="card-body">
                    <h3 class="text-warning mb-0">{{ kpis.pending_tasks }}</h3>
                    <small class="text-muted">Pendientes</small>
                </div>
            </div>
        </div>
        <div class="col-md-2 mb-3">
            <div class="card text-center shadow-sm">
                <div class="card-body">
                    <h3 class="text-danger mb-0">{{ kpis.overdue_tasks }}</h3>
                    <small class="text-muted">Vencidas</small>
                </div>
            </div>
        </div>
        <div class="col-md-2 mb-3">
            <div class="card text-center shadow-sm">
                <div class="card-body">
                    <h3 class="text-info mb-0">{{ kpis.progress_percentage|floatformat:0 }}%</h3>
                    <small class="text-muted">Progreso</small>
                </div>
            </div>
        </div>
        <div class="col-md-2 mb-3">
            <div class="card text-center shadow-sm">
                <div class="card-body">
                    <h3 class="text-primary mb-0">{{ kpis.on_time_rate|floatformat:0 }}%</h3>
                    <small class="text-muted">A Tiempo</small>
                </div>
            </div>
        </div>
    </div>

    



    <!-- Lista de Tareas -->
    <div class="card shadow">
        <div class="card-header bg-primary text-white">
            <h4 class="mb-0"><i class="fas fa-list"></i> Tareas del Cronograma</h4>
        </div>
        <div class="card-body">
            {% if tasks %}
            <div class="table-responsive">
                <table class="table table-hover">
                    <thead>
                        <tr>
                            <th>Título</th>
                            <th>Asignado</th>
                            <th>Prioridad</th>
                            <th>Inicio</th>
                            <th>Fin</th>
                            <th>Días</th>
                            <th>Estado</th>
                            <th width="100">Acción</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for task in tasks %}
                        <tr class="{% if task.is_completed %}table-success{% elif task.is_overdue %}table-danger{% endif %}">
                            
                            <td>
                                <strong>{{ task.title }}</strong>
                                {% if task.description %}
                                <br><small class="text-muted">{{ task.description|truncatewords:15 }}</small>
                                {% endif %}
                            </td>
                            <td>
                                {% if task.assigned_to %}
                                    <i class="fas fa-user"></i> {{ task.assigned_to.get_full_name|default:task.assigned_to.username }}
                                {% else %}
                                    <span class="text-muted">Sin asignar</span>
                                {% endif %}
                            </td>
                            <td>
                                {% if task.priority == 'critical' %}
                                    <span class="badge bg-danger">Crítica</span>
                                {% elif task.priority == 'high' %}
                                    <span class="badge bg-warning">Alta</span>
                                {% elif task.priority == 'medium' %}
                                    <span class="badge bg-info">Media</span>
                                {% else %}
                                    <span class="badge bg-secondary">Baja</span>
                                {% endif %}
                            </td>
                            <td>{{ task.start_date|date:"d/m/Y" }}</td>
                            <td>{{ task.end_date|date:"d/m/Y" }}</td>
                            <td class="text-center">
                                <span class="badge bg-secondary">{{ task.get_duration_days }} días</span>
                            </td>
                            <td>
                                {% if task.is_completed %}
                                    <span class="badge bg-success">
                                        <i class="fas fa-check"></i> Completada
                                    </span>
                                {% elif task.is_overdue %}
                                    <span class="badge bg-danger">
                                        <i class="fas fa-exclamation-triangle"></i> Vencida
                                    </span>
                                {% else %}
                                    <span class="badge bg-warning">
                                        <i class="fas fa-clock"></i> Pendiente
                                    </span>
                                {% endif %}
                            </td>
                            <td>
                                <button class="btn btn-sm {% if task.is_completed %}btn-success{% else %}btn-outline-success{% endif %} toggle-task-btn" 
                                        data-task-id="{{ task.pk }}"
                                        data-token="{{ schedule.public_token }}"
                                        title="{% if task.is_completed %}Marcar como pendiente{% else %}Marcar como completada{% endif %}">
                                    <i class="fas {% if task.is_completed %}fa-check-circle{% else %}fa-circle{% endif %}"></i>
                                </button>
                            </td>
                        </tr>
                        {% endfor %}
                    </tbody>
                    <tfoot>
                        <tr class="table-info">
                            <th colspan="5" class="text-end">Total:</th>
                            <th class="text-center">
                                <span class="badge bg-primary">{{ total_days }} días</span>
                            </th>
                            <th colspan="2"></th>
                        </tr>
                    </tfoot>
                </table>
            </div>
            {% else %}
            <div class="alert alert-info">
                <i class="fas fa-info-circle"></i> No hay tareas en este cronograma.
            </div>
            {% endif %}
        </div>
    </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
    // Función para obtener el CSRF token
    function getCsrfToken() {
        return document.querySelector('[name=csrfmiddlewaretoken]')?.value || '{{ csrf_token }}' || '';
    }
    
    // DEBUG: Consola para verificar la URL y elementos
    console.log('Script cargado. Botones encontrados:', document.querySelectorAll('.toggle-task-btn').length);
    
    // Función para manejar el toggle de tareas
    document.querySelectorAll('.toggle-task-btn').forEach(button => {
        button.addEventListener('click', function() {
            // Evitar doble clicks
            if (this.disabled) return;
            this.disabled = true;
            
            const taskId = this.dataset.taskId;
            const token = this.dataset.token;
            const url = `/public/schedule-tasks/${taskId}/toggle/`;
            
            console.log('Toggle tarea:', taskId, 'URL:', url, 'Token:', token);
            
            fetch(url, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': getCsrfToken()
                },
                body: JSON.stringify({
                    token: token
                })
            })
            .then(response => {
                console.log('Response status:', response.status);
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                return response.json();
            })
            .then(data => {
                console.log('Response data:', data);
                
                if (data.success) {
                    // Actualizar el botón
                    const icon = this.querySelector('i');
                    if (data.is_completed) {
                        this.className = 'btn btn-sm btn-success toggle-task-btn';
                        icon.className = 'fas fa-check-circle';
                        this.title = 'Marcar como pendiente';
                    } else {
                        this.className = 'btn btn-sm btn-outline-success toggle-task-btn';
                        icon.className = 'fas fa-circle';
                        this.title = 'Marcar como completada';
                    }
                    
                    // Actualizar la fila de la tarea
                    const row = this.closest('tr');
                    const statusCell = row.cells[7]; // Columna de estado
                    const progressCell = row.cells[6]; // Columna de progreso
                    const checkCell = row.cells[0]; // Columna de check
                    
                    // Actualizar icono de check
                    if (data.is_completed) {
                        checkCell.innerHTML = '<i class="fas fa-check-circle text-success fs-5"></i>';
                        row.classList.add('table-success');
                    } else {
                        checkCell.innerHTML = '<i class="far fa-circle text-muted fs-5"></i>';
                        row.classList.remove('table-success');
                    }
                    
                    // Actualizar estado
                    if (data.is_completed) {
                        statusCell.innerHTML = '<span class="badge bg-success"><i class="fas fa-check"></i> Completada</span>';
                    } else {
                        statusCell.innerHTML = '<span class="badge bg-warning"><i class="fas fa-clock"></i> Pendiente</span>';
                    }
                    
                    // Actualizar progreso
                    const progressBar = progressCell.querySelector('.progress-bar');
                    const progressText = progressBar.querySelector('strong');
                    if (progressBar && progressText) {
                        progressBar.style.width = data.progress + '%';
                        progressText.textContent = data.progress + '%';
                        
                        // Actualizar clase de color de la barra de progreso
                        progressBar.className = 'progress-bar ' + (data.progress >= 75 ? 'bg-success' : 
                                                                  data.progress >= 50 ? 'bg-info' : 
                                                                  data.progress >= 25 ? 'bg-warning' : 'bg-danger');
                    }
                    
                    // Recargar la página para actualizar KPIs después de un breve delay
                    setTimeout(() => {
                        location.reload();
                    }, 1000);
                } else {
                    alert('Error al actualizar la tarea: ' + (data.error || 'Error desconocido'));
                    this.disabled = false;
                }
            })
            .catch(error => {
                console.error('Error completo:', error);
                alert('Error de conexión al actualizar la tarea: ' + error.message);
                this.disabled = false;
            });
        });
    });
});
</script>
{% endblock %}
