{% extends 'base.html' %}
{% load static %}

{% block title %}{{ page_title }} - Vista Pública{% endblock %}

{% block content %}
<div class="container-fluid">
    <!-- Header público -->
    <div class="row mb-4">
        <div class="col-md-12 text-center">
            <div class="badge bg-success mb-2">Vista Pública</div>
            <h2>
                <i class="bi bi-file-earmark-ruled me-2"></i>{{ document.sequence }}
            </h2>
            <p class="text-muted">{{ document.title }}</p>
            {% if document.company %}
                <span class="badge rounded-pill" 
                      style="background-color: {{ document.company.color }}; color: white; font-size: 1rem;">
                    {{ document.company.name }}
                </span>
            {% else %}
                <span class="badge bg-secondary" style="font-size: 1rem;">
                    {{ document.company_name|default:"Sin empresa" }}
                </span>
            {% endif %}
        </div>
    </div>

    <!-- Estado del Documento -->
    {% if document.is_document_accepted or document.is_document_rejected %}
    <div class="row mb-4">
        <div class="col-md-10 offset-md-1">
            {% if document.is_document_accepted %}
            <div class="alert alert-success">
                <h5 class="alert-heading">
                    <i class="bi bi-check-circle-fill me-2"></i>Documento Aceptado
                </h5>
                <hr>
                <p class="mb-1"><strong>Revisado por:</strong> {{ document.document_reviewed_by_name }}</p>
                <p class="mb-1"><strong>Email:</strong> {{ document.document_reviewed_by_email }}</p>
                <p class="mb-1"><strong>Fecha:</strong> {{ document.document_reviewed_at|date:"d/m/Y H:i" }}</p>
                {% if document.document_review_comments %}
                <hr>
                <p class="mb-0"><strong>Comentarios:</strong></p>
                <p class="mb-0" style="white-space: pre-wrap;">{{ document.document_review_comments }}</p>
                {% endif %}
            </div>
            {% elif document.is_document_rejected %}
            <div class="alert alert-danger">
                <h5 class="alert-heading">
                    <i class="bi bi-x-circle-fill me-2"></i>Documento Rechazado
                </h5>
                <hr>
                <p class="mb-1"><strong>Revisado por:</strong> {{ document.document_reviewed_by_name }}</p>
                <p class="mb-1"><strong>Email:</strong> {{ document.document_reviewed_by_email }}</p>
                <p class="mb-1"><strong>Fecha:</strong> {{ document.document_reviewed_at|date:"d/m/Y H:i" }}</p>
                {% if document.document_review_comments %}
                <hr>
                <p class="mb-0"><strong>Comentarios:</strong></p>
                <p class="mb-0" style="white-space: pre-wrap;">{{ document.document_review_comments }}</p>
                {% endif %}
            </div>
            {% endif %}
        </div>
    </div>
    {% endif %}

    <!-- Descripción General -->
    <div class="row mb-4">
        <div class="col-md-10 offset-md-1">
            <div class="card">
                <div class="card-header d-flex justify-content-between align-items-center">
                    <h5 class="mb-0">
                        <i class="bi bi-card-text me-2"></i>Descripción General
                    </h5>
                    <button type="button" 
                            class="btn btn-sm btn-outline-primary"
                            data-bs-toggle="collapse"
                            data-bs-target="#editDescription"
                            aria-expanded="false"
                            aria-controls="editDescription">
                        <i class="bi bi-pencil me-1"></i>Editar
                    </button>
                </div>
                <div class="card-body">
                    {% if document.description %}
                        <p class="mb-3" style="white-space: pre-wrap;">{{ document.description }}</p>
                    {% else %}
                        <p class="text-muted mb-3">
                            <i>No se ha definido una descripción general para este documento.</i>
                        </p>
                    {% endif %}

                    <!-- Formulario de edición -->
                    <div class="collapse" id="editDescription">
                        <form method="post" class="border p-3 rounded bg-light">
                            {% csrf_token %}
                            <div class="mb-3">
                                <label class="form-label fw-bold">Editar Descripción General</label>
                                <textarea name="description" 
                                          class="form-control" 
                                          rows="5" 
                                          placeholder="Ingrese una descripción general del proyecto o alcance...">{{ document.description }}</textarea>
                            </div>
                            <button type="submit" name="edit_description" class="btn btn-primary me-2">
                                <i class="bi bi-check-lg me-1"></i>Guardar
                            </button>
                            <button type="button" 
                                    class="btn btn-secondary"
                                    data-bs-toggle="collapse"
                                    data-bs-target="#editDescription">
                                <i class="bi bi-x-lg me-1"></i>Cancelar
                            </button>
                        </form>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Progreso -->
    <div class="row mb-4">
        <div class="col-md-10 offset-md-1">
            <div class="card">
                <div class="card-body">
                    <h6 class="text-center mb-3">Progreso de Aprobación</h6>
                    <div class="progress" style="height: 30px;">
                        <div class="progress-bar 
                            {% if document.get_approval_percentage >= 80 %}bg-success
                            {% elif document.get_approval_percentage >= 50 %}bg-warning
                            {% else %}bg-danger{% endif %}" 
                             role="progressbar" 
                             style="width: {{ document.get_approval_percentage|floatformat:0 }}%"
                             aria-valuenow="{{ document.get_approval_percentage }}" 
                             aria-valuemin="0" 
                             aria-valuemax="100">
                            {{ document.get_approval_percentage }}%
                        </div>
                    </div>
                    <div class="d-flex justify-content-between mt-2">
                        <small class="text-muted">{{ document.get_approved_count }} de {{ document.get_total_count }} aprobados</small>
                        <small class="text-muted">{{ document.get_pending_count }} pendientes</small>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Lista de requerimientos -->
    <div class="row">
        <div class="col-md-10 offset-md-1">
            {% if requirements %}
            {% for req in requirements %}
            <div class="card mb-3">
                <div class="card-header d-flex justify-content-between align-items-center">
                    <h5 class="mb-0">
                        <span class="badge bg-secondary me-2">#{{ req.number }}</span>
                        Requerimiento {{ req.number }}
                    </h5>
                    {% if req.is_approved %}
                        <span class="badge bg-success">
                            <i class="bi bi-check-circle me-1"></i>Aprobado
                        </span>
                    {% else %}
                        <span class="badge bg-warning text-dark">Pendiente de Aprobación</span>
                    {% endif %}
                </div>
                <div class="card-body">
                    <!-- Descripción del requerimiento -->
                    <div class="mb-3">
                        {% if req.title %}
                            <h5 class="mb-3">{{ req.title }}</h5>
                        {% endif %}
                        <p class="lead">{{ req.description|linebreaks }}</p>
                    </div>

                    <!-- Información de aprobación -->
                    {% if req.is_approved %}
                    <div class="alert alert-success">
                        <h6 class="alert-heading">
                            <i class="bi bi-check-circle me-1"></i>Aprobado
                        </h6>
                        <p class="mb-1">
                            <strong>Por:</strong> {{ req.approved_by_name }}<br>
                            <strong>Email:</strong> {{ req.approved_by_email }}<br>
                            <strong>Fecha:</strong> {{ req.approved_at|date:"d/m/Y H:i" }}
                        </p>
                    </div>
                    {% else %}
                    <!-- Formulario de edición -->
                    <div class="collapse mb-3" id="editReq{{ req.id }}">
                        <form method="post" class="border p-3 rounded bg-light">
                            {% csrf_token %}
                            <input type="hidden" name="requirement_id" value="{{ req.id }}">
                            <div class="mb-3">
                                <label class="form-label fw-bold">Título</label>
                                <input type="text" name="title" class="form-control" placeholder="Título del requerimiento" value="{{ req.title }}">
                            </div>
                            <div class="mb-3">
                                <label class="form-label fw-bold">Descripción</label>
                                <textarea name="description" class="form-control" rows="4" required>{{ req.description }}</textarea>
                            </div>
                            <div class="d-flex gap-2">
                                <button type="submit" name="edit_requirement" class="btn btn-primary">
                                    <i class="bi bi-save me-1"></i>Guardar Cambios
                                </button>
                                <button type="button" class="btn btn-secondary" data-bs-toggle="collapse" data-bs-target="#editReq{{ req.id }}">
                                    Cancelar
                                </button>
                            </div>
                        </form>
                    </div>

                    <!-- Formulario de aprobación -->
                    <div class="collapse mb-3" id="approveReq{{ req.id }}">
                        <form method="post" class="border p-3 rounded bg-light">
                            {% csrf_token %}
                            <input type="hidden" name="requirement_id" value="{{ req.id }}">
                            <h6 class="mb-3">Aprobar Requerimiento</h6>
                            <div class="mb-3">
                                {{ approval_form.approver_name }}
                            </div>
                            <div class="mb-3">
                                {{ approval_form.approver_email }}
                            </div>
                            <div class="d-flex gap-2">
                                <button type="submit" name="approve_requirement" class="btn btn-success">
                                    <i class="bi bi-check-circle me-1"></i>Aprobar
                                </button>
                                <button type="button" class="btn btn-secondary" data-bs-toggle="collapse" data-bs-target="#approveReq{{ req.id }}">
                                    Cancelar
                                </button>
                            </div>
                        </form>
                    </div>

                    <!-- Botones de acción -->
                    <div class="d-flex gap-2">
                        <button type="button" class="btn btn-primary" data-bs-toggle="collapse" data-bs-target="#editReq{{ req.id }}">
                            <i class="bi bi-pencil me-1"></i>Editar
                        </button>
                        <button type="button" class="btn btn-success" data-bs-toggle="collapse" data-bs-target="#approveReq{{ req.id }}">
                            <i class="bi bi-check-circle me-1"></i>Aprobar
                        </button>
                        <button type="button" class="btn btn-info" data-bs-toggle="collapse" data-bs-target="#commentsReq{{ req.id }}">
                            <i class="bi bi-chat-left-text me-1"></i>Comentarios ({{ req.comments.count }})
                        </button>
                    </div>
                    {% endif %}

                    <!-- Sección de comentarios -->
                    <div class="collapse mt-3" id="commentsReq{{ req.id }}">
                        <div class="border rounded p-3 bg-light">
                            <h6 class="mb-3">
                                <i class="bi bi-chat-left-text me-2"></i>Comentarios
                            </h6>

                            <!-- Comentarios existentes -->
                            {% if req.comments.all %}
                            <div class="mb-3">
                                {% for comment in req.comments.all %}
                                <div class="card mb-2">
                                    <div class="card-body py-2">
                                        <div class="d-flex justify-content-between align-items-start">
                                            <div>
                                                <strong class="text-primary">{{ comment.author_name }}</strong>
                                                <small class="text-muted">({{ comment.author_email }})</small>
                                            </div>
                                            <small class="text-muted">{{ comment.created_at|date:"d/m/Y H:i" }}</small>
                                        </div>
                                        <p class="mb-0 mt-2" style="white-space: pre-wrap;">{{ comment.comment }}</p>
                                    </div>
                                </div>
                                {% endfor %}
                            </div>
                            {% else %}
                            <p class="text-muted mb-3">
                                <i>No hay comentarios aún. Sé el primero en comentar.</i>
                            </p>
                            {% endif %}

                            <!-- Formulario para agregar comentario -->
                            <div class="collapse" id="addCommentReq{{ req.id }}">
                                <form method="post" class="border p-3 rounded bg-white">
                                    {% csrf_token %}
                                    <input type="hidden" name="requirement_id" value="{{ req.id }}">
                                    <h6 class="mb-3">Agregar Comentario</h6>
                                    <div class="mb-3">
                                        <label class="form-label fw-bold">{{ comment_form.author_name.label }}</label>
                                        {{ comment_form.author_name }}
                                    </div>
                                    <div class="mb-3">
                                        <label class="form-label fw-bold">{{ comment_form.author_email.label }}</label>
                                        {{ comment_form.author_email }}
                                    </div>
                                    <div class="mb-3">
                                        <label class="form-label fw-bold">{{ comment_form.comment.label }}</label>
                                        {{ comment_form.comment }}
                                    </div>
                                    <div class="d-flex gap-2">
                                        <button type="submit" name="add_comment" class="btn btn-primary">
                                            <i class="bi bi-send me-1"></i>Enviar Comentario
                                        </button>
                                        <button type="button" class="btn btn-secondary" data-bs-toggle="collapse" data-bs-target="#addCommentReq{{ req.id }}">
                                            Cancelar
                                        </button>
                                    </div>
                                </form>
                            </div>

                            <!-- Botón para mostrar formulario -->
                            <button type="button" class="btn btn-outline-primary btn-sm" data-bs-toggle="collapse" data-bs-target="#addCommentReq{{ req.id }}">
                                <i class="bi bi-plus-circle me-1"></i>Agregar Comentario
                            </button>
                        </div>
                    </div>
                </div>
            </div>
            {% endfor %}
            {% else %}
            <div class="card">
                <div class="card-body text-center py-5">
                    <i class="bi bi-list-ol text-muted" style="font-size: 4rem;"></i>
                    <h4 class="mt-3 text-muted">No hay requerimientos aún</h4>
                    <p class="text-muted">Este documento aún no tiene requerimientos definidos</p>
                </div>
            </div>
            {% endif %}
        </div>
    </div>

    <!-- Sección de Revisión del Documento -->
    {% if document.is_document_pending %}
    <div class="row mt-5 mb-4">
        <div class="col-md-10 offset-md-1">
            <div class="card border-primary">
                <div class="card-header bg-primary text-white">
                    <h5 class="mb-0">
                        <i class="bi bi-clipboard-check me-2"></i>Revisión del Documento Completo
                    </h5>
                </div>
                <div class="card-body">
                    <p class="text-muted mb-4">
                        <i class="bi bi-info-circle me-1"></i>
                        Una vez que hayas revisado todos los requerimientos, puedes aceptar o rechazar el documento completo.
                    </p>

                    <!-- Formulario de Aceptación -->
                    <div class="collapse mb-3" id="acceptDocumentForm">
                        <form method="post" class="border border-success p-4 rounded bg-light">
                            {% csrf_token %}
                            <h6 class="text-success mb-3">
                                <i class="bi bi-check-circle-fill me-2"></i>Aceptar Documento
                            </h6>
                            <div class="mb-3">
                                <label class="form-label fw-bold">{{ review_form.reviewer_name.label }}</label>
                                {{ review_form.reviewer_name }}
                            </div>
                            <div class="mb-3">
                                <label class="form-label fw-bold">{{ review_form.reviewer_email.label }}</label>
                                {{ review_form.reviewer_email }}
                            </div>
                            <div class="mb-3">
                                <label class="form-label fw-bold">{{ review_form.comments.label }}</label>
                                {{ review_form.comments }}
                            </div>
                            <div class="d-flex gap-2">
                                <button type="submit" name="accept_document" class="btn btn-success">
                                    <i class="bi bi-check-circle-fill me-1"></i>Confirmar Aceptación
                                </button>
                                <button type="button" class="btn btn-secondary" data-bs-toggle="collapse" data-bs-target="#acceptDocumentForm">
                                    Cancelar
                                </button>
                            </div>
                        </form>
                    </div>

                    <!-- Formulario de Rechazo -->
                    <div class="collapse mb-3" id="rejectDocumentForm">
                        <form method="post" class="border border-danger p-4 rounded bg-light">
                            {% csrf_token %}
                            <h6 class="text-danger mb-3">
                                <i class="bi bi-x-circle-fill me-2"></i>Rechazar Documento
                            </h6>
                            <div class="mb-3">
                                <label class="form-label fw-bold">{{ review_form.reviewer_name.label }}</label>
                                {{ review_form.reviewer_name }}
                            </div>
                            <div class="mb-3">
                                <label class="form-label fw-bold">{{ review_form.reviewer_email.label }}</label>
                                {{ review_form.reviewer_email }}
                            </div>
                            <div class="mb-3">
                                <label class="form-label fw-bold">{{ review_form.comments.label }}</label>
                                {{ review_form.comments }}
                                <small class="form-text text-muted">
                                    Por favor, explica los motivos del rechazo para que puedan realizarse correcciones.
                                </small>
                            </div>
                            <div class="d-flex gap-2">
                                <button type="submit" name="reject_document" class="btn btn-danger">
                                    <i class="bi bi-x-circle-fill me-1"></i>Confirmar Rechazo
                                </button>
                                <button type="button" class="btn btn-secondary" data-bs-toggle="collapse" data-bs-target="#rejectDocumentForm">
                                    Cancelar
                                </button>
                            </div>
                        </form>
                    </div>

                    <!-- Botones principales -->
                    <div class="d-flex gap-3 justify-content-center">
                        <button type="button" class="btn btn-success btn-lg" data-bs-toggle="collapse" data-bs-target="#acceptDocumentForm">
                            <i class="bi bi-check-circle-fill me-2"></i>Aceptar Documento
                        </button>
                        <button type="button" class="btn btn-danger btn-lg" data-bs-toggle="collapse" data-bs-target="#rejectDocumentForm">
                            <i class="bi bi-x-circle-fill me-2"></i>Rechazar Documento
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>
    {% endif %}

    <!-- Información adicional -->
    <div class="row mt-4">
        <div class="col-md-10 offset-md-1">
            <div class="card">
                <div class="card-body text-center">
                    <small class="text-muted">
                        Esta es una vista pública del Documento de Requerimientos Funcionales.<br>
                        Puede editar y aprobar cada requerimiento individualmente.<br>
                        Última actualización: {{ document.updated_at|date:"d/m/Y H:i" }}
                    </small>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}
