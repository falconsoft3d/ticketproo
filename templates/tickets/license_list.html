{% extends 'base.html' %}
{% load static %}

{% block title %}{{ title }}{% endblock %}

{% block extra_css %}
<style>
    .license-card {
        transition: transform 0.2s;
    }
    .license-card:hover {
        transform: translateY(-2px);
    }
    .status-badge {
        font-size: 0.9rem;
        padding: 0.4rem 0.8rem;
    }
    .license-key {
        font-family: 'Courier New', monospace;
        font-weight: bold;
        letter-spacing: 1px;
    }
</style>
{% endblock %}

{% block content %}
<div class="container-fluid mt-4">
    <div class="row">
        <div class="col-12">
            <!-- Header -->
            <div class="d-flex justify-content-between align-items-center mb-4">
                <div>
                    <h2><i class="bi bi-key text-primary"></i> {{ title }}</h2>
                    <p class="text-muted">Gestión y control de licencias de productos</p>
                </div>
                <div>
                    <a href="{% url 'license_create' %}" class="btn btn-primary">
                        <i class="bi bi-plus-circle"></i> Nueva Licencia
                    </a>
                </div>
            </div>

            <!-- Estadísticas -->
            <div class="row mb-4">
                <div class="col-md-4">
                    <div class="card bg-primary text-white">
                        <div class="card-body text-center">
                            <h3>{{ total_licenses }}</h3>
                            <small>Total de Licencias</small>
                        </div>
                    </div>
                </div>
                <div class="col-md-4">
                    <div class="card bg-success text-white">
                        <div class="card-body text-center">
                            <h3>{{ active_licenses }}</h3>
                            <small>Licencias Activas</small>
                        </div>
                    </div>
                </div>
                <div class="col-md-4">
                    <div class="card bg-danger text-white">
                        <div class="card-body text-center">
                            <h3>{{ expired_licenses }}</h3>
                            <small>Licencias Expiradas</small>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Filtros -->
            <div class="card mb-4">
                <div class="card-body">
                    <form method="get" class="row g-3">
                        <div class="col-md-3">
                            <label for="company" class="form-label">Empresa</label>
                            <select class="form-select" name="company" id="company">
                                <option value="">Todas las empresas</option>
                                {% for company in companies %}
                                    <option value="{{ company.pk }}" 
                                            {% if current_filters.company == company.pk|stringformat:"s" %}selected{% endif %}>
                                        {{ company.name }}
                                    </option>
                                {% endfor %}
                            </select>
                        </div>
                        <div class="col-md-3">
                            <label for="status" class="form-label">Estado</label>
                            <select class="form-select" name="status" id="status">
                                <option value="">Todos los estados</option>
                                <option value="active" {% if current_filters.status == "active" %}selected{% endif %}>Activa</option>
                                <option value="expired" {% if current_filters.status == "expired" %}selected{% endif %}>Expirada</option>
                                <option value="suspended" {% if current_filters.status == "suspended" %}selected{% endif %}>Suspendida</option>
                                <option value="revoked" {% if current_filters.status == "revoked" %}selected{% endif %}>Revocada</option>
                            </select>
                        </div>
                        <div class="col-md-4">
                            <label for="product" class="form-label">Producto</label>
                            <input type="text" class="form-control" name="product" id="product" 
                                   value="{{ current_filters.product }}" placeholder="Buscar por producto...">
                        </div>
                        <div class="col-md-2">
                            <label class="form-label">&nbsp;</label>
                            <div class="d-grid">
                                <button type="submit" class="btn btn-outline-primary">
                                    <i class="bi bi-search"></i> Filtrar
                                </button>
                            </div>
                        </div>
                    </form>
                </div>
            </div>

            <!-- Lista de licencias -->
            {% if licenses %}
                <div class="row">
                    {% for license in licenses %}
                        <div class="col-md-6 col-lg-4 mb-4">
                            <div class="card license-card h-100">
                                <div class="card-header d-flex justify-content-between align-items-center">
                                    <div class="license-key text-primary">{{ license.license_key }}</div>
                                    <span class="badge bg-{{ license.get_status_display_color }} status-badge">
                                        {{ license.get_status_display }}
                                    </span>
                                </div>
                                <div class="card-body">
                                    <h6 class="card-title">{{ license.product }}</h6>
                                    <p class="card-text">
                                        <small class="text-muted">
                                            <i class="bi bi-building"></i> {{ license.company.name }}
                                        </small>
                                    </p>
                                    
                                    <div class="row text-center mb-3">
                                        <div class="col-6">
                                            <small class="text-muted d-block">Inicio</small>
                                            <strong>{{ license.start_date|date:"d/m/Y" }}</strong>
                                        </div>
                                        <div class="col-6">
                                            <small class="text-muted d-block">Vencimiento</small>
                                            <strong>{{ license.end_date|date:"d/m/Y" }}</strong>
                                        </div>
                                    </div>
                                    
                                    {% if license.is_active %}
                                        <div class="text-center mb-3">
                                            {% with days_left=license.days_until_expiry %}
                                                {% if days_left <= 30 %}
                                                    <span class="badge bg-warning">
                                                        <i class="bi bi-exclamation-triangle"></i> {{ days_left }} días restantes
                                                    </span>
                                                {% else %}
                                                    <span class="badge bg-success">
                                                        <i class="bi bi-check-circle"></i> {{ days_left }} días restantes
                                                    </span>
                                                {% endif %}
                                            {% endwith %}
                                        </div>
                                    {% elif license.is_expired %}
                                        <div class="text-center mb-3">
                                            <span class="badge bg-danger">
                                                <i class="bi bi-x-circle"></i> Expirada
                                            </span>
                                        </div>
                                    {% endif %}
                                </div>
                                <div class="card-footer">
                                    <div class="btn-group w-100" role="group">
                                        <a href="{% url 'license_detail' license.pk %}" class="btn btn-outline-primary btn-sm">
                                            <i class="bi bi-eye"></i> Ver
                                        </a>
                                        <a href="{% url 'license_qr' license.pk %}" class="btn btn-outline-info btn-sm">
                                            <i class="bi bi-qr-code"></i> QR
                                        </a>
                                        <a href="{% url 'license_edit' license.pk %}" class="btn btn-outline-secondary btn-sm">
                                            <i class="bi bi-pencil"></i> Editar
                                        </a>
                                        <a href="{% url 'license_delete' license.pk %}" class="btn btn-outline-danger btn-sm">
                                            <i class="bi bi-trash"></i> Eliminar
                                        </a>
                                    </div>
                                </div>
                            </div>
                        </div>
                    {% endfor %}
                </div>
            {% else %}
                <div class="text-center py-5">
                    <i class="bi bi-key display-1 text-muted"></i>
                    <h4 class="mt-3">No hay licencias</h4>
                    <p class="text-muted">
                        {% if current_filters.company or current_filters.status or current_filters.product %}
                            No se encontraron licencias con los filtros aplicados.
                        {% else %}
                            Aún no se han creado licencias en el sistema.
                        {% endif %}
                    </p>
                    <a href="{% url 'license_create' %}" class="btn btn-primary">
                        <i class="bi bi-plus-circle"></i> Crear Primera Licencia
                    </a>
                </div>
            {% endif %}
        </div>
    </div>
</div>
{% endblock %}