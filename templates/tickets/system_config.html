{% extends 'base.html' %}

{% block title %}Configuración del Sistema - TicketProo{% endblock %}

{% block content %}
<div class="row">
    <div class="col-12">
        <div class="d-flex justify-content-between align-items-center mb-4">
            <h1>
                <i class="bi bi-gear-fill text-primary"></i> 
                Configuración del Sistema
            </h1>
            <a href="{% url 'dashboard' %}" class="btn btn-outline-secondary">
                <i class="bi bi-arrow-left"></i> Volver al Dashboard
            </a>
        </div>

        <div class="row">
            <div class="col-lg-8">
                <form method="post" class="needs-validation" novalidate>
                    {% csrf_token %}
                    
                    <!-- Configuración General -->
                    <div class="card mb-4">
                        <div class="card-header">
                            <h5 class="mb-0">
                                <i class="bi bi-gear text-secondary"></i> 
                                Configuración General
                            </h5>
                        </div>
                        <div class="card-body">
                            <div class="mb-3">
                                <label for="{{ form.site_name.id_for_label }}" class="form-label">
                                    {{ form.site_name.label }}
                                </label>
                                {{ form.site_name }}
                                {% if form.site_name.errors %}
                                    <div class="text-danger small">
                                        {{ form.site_name.errors.0 }}
                                    </div>
                                {% endif %}
                                <div class="form-text">
                                    {{ form.site_name.help_text }}
                                </div>
                            </div>

                            <div class="mb-3">
                                <div class="form-check">
                                    {{ form.enable_public_registration }}
                                    <label for="{{ form.enable_public_registration.id_for_label }}" class="form-check-label">
                                        {{ form.enable_public_registration.label }}
                                    </label>
                                </div>
                                {% if form.enable_public_registration.errors %}
                                    <div class="text-danger small">
                                        {{ form.enable_public_registration.errors.0 }}
                                    </div>
                                {% endif %}
                                <div class="form-text">
                                    {{ form.enable_public_registration.help_text }}
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Configuración de Telegram -->
                    <div class="card mb-4">
                        <div class="card-header d-flex justify-content-between align-items-center">
                            <h5 class="mb-0">
                                <i class="bi bi-telegram text-primary"></i> 
                                Notificaciones de Telegram
                            </h5>
                            {% if config.telegram_bot_token and config.telegram_chat_id %}
                                <button type="submit" name="test_telegram" class="btn btn-sm btn-outline-primary">
                                    <i class="bi bi-send"></i> Probar Conexión
                                </button>
                            {% endif %}
                        </div>
                        <div class="card-body">
                            <div class="alert alert-info" role="alert">
                                <div class="d-flex align-items-start">
                                    <i class="bi bi-info-circle me-2 mt-1"></i>
                                    <div>
                                        <strong>¿Cómo configurar Telegram?</strong><br>
                                        <small>
                                            1. Habla con <a href="https://t.me/BotFather" target="_blank">@BotFather</a> en Telegram<br>
                                            2. Crea un nuevo bot con <code>/newbot</code><br>
                                            3. Copia el token que te proporciona<br>
                                            4. Agrega el bot a tu grupo y obtén el ID del chat<br>
                                            5. Configura los datos aquí y prueba la conexión
                                        </small>
                                    </div>
                                </div>
                            </div>

                            <div class="mb-3">
                                <div class="form-check form-switch">
                                    {{ form.enable_telegram_notifications }}
                                    <label for="{{ form.enable_telegram_notifications.id_for_label }}" class="form-check-label">
                                        {{ form.enable_telegram_notifications.label }}
                                    </label>
                                </div>
                                {% if form.enable_telegram_notifications.errors %}
                                    <div class="text-danger small">
                                        {{ form.enable_telegram_notifications.errors.0 }}
                                    </div>
                                {% endif %}
                                <div class="form-text">
                                    {{ form.enable_telegram_notifications.help_text }}
                                </div>
                            </div>

                            <div id="telegram-config" style="{% if not config.enable_telegram_notifications %}display: none;{% endif %}">
                                <div class="mb-3">
                                    <label for="{{ form.telegram_bot_token.id_for_label }}" class="form-label">
                                        {{ form.telegram_bot_token.label }}
                                    </label>
                                    {{ form.telegram_bot_token }}
                                    {% if form.telegram_bot_token.errors %}
                                        <div class="text-danger small">
                                            {{ form.telegram_bot_token.errors.0 }}
                                        </div>
                                    {% endif %}
                                    <div class="form-text">
                                        {{ form.telegram_bot_token.help_text }}
                                    </div>
                                </div>

                                <div class="mb-3">
                                    <label for="{{ form.telegram_chat_id.id_for_label }}" class="form-label">
                                        {{ form.telegram_chat_id.label }}
                                    </label>
                                    {{ form.telegram_chat_id }}
                                    {% if form.telegram_chat_id.errors %}
                                        <div class="text-danger small">
                                            {{ form.telegram_chat_id.errors.0 }}
                                        </div>
                                    {% endif %}
                                    <div class="form-text">
                                        {{ form.telegram_chat_id.help_text }}
                                    </div>
                                </div>

                                {% if config.enable_telegram_notifications %}
                                <div class="alert alert-light border">
                                    <h6 class="mb-2">
                                        <i class="bi bi-gear"></i> Estado de la configuración
                                    </h6>
                                    <div class="row text-center">
                                        <div class="col-md-4">
                                            <div class="text-{% if config.enable_telegram_notifications %}success{% else %}muted{% endif %}">
                                                <i class="bi bi-{% if config.enable_telegram_notifications %}check-circle-fill{% else %}x-circle{% endif %}"></i>
                                            </div>
                                            <small>Habilitado</small>
                                        </div>
                                        <div class="col-md-4">
                                            <div class="text-{% if config.telegram_bot_token %}success{% else %}warning{% endif %}">
                                                <i class="bi bi-{% if config.telegram_bot_token %}check-circle-fill{% else %}exclamation-triangle{% endif %}"></i>
                                            </div>
                                            <small>Token Bot</small>
                                        </div>
                                        <div class="col-md-4">
                                            <div class="text-{% if config.telegram_chat_id %}success{% else %}warning{% endif %}">
                                                <i class="bi bi-{% if config.telegram_chat_id %}check-circle-fill{% else %}exclamation-triangle{% endif %}"></i>
                                            </div>
                                            <small>Chat ID</small>
                                        </div>
                                    </div>
                                </div>
                                {% endif %}
                            </div>
                        </div>
                    </div>

                    <div class="d-flex gap-2">
                        <button type="submit" class="btn btn-primary">
                            <i class="bi bi-check-circle"></i> Guardar Configuración
                        </button>
                        <a href="{% url 'dashboard' %}" class="btn btn-secondary">
                            <i class="bi bi-x-circle"></i> Cancelar
                        </a>
                    </div>
                </form>
            </div>

            <div class="col-lg-4">
                <!-- Información de ayuda -->
                <div class="card">
                    <div class="card-header">
                        <h6 class="mb-0">
                            <i class="bi bi-question-circle"></i> Ayuda
                        </h6>
                    </div>
                    <div class="card-body">
                        <h6>Notificaciones de Telegram</h6>
                        <p class="small text-muted">
                            Cuando se active, el sistema enviará un mensaje al grupo de Telegram 
                            cada vez que se cree un nuevo ticket con información como:
                        </p>
                        <ul class="small text-muted">
                            <li>Número del ticket</li>
                            <li>Título y descripción</li>
                            <li>Usuario que lo creó</li>
                            <li>Prioridad y empresa</li>
                            <li>Fecha de creación</li>
                        </ul>

                        <hr>

                        <h6>Ejemplo de notificación:</h6>
                        <div class="bg-light p-2 rounded small">
                            🎫 <strong>Nuevo Ticket Creado</strong><br>
                            📋 <strong>Ticket:</strong> #T01-001<br>
                            📝 <strong>Título:</strong> Crear clientes<br>
                            👤 <strong>Creado por:</strong> Juan Pérez<br>
                            🟡 <strong>Prioridad:</strong> Media<br>
                            🏢 <strong>Empresa:</strong> Mi Empresa<br>
                            📅 <strong>Fecha:</strong> 08/10/2025 15:30
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
// Mostrar/ocultar configuración de Telegram
document.addEventListener('DOMContentLoaded', function() {
    const telegramToggle = document.getElementById('{{ form.enable_telegram_notifications.id_for_label }}');
    const telegramConfig = document.getElementById('telegram-config');
    
    if (telegramToggle) {
        telegramToggle.addEventListener('change', function() {
            if (this.checked) {
                telegramConfig.style.display = 'block';
            } else {
                telegramConfig.style.display = 'none';
            }
        });
    }
});
</script>
{% endblock %}