{% load django_bootstrap5 %}
{% load static %}
{% load project_extras %}
<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    
    <!-- Título dinámico con nombre del usuario -->
    <title>{% block title %}{% if user.is_authenticated %}{{ user.first_name|default:user.username }} - TicketProo{% else %}TicketProo - Sistema de Gestión de Tickets{% endif %}{% endblock %}</title>
    
    <!-- Favicon dinámico -->
    <link rel="icon" id="favicon" href="" type="image/svg+xml">
    
    {% bootstrap_css %}
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.0/font/bootstrap-icons.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link rel="stylesheet" href="{% static 'css/style.css' %}">
</head>
<body class="bg-light">
    {% if user.is_authenticated %}
            {% if is_working %}
                <!-- Navbar verde cuando está trabajando -->
                <nav class="navbar navbar-expand-lg navbar-dark bg-success">
            {% else %}
                <!-- Navbar normal cuando no está trabajando -->
                <nav class="navbar navbar-expand-lg navbar-dark bg-dark">
            {% endif %}
            <div class="container">
                <a class="navbar-brand fw-bold" href="{% url 'home' %}">
                    <i class="bi bi-ticket-perforated"></i> TicketProo
                </a>
            
            <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav">
                <span class="navbar-toggler-icon"></span>
            </button>
            
            <div class="collapse navbar-collapse" id="navbarNav">
                <ul class="navbar-nav me-auto">
                    <li class="nav-item">
                        <a class="nav-link {% if request.resolver_match.url_name == 'dashboard' %}active{% endif %}" 
                           href="{% url 'dashboard' %}">
                            <i class="bi bi-house-door"></i>
                        </a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link {% if request.resolver_match.url_name == 'ticket_list' %}active{% endif %}" 
                           href="{% url 'ticket_list' %}">
                            <i class="bi bi-list-ul"></i> 
                            {% if user.groups.all and user.groups.first.name == 'Agentes' %}
                                Todos
                            {% else %}
                                Mis Tickets
                            {% endif %}
                        </a>
                    </li>
                    <!--
                    <li class="nav-item">
                        <a class="nav-link {% if request.resolver_match.url_name == 'ticket_create' %}active{% endif %}" 
                           href="{% url 'ticket_create' %}">
                            <i class="bi bi-plus-circle"></i>
                        </a>
                    </li>
                    -->
                    
                    <!-- Menú de Chat -->
                    <li class="nav-item dropdown">
                        <a class="nav-link dropdown-toggle {% if 'chat' in request.resolver_match.url_name or 'ai_chat' in request.resolver_match.url_name %}active{% endif %}" 
                           href="#" id="navbarDropdownChat" role="button" data-bs-toggle="dropdown">
                            <i class="bi bi-chat-dots"></i>
                        </a>
                        <ul class="dropdown-menu">
                            <li>
                                <a class="dropdown-item {% if 'chat' in request.resolver_match.url_name and 'ai_chat' not in request.resolver_match.url_name %}active{% endif %}" 
                                   href="{% url 'chat_list' %}">
                                    <i class="bi bi-people"></i> Chat de Usuarios
                                </a>
                            </li>
                            <li>
                                <a class="dropdown-item {% if 'ai_chat' in request.resolver_match.url_name %}active{% endif %}" 
                                   href="{% url 'ai_chat_list' %}">
                                    <i class="bi bi-robot"></i> Chat con IA
                                </a>
                            </li>
                        </ul>
                    </li>
                    
                    <!-- Menú de Empleado - Solo para Agentes y Administradores -->
                    {% if user.is_authenticated %}
                        {% if user.is_staff or user.is_superuser or user.groups.all and user.groups.first.name == 'Agentes' %}
                    <li class="nav-item dropdown">
                        <a class="nav-link dropdown-toggle {% if 'employee_request' in request.resolver_match.url_name or 'ai_manager' in request.resolver_match.url_name or 'employee_dashboard' in request.resolver_match.url_name or 'internal_agreement' in request.resolver_match.url_name or 'training_plan' in request.resolver_match.url_name or 'my_training_progress' in request.resolver_match.url_name or 'ai_recommendation' in request.resolver_match.url_name or 'employee_absence' in request.resolver_match.url_name or 'absence_type' in request.resolver_match.url_name or 'company_protocol' in request.resolver_match.url_name or 'ai_tutor' in request.resolver_match.url_name or 'video_meeting' in request.resolver_match.url_name or 'expense_report' in request.resolver_match.url_name %}active{% endif %}" 
                           href="#" id="navbarDropdownEmployee" role="button" data-bs-toggle="dropdown">
                            <i class="bi bi-person-badge"></i> Empleado
                        </a>
                        <ul class="dropdown-menu">
                            <li>
                                <a class="dropdown-item {% if request.resolver_match.url_name == 'employee_dashboard' %}active{% endif %}" 
                                   href="{% url 'employee_dashboard' %}">
                                    <i class="bi bi-speedometer2"></i> Dashboard de Empleado
                                </a>
                            </li>
                            <li><hr class="dropdown-divider"></li>
                            <li>
                                <a class="dropdown-item {% if request.resolver_match.url_name == 'employee_request_list' %}active{% endif %}" 
                                   href="{% url 'employee_request_list' %}">
                                    <i class="bi bi-file-earmark-text"></i> Solicitudes de Empleados
                                </a>
                            </li>
                            <li>
                                <a class="dropdown-item {% if request.resolver_match.url_name == 'employee_request_create' %}active{% endif %}" 
                                   href="{% url 'employee_request_create' %}">
                                    <i class="bi bi-plus-circle"></i> Nueva Solicitud
                                </a>
                            </li>
                            <li><hr class="dropdown-divider"></li>
                            <li>
                                <a class="dropdown-item {% if 'expense_report' in request.resolver_match.url_name %}active{% endif %}" 
                                   href="{% url 'expense_report_list' %}">
                                    <i class="bi bi-receipt"></i> Rendición de Gastos
                                </a>
                            </li>
                            <li>
                                <a class="dropdown-item {% if 'video_meeting' in request.resolver_match.url_name %}active{% endif %}" 
                                   href="{% url 'video_meeting_list' %}">
                                    <i class="bi bi-camera-video"></i> Reuniones de Video
                                </a>
                            </li>
                            <li>
                                <a class="dropdown-item {% if 'quote_generator' in request.resolver_match.url_name %}active{% endif %}" 
                                   href="{% url 'quote_generator_list' %}">
                                    <i class="bi bi-chat-quote"></i> Generador de Citas IA
                                </a>
                            </li>
                            <li>
                                <a class="dropdown-item {% if 'ai_manager' in request.resolver_match.url_name %}active{% endif %}" 
                                   href="{% url 'ai_manager_list' %}">
                                    <i class="bi bi-robot"></i> AI Managers
                                </a>
                            </li>
                            <li><hr class="dropdown-divider"></li>
                            <li>
                                <a class="dropdown-item {% if 'internal_agreement' in request.resolver_match.url_name %}active{% endif %}" 
                                   href="{% url 'internal_agreement_list' %}">
                                    <i class="bi bi-file-earmark-check"></i> Acuerdos Internos
                                </a>
                            </li>
                            <li>
                                <a class="dropdown-item {% if request.resolver_match.url_name == 'internal_agreement_create' %}active{% endif %}" 
                                   href="{% url 'internal_agreement_create' %}">
                                    <i class="bi bi-plus-circle"></i> Nuevo Acuerdo
                                </a>
                            </li>
                            <li><hr class="dropdown-divider"></li>
                            <li>
                                <a class="dropdown-item {% if 'training_plan' in request.resolver_match.url_name %}active{% endif %}" 
                                   href="{% url 'training_plan_list' %}">
                                    <i class="bi bi-mortarboard"></i> Planes de Capacitación
                                </a>
                            </li>
                            <li>
                                <a class="dropdown-item {% if request.resolver_match.url_name == 'my_training_progress' %}active{% endif %}" 
                                   href="{% url 'my_training_progress' %}">
                                    <i class="bi bi-graph-up"></i> Mi Progreso
                                </a>
                            </li>
                            <li><hr class="dropdown-divider"></li>
                            <li>
                                <a class="dropdown-item {% if 'ai_recommendation' in request.resolver_match.url_name %}active{% endif %}" 
                                   href="{% url 'ai_recommendation_list' %}">
                                    <i class="bi bi-lightbulb"></i> Recomendaciones IA
                                </a>
                            </li>
                            <li><hr class="dropdown-divider"></li>
                            <li>
                                <a class="dropdown-item {% if 'employee_absence' in request.resolver_match.url_name %}active{% endif %}" 
                                   href="{% url 'employee_absence_list' %}">
                                    <i class="bi bi-calendar-x"></i> Gestión de Ausencias
                                </a>
                            </li>
                            <li>
                                <a class="dropdown-item {% if request.resolver_match.url_name == 'employee_absence_calendar' %}active{% endif %}" 
                                   href="{% url 'employee_absence_calendar' %}">
                                    <i class="bi bi-calendar3"></i> Calendario de Ausencias
                                </a>
                            </li>
                            <li>
                                <a class="dropdown-item {% if 'absence_type' in request.resolver_match.url_name %}active{% endif %}" 
                                   href="{% url 'absence_type_list' %}">
                                    <i class="bi bi-gear"></i> Tipos de Ausencias
                                </a>
                            </li>
                            <li><hr class="dropdown-divider"></li>
                            
                            <li>
                                <a class="dropdown-item {% if 'asset' in request.resolver_match.url_name %}active{% endif %}" 
                                   href="{% url 'asset_list' %}">
                                    <i class="bi bi-laptop"></i> Control de Activos
                                </a>
                            </li>

                            <li>
                                <a class="dropdown-item {% if 'ai_tutor' in request.resolver_match.url_name %}active{% endif %}" 
                                   href="{% url 'ai_tutor_list' %}">
                                    <i class="fas fa-robot"></i> Tutor IA
                                </a>
                            </li>

                            <li><hr class="dropdown-divider"></li>
                            
                            <li>
                                <a class="dropdown-item {% if 'company_protocol' in request.resolver_match.url_name %}active{% endif %}" 
                                   href="{% url 'company_protocol_list' %}">
                                    <i class="bi bi-file-text"></i> Protocolos Empresa
                                </a>
                            </li>
                            <li>
                                <a class="dropdown-item {% if request.resolver_match.url_name == 'company_protocol_create' %}active{% endif %}" 
                                   href="{% url 'company_protocol_create' %}">
                                    <i class="bi bi-plus-circle"></i> Nuevo Protocolo
                                </a>
                            </li>
                        </ul>
                    </li>
                        {% endif %}
                    {% endif %}
                    
                    <!-- Menú de Capacitación -->
                    {% if user.is_authenticated %}
                    <li class="nav-item dropdown">
                        <a class="nav-link dropdown-toggle {% if 'course' in request.resolver_match.url_name or 'exam' in request.resolver_match.url_name %}active{% endif %}" 
                           href="#" id="navbarDropdownTraining" role="button" data-bs-toggle="dropdown">
                            <i class="bi bi-book"></i> Capacitación
                        </a>
                        <ul class="dropdown-menu">
                            <li>
                                <a class="dropdown-item {% if request.resolver_match.url_name == 'course_list' %}active{% endif %}" 
                                   href="{% url 'course_list' %}">
                                    <i class="bi bi-collection"></i> Cursos
                                </a>
                            </li>
                            <li>
                                <a class="dropdown-item {% if request.resolver_match.url_name == 'exam_list' %}active{% endif %}" 
                                   href="{% url 'exam_list' %}">
                                    <i class="bi bi-question-circle"></i> Exámenes
                                </a>
                            </li>
                            <li>
                                <a class="dropdown-item {% if request.resolver_match.url_name == 'qr_generator' %}active{% endif %}" 
                                   href="{% url 'qr_generator' %}">
                                    <i class="bi bi-qr-code"></i> Generador QR
                                </a>
                            </li>
                            
                            <!-- Opciones adicionales para Agentes y Profesores -->
                            {% if user|can_manage_courses %}
                            <li><hr class="dropdown-divider"></li>
                            <li class="dropdown-header">
                                Gestión 
                                {% if user.groups.all %}
                                    ({{ user.groups.first.name }})
                                {% endif %}
                            </li>
                            <li>
                                <a class="dropdown-item {% if request.resolver_match.url_name == 'course_create' %}active{% endif %}" 
                                   href="{% url 'course_create' %}">
                                    <i class="bi bi-plus-circle"></i> Crear Curso
                                </a>
                            </li>
                            <li>
                                <a class="dropdown-item {% if request.resolver_match.url_name == 'exam_create' %}active{% endif %}" 
                                   href="{% url 'exam_create' %}">
                                    <i class="bi bi-plus-circle"></i> Crear Examen
                                </a>
                            </li>
                            {% if user.groups.all and user.groups.first.name == 'Agentes' %}
                            <li>
                                <a class="dropdown-item {% if request.resolver_match.url_name == 'exam_attempts_list' %}active{% endif %}" 
                                   href="{% url 'exam_attempts_list' %}">
                                    <i class="bi bi-clipboard-data"></i> Intentos de Exámenes
                                </a>
                            </li>
                            {% endif %}
                            {% endif %}
                        </ul>
                    </li>
                    {% endif %}
                    
                    <!-- Menú de Compartir Archivos - Solo para Agentes y Administradores -->
                    {% if user.is_authenticated %}
                        {% if user.is_staff or user.is_superuser or user.groups.all and user.groups.first.name == 'Agentes' %}
                    <li class="nav-item dropdown">
                        <a class="nav-link dropdown-toggle {% if 'shared_file' in request.resolver_match.url_name or 'form' in request.resolver_match.url_name %}active{% endif %}" 
                           href="#" id="navbarDropdownFiles" role="button" data-bs-toggle="dropdown">
                            <i class="bi bi-folder-symlink"></i> Comp.
                        </a>
                        <ul class="dropdown-menu">
                            <li class="dropdown-header">Archivos</li>
                            <li>
                                <a class="dropdown-item {% if request.resolver_match.url_name == 'shared_files_list' %}active{% endif %}" 
                                   href="{% url 'shared_files_list' %}">
                                    <i class="bi bi-files"></i> Mis Archivos
                                </a>
                            </li>
                            <li>
                                <a class="dropdown-item {% if request.resolver_match.url_name == 'shared_file_upload' %}active{% endif %}" 
                                   href="{% url 'shared_file_upload' %}">
                                    <i class="bi bi-cloud-upload"></i> Subir Archivo
                                </a>
                            </li>
                            <li><hr class="dropdown-divider"></li>
                            <li class="dropdown-header">Grabaciones</li>
                            <li>
                                <a class="dropdown-item {% if request.resolver_match.url_name == 'recordings_list' %}active{% endif %}" 
                                   href="{% url 'recordings_list' %}">
                                    <i class="bi bi-mic"></i> Mis Grabaciones
                                </a>
                            </li>
                            <li>
                                <a class="dropdown-item {% if request.resolver_match.url_name == 'recording_upload' %}active{% endif %}" 
                                   href="{% url 'recording_upload' %}">
                                    <i class="bi bi-mic-fill"></i> Subir Grabación
                                </a>
                            </li>
                            <li><hr class="dropdown-divider"></li>
                            <li class="dropdown-header">Formularios y Encuestas</li>
                            <li>
                                <a class="dropdown-item {% if request.resolver_match.url_name == 'form_list' %}active{% endif %}" 
                                   href="{% url 'form_list' %}">
                                    <i class="bi bi-list-ul"></i> Ver Formularios
                                </a>
                            </li>
                            <li>
                                <a class="dropdown-item {% if request.resolver_match.url_name == 'form_create' %}active{% endif %}" 
                                   href="{% url 'form_create' %}">
                                    <i class="bi bi-plus-circle"></i> Crear Formulario
                                </a>
                            </li>
                            <li><hr class="dropdown-divider"></li>
                            <li class="dropdown-header">Alcances</li>
                            <li>
                                <a class="dropdown-item {% if request.resolver_match.url_name == 'alcance_list' %}active{% endif %}" 
                                   href="{% url 'alcance_list' %}">
                                    <i class="bi bi-bullseye"></i> Ver Alcances
                                </a>
                            </li>
                            <li>
                                <a class="dropdown-item {% if request.resolver_match.url_name == 'alcance_create' %}active{% endif %}" 
                                   href="{% url 'alcance_create' %}">
                                    <i class="bi bi-plus-circle"></i> Crear Alcance
                                </a>
                            </li>
                            <li><hr class="dropdown-divider"></li>
                            <li class="dropdown-header">IA - Image to Prompt</li>
                            <li>
                                <a class="dropdown-item {% if request.resolver_match.url_name == 'image_prompt_list' %}active{% endif %}" 
                                   href="{% url 'image_prompt_list' %}">
                                    <i class="bi bi-list-task"></i> Mis Prompts
                                </a>
                            </li>
                            <li>
                                <a class="dropdown-item {% if request.resolver_match.url_name == 'image_prompt_create' %}active{% endif %}" 
                                   href="{% url 'image_prompt_create' %}">
                                    <i class="bi bi-image"></i> Generar Prompt desde Imagen
                                </a>
                            </li>
                            <li><hr class="dropdown-divider"></li>
                            <li class="dropdown-header">Gerentes IA</li>
                            <li>
                                <a class="dropdown-item {% if 'company_ai_dashboard' in request.resolver_match.url_name %}active{% endif %}" 
                                   href="{% url 'company_ai_dashboard_list' %}">
                                    <i class="bi bi-building"></i> Dashboard Empresarial
                                </a>
                            </li>
                            <li>
                                <a class="dropdown-item {% if 'user_ai_performance' in request.resolver_match.url_name %}active{% endif %}" 
                                   href="{% url 'user_ai_performance_dashboard' %}">
                                    <i class="bi bi-person-check"></i> Desempeño de Usuarios
                                </a>
                            </li>
                            <li>
                                <a class="dropdown-item {% if request.resolver_match.url_name == 'ai_manager_list' %}active{% endif %}" 
                                   href="{% url 'ai_manager_list' %}">
                                    <i class="bi bi-robot"></i> Ver Gerentes IA
                                </a>
                            </li>
                            <li>
                                <a class="dropdown-item {% if request.resolver_match.url_name == 'ai_manager_create' %}active{% endif %}" 
                                   href="{% url 'ai_manager_create' %}">
                                    <i class="bi bi-plus-circle"></i> Crear Gerente IA
                                </a>
                            </li>
                            <li><hr class="dropdown-divider"></li>
                            <li class="dropdown-header">WhatsApp</li>
                            <li>
                                <a class="dropdown-item {% if 'whatsapp' in request.resolver_match.url_name %}active{% endif %}" 
                                   href="{% url 'whatsapp_dashboard' %}">
                                    <i class="fab fa-whatsapp"></i> Dashboard
                                </a>
                            </li>
                            <li>
                                <a class="dropdown-item {% if request.resolver_match.url_name == 'whatsapp_keyword_create' %}active{% endif %}" 
                                   href="{% url 'whatsapp_keyword_create' %}">
                                    <i class="bi bi-plus-circle"></i> Nueva Palabra Clave
                                </a>
                            </li>
                            <li>
                                <a class="dropdown-item {% if request.resolver_match.url_name == 'whatsapp_messages' %}active{% endif %}" 
                                   href="{% url 'whatsapp_messages' %}">
                                    <i class="bi bi-chat-dots"></i> Mensajes
                                </a>
                            </li>
                            <li><hr class="dropdown-divider"></li>
                            <li class="dropdown-header">Acceso Público</li>
                            <li>
                                <a class="dropdown-item {% if request.resolver_match.url_name == 'public_file_upload' %}active{% endif %}" 
                                   href="{% url 'public_file_upload' %}" target="_blank">
                                    <i class="bi bi-globe"></i> Subir Archivo Público
                                </a>
                            </li>
                            <li>
                                <a class="dropdown-item {% if request.resolver_match.url_name == 'public_recording_upload' %}active{% endif %}" 
                                   href="{% url 'public_recording_upload' %}" target="_blank">
                                    <i class="bi bi-broadcast"></i> Subir Grabación Pública
                                </a>
                            </li>
                            <!-- Opciones adicionales para Agentes -->
                            {% if user.groups.all and user.groups.first.name == 'Agentes' %}
                            <li><hr class="dropdown-divider"></li>
                            <li class="dropdown-header">Administración</li>
                            <li>
                                <a class="dropdown-item {% if request.resolver_match.url_name == 'shared_files_stats' %}active{% endif %}" 
                                   href="{% url 'shared_files_stats' %}">
                                    <i class="bi bi-bar-chart"></i> Estadísticas Archivos
                                </a>
                            </li>
                            <li>
                                <a class="dropdown-item {% if request.resolver_match.url_name == 'recordings_stats' %}active{% endif %}" 
                                   href="{% url 'recordings_stats' %}">
                                    <i class="bi bi-graph-up"></i> Estadísticas Grabaciones
                                </a>
                            </li>
                            {% endif %}
                        </ul>
                    </li>
                        {% endif %}
                    {% endif %}
                    
                    <!-- Menú de Formularios -->
                    
                    
                    <!-- Menú de gestión para agentes -->
                    {% if user.groups.all and user.groups.first.name == 'Agentes' %}
                    <li class="nav-item dropdown">
                        <a class="nav-link dropdown-toggle {% if 'user' in request.resolver_match.url_name or 'category' in request.resolver_match.url_name or 'blog' in request.resolver_match.url_name %}active{% endif %}" 
                           href="#" id="navbarDropdownManagement" role="button" data-bs-toggle="dropdown">
                            <i class="bi bi-gear"></i> Gestión
                        </a>
                        <ul class="dropdown-menu">
                            <li>
                                <a class="dropdown-item {% if 'notes' in request.resolver_match.url_name %}active{% endif %}" 
                                   href="{% url 'notes_list' %}">
                                    <i class="bi bi-journal-text"></i> Notas Internas
                                </a>
                            </li>
                            <li>
                                <a class="dropdown-item {% if 'category' in request.resolver_match.url_name %}active{% endif %}" 
                                   href="{% url 'category_list' %}">
                                    <i class="bi bi-tags"></i> Categorías
                                </a>
                            </li>
                            <li>
                                <a class="dropdown-item {% if 'project' in request.resolver_match.url_name %}active{% endif %}" 
                                   href="{% url 'project_list' %}">
                                    <i class="bi bi-folder"></i> Proyectos
                                </a>
                            </li>
                            <li>
                                <a class="dropdown-item {% if 'product' in request.resolver_match.url_name %}active{% endif %}" 
                                   href="{% url 'product_list' %}">
                                    <i class="bi bi-box-seam"></i> Productos
                                </a>
                            </li>
                            <li>
                                <a class="dropdown-item {% if 'company' in request.resolver_match.url_name %}active{% endif %}" 
                                   href="{% url 'company_list' %}">
                                    <i class="bi bi-building"></i> Empresas
                                </a>
                            </li>
                            <li>
                                <a class="dropdown-item {% if 'contacto_web' in request.resolver_match.url_name %}active{% endif %}" 
                                   href="{% url 'contactos_web_list' %}">
                                    <i class="bi bi-envelope-plus"></i> Contactos Web
                                </a>
                            </li>
                            <li>
                                <a class="dropdown-item {% if 'landing_page' in request.resolver_match.url_name %}active{% endif %}" 
                                   href="{% url 'landing_page_list' %}">
                                    <i class="fas fa-rocket"></i> Landing Pages
                                </a>
                            </li>
                            <li>
                                <a class="dropdown-item {% if 'landing_submissions' in request.resolver_match.url_name or 'ai_evaluation' in request.resolver_match.url_name %}active{% endif %}" 
                                   href="{% url 'landing_submissions_list' %}">
                                    <i class="fas fa-robot text-primary"></i> Evaluación IA
                                </a>
                            </li>
                            <li><hr class="dropdown-divider"></li>
                            <li>
                                <a class="dropdown-item {% if 'contact' in request.resolver_match.url_name %}active{% endif %}" 
                                   href="{% url 'contact_list' %}">
                                    <i class="bi bi-person-lines-fill"></i> Contactos
                                </a>
                            </li>
                            <li>
                                <a class="dropdown-item {% if 'crm' in request.resolver_match.url_name or 'opportunity' in request.resolver_match.url_name %}active{% endif %}" 
                                   href="{% url 'crm_dashboard' %}">
                                    <i class="bi bi-graph-up-arrow"></i> CRM
                                </a>
                            </li>
                            <li>
                                <a class="dropdown-item {% if 'my_activities' in request.resolver_match.url_name %}active{% endif %}" 
                                   href="{% url 'my_activities_dashboard' %}">
                                    <i class="fas fa-tasks"></i> Mis Actividades
                                </a>
                            </li>
                            <li>
                                <a class="dropdown-item {% if 'opportunity_status' in request.resolver_match.url_name %}active{% endif %}" 
                                   href="{% url 'opportunity_status_list' %}">
                                    <i class="bi bi-kanban"></i> Estados CRM
                                </a>
                            </li>
                            <li>
                                <a class="dropdown-item {% if 'meeting' in request.resolver_match.url_name %}active{% endif %}" 
                                   href="{% url 'meeting_list' %}">
                                    <i class="bi bi-calendar-event"></i> Reuniones
                                </a>
                            </li>
                            <li><hr class="dropdown-divider"></li>
                            <li>
                                <a class="dropdown-item {% if 'contact_submission' in request.resolver_match.url_name %}active{% endif %}" 
                                   href="{% url 'contact_submissions_list' %}">
                                    <i class="bi bi-envelope-paper"></i> Formularios de Contacto
                                </a>
                            </li>
                            <li><hr class="dropdown-divider"></li>
                            <li class="dropdown-header">Blog</li>
                            <li>
                                <a class="dropdown-item {% if request.resolver_match.url_name == 'blog_post_list_admin' %}active{% endif %}" 
                                   href="{% url 'blog_post_list_admin' %}">
                                    <i class="bi bi-newspaper"></i> Gestionar Blog
                                </a>
                            </li>
                            <li>
                                <a class="dropdown-item {% if request.resolver_match.url_name == 'blog_post_create' %}active{% endif %}" 
                                   href="{% url 'blog_post_create' %}">
                                    <i class="bi bi-plus-circle"></i> Nuevo Artículo
                                </a>
                            </li>
                            <li>
                                <a class="dropdown-item {% if request.resolver_match.url_name == 'blog_category_list' %}active{% endif %}" 
                                   href="{% url 'blog_category_list' %}">
                                    <i class="bi bi-tags"></i> Categorías
                                </a>
                            </li>
                            <li><hr class="dropdown-divider"></li>
                            <li>
                                <a class="dropdown-item {% if request.resolver_match.url_name in 'task_list,task_create,task_detail,task_edit,task_delete,task_toggle_status,task_control_dashboard,task_control_complete,task_control_start,task_control_pause' %}active{% endif %}" 
                                   href="{% url 'task_list' %}">
                                    <i class="bi bi-list-task"></i> Tareas
                                </a>
                            </li>
                            <li>
                                <a class="dropdown-item {% if request.resolver_match.url_name in 'daily_task_management,create_task_session,view_task_session,delete_task_session,toggle_daily_task_completion,daily_task_history' %}active{% endif %}" 
                                   href="{% url 'daily_task_management' %}">
                                    <i class="bi bi-journal-check"></i> Gestiones de Tareas
                                </a>
                            </li>
                            <li><hr class="dropdown-divider"></li>
                            <li>
                                <a class="dropdown-item {% if 'work_order' in request.resolver_match.url_name %}active{% endif %}" 
                                   href="{% url 'work_order_list' %}">
                                    <i class="bi bi-clipboard-check"></i> Órdenes de Trabajo
                                </a>
                            </li>
                            <li><hr class="dropdown-divider"></li>
                            <li class="dropdown-header">Conceptos</li>
                            <li>
                                <a class="dropdown-item {% if 'concept' in request.resolver_match.url_name %}active{% endif %}" 
                                   href="{% url 'concept_list' %}">
                                    <i class="bi bi-lightbulb"></i> Gestionar Conceptos
                                </a>
                            </li>
                            <li>
                                <a class="dropdown-item {% if request.resolver_match.url_name == 'concept_create' %}active{% endif %}" 
                                   href="{% url 'concept_create' %}">
                                    <i class="bi bi-plus-circle"></i> Nuevo Concepto
                                </a>
                            </li>
                        </ul>
                    </li>
                    
                    <!-- Menú QA - Quejas y Sugerencias (Solo para Agentes) -->
                    <li class="nav-item dropdown">
                        <a class="nav-link dropdown-toggle {% if 'qa_' in request.resolver_match.url_name %}active{% endif %}" 
                           href="#" id="navbarDropdownQA" role="button" data-bs-toggle="dropdown">
                            <i class="fas fa-comments"></i> QA
                        </a>
                        <ul class="dropdown-menu">
                            <li class="dropdown-header">Control de Calidad</li>
                            
                            <li>
                                <a class="dropdown-item {% if request.resolver_match.url_name == 'qa_complaint_list' %}active{% endif %}" 
                                   href="{% url 'qa_complaint_list' %}">
                                    <i class="fas fa-list"></i> Gestionar Reportes
                                </a>
                            </li>
                            <li>
                                <a class="dropdown-item {% if request.resolver_match.url_name == 'qa_complaint_create' %}active{% endif %}" 
                                   href="{% url 'qa_complaint_create' %}">
                                    <i class="fas fa-plus-circle"></i> Nuevo Reporte QA
                                </a>
                            </li>
                            <li><hr class="dropdown-divider"></li>
                            <li class="dropdown-header">Cumplimiento</li>
                            <li>
                                <a class="dropdown-item {% if 'monthly_cumplimiento' in request.resolver_match.url_name %}active{% endif %}" 
                                   href="{% url 'monthly_cumplimiento_list' %}">
                                    <i class="fas fa-calendar-check"></i> Cumplimiento Mensual
                                </a>
                            </li>
                            <li><hr class="dropdown-divider"></li>
                            <li class="dropdown-header">Filtros Rápidos</li>
                            <li>
                                <a class="dropdown-item" href="{% url 'qa_complaint_list' %}?status=open">
                                    <i class="fas fa-exclamation-circle text-danger"></i> Reportes Abiertos
                                </a>
                            </li>
                            <li>
                                <a class="dropdown-item" href="{% url 'qa_complaint_list' %}?assigned=me">
                                    <i class="fas fa-user-check text-primary"></i> Mis Asignaciones
                                </a>
                            </li>
                            <li>
                                <a class="dropdown-item" href="{% url 'qa_complaint_list' %}?priority=critical">
                                    <i class="fas fa-exclamation-triangle text-danger"></i> Prioridad Crítica
                                </a>
                            </li>
                            <li>
                                <a class="dropdown-item" href="{% url 'qa_complaint_list' %}?type=complaint">
                                    <i class="fas fa-frown text-warning"></i> Solo Quejas
                                </a>
                            </li>
                            <li>
                                <a class="dropdown-item" href="{% url 'qa_complaint_list' %}?type=suggestion">
                                    <i class="fas fa-lightbulb text-info"></i> Solo Sugerencias
                                </a>
                            </li>
                        </ul>
                    </li>
                    
                    <!-- Menú Herramientas (Solo para Agentes) -->
                    <li class="nav-item dropdown">
                        <a class="nav-link dropdown-toggle" href="#" id="toolsDropdown" role="button" data-bs-toggle="dropdown" aria-expanded="false">
                            <i class="bi bi-tools"></i> Her.
                        </a>
                        <ul class="dropdown-menu" aria-labelledby="toolsDropdown">
                            <li class="dropdown-header">Herramientas de PDF</li>
                            <li>
                                <a class="dropdown-item {% if 'pdf_get_pages' in request.resolver_match.url_name %}active{% endif %}" 
                                   href="{% url 'pdf_get_pages' %}">
                                    <i class="bi bi-file-earmark-pdf"></i> GetPDFPage
                                </a>
                            </li>
                            <li>
                                <a class="dropdown-item {% if 'pdf_join' in request.resolver_match.url_name %}active{% endif %}" 
                                   href="{% url 'pdf_join' %}">
                                    <i class="bi bi-files"></i> JointPDF
                                </a>
                            </li>
                            <li>
                                <a class="dropdown-item {% if 'pdf_split' in request.resolver_match.url_name %}active{% endif %}" 
                                   href="{% url 'pdf_split' %}">
                                    <i class="bi bi-file-earmark-break"></i> Pdf2Pdfs
                                </a>
                            </li>
                            <li><hr class="dropdown-divider"></li>
                            <li class="dropdown-header">Calculadora</li>
                            <li>
                                <a class="dropdown-item {% if 'calculator' in request.resolver_match.url_name %}active{% endif %}" 
                                   href="{% url 'calculator' %}">
                                    <i class="bi bi-calculator"></i> Calculadora
                                </a>
                            </li>
                            <li><hr class="dropdown-divider"></li>
                            <li class="dropdown-header">Comandos</li>
                            <li>
                                <a class="dropdown-item {% if 'command_library' in request.resolver_match.url_name %}active{% endif %}" 
                                   href="{% url 'command_library' %}">
                                    <i class="bi bi-terminal"></i> Biblioteca de Comandos
                                </a>
                            </li>
                            <li><hr class="dropdown-divider"></li>
                            <li class="dropdown-header">Diseño</li>
                            <li>
                                <a class="dropdown-item {% if 'color_picker' in request.resolver_match.url_name %}active{% endif %}" 
                                   href="{% url 'color_picker' %}">
                                    <i class="bi bi-palette"></i> Color Picker
                                </a>
                            </li>
                            <li><hr class="dropdown-divider"></li>
                            <li class="dropdown-header">Redes y Análisis</li>
                            <li>
                                <a class="dropdown-item {% if 'website_tracker' in request.resolver_match.url_name %}active{% endif %}" 
                                   href="{% url 'website_tracker_list' %}">
                                    <i class="bi bi-radar"></i> Rastreador Web
                                </a>
                            </li>
                            <li><hr class="dropdown-divider"></li>
                            <li class="dropdown-header">Proceso de Selección</li>
                            <li>
                                <a class="dropdown-item {% if 'candidate' in request.resolver_match.url_name %}active{% endif %}" 
                                   href="{% url 'candidate_list' %}">
                                    <i class="bi bi-person-check"></i> Candidatos
                                </a>
                            </li>
                            <li>
                                <a class="dropdown-item {% if 'job_application' in request.resolver_match.url_name %}active{% endif %}" 
                                   href="{% url 'job_application_token_list' %}">
                                    <i class="bi bi-briefcase"></i> Enlaces de Aplicación
                                </a>
                            </li>
                            <li><hr class="dropdown-divider"></li>
                            <li class="dropdown-header">Empleados Activos</li>
                            <li>
                                <a class="dropdown-item {% if 'active_employee' in request.resolver_match.url_name %}active{% endif %}" 
                                   href="{% url 'active_employee_list' %}">
                                    <i class="bi bi-people-fill"></i> Empleados
                                </a>
                            </li>
                            <li>
                                <a class="dropdown-item {% if 'employee' in request.resolver_match.url_name and 'active' not in request.resolver_match.url_name and 'candidate' not in request.resolver_match.url_name and 'payroll' not in request.resolver_match.url_name %}active{% endif %}" 
                                   href="{% url 'employee_list' %}">
                                    <i class="bi bi-list-ul"></i> Todos los Registros
                                </a>
                            </li>
                            
                            <li><hr class="dropdown-divider"></li>
                            <li class="dropdown-header">Nóminas</li>
                            <li>
                                <a class="dropdown-item {% if 'payroll' in request.resolver_match.url_name %}active{% endif %}" 
                                   href="{% url 'active_employee_list' %}">
                                    <i class="bi bi-receipt-cutoff"></i> Gestionar Nóminas
                                </a>
                            </li>
                            <li><hr class="dropdown-divider"></li>
                            <li class="dropdown-header">Gestión de Usuarios</li>
                            <li>
                                <a class="dropdown-item {% if request.resolver_match.url_name == 'user_management' %}active{% endif %}" 
                                   href="{% url 'user_management' %}">
                                    <i class="bi bi-people"></i> Usuarios
                                </a>
                            </li>
                            <li>
                                <a class="dropdown-item {% if request.resolver_match.url_name == 'user_create' %}active{% endif %}" 
                                   href="{% url 'user_create' %}">
                                    <i class="bi bi-person-plus"></i> Crear Usuario
                                </a>
                            </li>
                            <li><hr class="dropdown-divider"></li>
                            <li class="dropdown-header">Sistema</li>
                            <li>
                                <a class="dropdown-item {% if 'system_configuration' in request.resolver_match.url_name %}active{% endif %}" 
                                   href="{% url 'system_configuration' %}">
                                    <i class="bi bi-gear-fill"></i> Configuración del Sistema
                                </a>
                            </li>
                            <li>
                                <a class="dropdown-item {% if 'url_manager' in request.resolver_match.url_name %}active{% endif %}" 
                                   href="{% url 'url_manager_list' %}">
                                    <i class="bi bi-link-45deg"></i> Gestión de URLs
                                </a>
                            </li>
                            <li>
                                <a class="dropdown-item {% if 'short_url' in request.resolver_match.url_name %}active{% endif %}" 
                                   href="{% url 'short_url_list' %}">
                                    <i class="bi bi-scissors"></i> Acortador de URLs
                                </a>
                            </li>
                            <li>
                                <a class="dropdown-item {% if 'public_upload' in request.resolver_match.url_name %}active{% endif %}" 
                                   href="{% url 'public_upload_url_list' %}">
                                    <i class="bi bi-cloud-upload"></i> URLs Públicas de Subida
                                </a>
                            </li>
                            <li>
                                <a class="dropdown-item {% if 'time' in request.resolver_match.url_name %}active{% endif %}" 
                                   href="{% url 'time_clock' %}">
                                    <i class="bi bi-clock"></i> Control de Horario
                                </a>
                            </li>
                            <li>
                                <a class="dropdown-item {% if 'attendance' in request.resolver_match.url_name %}active{% endif %}" 
                                   href="{% url 'attendance_overview' %}">
                                    <i class="bi bi-people-fill"></i> Asistencia General
                                </a>
                            </li>
                            <li><hr class="dropdown-divider"></li>
                            <li class="dropdown-header">Juegos</li>
                            <li>
                                <a class="dropdown-item {% if 'tetris' in request.resolver_match.url_name %}active{% endif %}" 
                                   href="{% url 'tetris' %}">
                                    <i class="bi bi-grid-3x3-gap"></i> Tetris
                                </a>
                            </li>
                        </ul>
                    </li>
                    
                    
                    <li class="nav-item dropdown">
                        <a class="nav-link dropdown-toggle" href="#" id="docDropdown" role="button" data-bs-toggle="dropdown" aria-expanded="false">
                            <i class="bi bi-file-earmark-text"></i> Doc
                        </a>
                        <ul class="dropdown-menu" aria-labelledby="docDropdown">
                            <li>
                                <h6 class="dropdown-header">Documentación</h6>
                            </li>
                            <li>
                                <a class="dropdown-item {% if 'document' in request.resolver_match.url_name %}active{% endif %}" 
                                   href="{% url 'document_list' %}">
                                    <i class="bi bi-file-earmark-text"></i> Documentos
                                </a>
                            </li>
                            <li>
                                <a class="dropdown-item {% if 'agreement' in request.resolver_match.url_name %}active{% endif %}" 
                                   href="{% url 'agreement_list' %}">
                                    <i class="bi bi-file-earmark-check"></i> Acuerdos
                                </a>
                            </li>
                            <li>
                                <a class="dropdown-item {% if 'multiple_documentation' in request.resolver_match.url_name %}active{% endif %}" 
                                   href="{% url 'multiple_documentation_list' %}">
                                    <i class="fas fa-folder-open"></i> Documentación Múltiple
                                </a>
                            </li>
                            <li>
                                <a class="dropdown-item {% if 'company_documentation' in request.resolver_match.url_name %}active{% endif %}" 
                                   href="{% url 'company_documentation_list' %}">
                                    <i class="bi bi-collection"></i> Documentaciones de Empresas
                                </a>
                            </li>
                            <li>
                                <a class="dropdown-item {% if 'legal_contract' in request.resolver_match.url_name %}active{% endif %}" 
                                   href="{% url 'legal_contract_list' %}">
                                    <i class="bi bi-file-earmark-ruled"></i> Contratos Legales
                                </a>
                            </li>
                            <li>
                                <a class="dropdown-item {% if 'ai_book' in request.resolver_match.url_name %}active{% endif %}" 
                                   href="{% url 'ai_book_list' %}">
                                    <i class="bi bi-book"></i> Generador de Libros IA
                                </a>
                            </li>
                            <li>
                                <a class="dropdown-item {% if 'ai_article' in request.resolver_match.url_name %}active{% endif %}" 
                                   href="{% url 'ai_article_project_list' %}">
                                    <i class="bi bi-newspaper"></i> Generador de Artículos IA
                                </a>
                            </li>
                            <li>
                                <a class="dropdown-item {% if 'countdown_timer' in request.resolver_match.url_name %}active{% endif %}" 
                                   href="{% url 'countdown_timer_list' %}">
                                    <i class="bi bi-stopwatch"></i> Cuentas Regresivas
                                </a>
                            </li>
                            <li>
                                <a class="dropdown-item {% if 'procedure' in request.resolver_match.url_name %}active{% endif %}" 
                                   href="{% url 'procedure_list' %}">
                                    <i class="bi bi-list-columns-reverse"></i> Procedimientos
                                </a>
                            </li>
                            <li>
                                <a class="dropdown-item {% if 'supplier_contract_review' in request.resolver_match.url_name %}active{% endif %}" 
                                   href="{% url 'supplier_contract_review_list' %}">
                                    <i class="bi bi-shield-check"></i> Revisar Contratos de Proveedores
                                </a>
                            </li>
                            <li>
                                <a class="dropdown-item {% if 'license' in request.resolver_match.url_name %}active{% endif %}" 
                                   href="{% url 'license_list' %}">
                                    <i class="bi bi-key"></i> Control de Licencias
                                </a>
                            </li>
                            <li>
                                <a class="dropdown-item {% if 'paypal_link' in request.resolver_match.url_name %}active{% endif %}" 
                                   href="{% url 'paypal_link_list' %}">
                                    <i class="bi bi-paypal"></i> Enlaces de Pago PayPal
                                </a>
                            </li>
                            <li><hr class="dropdown-divider"></li>
                            <li>
                                <h6 class="dropdown-header">Captura de Leads</h6>
                            </li>
                            <li>
                                <a class="dropdown-item {% if 'contact_generator' in request.resolver_match.url_name %}active{% endif %}" 
                                   href="{% url 'contact_generator_list' %}">
                                    <i class="bi bi-person-plus"></i> Crear Contactos
                                </a>
                            </li>
                            <li>
                                <a class="dropdown-item {% if 'company_request_generator' in request.resolver_match.url_name %}active{% endif %}"
                                   href="{% url 'company_request_generator_list' %}">
                                    <i class="bi bi-file-earmark-text"></i> Crear Solicitudes Empresas
                                </a>
                            </li>
                        </ul>
                    </li>    
                    
                    <!-- Menú Otros (Solo para Agentes) -->
                    <li class="nav-item dropdown">
                        <a class="nav-link dropdown-toggle" href="#" id="reportsDropdown" role="button" data-bs-toggle="dropdown" aria-expanded="false">
                            <i class="bi bi-graph-up"></i> Otros
                        </a>
                        <ul class="dropdown-menu" aria-labelledby="reportsDropdown">
                            <li>
                                <a class="dropdown-item {% if 'daily_report' in request.resolver_match.url_name %}active{% endif %}" 
                                   href="{% url 'daily_report' %}">
                                    <i class="bi bi-calendar-day"></i> Parte Diario
                                </a>
                            </li>
                            <li><hr class="dropdown-divider"></li>
                            <li>
                                <h6 class="dropdown-header">Analytics Web</h6>
                            </li>
                            <li>
                                <a class="dropdown-item {% if 'page_visits_analytics' in request.resolver_match.url_name %}active{% endif %}" 
                                   href="{% url 'page_visits_analytics' %}">
                                    <i class="fas fa-chart-bar"></i> Analytics de Páginas
                                </a>
                            </li>
                            <li>
                                <a class="dropdown-item {% if 'page_visits_detail' in request.resolver_match.url_name %}active{% endif %}" 
                                   href="{% url 'page_visits_detail' %}">
                                    <i class="fas fa-list"></i> Detalle de Visitas
                                </a>
                            </li>
                            <li><hr class="dropdown-divider"></li>
                            <li>
                                <h6 class="dropdown-header">Inteligencia Artificial</h6>
                            </li>
                            <li>
                                <a class="dropdown-item {% if 'ai_blog_configurator' in request.resolver_match.url_name %}active{% endif %}" 
                                   href="{% url 'ai_blog_configurators_list' %}">
                                    <i class="fas fa-robot"></i> Configurador de IA Blog
                                </a>
                            </li>
                            <li><hr class="dropdown-divider"></li>
                            <li>
                                <h6 class="dropdown-header">Documentación</h6>
                            </li>
                            <li>
                                <a class="dropdown-item {% if 'multiple_documentation' in request.resolver_match.url_name %}active{% endif %}" 
                                   href="{% url 'multiple_documentation_list' %}">
                                    <i class="fas fa-folder-open"></i> Documentación Múltiple
                                </a>
                            </li>
                            <li>
                                <a class="dropdown-item {% if 'company_documentation' in request.resolver_match.url_name %}active{% endif %}" 
                                   href="{% url 'company_documentation_list' %}">
                                    <i class="bi bi-collection"></i> Documentaciones de Empresas
                                </a>
                            </li>
                            <li>
                                <a class="dropdown-item {% if 'legal_contract' in request.resolver_match.url_name %}active{% endif %}" 
                                   href="{% url 'legal_contract_list' %}">
                                    <i class="bi bi-file-earmark-ruled"></i> Contratos Legales
                                </a>
                            </li>
                            <li>
                                <a class="dropdown-item {% if 'license' in request.resolver_match.url_name %}active{% endif %}" 
                                   href="{% url 'license_list' %}">
                                    <i class="bi bi-key"></i> Control de Licencias
                                </a>
                            </li>
                            <li>
                                <a class="dropdown-item {% if 'countdown_timer' in request.resolver_match.url_name %}active{% endif %}" 
                                   href="{% url 'countdown_timer_list' %}">
                                    <i class="bi bi-stopwatch"></i> Cuentas Regresivas
                                </a>
                            </li>
                            <li><hr class="dropdown-divider"></li>
                            <li>
                                <h6 class="dropdown-header">Captura de Leads</h6>
                            </li>
                            <li>
                                <a class="dropdown-item {% if 'contact_generator' in request.resolver_match.url_name %}active{% endif %}" 
                                   href="{% url 'contact_generator_list' %}">
                                    <i class="bi bi-person-plus"></i> Crear Contactos
                                </a>
                            </li>
                            <li>
                                <a class="dropdown-item {% if 'company_request_generator' in request.resolver_match.url_name %}active{% endif %}"
                                   href="{% url 'company_request_generator_list' %}">
                                    <i class="bi bi-file-earmark-text"></i> Crear Solicitudes Empresas
                                </a>
                            </li>
                            <li><hr class="dropdown-divider"></li>
                            <li>
                                <h6 class="dropdown-header">Planificación</h6>
                            </li>
                            <li>
                                <a class="dropdown-item {% if 'task_schedule' in request.resolver_match.url_name %}active{% endif %}" 
                                   href="{% url 'task_schedule_list' %}">
                                    <i class="fas fa-tasks"></i> Cronogramas de Tareas
                                </a>
                            </li>
                            <li><hr class="dropdown-divider"></li>
                            <li>
                                <h6 class="dropdown-header">Herramientas</h6>
                            </li>
                            <li>
                                <a class="dropdown-item {% if 'world_clock' in request.resolver_match.url_name %}active{% endif %}" 
                                   href="{% url 'world_clock' %}">
                                    <i class="bi bi-globe"></i> Reloj Mundial
                                </a>
                            </li>
                            <li>
                                <a class="dropdown-item {% if 'financial_actions' in request.resolver_match.url_name %}active{% endif %}" 
                                   href="{% url 'financial_actions_list' %}">
                                    <i class="bi bi-graph-up-arrow"></i> Acciones Financieras
                                </a>
                            </li>
                            <li>
                                <a class="dropdown-item {% if 'client_assistance_dashboard' in request.resolver_match.url_name %}active{% endif %}" 
                                   href="{% url 'client_assistance_dashboard' %}">
                                    <i class="fas fa-chart-line"></i> Dashboard Clientes
                                </a>
                            </li>
                            <li>
                                <a class="dropdown-item {% if 'client_assistance' in request.resolver_match.url_name or 'client_time_entries' in request.resolver_match.url_name %}active{% endif %}" 
                                   href="{% url 'client_assistance_list' %}">
                                    <i class="fas fa-users"></i> Asistencia de Cliente
                                </a>
                            </li>
                            <li><hr class="dropdown-divider"></li>
                            <li>
                                <h6 class="dropdown-header">Productos</h6>
                            </li>
                            <li>
                                <a class="dropdown-item {% if 'product_set' in request.resolver_match.url_name %}active{% endif %}" 
                                   href="{% url 'product_set_list' %}">
                                    <i class="bi bi-box-seam"></i> Conjuntos de Productos
                                </a>
                            </li>
                            
                            <li><hr class="dropdown-divider"></li>
                            <li>
                                <h6 class="dropdown-header">Estimaciones</h6>
                            </li>
                            <li>
                                <a class="dropdown-item {% if 'precotizador' in request.resolver_match.url_name %}active{% endif %}" 
                                   href="{% url 'precotizador_list' %}">
                                    <i class="bi bi-calculator"></i> Precotizador
                                </a>
                            </li>
                        </ul>
                    </li>
                    {% endif %}
                </ul>
                
                <!-- Botones de Control de Horario (solo para agentes) -->
                {% if user.is_authenticated %}
                    {% for group in user.groups.all %}
                        {% if group.name == 'Agentes' %}
                        <ul class="navbar-nav me-auto">
                            {% if is_working %}
                                <li class="nav-item">
                                    <a class="btn btn-danger btn-sm me-2" href="{% url 'time_end_work' %}">
                                        <i class="bi bi-stop-circle"></i>
                                    </a>
                                </li>
                            {% else %}
                                <li class="nav-item">
                                    <a class="btn btn-success btn-sm me-2" href="{% url 'time_start_work' %}">
                                        <i class="bi bi-play-circle"></i>
                                    </a>
                                </li>
                            {% endif %}
                        </ul>
                        {% endif %}
                    {% endfor %}
                {% endif %}
                
                <ul class="navbar-nav">
                    <li class="nav-item dropdown">
                        <a class="nav-link dropdown-toggle" href="#" id="navbarDropdown" role="button" data-bs-toggle="dropdown">
                            <i class="bi bi-person-circle"></i> {{ user.username }}
                        </a>
                        <ul class="dropdown-menu">
                            <li><a class="dropdown-item" href="{% url 'user_profile' %}">
                                <i class="bi bi-person-gear"></i> Mi Perfil
                            </a></li>
                            <li><a class="dropdown-item" href="{% url 'my_notes' %}">
                                <i class="bi bi-journal-text"></i> Mis Notas
                            </a></li>
                            
                            <!-- Menú de Juegos (Para todos los usuarios autenticados) -->
                            <li><hr class="dropdown-divider"></li>
                            <li class="dropdown-header">🎮 Juegos</li>
                            <li><a class="dropdown-item {% if 'tetris' in request.resolver_match.url_name %}active{% endif %}" 
                                   href="{% url 'tetris' %}">
                                <i class="bi bi-grid-3x3-gap"></i> Tetris
                            </a></li>
                            
                            <li><hr class="dropdown-divider"></li>
                            <li><a class="dropdown-item" href="{% url 'logout' %}">
                                <i class="bi bi-box-arrow-right"></i> Cerrar Sesión
                            </a></li>
                        </ul>
                    </li>
                </ul>
            </div>
        </div>
    </nav>
    {% else %}
    <!-- Navbar para usuarios no autenticados -->
    <nav class="navbar navbar-expand-lg navbar-dark bg-primary">
        <div class="container">
            <a class="navbar-brand fw-bold" href="{% url 'contacto_web' %}">
                <i class="bi bi-ticket-perforated"></i> TicketProo
            </a>
            
            <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNavPublic">
                <span class="navbar-toggler-icon"></span>
            </button>
            
            <div class="collapse navbar-collapse" id="navbarNavPublic">
                <ul class="navbar-nav me-auto">
                    <li class="nav-item">
                        <a class="nav-link" href="{% url 'contacto_web' %}">
                            <i class="bi bi-house-door"></i> Inicio
                        </a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="{% url 'contacto_web' %}">
                            <i class="bi bi-envelope"></i> Contáctanos
                        </a>
                    </li>
                </ul>
                
                <ul class="navbar-nav">
                    <li class="nav-item">
                        <a class="nav-link" href="{% url 'login' %}">
                            <i class="bi bi-box-arrow-in-right"></i> Iniciar Sesión
                        </a>
                    </li>
                </ul>
            </div>
        </div>
    </nav>
    {% endif %}

    <main class="container mt-4">
        {% if messages %}
            {% for message in messages %}
                <div class="alert alert-{{ message.tags }} alert-dismissible fade show" role="alert">
                    {{ message }}
                    <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
                </div>
            {% endfor %}
        {% endif %}

        {% block content %}
        {% endblock %}
    </main>

    <!-- Barra lateral de usuarios activos (disponible en todo el dashboard) -->
    {% if user.is_authenticated %}
    <!-- Botón flotante para Chat IA -->
    <button id="aiChatToggle" class="btn btn-gradient shadow-lg" onclick="window.toggleAIChat()"
            style="position: fixed; right: 0; top: calc(50% - 240px); transform: translateY(-50%); z-index: 1050; 
                   border-radius: 8px 0 0 8px; width: 60px; height: 60px; display: flex; align-items: center; justify-content: center;
                   border-right: none; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); border: none;
                   transition: all 0.3s ease;" 
            title="Chat con IA"
            onmouseover="this.style.transform = 'translateY(-50%) scale(1.1)'"
            onmouseout="this.style.transform = 'translateY(-50%) scale(1)'">
        <i class="bi bi-robot" style="color: white; font-size: 1.2em;"></i>
    </button>

    <!-- Botón flotante para crear ticket de soporte -->
    <button id="createTicketToggle" class="btn btn-primary shadow-lg" 
            onclick="window.location.href='/tickets/create/'"
            style="position: fixed; right: 0; top: calc(50% - 160px); transform: translateY(-50%); z-index: 1050; 
                   border-radius: 8px 0 0 8px; width: 60px; height: 60px; display: flex; align-items: center; justify-content: center;
                   border-right: none; transition: all 0.3s ease;" 
            title="Crear Ticket de Soporte"
            onmouseover="this.style.transform = 'translateY(-50%) scale(1.1)'"
            onmouseout="this.style.transform = 'translateY(-50%) scale(1)'">
        <i class="bi bi-ticket-perforated"></i>
        <span id="openTicketsBadge" class="position-absolute top-0 start-0 translate-middle badge rounded-pill bg-danger" style="font-size: 0.7em;">
            0
        </span>
    </button>

    <!-- Botón flotante para notas rápidas -->
    <button id="quickNoteToggle" class="btn btn-warning shadow-lg" onclick="window.toggleQuickNote()"
            style="position: fixed; right: 0; top: calc(50% - 80px); transform: translateY(-50%); z-index: 1050; 
                   border-radius: 8px 0 0 8px; width: 60px; height: 60px; display: flex; align-items: center; justify-content: center;
                   border-right: none; transition: all 0.3s ease;" 
            title="Crear Nota Rápida"
            onmouseover="this.style.transform = 'translateY(-50%) scale(1.1)'"
            onmouseout="this.style.transform = 'translateY(-50%) scale(1)'">
        <i class="bi bi-sticky"></i>
    </button>

    <!-- Botón flotante para mostrar/ocultar la barra lateral -->
    <button id="activeUsersSidebarToggle" class="btn btn-success shadow-lg" 
            style="position: fixed; right: 0; top: 50%; transform: translateY(-50%); z-index: 1050; 
                   border-radius: 8px 0 0 8px; width: 60px; height: 60px; display: flex; align-items: center; justify-content: center;
                   border-right: none; transition: all 0.3s ease;"
            onmouseover="this.style.transform = 'translateY(-50%) scale(1.1)'"
            onmouseout="this.style.transform = 'translateY(-50%) scale(1)'">
        <i class="bi bi-people-fill"></i>
        <span id="activeUsersBadge" class="position-absolute top-0 start-0 translate-middle badge rounded-pill bg-danger" style="font-size: 0.7em;">
            0
        </span>
    </button>

    <!-- Botón flotante para la calculadora -->
    <button id="calculatorToggle" class="btn btn-info shadow-lg" 
            style="position: fixed; right: 0; top: calc(50% + 80px); transform: translateY(-50%); z-index: 1050; 
                   border-radius: 8px 0 0 8px; width: 60px; height: 60px; display: flex; align-items: center; justify-content: center;
                   border-right: none; transition: all 0.3s ease;"
            onmouseover="this.style.transform = 'translateY(-50%) scale(1.1)'"
            onmouseout="this.style.transform = 'translateY(-50%) scale(1)'">
        <i class="bi bi-calculator"></i>
    </button>

    <!-- Botón flotante para Quick TODO -->
    <button id="quickTodoToggle" class="btn btn-secondary shadow-lg" onclick="window.toggleQuickTodo()"
            style="position: fixed; right: 0; top: calc(50% + 160px); transform: translateY(-50%); z-index: 1050; 
                   border-radius: 8px 0 0 8px; width: 60px; height: 60px; display: flex; align-items: center; justify-content: center;
                   border-right: none; transition: all 0.3s ease;" 
            title="Lista de Tareas Rápidas"
            onmouseover="this.style.transform = 'translateY(-50%) scale(1.1)'"
            onmouseout="this.style.transform = 'translateY(-50%) scale(1)'">
        <i class="bi bi-check2-square"></i>
        <span id="pendingTodosBadge" class="position-absolute top-0 start-0 translate-middle badge rounded-pill bg-danger" style="font-size: 0.7em;">
            0
        </span>
    </button>

    <!-- Botón flotante para Monitor del Sistema -->
    <button id="systemMonitorToggle" class="btn btn-dark shadow-lg" onclick="window.toggleSystemMonitor()"
            style="position: fixed; right: 0; top: calc(50% + 240px); transform: translateY(-50%); z-index: 1050; 
                   border-radius: 8px 0 0 8px; width: 60px; height: 60px; display: flex; align-items: center; justify-content: center;
                   border-right: none; transition: all 0.3s ease; background: linear-gradient(135deg, #343a40 0%, #6c757d 100%);" 
            title="Monitor del Sistema"
            onmouseover="this.style.transform = 'translateY(-50%) scale(1.1)'"
            onmouseout="this.style.transform = 'translateY(-50%) scale(1)'">
        <i class="bi bi-speedometer2" style="color: white; font-size: 1.2em;"></i>
    </button>

    <!-- Barra lateral deslizante -->
    <div id="activeUsersSidebar" class="shadow-lg" 
         style="position: fixed; right: -400px; top: 0; width: 400px; height: 100vh; 
                background: white; z-index: 1040; transition: right 0.3s ease; border-left: 3px solid #28a745;
                overflow: hidden; display: flex; flex-direction: column;">
        
        <!-- Header de la barra lateral -->
        <div class="p-3 bg-success text-white d-flex justify-content-between align-items-center">
            <div>
                <h6 class="mb-0">
                    <i class="bi bi-people-fill me-2"></i>
                    Usuarios Activos
                </h6>
                <small class="opacity-75">En oficina ahora</small>
            </div>
            <button id="closeSidebar" class="btn btn-sm btn-outline-light">
                <i class="bi bi-x-lg"></i>
            </button>
        </div>

        <!-- Información de actualización -->
        <div class="px-3 py-2 bg-light border-bottom">
            <small class="text-muted d-flex justify-content-between">
                <span>
                    <i class="bi bi-clock me-1"></i>
                    Última actualización
                </span>
                <span id="lastUpdateSidebar">--:--</span>
            </small>
        </div>

        <!-- Lista de usuarios activos -->
        <div id="activeUsersListSidebar" class="p-3" style="flex: 1; overflow-y: auto; max-height: calc(100vh - 200px);">
            <!-- Loading inicial -->
            <div class="text-center py-4">
                <div class="spinner-border text-success" role="status">
                    <span class="visually-hidden">Cargando...</span>
                </div>
                <p class="mt-2 text-muted">Cargando usuarios activos...</p>
            </div>
        </div>

        <!-- Footer de la barra lateral -->
        <div class="position-absolute bottom-0 start-0 end-0 p-3 bg-light border-top">
            <div class="d-flex justify-content-between align-items-center">
                <small class="text-muted">
                    <i class="bi bi-info-circle me-1"></i>
                    Auto-actualización cada 30s
                </small>
                <button id="refreshActiveUsers" class="btn btn-sm btn-outline-success">
                    <i class="bi bi-arrow-clockwise"></i>
                </button>
            </div>
        </div>
    </div>

    <!-- Overlay para cerrar la barra lateral -->
    <div id="sidebarOverlay" class="position-fixed w-100 h-100" 
         style="top: 0; left: 0; background: rgba(0,0,0,0.5); z-index: 1030; display: none;"></div>

    <!-- Calculadora tipo Windows -->
    <div id="calculatorWidget" class="shadow-lg" 
         style="position: fixed; right: -320px; top: 20%; width: 320px; height: 500px; 
                background: white; z-index: 1045; transition: right 0.3s ease; border-radius: 8px;
                border: 1px solid #ddd; overflow: hidden; display: flex; flex-direction: column;">
        
        <!-- Header de la calculadora -->
        <div class="p-2 bg-primary text-white d-flex justify-content-between align-items-center">
            <div class="d-flex align-items-center">
                <i class="bi bi-calculator me-2"></i>
                <h6 class="mb-0">Calculadora</h6>
            </div>
            <button id="closeCalculator" class="btn btn-sm btn-outline-light">
                <i class="bi bi-x-lg"></i>
            </button>
        </div>

        <!-- Pantalla de la calculadora -->
        <div class="p-3 bg-light border-bottom">
            <input type="text" id="calculatorDisplay" class="form-control form-control-lg text-end" 
                   value="0" readonly style="font-family: 'Courier New', monospace; font-size: 1.5rem; background: #f8f9fa;">
        </div>

        <!-- Botones de la calculadora -->
        <div class="flex-grow-1 p-3" style="display: grid; grid-template-columns: repeat(4, 1fr); gap: 8px;">
            <!-- Fila 1 -->
            <button class="btn btn-outline-secondary calc-btn" onclick="clearCalculator()" style="grid-column: span 2;">
                <strong>C</strong>
            </button>
            <button class="btn btn-outline-secondary calc-btn" onclick="deleteLast()">
                <i class="bi bi-backspace"></i>
            </button>
            <button class="btn btn-outline-warning calc-btn" onclick="appendOperator('/')">
                ÷
            </button>

            <!-- Fila 2 -->
            <button class="btn btn-outline-dark calc-btn" onclick="appendNumber('7')">7</button>
            <button class="btn btn-outline-dark calc-btn" onclick="appendNumber('8')">8</button>
            <button class="btn btn-outline-dark calc-btn" onclick="appendNumber('9')">9</button>
            <button class="btn btn-outline-warning calc-btn" onclick="appendOperator('*')">×</button>

            <!-- Fila 3 -->
            <button class="btn btn-outline-dark calc-btn" onclick="appendNumber('4')">4</button>
            <button class="btn btn-outline-dark calc-btn" onclick="appendNumber('5')">5</button>
            <button class="btn btn-outline-dark calc-btn" onclick="appendNumber('6')">6</button>
            <button class="btn btn-outline-warning calc-btn" onclick="appendOperator('-')">-</button>

            <!-- Fila 4 -->
            <button class="btn btn-outline-dark calc-btn" onclick="appendNumber('1')">1</button>
            <button class="btn btn-outline-dark calc-btn" onclick="appendNumber('2')">2</button>
            <button class="btn btn-outline-dark calc-btn" onclick="appendNumber('3')">3</button>
            <button class="btn btn-outline-warning calc-btn" onclick="appendOperator('+')" style="grid-row: span 2;">
                +
            </button>

            <!-- Fila 5 -->
            <button class="btn btn-outline-dark calc-btn" onclick="appendNumber('0')" style="grid-column: span 2;">
                0
            </button>
            <button class="btn btn-outline-dark calc-btn" onclick="appendDecimal()">.</button>
            <!-- El botón + ocupa dos filas -->

            <!-- Fila 6 - Botón igual -->
            <button class="btn btn-primary calc-btn" onclick="calculate()" style="grid-column: span 3;">
                <strong>=</strong>
            </button>
        </div>
    </div>

    <!-- Overlay para cerrar la calculadora -->
    <div id="calculatorOverlay" class="position-fixed w-100 h-100" 
         style="top: 0; left: 0; background: rgba(0,0,0,0.3); z-index: 1040; display: none;"></div>

    <!-- Ventana deslizante del Quick TODO -->
    <div id="quickTodoSidebar" class="shadow-lg" 
         style="position: fixed; right: -450px; top: 0; width: 450px; height: 100vh; 
                background: #f8f9fa; z-index: 1045; transition: right 0.3s ease; border-left: 3px solid #6c757d;
                overflow: hidden; display: flex; flex-direction: column;">
        
        <!-- Header del Quick TODO -->
        <div class="p-3 text-white d-flex justify-content-between align-items-center"
             style="background: linear-gradient(135deg, #6c757d 0%, #495057 100%);">
            <div>
                <h6 class="mb-0">
                    <i class="bi bi-check2-square me-2"></i>
                    Lista de Tareas
                </h6>
                <small class="opacity-75">Tareas rápidas</small>
            </div>
            <button id="closeQuickTodo" class="btn btn-sm btn-outline-light">
                <i class="bi bi-x-lg"></i>
            </button>
        </div>

        <!-- Formulario para agregar nueva tarea -->
        <div class="p-3 border-bottom bg-white">
            <div class="input-group">
                <input type="text" id="newTodoInput" class="form-control" 
                       placeholder="Agregar nueva tarea..." 
                       style="border-radius: 20px 0 0 20px; border: 2px solid #e9ecef;">
                <button id="addTodoButton" class="btn btn-secondary" 
                        style="border-radius: 0 20px 20px 0; border: 2px solid #6c757d; border-left: none;">
                    <i class="bi bi-plus-lg"></i>
                </button>
            </div>
        </div>

        <!-- Lista de tareas -->
        <div id="todoList" class="flex-fill p-3" style="overflow-y: auto; background: #f8f9fa;">
            <!-- Loading inicial -->
            <div id="todoLoading" class="text-center py-4">
                <div class="spinner-border text-secondary" role="status">
                    <span class="visually-hidden">Cargando...</span>
                </div>
                <p class="mt-2 text-muted">Cargando tareas...</p>
            </div>
            
            <!-- Lista de tareas se carga aquí dinámicamente -->
        </div>

        <!-- Footer con estadísticas -->
        <div class="p-3 bg-white border-top">
            <div class="d-flex justify-content-between align-items-center">
                <small class="text-muted">
                    <span id="todoStats">0 tareas</span>
                </small>
                <button id="clearCompletedTodos" class="btn btn-sm btn-outline-danger" style="display: none;">
                    <i class="bi bi-trash me-1"></i>
                    Limpiar completadas
                </button>
            </div>
        </div>
    </div>

    <!-- Overlay para cerrar el Quick TODO -->
    <div id="quickTodoOverlay" class="position-fixed w-100 h-100" 
         style="top: 0; left: 0; background: rgba(0,0,0,0.3); z-index: 1040; display: none;"></div>

    <!-- Ventana deslizante del Monitor del Sistema -->
    <div id="systemMonitorSidebar" class="shadow-lg" 
         style="position: fixed; right: -500px; top: 0; width: 500px; height: 100vh; 
                background: #f8f9fa; z-index: 1045; transition: right 0.3s ease; border-left: 3px solid #343a40;
                overflow: hidden; display: flex; flex-direction: column;">
        
        <!-- Header del Monitor del Sistema -->
        <div class="p-3 text-white d-flex justify-content-between align-items-center"
             style="background: linear-gradient(135deg, #343a40 0%, #6c757d 100%);">
            <div>
                <h6 class="mb-0">
                    <i class="bi bi-speedometer2 me-2"></i>
                    Monitor del Sistema
                </h6>
                <small class="opacity-75">Información en tiempo real</small>
            </div>
            <button id="closeSystemMonitor" class="btn btn-sm btn-outline-light">
                <i class="bi bi-x-lg"></i>
            </button>
        </div>

        <!-- Información del sistema -->
        <div id="systemInfo" class="flex-fill p-3" style="overflow-y: auto; background: #f8f9fa;">
            <!-- Loading inicial -->
            <div id="systemLoading" class="text-center py-4">
                <div class="spinner-border text-dark" role="status">
                    <span class="visually-hidden">Cargando...</span>
                </div>
                <p class="mt-2 text-muted">Obteniendo información del sistema...</p>
            </div>
            
            <!-- Grid de KPIs -->
            <div id="systemKPIs" class="g-3" style="display: none;">
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem;">
                    <!-- CPU -->
                    <div class="card border-0 shadow-sm h-100">
                        <div class="card-body text-center py-2">
                            <i class="bi bi-cpu display-6 text-primary mb-1" style="font-size: 2rem;"></i>
                            <h6 class="card-title mb-1">CPU</h6>
                            <div id="cpuUsage" class="h5 text-primary mb-0">--</div>
                            <small class="text-muted">Uso del procesador</small>
                        </div>
                    </div>

                    <!-- RAM -->
                    <div class="card border-0 shadow-sm h-100">
                        <div class="card-body text-center py-2">
                            <i class="bi bi-memory display-6 text-success mb-1" style="font-size: 2rem;"></i>
                            <h6 class="card-title mb-1">RAM</h6>
                            <div id="ramUsage" class="h5 text-success mb-0">--</div>
                            <small class="text-muted">Memoria utilizada</small>
                        </div>
                    </div>

                    <!-- Disco -->
                    <div class="card border-0 shadow-sm h-100">
                        <div class="card-body text-center py-2">
                            <i class="bi bi-hdd display-6 text-warning mb-1" style="font-size: 2rem;"></i>
                            <h6 class="card-title mb-1">Disco</h6>
                            <div id="diskUsage" class="h5 text-warning mb-0">--</div>
                            <small class="text-muted">Espacio libre</small>
                        </div>
                    </div>

                    <!-- Conexión -->
                    <div class="card border-0 shadow-sm h-100">
                        <div class="card-body text-center py-2">
                            <i class="bi bi-wifi display-6 text-info mb-1" style="font-size: 2rem;"></i>
                            <h6 class="card-title mb-1">Red</h6>
                            <div id="networkStatus" class="h5 text-info mb-0">--</div>
                            <small class="text-muted">Estado de conexión</small>
                        </div>
                    </div>

                    <!-- Temperatura -->
                    <div class="card border-0 shadow-sm h-100">
                        <div class="card-body text-center py-2">
                            <i class="bi bi-thermometer-half display-6 text-danger mb-1" style="font-size: 2rem;"></i>
                            <h6 class="card-title mb-1">Temperatura</h6>
                            <div id="systemTemp" class="h5 text-danger mb-0">--</div>
                            <small class="text-muted">CPU Temperature</small>
                        </div>
                    </div>

                    <!-- Procesos -->
                    <div class="card border-0 shadow-sm h-100">
                        <div class="card-body text-center py-2">
                            <i class="bi bi-list-task display-6 text-secondary mb-1" style="font-size: 2rem;"></i>
                            <h6 class="card-title mb-1">Procesos</h6>
                            <div id="processCount" class="h5 text-secondary mb-0">--</div>
                            <small class="text-muted">Procesos activos</small>
                        </div>
                    </div>

                    <!-- Usuarios -->
                    <div class="card border-0 shadow-sm h-100">
                        <div class="card-body text-center py-2">
                            <i class="bi bi-people display-6 text-purple mb-1" style="color: #6f42c1!important; font-size: 2rem;"></i>
                            <h6 class="card-title mb-1">Usuarios</h6>
                            <div id="userSessions" class="h5 mb-0" style="color: #6f42c1!important;">--</div>
                            <small class="text-muted">Sesiones activas</small>
                        </div>
                    </div>

                    <!-- Uptime -->
                    <div class="card border-0 shadow-sm h-100">
                        <div class="card-body text-center py-2">
                            <i class="bi bi-clock-history display-6 text-dark mb-1" style="font-size: 2rem;"></i>
                            <h6 class="card-title mb-1">Uptime</h6>
                            <div id="systemUptime" class="h5 text-dark mb-0">--</div>
                            <small class="text-muted">Tiempo funcionando</small>
                        </div>
                    </div>
                </div>
            </div>

                <!-- Información detallada -->
                <div class="col-12">
                    <div class="card border-0 shadow-sm">
                        <div class="card-header bg-light">
                            <h6 class="mb-0">
                                <i class="bi bi-info-circle me-2"></i>
                                Información Detallada
                            </h6>
                        </div>
                        <div class="card-body">
                            <div class="row g-2">
                                <div class="col-sm-6">
                                    <strong>IP Local:</strong>
                                    <div id="localIP" class="text-muted">Obteniendo...</div>
                                </div>
                                <div class="col-sm-6">
                                    <strong>IP Pública:</strong>
                                    <div id="publicIP" class="text-muted">Obteniendo...</div>
                                </div>
                                <div class="col-sm-6">
                                    <strong>Navegador:</strong>
                                    <div id="browserInfo" class="text-muted">--</div>
                                </div>
                                <div class="col-sm-6">
                                    <strong>Resolución:</strong>
                                    <div id="screenResolution" class="text-muted">--</div>
                                </div>
                                <div class="col-sm-6">
                                    <strong>Zona Horaria:</strong>
                                    <div id="timezone" class="text-muted">--</div>
                                </div>
                                <div class="col-sm-6">
                                    <strong>Idioma:</strong>
                                    <div id="language" class="text-muted">--</div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Gráficos en tiempo real -->
                <div class="col-12">
                    <div class="card border-0 shadow-sm">
                        <div class="card-header bg-light">
                            <h6 class="mb-0">
                                <i class="bi bi-graph-up me-2"></i>
                                Rendimiento en Tiempo Real
                            </h6>
                        </div>
                        <div class="card-body">
                            <!-- Mini gráfico de CPU -->
                            <div class="mb-3">
                                <label class="form-label small">CPU (%)</label>
                                <div class="progress" style="height: 8px;">
                                    <div id="cpuProgressBar" class="progress-bar bg-primary" style="width: 0%"></div>
                                </div>
                            </div>
                            <!-- Mini gráfico de RAM -->
                            <div class="mb-3">
                                <label class="form-label small">RAM (%)</label>
                                <div class="progress" style="height: 8px;">
                                    <div id="ramProgressBar" class="progress-bar bg-success" style="width: 0%"></div>
                                </div>
                            </div>
                            <!-- Mini gráfico de Disco -->
                            <div class="mb-3">
                                <label class="form-label small">Disco (%)</label>
                                <div class="progress" style="height: 8px;">
                                    <div id="diskProgressBar" class="progress-bar bg-warning" style="width: 0%"></div>
                                </div>
                            </div>
                            <!-- Nueva barra de progreso para procesos -->
                            <div class="mb-3">
                                <label class="form-label small">Procesos Activos</label>
                                <div class="progress" style="height: 8px;">
                                    <div id="processProgressBar" class="progress-bar bg-secondary" style="width: 0%"></div>
                                </div>
                                <small class="text-muted" id="processProgressText">--</small>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Footer con controles -->
        <div class="p-3 bg-white border-top">
            <div class="d-flex justify-content-between align-items-center">
                <small class="text-muted">
                    <i class="bi bi-arrow-clockwise me-1"></i>
                    Actualización automática cada 5s
                </small>
                <div>
                    <button id="refreshSystemInfo" class="btn btn-sm btn-outline-dark me-2">
                        <i class="bi bi-arrow-clockwise"></i>
                    </button>
                    <button id="pauseSystemMonitor" class="btn btn-sm btn-outline-warning">
                        <i class="bi bi-pause-fill"></i>
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Overlay para cerrar el Monitor del Sistema -->
    <div id="systemMonitorOverlay" class="position-fixed w-100 h-100" 
         style="top: 0; left: 0; background: rgba(0,0,0,0.3); z-index: 1040; display: none;"></div>

    <!-- Ventana deslizante del Chat IA -->
    <div id="aiChatSidebar" class="shadow-lg" 
         style="position: fixed; right: -500px; top: 0; width: 500px; height: 100vh; 
                background: white; z-index: 1045; transition: right 0.3s ease; border-left: 3px solid #667eea;
                overflow: hidden; display: flex; flex-direction: column;">
        
        <!-- Header del chat IA -->
        <div class="p-3 text-white d-flex justify-content-between align-items-center"
             style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);">
            <div>
                <h6 class="mb-0">
                    <i class="bi bi-robot me-2"></i>
                    Chat con IA
                </h6>
                <small class="opacity-75">Asistente inteligente</small>
            </div>
            <button id="closeAIChat" class="btn btn-sm btn-outline-light">
                <i class="bi bi-x-lg"></i>
            </button>
        </div>

        <!-- Área de mensajes del chat -->
        <div id="aiChatMessages" class="flex-grow-1 p-3" style="overflow-y: auto; max-height: calc(100vh - 200px); background: #f8f9fa;">
            <!-- Mensaje de bienvenida -->
            <div class="d-flex mb-3">
                <div class="me-2">
                    <div class="bg-primary text-white rounded-circle d-flex align-items-center justify-content-center" 
                         style="width: 40px; height: 40px;">
                        <i class="bi bi-robot"></i>
                    </div>
                </div>
                <div class="bg-white p-3 rounded-3 shadow-sm flex-grow-1">
                    <p class="mb-0">¡Hola! Soy tu asistente de IA. ¿En qué puedo ayudarte hoy?</p>
                    <small class="text-muted">Puedes preguntarme sobre tickets, tareas, o cualquier cosa relacionada con el sistema.</small>
                </div>
            </div>
        </div>

        <!-- Área de entrada de texto -->
        <div class="p-3 border-top bg-white">
            <div class="d-flex">
                <input type="text" id="aiChatInput" class="form-control me-2" 
                       placeholder="Escribe tu mensaje aquí..."
                       onkeypress="if(event.key==='Enter') sendAIMessage()">
                <button id="sendAIMessage" class="btn btn-primary" onclick="sendAIMessage()">
                    <i class="bi bi-send"></i>
                </button>
            </div>
            <small class="text-muted">
                <i class="bi bi-info-circle me-1"></i>
                Presiona Enter para enviar tu mensaje
            </small>
        </div>
    </div>

    <!-- Overlay para cerrar el chat IA -->
    <div id="aiChatOverlay" class="position-fixed w-100 h-100" 
         style="top: 0; left: 0; background: rgba(0,0,0,0.5); z-index: 1040; display: none;"></div>

    <!-- Modal para crear nota rápida -->
    <div class="modal fade" id="quickNoteModal" tabindex="-1" aria-hidden="true">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header bg-warning text-dark">
                    <h5 class="modal-title">
                        <i class="bi bi-sticky me-2"></i>
                        Crear Nota Rápida
                    </h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <form id="quickNoteForm">
                    <div class="modal-body">
                        <div class="mb-3">
                            <label for="quickNoteTitle" class="form-label">
                                <i class="bi bi-card-heading me-1"></i>
                                Título de la nota
                            </label>
                            <input type="text" class="form-control" id="quickNoteTitle" 
                                   placeholder="Título descriptivo (mín. 5 caracteres)..." required>
                        </div>
                        <div class="mb-3">
                            <label for="quickNoteContent" class="form-label">
                                <i class="bi bi-textarea-t me-1"></i>
                                Contenido
                            </label>
                            <textarea class="form-control" id="quickNoteContent" rows="8" 
                                      placeholder="Descripción detallada de la nota (mín. 10 caracteres)..." required></textarea>
                        </div>
                        <div class="row">
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label for="quickNoteCategory" class="form-label">
                                        <i class="bi bi-tags me-1"></i>
                                        Categoría
                                    </label>
                                    <select class="form-select" id="quickNoteCategory">
                                        <option value="personal">Personal</option>
                                        <option value="trabajo">Trabajo</option>
                                        <option value="ideas">Ideas</option>
                                        <option value="recordatorios">Recordatorios</option>
                                        <option value="reuniones">Reuniones</option>
                                        <option value="proyectos">Proyectos</option>
                                    </select>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label for="quickNotePriority" class="form-label">
                                        <i class="bi bi-exclamation-triangle me-1"></i>
                                        Prioridad
                                    </label>
                                    <select class="form-select" id="quickNotePriority">
                                        <option value="baja">Baja</option>
                                        <option value="media" selected>Media</option>
                                        <option value="alta">Alta</option>
                                        <option value="urgente">Urgente</option>
                                    </select>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                            <i class="bi bi-x-circle me-1"></i>
                            Cancelar
                        </button>
                        <button type="button" class="btn btn-warning" id="saveQuickNote" onclick="window.saveQuickNote()">
                            <i class="bi bi-save me-1"></i>
                            Guardar Nota
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>
    {% endif %}

    <!-- Footer simple -->
    <footer class="mt-5 py-4 border-top text-center">
        <div class="container">
            <div class="row">
                <div class="col-12">
                    <p class="text-muted mb-1">&copy; 2025 TicketProo - Sistema de Gestión de Tickets</p>
                    <p class="text-muted small mb-0">Desarrollado por Marlon Falcón Hdez</p>
                </div>
            </div>
        </div>
    </footer>

    {% bootstrap_javascript %}
    
    <!-- Scripts principales del sistema -->
    <script>
        // Funciones auxiliares para manejar visibilidad de botones flotantes
        function hideOtherFloatingButtons(except = []) {
            const floatingButtons = [
                'aiChatToggle',
                'createTicketToggle', 
                'quickNoteToggle',
                'activeUsersSidebarToggle',
                'calculatorToggle',
                'quickTodoToggle',
                'systemMonitorToggle'
            ];
            
            floatingButtons.forEach(buttonId => {
                if (!except.includes(buttonId)) {
                    const button = document.getElementById(buttonId);
                    if (button) {
                        button.style.opacity = '0.3';
                        button.style.pointerEvents = 'none';
                        button.style.transform = 'translateY(-50%) translateX(100px) scale(0.8)'; // Mover hacia la derecha
                    }
                }
            });
        }
        
        function showAllFloatingButtons() {
            const floatingButtons = [
                'aiChatToggle',
                'createTicketToggle', 
                'quickNoteToggle',
                'activeUsersSidebarToggle',
                'calculatorToggle',
                'quickTodoToggle',
                'systemMonitorToggle'
            ];
            
            floatingButtons.forEach(buttonId => {
                const button = document.getElementById(buttonId);
                if (button) {
                    button.style.opacity = '1';
                    button.style.pointerEvents = 'auto';
                    // Mantener el transform base y permitir que el hover funcione
                    button.style.transform = 'translateY(-50%) translateX(0) scale(1)';
                }
            });
        }

        // Funciones globales para notas rápidas - Asignar al objeto window
        window.toggleQuickNote = function() {
            console.log('toggleQuickNote() llamada');
            
            try {
                const modalElement = document.getElementById('quickNoteModal');
                if (!modalElement) {
                    console.error('❌ Modal quickNoteModal no encontrado');
                    alert('Error: Modal de notas no encontrado');
                    return;
                }
                
                console.log('✅ Modal encontrado:', modalElement);
                
                // Ocultar otros botones flotantes al abrir el modal
                hideOtherFloatingButtons(['quickNoteToggle']);
                
                const modal = new bootstrap.Modal(modalElement);
                modal.show();
                
                // Configurar eventos para cuando se cierre el modal
                modalElement.addEventListener('hidden.bs.modal', function () {
                    // Mostrar todos los botones flotantes cuando se cierre el modal
                    showAllFloatingButtons();
                    // Asegurar que no quede ningún backdrop residual
                    const backdrops = document.querySelectorAll('.modal-backdrop');
                    backdrops.forEach(backdrop => backdrop.remove());
                }, { once: true }); // Solo ejecutar una vez
                
                console.log('✅ Modal mostrado exitosamente');
                
                // Limpiar formulario
                const form = document.getElementById('quickNoteForm');
                if (form) {
                    form.reset();
                    console.log('✅ Formulario limpiado');
                }
                
                // Focus en título después de un pequeño delay
                setTimeout(() => {
                    const titleInput = document.getElementById('quickNoteTitle');
                    if (titleInput) {
                        titleInput.focus();
                        console.log('✅ Focus en título establecido');
                    }
                }, 100);
                
            } catch (error) {
                console.error('❌ Error en toggleQuickNote():', error);
                alert('Error al abrir modal de notas: ' + error.message);
                // Restaurar botones en caso de error
                showAllFloatingButtons();
            }
        };

        window.saveQuickNote = function() {
            console.log('saveQuickNote() llamada');
            
            const title = document.getElementById('quickNoteTitle').value.trim();
            const content = document.getElementById('quickNoteContent').value.trim();
            const category = document.getElementById('quickNoteCategory').value;
            const priority = document.getElementById('quickNotePriority').value;
            
            if (!title || !content) {
                alert('Por favor, completa el título y contenido de la nota.');
                return;
            }
            
            // Validaciones específicas según el backend
            if (title.length < 5) {
                alert('El título debe tener al menos 5 caracteres.');
                return;
            }
            
            if (content.length < 10) {
                alert('La descripción debe tener al menos 10 caracteres.');
                return;
            }
            
            const saveButton = document.getElementById('saveQuickNote');
            const originalText = saveButton.innerHTML;
            
            // Mostrar loading
            saveButton.innerHTML = '<i class="bi bi-hourglass-split me-1"></i>Guardando...';
            saveButton.disabled = true;
            
            // Preparar datos para enviar - mapear a los campos del formulario backend
            const noteData = {
                title: title,
                description: content,  // 'content' se mapea a 'description'
                category: category,
                priority: priority,
                created_via: 'quick_note_widget'  // Campo adicional para tracking
            };
            
            console.log('[Nota Rápida] Enviando nota:', noteData);
            
            // Usar fetch para enviar los datos sin redirección
            fetch('/notes/create/', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/x-www-form-urlencoded',
                    'X-CSRFToken': getCookie('csrftoken'),
                    'X-Requested-With': 'XMLHttpRequest'
                },
                body: new URLSearchParams({
                    'title': noteData.title,
                    'description': noteData.description,
                    'user': '{{ user.id }}', // Usar el usuario actual de Django
                    'company': '', // Empresa opcional
                    'is_private': 'false',
                    'created_via': 'quick_note_widget'
                })
            })
            .then(response => {
                console.log('Respuesta del servidor:', response.status);
                
                if (response.ok) {
                    // Respuesta exitosa (200)
                    return response.json().then(data => {
                        console.log('Datos JSON recibidos:', data);
                        
                        if (data.success) {
                            // Éxito - mostrar confirmación
                            saveButton.innerHTML = '<i class="bi bi-check-circle me-1"></i>¡Guardada!';
                            saveButton.classList.remove('btn-warning');
                            saveButton.classList.add('btn-success');
                            
                            // Cerrar modal después de un breve delay
                            setTimeout(() => {
                                const modal = bootstrap.Modal.getInstance(document.getElementById('quickNoteModal'));
                                if (modal) {
                                    modal.hide();
                                }
                                
                                // Mostrar notificación de éxito
                                showQuickNotification(data.message || '¡Nota guardada exitosamente!', 'success');
                                
                                // Limpiar formulario
                                document.getElementById('quickNoteForm').reset();
                                
                                // Restaurar botón
                                saveButton.innerHTML = originalText;
                                saveButton.classList.remove('btn-success');
                                saveButton.classList.add('btn-warning');
                                saveButton.disabled = false;
                            }, 1500);
                        } else {
                            throw new Error(data.message || 'Error al guardar la nota');
                        }
                    });
                } else if (response.status === 400) {
                    // Error de validación (400 Bad Request)
                    return response.json().then(data => {
                        console.log('Errores de validación:', data.errors);
                        
                        let errorMessages = [];
                        if (data.errors) {
                            // Procesar errores de formulario Django
                            for (const [field, errors] of Object.entries(data.errors)) {
                                if (Array.isArray(errors)) {
                                    errorMessages.push(...errors);
                                } else {
                                    errorMessages.push(errors);
                                }
                            }
                        }
                        
                        const errorMessage = errorMessages.length > 0 
                            ? errorMessages.join(' ') 
                            : 'Error de validación en el formulario.';
                        
                        // Mostrar error
                        saveButton.innerHTML = '<i class="bi bi-exclamation-circle me-1"></i>Error';
                        saveButton.classList.remove('btn-warning');
                        saveButton.classList.add('btn-danger');
                        
                        // Mostrar notificación de error con detalles
                        showQuickNotification(errorMessage, 'danger');
                        
                        // Restaurar botón después de un delay
                        setTimeout(() => {
                            saveButton.innerHTML = originalText;
                            saveButton.classList.remove('btn-danger');
                            saveButton.classList.add('btn-warning');
                            saveButton.disabled = false;
                        }, 4000);
                    });
                } else {
                    throw new Error('Error del servidor: ' + response.status);
                }
            })
            .catch(error => {
                console.error('Error:', error);
                
                // Mostrar error
                saveButton.innerHTML = '<i class="bi bi-exclamation-circle me-1"></i>Error';
                saveButton.classList.remove('btn-warning');
                saveButton.classList.add('btn-danger');
                
                // Mostrar notificación de error
                showQuickNotification('Error al guardar la nota. Inténtalo de nuevo.', 'danger');
                
                // Restaurar botón después de un delay
                setTimeout(() => {
                    saveButton.innerHTML = originalText;
                    saveButton.classList.remove('btn-danger');
                    saveButton.classList.add('btn-warning');
                    saveButton.disabled = false;
                }, 3000);
            });
        };

        // Función auxiliar para obtener CSRF token
        function getCookie(name) {
            let cookieValue = null;
            if (document.cookie && document.cookie !== '') {
                const cookies = document.cookie.split(';');
                for (let i = 0; i < cookies.length; i++) {
                    const cookie = cookies[i].trim();
                    if (cookie.substring(0, name.length + 1) === (name + '=')) {
                        cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                        break;
                    }
                }
            }
            return cookieValue;
        }

        // Función para mostrar notificaciones rápidas
        function showQuickNotification(message, type = 'info') {
            const notification = document.createElement('div');
            notification.className = `alert alert-${type} alert-dismissible fade show position-fixed`;
            notification.style.cssText = 'top: 20px; right: 20px; z-index: 9999; min-width: 300px;';
            notification.innerHTML = `
                ${message}
                <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
            `;
            
            document.body.appendChild(notification);
            
            // Auto-remover después de 5 segundos
            setTimeout(() => {
                if (notification.parentNode) {
                    notification.parentNode.removeChild(notification);
                }
            }, 5000);
        }

        // Funciones para el Chat IA
        window.toggleAIChat = function() {
            console.log('🤖 toggleAIChat() llamada');
            
            const sidebar = document.getElementById('aiChatSidebar');
            const overlay = document.getElementById('aiChatOverlay');
            
            if (!sidebar || !overlay) {
                console.error('❌ Elementos del chat IA no encontrados');
                return;
            }
            
            // Abrir directamente el chat
            openAIChatSidebar();
        };

        function openAIChatSidebar() {
            const sidebar = document.getElementById('aiChatSidebar');
            const overlay = document.getElementById('aiChatOverlay');
            const toggle = document.getElementById('aiChatToggle');
            
            // Mostrar la barra lateral desde la derecha y el overlay
            sidebar.style.right = '0';
            overlay.style.display = 'block';
            
            // Mover el botón junto con la ventana
            if (toggle) {
                toggle.style.right = '500px';
            }
            
            // Ocultar todos los demás botones flotantes
            hideOtherFloatingButtons(['aiChatToggle']);
            
            // Focus en el input de chat
            setTimeout(() => {
                const input = document.getElementById('aiChatInput');
                if (input) input.focus();
            }, 300);
            
            console.log('✅ Chat IA abierto');
        }

        function createAIChatSession() {
            // Primero verificar si ya existe una sesión disponible
            return fetch('/ai-chat/', {
                method: 'GET',
                credentials: 'same-origin'
            })
            .then(response => response.text())
            .then(html => {
                // Buscar si hay sesiones existentes en el HTML
                const parser = new DOMParser();
                const doc = parser.parseFromString(html, 'text/html');
                const sessionLinks = doc.querySelectorAll('a[href*="/ai-chat-live/"]');
                
                if (sessionLinks.length > 0) {
                    // Usar la primera sesión existente
                    const firstLink = sessionLinks[0].getAttribute('href');
                    const sessionMatch = firstLink.match(/ai-chat-live\/(\d+)/);
                    if (sessionMatch) {
                        currentAIChatSession = parseInt(sessionMatch[1]);
                        console.log('✅ Usando sesión existente:', currentAIChatSession);
                        return Promise.resolve();
                    }
                }
                
                // Si no hay sesiones, crear una nueva
                return fetch('/ai-chat/', {
                    method: 'POST',
                    credentials: 'same-origin',
                    headers: {
                        'Content-Type': 'application/x-www-form-urlencoded',
                        'X-CSRFToken': getCookie('csrftoken'),
                        'X-Requested-With': 'XMLHttpRequest'
                    },
                    body: new URLSearchParams({
                        'title': 'Chat Rápido - ' + new Date().toLocaleString(),
                        'ai_model': 'gpt-4o',
                        'system_prompt': 'Eres un asistente útil para el sistema de tickets TicketProo. Puedes ayudar con consultas sobre tickets, tareas y gestión del sistema.'
                    })
                })
                .then(response => {
                    if (response.redirected) {
                        // La respuesta fue una redirección, extraer el session_id de la URL
                        const redirectUrl = response.url;
                        const sessionMatch = redirectUrl.match(/ai-chat(?:-live)?\/(\d+)/);
                        if (sessionMatch) {
                            currentAIChatSession = parseInt(sessionMatch[1]);
                            console.log('✅ Nueva sesión de chat creada:', currentAIChatSession);
                            return Promise.resolve();
                        }
                    }
                    throw new Error('No se pudo crear la sesión de chat');
                });
            })
            .catch(error => {
                console.error('❌ Error al gestionar sesión:', error);
                // Usar sesión por defecto si no se puede crear
                currentAIChatSession = 7; // Usar sesión 7 que veo en los logs
                console.log('⚠️ Usando sesión por defecto:', currentAIChatSession);
                return Promise.resolve();
            });
        }

        function closeAIChat() {
            console.log('🤖 Cerrando chat IA');
            
            const sidebar = document.getElementById('aiChatSidebar');
            const overlay = document.getElementById('aiChatOverlay');
            const toggle = document.getElementById('aiChatToggle');
            
            if (sidebar) sidebar.style.right = '-500px';
            if (overlay) overlay.style.display = 'none';
            
            // Devolver el botón a su posición original
            if (toggle) {
                toggle.style.right = '0';
            }
            
            // Mostrar todos los botones flotantes de nuevo
            showAllFloatingButtons();
        }

        function sendAIMessage() {
            const input = document.getElementById('aiChatInput');
            const messagesContainer = document.getElementById('aiChatMessages');
            const sendButton = document.getElementById('sendAIMessage');
            
            if (!input || !messagesContainer || !sendButton) {
                console.error('❌ Elementos del chat no encontrados');
                return;
            }
            
            const message = input.value.trim();
            if (!message) return;
            
            // Agregar mensaje del usuario
            addChatMessage(message, 'user');
            
            // Limpiar input y deshabilitar botón
            input.value = '';
            sendButton.disabled = true;
            sendButton.innerHTML = '<i class="bi bi-hourglass-split"></i>';
            
            // Agregar mensaje de "escribiendo..."
            const typingId = addChatMessage('IA está escribiendo...', 'ai', true);
            
            // Enviar mensaje directamente a la API de ChatGPT
            fetch('/api/ai-chat/direct/', {
                method: 'POST',
                credentials: 'same-origin',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': getCookie('csrftoken'),
                    'X-Requested-With': 'XMLHttpRequest'
                },
                body: JSON.stringify({
                    'message': message
                })
            })
            .then(response => response.json())
            .then(data => {
                // Remover mensaje de "escribiendo..."
                const typingElement = document.getElementById(typingId);
                if (typingElement) typingElement.remove();
                
                // Agregar respuesta de la IA
                if (data.status === 'success') {
                    addChatMessage(data.response, 'ai');
                } else {
                    const errorMsg = data.error || 'Lo siento, hubo un error al procesar tu mensaje.';
                    addChatMessage(errorMsg, 'ai');
                }
            })
            .catch(error => {
                console.error('❌ Error al enviar mensaje:', error);
                // Remover mensaje de "escribiendo..."
                const typingElement = document.getElementById(typingId);
                if (typingElement) typingElement.remove();
                
                addChatMessage('Error de conexión. Por favor, inténtalo de nuevo.', 'ai');
            })
            .finally(() => {
                // Rehabilitar botón
                sendButton.disabled = false;
                sendButton.innerHTML = '<i class="bi bi-send"></i>';
                input.focus();
            });
        }

        function addChatMessage(message, sender, isTyping = false) {
            const messagesContainer = document.getElementById('aiChatMessages');
            if (!messagesContainer) return;
            
            const messageId = 'msg_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9);
            const isUser = sender === 'user';
            
            // Formatear mensaje para mostrar saltos de línea
            const formattedMessage = message.replace(/\n/g, '<br>');
            
            const messageDiv = document.createElement('div');
            messageDiv.id = messageId;
            messageDiv.className = `d-flex mb-3 ${isUser ? 'justify-content-end' : ''}`;
            
            if (isUser) {
                messageDiv.innerHTML = `
                    <div class="bg-primary text-white p-3 rounded-3 shadow-sm" style="max-width: 80%;">
                        <div class="mb-0">${formattedMessage}</div>
                        <small class="opacity-75 d-block mt-2">${new Date().toLocaleTimeString()}</small>
                    </div>
                    <div class="ms-2">
                        <div class="bg-secondary text-white rounded-circle d-flex align-items-center justify-content-center" 
                             style="width: 40px; height: 40px;">
                            <i class="bi bi-person"></i>
                        </div>
                    </div>
                `;
            } else {
                const content = isTyping ? 
                    `<span class="text-muted"><i>${formattedMessage}</i></span>` : 
                    formattedMessage;
                    
                messageDiv.innerHTML = `
                    <div class="me-2">
                        <div class="text-white rounded-circle d-flex align-items-center justify-content-center" 
                             style="width: 40px; height: 40px; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);">
                            <i class="bi bi-robot"></i>
                        </div>
                    </div>
                    <div class="bg-white p-3 rounded-3 shadow-sm flex-grow-1" style="max-width: 80%;">
                        <div class="mb-0">${content}</div>
                        <small class="text-muted d-block mt-2">${new Date().toLocaleTimeString()}</small>
                    </div>
                `;
            }
            
            messagesContainer.appendChild(messageDiv);
            
            // Scroll automático al final
            messagesContainer.scrollTop = messagesContainer.scrollHeight;
            
            return messageId;
        }

        // Funciones para el Monitor del Sistema
        window.toggleSystemMonitor = function() {
            console.log('🖥️ toggleSystemMonitor() llamada');
            
            const sidebar = document.getElementById('systemMonitorSidebar');
            const overlay = document.getElementById('systemMonitorOverlay');
            
            if (!sidebar || !overlay) {
                console.error('❌ Elementos del monitor del sistema no encontrados');
                return;
            }
            
            // Abrir directamente el monitor
            openSystemMonitorSidebar();
        };

        function openSystemMonitorSidebar() {
            const sidebar = document.getElementById('systemMonitorSidebar');
            const overlay = document.getElementById('systemMonitorOverlay');
            const toggle = document.getElementById('systemMonitorToggle');
            
            // Mostrar la barra lateral desde la derecha y el overlay
            sidebar.style.right = '0';
            overlay.style.display = 'block';
            
            // Mover el botón junto con la ventana
            if (toggle) {
                toggle.style.right = '500px';
            }
            
            // Ocultar todos los demás botones flotantes
            hideOtherFloatingButtons(['systemMonitorToggle']);
            
            // Inicializar el monitoreo del sistema
            initSystemMonitoring();
            
            console.log('✅ Monitor del sistema abierto');
        }

        function closeSystemMonitor() {
            console.log('🖥️ Cerrando monitor del sistema');
            
            const sidebar = document.getElementById('systemMonitorSidebar');
            const overlay = document.getElementById('systemMonitorOverlay');
            const toggle = document.getElementById('systemMonitorToggle');
            
            if (sidebar) sidebar.style.right = '-500px';
            if (overlay) overlay.style.display = 'none';
            
            // Devolver el botón a su posición original
            if (toggle) {
                toggle.style.right = '0';
            }
            
            // Mostrar todos los botones flotantes de nuevo
            showAllFloatingButtons();
            
            // Detener el monitoreo automático
            if (window.systemMonitorInterval) {
                clearInterval(window.systemMonitorInterval);
                window.systemMonitorInterval = null;
            }
        }

        let systemMonitorPaused = false;

        function initSystemMonitoring() {
            console.log('🖥️ Inicializando monitoreo del sistema');
            
            // Mostrar los KPIs y ocultar loading
            document.getElementById('systemLoading').style.display = 'none';
            document.getElementById('systemKPIs').style.display = 'block';
            
            // Obtener información inicial
            updateSystemInfo();
            
            // Configurar actualización automática cada 5 segundos
            if (window.systemMonitorInterval) {
                clearInterval(window.systemMonitorInterval);
            }
            
            window.systemMonitorInterval = setInterval(() => {
                if (!systemMonitorPaused) {
                    updateSystemInfo();
                }
            }, 5000);
        }

        function updateSystemInfo() {
            console.log('🔄 Actualizando información del sistema');
            
            // Información del navegador y sistema
            updateBrowserInfo();
            
            // Simular datos de CPU, RAM y Disco (en un entorno real, estos vendrían del backend)
            updatePerformanceMetrics();
            
            // Obtener IP pública
            getPublicIP();
            
            // Obtener información de red local
            getNetworkInfo();
        }

        function updateBrowserInfo() {
            // Información del navegador
            const browserInfo = navigator.userAgent.split(' ').slice(-2).join(' ');
            document.getElementById('browserInfo').textContent = browserInfo;
            
            // Resolución de pantalla
            const resolution = `${screen.width}x${screen.height}`;
            document.getElementById('screenResolution').textContent = resolution;
            
            // Zona horaria
            const timezone = Intl.DateTimeFormat().resolvedOptions().timeZone;
            document.getElementById('timezone').textContent = timezone;
            
            // Idioma
            const language = navigator.language || navigator.userLanguage;
            document.getElementById('language').textContent = language;
        }

        function updatePerformanceMetrics() {
            // Obtener datos reales del servidor
            fetch('/api/system-info/', {
                method: 'GET',
                headers: {
                    'X-CSRFToken': getCookie('csrftoken'),
                    'Content-Type': 'application/json'
                },
                credentials: 'same-origin'
            })
            .then(response => response.json())
            .then(data => {
                if (data.status === 'success') {
                    // Actualizar CPU
                    document.getElementById('cpuUsage').textContent = `${data.cpu.usage_percent}%`;
                    document.getElementById('cpuProgressBar').style.width = `${data.cpu.usage_percent}%`;
                    updateProgressBarColor('cpuProgressBar', data.cpu.usage_percent);
                    
                    // Actualizar RAM
                    document.getElementById('ramUsage').textContent = `${data.memory.usage_percent}%`;
                    document.getElementById('ramProgressBar').style.width = `${data.memory.usage_percent}%`;
                    updateProgressBarColor('ramProgressBar', data.memory.usage_percent);
                    
                    // Actualizar Disco
                    document.getElementById('diskUsage').textContent = `${data.disk.free_gb} GB libre`;
                    document.getElementById('diskProgressBar').style.width = `${data.disk.usage_percent}%`;
                    updateProgressBarColor('diskProgressBar', data.disk.usage_percent);
                    
                    // Nueva barra de progreso para procesos (escalar de 0-300 procesos a 0-100%)
                    const processPercent = Math.min((data.process_count / 300) * 100, 100);
                    document.getElementById('processProgressBar').style.width = `${processPercent}%`;
                    document.getElementById('processProgressText').textContent = `${data.process_count} procesos`;
                    updateProgressBarColor('processProgressBar', processPercent);
                    
                    // Actualizar información de red
                    document.getElementById('localIP').textContent = data.network.local_ip;
                    
                    // Actualizar nuevos KPIs
                    document.getElementById('processCount').textContent = data.process_count || 0;
                    document.getElementById('systemTemp').textContent = data.temperature ? `${data.temperature}°C` : 'N/A';
                    document.getElementById('userSessions').textContent = data.user_sessions || 1;
                    document.getElementById('systemUptime').textContent = `${data.uptime.days}d ${data.uptime.hours}h`;
                    
                    // Información adicional del sistema
                    const systemCard = document.querySelector('#systemKPIs .col-12:last-child .card-body');
                    if (systemCard) {
                        systemCard.innerHTML = `
                            <div class="row g-2">
                                <div class="col-sm-6">
                                    <strong>IP Local:</strong>
                                    <div class="text-muted">${data.network.local_ip}</div>
                                </div>
                                <div class="col-sm-6">
                                    <strong>MAC Address:</strong>
                                    <div class="text-muted">${data.network.mac_address}</div>
                                </div>
                                <div class="col-sm-6">
                                    <strong>Sistema:</strong>
                                    <div class="text-muted">${data.system.platform} ${data.system.platform_release}</div>
                                </div>
                                <div class="col-sm-6">
                                    <strong>Hostname:</strong>
                                    <div class="text-muted">${data.network.hostname}</div>
                                </div>
                                <div class="col-sm-6">
                                    <strong>CPU Cores:</strong>
                                    <div class="text-muted">${data.cpu.cores} cores</div>
                                </div>
                                <div class="col-sm-6">
                                    <strong>Uptime:</strong>
                                    <div class="text-muted">${data.uptime.days}d ${data.uptime.hours}h</div>
                                </div>
                                <div class="col-12">
                                    <strong>Top Procesos:</strong>
                                    <div class="text-muted small">
                                        ${data.top_processes.slice(0, 3).map(proc => 
                                            `${proc.name}: ${(proc.cpu_percent || 0).toFixed(1)}%`
                                        ).join(', ')}
                                    </div>
                                </div>
                            </div>
                        `;
                    }
                } else {
                    console.error('Error obteniendo datos del sistema:', data.error);
                    // Fallback a datos simulados si hay error
                    updatePerformanceMetricsFallback();
                }
            })
            .catch(error => {
                console.error('Error en la solicitud del sistema:', error);
                // Fallback a datos simulados si hay error
                updatePerformanceMetricsFallback();
            });
        }

        function updatePerformanceMetricsFallback() {
            // Fallback con datos simulados si la API falla
            const cpuUsage = Math.floor(Math.random() * 100);
            const ramUsage = Math.floor(Math.random() * 100);
            const diskUsage = Math.floor(Math.random() * 100);
            
            // Actualizar displays principales
            document.getElementById('cpuUsage').textContent = `${cpuUsage}%`;
            document.getElementById('ramUsage').textContent = `${ramUsage}%`;
            document.getElementById('diskUsage').textContent = `${100 - diskUsage}% libre`;
            
            // Actualizar nuevos KPIs con datos simulados
            document.getElementById('processCount').textContent = Math.floor(Math.random() * 200) + 50;
            document.getElementById('systemTemp').textContent = `${Math.floor(Math.random() * 20) + 45}°C`;
            document.getElementById('userSessions').textContent = Math.floor(Math.random() * 5) + 1;
            document.getElementById('systemUptime').textContent = `${Math.floor(Math.random() * 30)}d ${Math.floor(Math.random() * 24)}h`;
            
            // Actualizar barras de progreso
            document.getElementById('cpuProgressBar').style.width = `${cpuUsage}%`;
            document.getElementById('ramProgressBar').style.width = `${ramUsage}%`;
            document.getElementById('diskProgressBar').style.width = `${diskUsage}%`;
            
            // Nueva barra de progreso para procesos
            const processCount = Math.floor(Math.random() * 200) + 50;
            const processPercent = Math.min((processCount / 300) * 100, 100);
            document.getElementById('processProgressBar').style.width = `${processPercent}%`;
            document.getElementById('processProgressText').textContent = `${processCount} procesos`;
            
            // Cambiar colores según el nivel
            updateProgressBarColor('cpuProgressBar', cpuUsage);
            updateProgressBarColor('ramProgressBar', ramUsage);
            updateProgressBarColor('diskProgressBar', diskUsage);
            updateProgressBarColor('processProgressBar', processPercent);
        }

        function updateProgressBarColor(elementId, value) {
            const element = document.getElementById(elementId);
            element.className = 'progress-bar';
            
            if (value < 50) {
                element.classList.add('bg-success');
            } else if (value < 80) {
                element.classList.add('bg-warning');
            } else {
                element.classList.add('bg-danger');
            }
        }

        function getPublicIP() {
            fetch('https://api.ipify.org?format=json')
                .then(response => response.json())
                .then(data => {
                    document.getElementById('publicIP').textContent = data.ip;
                })
                .catch(() => {
                    document.getElementById('publicIP').textContent = 'No disponible';
                });
        }

        function getNetworkInfo() {
            // Intentar obtener IP local usando WebRTC
            const pc = new RTCPeerConnection({iceServers: []});
            
            pc.createDataChannel('');
            pc.createOffer()
                .then(offer => pc.setLocalDescription(offer))
                .catch(() => {});
            
            pc.onicecandidate = (ice) => {
                if (ice && ice.candidate && ice.candidate.candidate) {
                    const candidate = ice.candidate.candidate;
                    const ipMatch = candidate.match(/(\d+\.\d+\.\d+\.\d+)/);
                    
                    if (ipMatch) {
                        document.getElementById('localIP').textContent = ipMatch[1];
                        pc.close();
                    }
                }
            };
            
            // Estado de la red
            if (navigator.onLine) {
                document.getElementById('networkStatus').textContent = 'Conectado';
                document.getElementById('networkStatus').className = 'h4 text-success';
            } else {
                document.getElementById('networkStatus').textContent = 'Desconectado';
                document.getElementById('networkStatus').className = 'h4 text-danger';
            }
        }

        // Test de Bootstrap
        document.addEventListener('DOMContentLoaded', function() {
            console.log('🔍 Verificando Bootstrap...');
            console.log('Bootstrap disponible:', typeof bootstrap !== 'undefined');
            console.log('Modal de Bootstrap:', typeof bootstrap.Modal !== 'undefined');
            
            // Test del modal de notas
            const modalElement = document.getElementById('quickNoteModal');
            console.log('Modal quickNoteModal encontrado:', !!modalElement);
            
            if (modalElement) {
                console.log('Modal element:', modalElement);
            }

            // Verificar funciones globales
            console.log('Función toggleQuickNote disponible:', typeof window.toggleQuickNote);
            console.log('Función saveQuickNote disponible:', typeof window.saveQuickNote);

            // Event listener para el botón de notas rápidas
            const quickNoteBtn = document.getElementById('quickNoteToggle');
            if (quickNoteBtn) {
                console.log('✅ Botón de notas encontrado, agregando event listener');
                quickNoteBtn.addEventListener('click', function(e) {
                    e.preventDefault();
                    console.log('Event listener: Abriendo modal de nota rápida...');
                    window.toggleQuickNote();
                });
            } else {
                console.error('❌ Botón quickNoteToggle no encontrado');
            }
            
            // Permitir guardar con Enter en el modal
            const quickNoteModal = document.getElementById('quickNoteModal');
            if (quickNoteModal) {
                quickNoteModal.addEventListener('keydown', function(e) {
                    if (e.key === 'Enter' && (e.ctrlKey || e.metaKey)) {
                        e.preventDefault();
                        window.saveQuickNote();
                    }
                });
                
                // Focus en título cuando se abre el modal
                quickNoteModal.addEventListener('shown.bs.modal', function() {
                    const titleInput = document.getElementById('quickNoteTitle');
                    if (titleInput) {
                        titleInput.focus();
                    }
                });
            }
        });
    </script>
    
    <!-- Script para favicon dinámico -->
    <script>
        function updateFavicon(isWorking) {
            const favicon = document.getElementById('favicon');
            if (favicon) {
                if (isWorking) {
                    // Favicon verde cuando está trabajando
                    favicon.href = "data:image/svg+xml,%3csvg xmlns='http://www.w3.org/2000/svg' width='32' height='32' viewBox='0 0 32 32'%3e%3ccircle cx='16' cy='16' r='14' fill='%2328a745'/%3e%3crect x='8' y='11' width='16' height='10' rx='1' fill='white'/%3e%3ccircle cx='9' cy='16' r='1' fill='%2328a745'/%3e%3ccircle cx='23' cy='16' r='1' fill='%2328a745'/%3e%3crect x='11' y='13' width='6' height='1' fill='%2328a745'/%3e%3crect x='11' y='15' width='4' height='1' fill='%2328a745'/%3e%3crect x='11' y='17' width='5' height='1' fill='%2328a745'/%3e%3crect x='18' y='13' width='3' height='1' fill='%2328a745'/%3e%3c/svg%3e";
                } else {
                    // Favicon gris cuando no está trabajando
                    favicon.href = "data:image/svg+xml,%3csvg xmlns='http://www.w3.org/2000/svg' width='32' height='32' viewBox='0 0 32 32'%3e%3ccircle cx='16' cy='16' r='14' fill='%23495057'/%3e%3crect x='8' y='11' width='16' height='10' rx='1' fill='white'/%3e%3ccircle cx='9' cy='16' r='1' fill='%23495057'/%3e%3ccircle cx='23' cy='16' r='1' fill='%23495057'/%3e%3crect x='11' y='13' width='6' height='1' fill='%23495057'/%3e%3crect x='11' y='15' width='4' height='1' fill='%23495057'/%3e%3crect x='11' y='17' width='5' height='1' fill='%23495057'/%3e%3crect x='18' y='13' width='3' height='1' fill='%23495057'/%3e%3c/svg%3e";
                }
            }
        }
        
        // Inicializar favicon al cargar la página
        {% if user.is_authenticated %}
            const isWorking = {{ is_working|yesno:"true,false" }};
            updateFavicon(isWorking);
            
            // Actualizar cada 30 segundos
            setInterval(function() {
                // Aquí podrías hacer una llamada AJAX para verificar el estado
                updateFavicon(isWorking);
            }, 30000);
        {% else %}
            // Usuario no autenticado - favicon gris
            updateFavicon(false);
        {% endif %}
    </script>
    
    <!-- Script para fecha y hora en tiempo real -->
    <script>
        function updateDateTime() {
            console.log('=== updateDateTime() ejecutándose ===');
            const now = new Date();
            
            // Configurar opciones para fecha y hora en el ticker
            const dateOptions = { 
                day: '2-digit', 
                month: '2-digit', 
                year: 'numeric' 
            };
            
            const timeOptions = { 
                hour: '2-digit', 
                minute: '2-digit',
                hour12: false
            };
            
            // Formatear fecha y hora
            const formattedDate = now.toLocaleDateString('es-ES', dateOptions);
            const formattedTime = now.toLocaleTimeString('es-ES', timeOptions);
            
            console.log('Fecha formateada:', formattedDate);
            console.log('Hora formateada:', formattedTime);
            
            // Actualizar elementos del DOM
            const dateElement = document.getElementById('current-date');
            const timeElement = document.getElementById('current-time');
            
            console.log('Elemento fecha encontrado:', !!dateElement, dateElement);
            console.log('Elemento hora encontrado:', !!timeElement, timeElement);
            
            if (dateElement) {
                dateElement.textContent = formattedDate;
                console.log('✅ Fecha actualizada:', formattedDate);
            } else {
                console.error('❌ Elemento current-date NO encontrado');
            }
            
            if (timeElement) {
                timeElement.textContent = formattedTime;
                console.log('✅ Hora actualizada:', formattedTime);
            } else {
                console.error('❌ Elemento current-time NO encontrado');
            }
            
            // Verificar si el ticker está visible
            const tickerElement = document.getElementById('financial-ticker-global');
            console.log('Ticker visible:', !!tickerElement, tickerElement ? getComputedStyle(tickerElement).display : 'N/A');
        }
        
        // Ejecutar inmediatamente para test
        console.log('🚀 Iniciando script de fecha/hora...');
        updateDateTime();
        
        // También cuando el DOM esté listo
        document.addEventListener('DOMContentLoaded', function() {
            console.log('📄 DOM cargado, ejecutando updateDateTime...');
            updateDateTime();
            // Actualizar cada minuto
            setInterval(updateDateTime, 60000);
        });
        
        // Y también después de un delay para asegurar que todo esté cargado
        setTimeout(function() {
            console.log('⏰ Timeout ejecutado, ejecutando updateDateTime...');
            updateDateTime();
        }, 2000);
    </script>
    
    <!-- Widget de Chat Flotante -->
    {% if user.is_authenticated %}
    <div id="chat-widget" class="chat-widget">
        <div class="chat-widget-header" onclick="toggleChatWidget()">
            <i class="fas fa-comments"></i>
            <div class="chat-notifications" id="chat-notifications" style="display: none;">
                <span id="notification-count">0</span>
            </div>
        </div>
        
        <div class="chat-widget-body" id="chat-widget-body" style="display: none;">
            <div class="chat-widget-tabs">
                <button class="chat-tab active" onclick="showChatTab('conversations')">
                    Conversaciones
                </button>
                <button class="chat-tab" onclick="showChatTab('users')">
                    Usuarios
                </button>
            </div>
            
            <div class="chat-tab-content" id="conversations-tab">
                <div class="chat-conversations-list" id="chat-conversations">
                    <div class="text-center p-3">
                        <i class="fas fa-spinner fa-spin"></i>
                        <small class="d-block mt-2">Cargando conversaciones...</small>
                    </div>
                </div>
            </div>
            
            <div class="chat-tab-content" id="users-tab" style="display: none;">
                <div class="chat-users-list" id="chat-users">
                    <div class="text-center p-3">
                        <i class="fas fa-spinner fa-spin"></i>
                        <small class="d-block mt-2">Cargando usuarios...</small>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <style>
    .chat-widget {
        position: fixed;
        bottom: 20px;
        left: 20px;
        width: 50px;
        height: 50px;
        z-index: 1050;
        font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
    }
    
    .chat-widget-header {
        background: #2196f3;
        color: white;
        padding: 12px;
        cursor: pointer;
        display: flex;
        align-items: center;
        justify-content: center;
        user-select: none;
        transition: all 0.3s ease;
        width: 50px;
        height: 50px;
        border-radius: 50%;
        position: relative;
    }
    
    .chat-widget-header:hover {
        background: #1976d2;
        transform: scale(1.1);
        box-shadow: 0 4px 15px rgba(33, 150, 243, 0.4);
    }
    .chat-widget.expanded {
        width: 320px;
        height: auto;
        max-height: 500px;
        background: white;
        border-radius: 15px;
        box-shadow: 0 8px 35px rgba(0,0,0,0.15);
        display: flex;
        flex-direction: column;
        overflow: hidden;
        border: 1px solid #e3e6f0;
    }

    .chat-widget.expanded .chat-widget-header {
        border-radius: 15px 15px 0 0;
        width: 100%;
        height: auto;
        padding: 15px 20px;
        justify-content: space-between;
    }

    .chat-widget.expanded .chat-widget-header i {
        font-size: 1.1rem;
    }

    .chat-widget.expanded .chat-widget-header::after {
        content: "Chat";
        margin-left: 10px;
        font-weight: 500;
    }
        font-weight: 600;
        font-size: 1rem;
    }
    
    .chat-notifications {
        background: #ff5722;
        color: white;
        border-radius: 12px;
        width: 20px;
        height: 20px;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 10px;
        font-weight: bold;
        position: absolute;
        top: -5px;
        right: -5px;
        border: 2px solid white;
        animation: pulse 2s infinite;
    }
    }
    
    @keyframes pulse {
        0% { transform: scale(1); }
        50% { transform: scale(1.1); }
        100% { transform: scale(1); }
    }
    
    .chat-widget-body {
        flex: 1;
        display: flex;
        flex-direction: column;
        max-height: 400px;
        background: #f8f9fa;
    }
    
    .chat-widget-tabs {
        display: flex;
        border-bottom: 1px solid #dee2e6;
        background: white;
    }
    
    .chat-tab {
        flex: 1;
        padding: 12px 16px;
        border: none;
        background: none;
        color: #6c757d;
        font-size: 13px;
        cursor: pointer;
        transition: all 0.2s;
        font-weight: 500;
        position: relative;
    }
    
    .chat-tab.active {
        color: #667eea;
        background: #f8f9fa;
    }
    
    .chat-tab.active::after {
        content: '';
        position: absolute;
        bottom: 0;
        left: 0;
        right: 0;
        height: 3px;
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    }
    
    .chat-tab:hover:not(.active) {
        background: #f1f3f4;
        color: #495057;
    }
    
    .chat-tab-content {
        flex: 1;
        overflow-y: auto;
    }
    
    .chat-conversation-item,
    .chat-user-item {
        padding: 12px 16px;
        border-bottom: 1px solid #f1f3f4;
        cursor: pointer;
        transition: all 0.2s;
        display: flex;
        align-items: center;
        text-decoration: none;
        color: inherit;
        background: white;
    }
    
    .chat-conversation-item:hover,
    .chat-user-item:hover {
        background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
        color: inherit;
        text-decoration: none;
        transform: translateX(2px);
    }
    
    .chat-avatar {
        width: 36px;
        height: 36px;
        border-radius: 50%;
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 13px;
        font-weight: bold;
        margin-right: 12px;
        flex-shrink: 0;
        border: 2px solid white;
        box-shadow: 0 2px 8px rgba(0,0,0,0.1);
    }
    
    .chat-info {
        flex: 1;
        min-width: 0;
    }
    
    .chat-name {
        font-size: 14px;
        font-weight: 600;
        margin: 0;
        white-space: nowrap;
        overflow: hidden;
        text-overflow: ellipsis;
        color: #2c3e50;
    }
    
    .chat-last-message {
        font-size: 12px;
        color: #6c757d;
        margin: 2px 0 0 0;
        white-space: nowrap;
        overflow: hidden;
        text-overflow: ellipsis;
    }
    
    .chat-time {
        font-size: 10px;
        color: #6c757d;
        white-space: nowrap;
    }
    
    .chat-unread {
        background: linear-gradient(135deg, #ff6b6b 0%, #ee5a24 100%);
        color: white;
        border-radius: 12px;
        padding: 2px 8px;
        font-size: 10px;
        font-weight: bold;
        margin-left: 8px;
        min-width: 18px;
        text-align: center;
    }
    
    .empty-state {
        text-align: center;
        padding: 40px 20px;
        color: #6c757d;
    }
    
    .empty-state i {
        font-size: 2.5rem;
        margin-bottom: 12px;
        opacity: 0.4;
        color: #667eea;
    }
    
    .empty-state h6 {
        font-weight: 600;
        margin-bottom: 8px;
        color: #495057;
    }
    
    .empty-state p {
        font-size: 12px;
        margin: 0;
    }
    
    .chat-toggle-icon {
        transition: transform 0.3s ease;
    }
    
    .chat-toggle-icon.rotated {
        transform: rotate(180deg);
    }
    </style>
    
    <!-- Estilos específicos para Quick TODO -->
    <style>
    /* Checkboxes redondos estilo Mac */
    .todo-checkbox {
        width: 18px !important;
        height: 18px !important;
        border-radius: 50% !important;
        border: 2px solid #6c757d !important;
        background-color: transparent !important;
        cursor: pointer !important;
        transition: all 0.2s ease !important;
        position: relative !important;
    }
    
    .todo-checkbox:checked {
        background-color: #28a745 !important;
        border-color: #28a745 !important;
        box-shadow: 0 0 0 2px rgba(40, 167, 69, 0.2) !important;
    }
    
    .todo-checkbox:checked::before {
        content: '✓' !important;
        color: white !important;
        font-size: 12px !important;
        font-weight: bold !important;
        position: absolute !important;
        top: -1px !important;
        left: 2px !important;
        line-height: 1 !important;
    }
    
    .todo-checkbox:hover {
        border-color: #28a745 !important;
        box-shadow: 0 0 0 2px rgba(40, 167, 69, 0.1) !important;
    }
    
    .todo-checkbox:focus {
        box-shadow: 0 0 0 3px rgba(40, 167, 69, 0.25) !important;
        outline: none !important;
    }
    
    /* Animaciones para los items de TODO */
    .todo-item {
        transition: all 0.3s ease !important;
        border-left: 3px solid #dee2e6 !important;
    }
    
    .todo-item:hover {
        transform: translateX(5px) !important;
        box-shadow: 0 4px 8px rgba(0,0,0,0.1) !important;
    }
    
    /* Estilos para tareas completadas */
    .todo-item.completed {
        opacity: 0.7 !important;
        border-left-color: #28a745 !important;
    }
    
    .todo-text {
        font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif !important;
        line-height: 1.4 !important;
        margin-bottom: 0 !important;
    }
    
    /* Estilo para el input de nueva tarea */
    #newTodoInput {
        font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif !important;
    }
    
    #newTodoInput:focus {
        border-color: #6c757d !important;
        box-shadow: 0 0 0 0.2rem rgba(108, 117, 125, 0.25) !important;
    }
    
    /* Estilo para el botón de agregar */
    #addTodoButton {
        transition: all 0.2s ease !important;
    }
    
    #addTodoButton:hover {
        transform: scale(1.05) !important;
    }
    
    /* Scrollbar personalizado para la lista de tareas */
    #todoList::-webkit-scrollbar {
        width: 6px;
    }
    
    #todoList::-webkit-scrollbar-track {
        background: #f1f1f1;
        border-radius: 3px;
    }
    
    #todoList::-webkit-scrollbar-thumb {
        background: #c1c1c1;
        border-radius: 3px;
    }
    
    #todoList::-webkit-scrollbar-thumb:hover {
        background: #a8a8a8;
    }
    </style>
    
    <script>
    let chatWidgetExpanded = false;
    
    function toggleChatWidget() {
        const body = document.getElementById('chat-widget-body');
        const widget = document.getElementById('chat-widget');
        
        if (chatWidgetExpanded) {
            body.style.display = 'none';
            widget.classList.remove('expanded');
            chatWidgetExpanded = false;
        } else {
            body.style.display = 'flex';
            widget.classList.add('expanded');
            chatWidgetExpanded = true;
            loadChatConversations();
        }
    }
    
    function showChatTab(tab) {
        // Actualizar tabs
        document.querySelectorAll('.chat-tab').forEach(t => t.classList.remove('active'));
        
        // Mostrar contenido
        document.querySelectorAll('.chat-tab-content').forEach(content => {
            content.style.display = 'none';
        });
        
        if (tab === 'conversations') {
            document.getElementById('conversations-tab').style.display = 'block';
            document.querySelectorAll('.chat-tab')[0].classList.add('active');
            loadChatConversations();
        } else if (tab === 'users') {
            document.getElementById('users-tab').style.display = 'block';
            document.querySelectorAll('.chat-tab')[1].classList.add('active');
            loadChatUsers();
        }
    }
    
    function loadChatConversations() {
        const container = document.getElementById('chat-conversations');
        container.innerHTML = '<div class="text-center p-3"><i class="fas fa-spinner fa-spin"></i><small class="d-block mt-2">Cargando...</small></div>';
        
        fetch('/chat/')
            .then(response => response.text())
            .then(html => {
                const parser = new DOMParser();
                const doc = parser.parseFromString(html, 'text/html');
                const conversations = doc.querySelectorAll('.conversation-item');
                
                if (conversations.length > 0) {
                    let conversationsHtml = '';
                    conversations.forEach(conv => {
                        const avatar = conv.querySelector('.conversation-avatar');
                        const name = conv.querySelector('.conversation-name').textContent.trim();
                        const preview = conv.querySelector('.conversation-preview');
                        const badge = conv.querySelector('.unread-badge');
                        const href = conv.getAttribute('href');
                        
                        conversationsHtml += `
                            <a href="${href}" class="chat-conversation-item">
                                <div class="chat-avatar">
                                    ${avatar ? avatar.textContent.trim() : name.charAt(0).toUpperCase()}
                                </div>
                                <div class="chat-info">
                                    <div class="chat-name">${name}</div>
                                    ${preview ? `<div class="chat-last-message">${preview.textContent.trim()}</div>` : ''}
                                </div>
                                ${badge ? `<span class="chat-unread">${badge.textContent.trim()}</span>` : ''}
                            </a>
                        `;
                    });
                    container.innerHTML = conversationsHtml;
                } else {
                    container.innerHTML = `
                        <div class="empty-state">
                            <i class="fas fa-comments"></i>
                            <h6>Sin conversaciones</h6>
                            <p>Inicia una nueva conversación</p>
                        </div>
                    `;
                }
            })
            .catch(error => {
                console.error('Error loading conversations:', error);
                container.innerHTML = `
                    <div class="empty-state">
                        <i class="fas fa-exclamation-triangle"></i>
                        <h6>Error al cargar</h6>
                        <p>Intenta de nuevo</p>
                    </div>
                `;
            });
    }
    
    function loadChatUsers() {
        const container = document.getElementById('chat-users');
        container.innerHTML = '<div class="text-center p-3"><i class="fas fa-spinner fa-spin"></i><small class="d-block mt-2">Cargando...</small></div>';
        
        fetch('/chat/users/')
            .then(response => response.text())
            .then(html => {
                const parser = new DOMParser();
                const doc = parser.parseFromString(html, 'text/html');
                const users = doc.querySelectorAll('.user-item');
                
                if (users.length > 0) {
                    let usersHtml = '';
                    users.forEach(user => {
                        const avatar = user.querySelector('.user-avatar');
                        const name = user.querySelector('h6').textContent.trim();
                        const username = user.querySelector('small').textContent.trim();
                        const href = user.getAttribute('href');
                        
                        usersHtml += `
                            <a href="${href}" class="chat-user-item">
                                <div class="chat-avatar">
                                    ${avatar ? avatar.textContent.trim() : name.charAt(0).toUpperCase()}
                                </div>
                                <div class="chat-info">
                                    <div class="chat-name">${name}</div>
                                    <div class="chat-last-message">${username}</div>
                                </div>
                            </a>
                        `;
                    });
                    container.innerHTML = usersHtml;
                } else {
                    container.innerHTML = `
                        <div class="empty-state">
                            <i class="fas fa-users"></i>
                            <h6>Sin usuarios</h6>
                            <p>No hay usuarios disponibles</p>
                        </div>
                    `;
                }
            })
            .catch(error => {
                console.error('Error loading users:', error);
                container.innerHTML = `
                    <div class="empty-state">
                        <i class="fas fa-exclamation-triangle"></i>
                        <h6>Error al cargar</h6>
                        <p>Intenta de nuevo</p>
                    </div>
                `;
            });
    }
    </script>
    {% endif %}
    
    <!-- Botón Flotante de IA Global -->
    {% if user.is_authenticated %}
    <div id="ai-floating-button" class="ai-floating-btn">
        <a href="{% url 'voice_command_interface' %}" 
           class="btn btn-primary btn-lg rounded-circle shadow-lg"
           title="Comandos de Voz IA - Crear tickets hablando">
            <i class="fas fa-microphone-alt"></i>
        </a>
        <div class="ai-floating-tooltip">
            <span>Comandos de Voz IA</span>
        </div>
    </div>
    {% endif %}
    
    {% block extra_js %}
    {% endblock %}
    
    <script>
    // Funcionalidad del botón flotante de IA
    document.addEventListener('DOMContentLoaded', function() {
        const aiButton = document.getElementById('ai-floating-button');
        if (aiButton) {
            const tooltip = aiButton.querySelector('.ai-floating-tooltip');
            
            // Mostrar tooltip al hacer hover
            aiButton.addEventListener('mouseenter', function() {
                tooltip.classList.add('show');
            });
            
            aiButton.addEventListener('mouseleave', function() {
                tooltip.classList.remove('show');
            });
            
            // Animación de pulso cada 30 segundos para recordar al usuario
            setInterval(function() {
                aiButton.classList.add('pulse-animation');
                setTimeout(() => {
                    aiButton.classList.remove('pulse-animation');
                }, 2000);
            }, 30000);
        }
    });
    </script>
    
    <style>
    /* Estilo del botón flotante de IA */
    .ai-floating-btn {
        position: fixed;
        right: 30px;
        bottom: 30px;
        z-index: 1000;
        transition: all 0.3s ease;
    }

    .ai-floating-btn .btn {
        width: 60px;
        height: 60px;
        display: flex;
        align-items: center;
        justify-content: center;
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        border: none;
        color: white;
        font-size: 1.5rem;
        transition: all 0.3s ease;
        position: relative;
        overflow: hidden;
    }

    .ai-floating-btn .btn:hover {
        transform: scale(1.1);
        box-shadow: 0 8px 25px rgba(102, 126, 234, 0.4);
        background: linear-gradient(135deg, #764ba2 0%, #667eea 100%);
    }

    .ai-floating-btn .btn:before {
        content: '';
        position: absolute;
        top: 50%;
        left: 50%;
        width: 0;
        height: 0;
        border-radius: 50%;
        background: rgba(255, 255, 255, 0.3);
        transition: all 0.6s ease;
        transform: translate(-50%, -50%);
    }

    .ai-floating-btn .btn:hover:before {
        width: 120%;
        height: 120%;
    }

    /* Tooltip del botón */
    .ai-floating-tooltip {
        position: absolute;
        right: 70px;
        top: 50%;
        transform: translateY(-50%);
        background: rgba(0, 0, 0, 0.8);
        color: white;
        padding: 8px 12px;
        border-radius: 6px;
        font-size: 14px;
        white-space: nowrap;
        opacity: 0;
        pointer-events: none;
        transition: all 0.3s ease;
    }

    .ai-floating-tooltip:after {
        content: '';
        position: absolute;
        left: 100%;
        top: 50%;
        transform: translateY(-50%);
        border: 6px solid transparent;
        border-left-color: rgba(0, 0, 0, 0.8);
    }

    .ai-floating-tooltip.show {
        opacity: 1;
        transform: translateY(-50%) translateX(-10px);
    }

    /* Animación de pulso */
    .ai-floating-btn.pulse-animation .btn {
        animation: pulse-glow 2s ease-in-out;
    }

    @keyframes pulse-glow {
        0% {
            box-shadow: 0 4px 15px rgba(102, 126, 234, 0.3);
        }
        50% {
            box-shadow: 0 8px 30px rgba(102, 126, 234, 0.6);
            transform: scale(1.05);
        }
        100% {
            box-shadow: 0 4px 15px rgba(102, 126, 234, 0.3);
        }
    }

    /* Responsivo */
    @media (max-width: 768px) {
        .ai-floating-btn {
            right: 20px;
            bottom: 20px;
        }
        
        .ai-floating-btn .btn {
            width: 50px;
            height: 50px;
            font-size: 1.2rem;
        }
        
        .ai-floating-tooltip {
            display: none; /* Ocultar tooltip en móviles */
        }
    }

    /* Asegurar que esté por encima de otros elementos */
    .ai-floating-btn {
        z-index: 9999;
    }
    
    /* Estilos para el ticker financiero */
    #financial-ticker-global {
        position: fixed;
        bottom: 0;
        left: 0;
        right: 0;
        z-index: 1000;
        height: 40px;
        overflow: hidden;
        background: linear-gradient(90deg, #1a1a1a 0%, #2d2d2d 100%);
        border-top: 1px solid #444;
    }

    .ticker-content-global {
        animation: none;
        transition: all 0.5s ease-in-out;
        height: 40px;
        display: flex;
        align-items: center;
    }

    .ticker-item-global {
        min-width: 100%;
        white-space: nowrap;
        display: flex;
        align-items: center;
        padding: 0 20px;
    }

    /* Animación suave para cambios */
    .ticker-content-global {
        opacity: 1;
        transition: opacity 0.3s ease-in-out;
    }

    .ticker-fade-global {
        opacity: 0.7;
    }

    /* Ajustar el padding bottom del main para que no se superponga con el ticker */
    main.container {
        padding-bottom: 60px;
    }

    /* Responsivo para el ticker */
    @media (max-width: 768px) {
        #financial-ticker-global {
            height: 35px;
        }
        
        .ticker-content-global {
            height: 35px;
        }
        
        .ticker-item-global {
            padding: 0 15px;
            font-size: 0.9rem;
        }
        
        main.container {
            padding-bottom: 55px;
        }
    }
    </style>

    <!-- Ticker de Acciones Financieras Global -->
    {% if user.is_authenticated %}
    <div id="financial-ticker-global" class="bg-dark text-white">
        <div class="d-flex align-items-center h-100">
            <div class="me-3 ps-3">
                <i class="bi bi-graph-up-arrow"></i>
                <small class="fw-bold">MERCADOS:</small>
            </div>
            <div class="flex-grow-1">
                <div id="financial-ticker" class="d-flex align-items-center h-100">
                    <div class="ticker-content-global d-flex align-items-center">
                        <!-- Las acciones se cargarán aquí via JavaScript -->
                        <span class="text-muted">Cargando datos del mercado...</span>
                    </div>
                </div>
            </div>
            {% if is_agent %}
            <div class="me-3">
                <a href="{% url 'financial_actions_list' %}" class="btn btn-sm btn-outline-light" title="Configurar Acciones">
                    <i class="bi bi-gear"></i>
                </a>
                <button onclick="refreshFinancialTicker()" class="btn btn-sm btn-outline-light ms-2" title="Actualizar Acciones">
                    <i class="bi bi-arrow-clockwise"></i>
                </button>
            </div>
            {% endif %}
            <!-- Fecha y hora minimalista -->
            <div class="pe-3 text-end">
                <small class="text-white-50">
                    Fecha: <span id="current-date"></span> | Hora: <span id="current-time"></span>
                </small>
            </div>
        </div>
    </div>

    <script>
    // Ticker de acciones financieras global - v2.0
    console.log('Iniciando ticker financiero v2.0...');
    
    let tickerDataGlobal = [];
    let currentTickerIndexGlobal = 0;

    function loadTickerDataGlobal() {
        console.log('Cargando datos del ticker...');
        
        fetch('{% url "financial_actions_ticker_data" %}?t=' + Date.now())
            .then(response => {
                console.log('Respuesta API:', response.status);
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                return response.json();
            })
            .then(data => {
                console.log('Datos recibidos:', data);
                tickerDataGlobal = data.actions || [];
                
                const tickerContent = document.querySelector('#financial-ticker .ticker-content-global');
                if (!tickerContent) {
                    console.error('Elemento ticker no encontrado');
                    return;
                }
                
                if (tickerDataGlobal.length > 0) {
                    console.log(`${tickerDataGlobal.length} acciones cargadas`);
                    updateTickerGlobal();
                } else {
                    console.log('No hay acciones activas');
                    tickerContent.innerHTML = '<span class="text-muted">No hay acciones configuradas</span>';
                }
            })
            .catch(error => {
                console.error('Error del ticker:', error);
                const tickerContent = document.querySelector('#financial-ticker .ticker-content-global');
                if (tickerContent) {
                    tickerContent.innerHTML = '<span class="text-danger">Error cargando datos</span>';
                }
            });
    }

    function updateTickerGlobal() {
        if (tickerDataGlobal.length === 0) {
            console.log('No hay datos para mostrar');
            return;
        }
        
        const action = tickerDataGlobal[currentTickerIndexGlobal];
        const tickerContent = document.querySelector('#financial-ticker .ticker-content-global');
        
        if (!tickerContent) {
            console.error('Elemento ticker no encontrado en update');
            return;
        }
        
        let changeIcon = '●';
        let changeClass = 'text-muted';
        
        if (action.is_positive_change) {
            changeIcon = '▲';
            changeClass = 'text-success';
        } else if (action.is_negative_change) {
            changeIcon = '▼';
            changeClass = 'text-danger';
        }
        
        let changeText = '';
        if (action.previous_price !== null) {
            const priceChange = parseFloat(action.price_change) || 0;
            const priceChangePercent = parseFloat(action.price_change_percent) || 0;
            const sign = priceChange >= 0 ? '+' : '';
            changeText = `<span class="${changeClass} ms-2">
                ${changeIcon} ${sign}${priceChange.toFixed(4)} (${sign}${priceChangePercent.toFixed(2)}%)
            </span>`;
        }
        
        const html = `
            <div class="d-flex align-items-center ticker-item-global">
                <span class="fw-bold me-2">${action.symbol}</span>
                <span class="me-2">${parseFloat(action.current_price).toFixed(4)} ${action.currency}</span>
                ${changeText}
                <span class="text-muted ms-3 small">${action.name}</span>
            </div>
        `;
        
        console.log(`Mostrando: ${action.symbol} - ${action.current_price}`);
        tickerContent.innerHTML = html;
        
        // Pasar al siguiente elemento
        currentTickerIndexGlobal = (currentTickerIndexGlobal + 1) % tickerDataGlobal.length;
    }

    // Inicializar cuando el DOM esté listo
    document.addEventListener('DOMContentLoaded', function() {
        const tickerElement = document.getElementById('financial-ticker-global');
        if (tickerElement) {
            console.log('Ticker element encontrado, iniciando...');
            
            // Cargar datos iniciales
            loadTickerDataGlobal();
            
            // Rotar ticker cada 5 segundos
            setInterval(updateTickerGlobal, 5000);
            
            // Recargar datos cada 30 segundos
            setInterval(loadTickerDataGlobal, 30000);
        } else {
            console.log('Ticker element no encontrado');
        }
    });
    
    // Función para actualizar manualmente el ticker
    function refreshFinancialTicker() {
        console.log('Actualizando ticker manualmente...');
        const button = event.target.closest('button');
        const icon = button.querySelector('i');
        
        // Cambiar icono a spinner
        icon.className = 'bi bi-arrow-repeat';
        icon.style.animation = 'spin 1s linear infinite';
        
        // Cargar datos nuevos
        loadTickerDataGlobal();
        
        // Restaurar icono después de 2 segundos
        setTimeout(() => {
            icon.className = 'bi bi-arrow-clockwise';
            icon.style.animation = '';
        }, 2000);
    }
    
    // CSS para la animación del spinner
    const style = document.createElement('style');
    style.textContent = `
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
    `;
    document.head.appendChild(style);
    </script>
    
    <!-- Script para la barra lateral de usuarios activos -->
    <script>
        // Variables globales para la barra lateral
        let activeUsersSidebarOpen = false;
        let autoRefreshInterval = null;

        // Función para alternar la barra lateral
        function toggleActiveUsersSidebar() {
            const sidebar = document.getElementById('activeUsersSidebar');
            const overlay = document.getElementById('sidebarOverlay');
            const toggle = document.getElementById('activeUsersSidebarToggle');
            
            if (!activeUsersSidebarOpen) {
                // Abrir barra lateral
                sidebar.style.right = '0px';
                overlay.style.display = 'block';
                toggle.style.right = '400px'; // Mover el botón al lado de la barra
                activeUsersSidebarOpen = true;
                
                // Ocultar todos los demás botones flotantes
                hideOtherFloatingButtons(['activeUsersSidebarToggle']);
                
                // Cargar usuarios cuando se abre
                loadActiveUsersSidebar();
                
                // Iniciar auto-refresh
                startAutoRefresh();
            } else {
                // Cerrar barra lateral
                closeSidebar();
            }
        }

        // Función para cerrar la barra lateral
        function closeSidebar() {
            const sidebar = document.getElementById('activeUsersSidebar');
            const overlay = document.getElementById('sidebarOverlay');
            const toggle = document.getElementById('activeUsersSidebarToggle');
            
            sidebar.style.right = '-400px';
            overlay.style.display = 'none';
            toggle.style.right = '0'; // Volver al borde derecho
            activeUsersSidebarOpen = false;
            
            // Mostrar todos los botones flotantes de nuevo
            showAllFloatingButtons();
            
            // Detener auto-refresh
            stopAutoRefresh();
        }

        // Función para cargar usuarios activos en la barra lateral
        function loadActiveUsersSidebar() {
            const listContainer = document.getElementById('activeUsersListSidebar');
            const lastUpdateElement = document.getElementById('lastUpdateSidebar');
            
            // Mostrar loading
            listContainer.innerHTML = `
                <div class="text-center py-4">
                    <div class="spinner-border text-success" role="status">
                        <span class="visually-hidden">Cargando...</span>
                    </div>
                    <p class="mt-2 text-muted">Cargando usuarios activos...</p>
                </div>
            `;
            
            // Llamada a la API
            fetch('/api/active-users/')
                .then(response => response.json())
                .then(data => {
                    displayActiveUsersSidebar(data.users);
                    updateActiveUsersCount(data.count);
                    
                    // Actualizar tiempo
                    const now = new Date();
                    lastUpdateElement.textContent = now.toLocaleTimeString('es-ES', {
                        hour: '2-digit',
                        minute: '2-digit'
                    });
                })
                .catch(error => {
                    console.log('[Barra Lateral] Error al cargar usuarios:', error);
                    // Mostrar datos de ejemplo en caso de error
                    displayActiveUsersSidebar([
                        {
                            name: 'María García',
                            username: 'mgarcia',
                            email: 'maria.garcia@empresa.com',
                            phone: '+34 612 345 678',
                            entry_time: '08:30',
                            avatar_url: 'https://ui-avatars.com/api/?name=Maria+Garcia&background=28a745&color=fff&size=50',
                            status: 'active'
                        },
                        {
                            name: 'Juan Pérez',
                            username: 'jperez',
                            email: 'juan.perez@empresa.com',
                            phone: '+34 623 456 789',
                            entry_time: '09:15',
                            avatar_url: 'https://ui-avatars.com/api/?name=Juan+Perez&background=28a745&color=fff&size=50',
                            status: 'active'
                        },
                        {
                            name: 'Ana López',
                            username: 'alopez',
                            email: 'ana.lopez@empresa.com',
                            phone: '+34 634 567 890',
                            entry_time: '08:45',
                            avatar_url: 'https://ui-avatars.com/api/?name=Ana+Lopez&background=28a745&color=fff&size=50',
                            status: 'active'
                        }
                    ]);
                    updateActiveUsersCount(3);
                });
        }

        // Función para mostrar usuarios en la barra lateral
        function displayActiveUsersSidebar(users) {
            const listContainer = document.getElementById('activeUsersListSidebar');
            
            if (users.length === 0) {
                listContainer.innerHTML = `
                    <div class="text-center py-4">
                        <i class="bi bi-person-x text-muted" style="font-size: 3rem;"></i>
                        <p class="text-muted mt-2">No hay usuarios activos en este momento</p>
                    </div>
                `;
                return;
            }
            
            // Añadir indicador de scroll si hay muchos usuarios
            const scrollIndicator = users.length > 3 ? `
                <div class="text-center py-2 mb-2 border-bottom">
                    <small class="text-muted">
                        <i class="bi bi-chevron-down"></i>
                        ${users.length} usuarios activos - Desliza para ver más
                    </small>
                </div>
            ` : '';
            
            const usersHtml = users.map(user => `
                <div class="d-flex align-items-start p-3 mb-2 border rounded hover-bg-light">
                    <img src="${user.avatar_url}" alt="${user.name}" 
                         class="rounded-circle me-3" width="50" height="50">
                    <div class="flex-grow-1">
                        <div class="fw-semibold mb-1">${user.name}</div>
                        
                        <div class="small text-muted mb-1">
                            <i class="bi bi-clock me-1"></i>
                            Entrada: ${user.entry_time || 'N/A'}
                        </div>
                        
                        ${user.email ? `
                        <div class="small text-muted mb-1">
                            <i class="bi bi-envelope me-1"></i>
                            <a href="mailto:${user.email}" class="text-decoration-none text-muted">
                                ${user.email}
                            </a>
                        </div>
                        ` : ''}
                        
                        ${user.phone ? `
                        <div class="small text-muted mb-2">
                            <i class="bi bi-telephone me-1"></i>
                            <a href="tel:${user.phone}" class="text-decoration-none text-muted">
                                ${user.phone}
                            </a>
                        </div>
                        ` : ''}
                        
                        <!-- Botones de acción -->
                        <div class="d-flex gap-1 mt-2">
                            ${user.phone ? `
                            <button class="btn btn-sm btn-outline-success" 
                                    onclick="openWhatsApp('${user.phone}', '${user.name}')"
                                    title="WhatsApp">
                                <i class="bi bi-whatsapp"></i>
                            </button>
                            ` : ''}
                            
                            <button class="btn btn-sm btn-outline-info" 
                                    onclick="viewUserProfile('${user.id}', '${user.name}')"
                                    title="Ver perfil">
                                <i class="bi bi-person"></i>
                            </button>
                        </div>
                    </div>
                    
                    <div class="text-end">
                        <span class="badge bg-success">
                            <i class="bi bi-circle-fill" style="font-size: 0.6em;"></i>
                            Activo
                        </span>
                    </div>
                </div>
            `).join('');
            
            listContainer.innerHTML = scrollIndicator + usersHtml;
            
            // Añadir efecto de fade-in para nuevos elementos
            const userElements = listContainer.querySelectorAll('.hover-bg-light');
            userElements.forEach((element, index) => {
                element.style.opacity = '0';
                element.style.transform = 'translateX(10px)';
                setTimeout(() => {
                    element.style.transition = 'all 0.3s ease';
                    element.style.opacity = '1';
                    element.style.transform = 'translateX(0)';
                }, index * 50);
            });
        }

        // Función para actualizar el conteo en el badge
        function updateActiveUsersCount(count) {
            const badge = document.getElementById('activeUsersBadge');
            if (badge) {
                badge.textContent = count;
                badge.style.display = count > 0 ? 'inline' : 'none';
            }
        }

        // Función para cargar solo el conteo (más rápido)
        function loadActiveUsersCount() {
            fetch('/api/active-users/count/')
                .then(response => response.json())
                .then(data => {
                    updateActiveUsersCount(data.count);
                })
                .catch(error => {
                    console.log('[Barra Lateral] Error al cargar conteo:', error);
                    // Mostrar conteo de ejemplo
                    updateActiveUsersCount(3);
                });
        }

        // Funciones para acciones de usuario
        function openWhatsApp(phone, userName) {
            console.log(`[WhatsApp] Abriendo chat con ${userName} - ${phone}`);
            
            // Limpiar el número de teléfono (quitar espacios y caracteres especiales)
            const cleanPhone = phone.replace(/[\s\-\(\)]/g, '');
            
            // Mensaje predeterminado
            const message = `Hola ${userName}, te escribo desde el sistema TicketProo.`;
            const encodedMessage = encodeURIComponent(message);
            
            // URL de WhatsApp
            const whatsappUrl = `https://wa.me/${cleanPhone}?text=${encodedMessage}`;
            
            // Abrir WhatsApp en nueva pestaña
            window.open(whatsappUrl, '_blank');
        }

        function viewUserProfile(userId, userName) {
            console.log(`[Perfil] Viendo perfil de ${userName} (ID: ${userId})`);
            
            // Crear y mostrar modal con información del usuario
            showUserProfileModal(userId, userName);
        }

        function showUserProfileModal(userId, userName) {
            // Crear modal dinámicamente
            const modalHtml = `
                <div class="modal fade" id="userProfileModal" tabindex="-1" aria-hidden="true">
                    <div class="modal-dialog modal-lg">
                        <div class="modal-content">
                            <div class="modal-header bg-success text-white">
                                <h5 class="modal-title">
                                    <i class="bi bi-person-circle me-2"></i>
                                    Perfil de ${userName}
                                </h5>
                                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                            </div>
                            <div class="modal-body">
                                <div class="text-center py-4">
                                    <div class="spinner-border text-success" role="status">
                                        <span class="visually-hidden">Cargando perfil...</span>
                                    </div>
                                    <p class="mt-2">Cargando información del usuario...</p>
                                </div>
                            </div>
                            <div class="modal-footer">
                                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cerrar</button>
                                <a href="/employee-dashboard/?employee_id=${userId}" class="btn btn-primary" target="_blank">
                                    <i class="bi bi-arrow-up-right-square me-1"></i>
                                    Ver Dashboard Completo
                                </a>
                            </div>
                        </div>
                    </div>
                </div>
            `;
            
            // Eliminar modal existente si existe
            const existingModal = document.getElementById('userProfileModal');
            if (existingModal) {
                existingModal.remove();
            }
            
            // Añadir modal al DOM
            document.body.insertAdjacentHTML('beforeend', modalHtml);
            
            // Mostrar modal
            const modal = new bootstrap.Modal(document.getElementById('userProfileModal'));
            modal.show();
            
            // Simular carga de datos del perfil
            setTimeout(() => {
                loadUserProfileData(userId, userName);
            }, 1000);
        }

        function loadUserProfileData(userId, userName) {
            // Simular datos del perfil (en una implementación real, esto vendría de la API)
            const profileData = {
                name: userName,
                email: 'usuario@empresa.com',
                phone: '+34 600 000 000',
                cargo: 'Desarrollador',
                departamento: 'Tecnología',
                fechaIngreso: '2023-01-15',
                ultimaActividad: 'Hace 5 minutos'
            };
            
            const profileHtml = `
                <div class="row">
                    <div class="col-md-4 text-center">
                        <img src="https://ui-avatars.com/api/?name=${encodeURIComponent(userName)}&background=28a745&color=fff&size=120" 
                             class="rounded-circle mb-3" width="120" height="120">
                        <h5>${profileData.name}</h5>
                        <p class="text-muted">${profileData.cargo}</p>
                    </div>
                    <div class="col-md-8">
                        <h6>Información de Contacto</h6>
                        <div class="mb-3">
                            <div class="d-flex align-items-center mb-2">
                                <i class="bi bi-envelope me-2 text-primary"></i>
                                <a href="mailto:${profileData.email}" class="text-decoration-none">
                                    ${profileData.email}
                                </a>
                            </div>
                            <div class="d-flex align-items-center mb-2">
                                <i class="bi bi-telephone me-2 text-success"></i>
                                <a href="tel:${profileData.phone}" class="text-decoration-none">
                                    ${profileData.phone}
                                </a>
                            </div>
                        </div>
                        
                        <h6>Información Laboral</h6>
                        <div class="mb-3">
                            <div class="d-flex justify-content-between mb-1">
                                <span><strong>Departamento:</strong></span>
                                <span>${profileData.departamento}</span>
                            </div>
                            <div class="d-flex justify-content-between mb-1">
                                <span><strong>Fecha de Ingreso:</strong></span>
                                <span>${profileData.fechaIngreso}</span>
                            </div>
                            <div class="d-flex justify-content-between mb-1">
                                <span><strong>Última Actividad:</strong></span>
                                <span class="text-success">${profileData.ultimaActividad}</span>
                            </div>
                        </div>
                        
                        <div class="d-flex gap-2 mt-3">
                            <button class="btn btn-sm btn-outline-success" 
                                    onclick="openWhatsApp('${profileData.phone}', '${userName}')">
                                <i class="bi bi-whatsapp me-1"></i>
                                WhatsApp
                            </button>
                        </div>
                    </div>
                </div>
            `;
            
            const modalBody = document.querySelector('#userProfileModal .modal-body');
            if (modalBody) {
                modalBody.innerHTML = profileHtml;
            }
        }

        // Variables globales para la calculadora
        let calculatorOpen = false;
        let currentInput = '0';
        let previousInput = '';
        let operator = '';
        let waitingForOperand = false;

        // Función para alternar la calculadora
        function toggleCalculator() {
            const calculator = document.getElementById('calculatorWidget');
            const overlay = document.getElementById('calculatorOverlay');
            const toggle = document.getElementById('calculatorToggle');
            
            if (!calculatorOpen) {
                // Abrir calculadora
                calculator.style.right = '0px';
                overlay.style.display = 'block';
                toggle.style.right = '320px'; // Mover el botón al lado de la calculadora
                calculatorOpen = true;
                
                // Ocultar todos los demás botones flotantes
                hideOtherFloatingButtons(['calculatorToggle']);
            } else {
                // Cerrar calculadora
                closeCalculatorWidget();
            }
        }

        // Función para cerrar la calculadora
        function closeCalculatorWidget() {
            const calculator = document.getElementById('calculatorWidget');
            const overlay = document.getElementById('calculatorOverlay');
            const toggle = document.getElementById('calculatorToggle');
            
            calculator.style.right = '-320px';
            overlay.style.display = 'none';
            toggle.style.right = '0'; // Volver a la posición original
            calculatorOpen = false;
            
            // Mostrar todos los botones flotantes de nuevo
            showAllFloatingButtons();
        }

        // Funciones de la calculadora
        function updateDisplay() {
            const display = document.getElementById('calculatorDisplay');
            display.value = currentInput;
        }

        function appendNumber(number) {
            if (waitingForOperand) {
                currentInput = number;
                waitingForOperand = false;
            } else {
                currentInput = currentInput === '0' ? number : currentInput + number;
            }
            updateDisplay();
        }

        function appendDecimal() {
            if (waitingForOperand) {
                currentInput = '0.';
                waitingForOperand = false;
            } else if (currentInput.indexOf('.') === -1) {
                currentInput += '.';
            }
            updateDisplay();
        }

        function appendOperator(nextOperator) {
            const inputValue = parseFloat(currentInput);

            if (previousInput === '') {
                previousInput = inputValue;
            } else if (operator) {
                const result = performCalculation();
                currentInput = String(result);
                previousInput = result;
                updateDisplay();
            }

            waitingForOperand = true;
            operator = nextOperator;
        }

        function calculate() {
            if (previousInput === '' || operator === '' || waitingForOperand) {
                return;
            }

            const result = performCalculation();
            currentInput = String(result);
            previousInput = '';
            operator = '';
            waitingForOperand = false;
            updateDisplay();
        }

        function performCalculation() {
            const prev = parseFloat(previousInput);
            const current = parseFloat(currentInput);

            switch (operator) {
                case '+':
                    return prev + current;
                case '-':
                    return prev - current;
                case '*':
                    return prev * current;
                case '/':
                    return current !== 0 ? prev / current : 0;
                default:
                    return current;
            }
        }

        function clearCalculator() {
            currentInput = '0';
            previousInput = '';
            operator = '';
            waitingForOperand = false;
            updateDisplay();
        }

        function deleteLast() {
            if (currentInput.length > 1) {
                currentInput = currentInput.slice(0, -1);
            } else {
                currentInput = '0';
            }
            updateDisplay();
        }

        // ============= FUNCIONES QUICK TODO =============
        
        let quickTodoSidebarOpen = false;
        
        window.toggleQuickTodo = function() {
            const sidebar = document.getElementById('quickTodoSidebar');
            const overlay = document.getElementById('quickTodoOverlay');
            
            if (quickTodoSidebarOpen) {
                closeQuickTodo();
            } else {
                openQuickTodo();
            }
        };
        
        function openQuickTodo() {
            const sidebar = document.getElementById('quickTodoSidebar');
            const overlay = document.getElementById('quickTodoOverlay');
            const toggle = document.getElementById('quickTodoToggle');
            
            sidebar.style.right = '0';
            overlay.style.display = 'block';
            toggle.style.right = '450px'; // Mover el botón al lado de la ventana
            quickTodoSidebarOpen = true;
            
            // Ocultar todos los demás botones flotantes
            hideOtherFloatingButtons(['quickTodoToggle']);
            
            // Cargar tareas al abrir
            loadTodos();
        }
        
        function closeQuickTodo() {
            const sidebar = document.getElementById('quickTodoSidebar');
            const overlay = document.getElementById('quickTodoOverlay');
            const toggle = document.getElementById('quickTodoToggle');
            
            sidebar.style.right = '-450px';
            overlay.style.display = 'none';
            toggle.style.right = '0'; // Volver a la posición original
            quickTodoSidebarOpen = false;
            
            // Mostrar todos los botones flotantes de nuevo
            showAllFloatingButtons();
        }
        
        function loadTodos() {
            const loading = document.getElementById('todoLoading');
            const todoList = document.getElementById('todoList');
            
            loading.style.display = 'block';
            
            fetch('/api/quick-todos/', {
                method: 'GET',
                credentials: 'same-origin',
                headers: {
                    'X-Requested-With': 'XMLHttpRequest'
                }
            })
            .then(response => response.json())
            .then(data => {
                loading.style.display = 'none';
                renderTodos(data.todos || []);
                updateTodoStats(data.todos || []);
            })
            .catch(error => {
                console.error('Error cargando tareas:', error);
                loading.style.display = 'none';
                showTodoError('Error al cargar las tareas');
            });
        }
        
        function renderTodos(todos) {
            const todoList = document.getElementById('todoList');
            const loading = document.getElementById('todoLoading');
            
            // Limpiar lista excepto el loading
            const children = Array.from(todoList.children);
            children.forEach(child => {
                if (child.id !== 'todoLoading') {
                    child.remove();
                }
            });
            
            if (todos.length === 0) {
                const emptyMessage = document.createElement('div');
                emptyMessage.className = 'text-center py-4 text-muted';
                emptyMessage.innerHTML = `
                    <i class="bi bi-clipboard-check" style="font-size: 3rem; opacity: 0.3;"></i>
                    <p class="mt-2">No tienes tareas pendientes</p>
                    <small>Agrega una nueva tarea arriba</small>
                `;
                todoList.appendChild(emptyMessage);
                return;
            }
            
            todos.forEach(todo => {
                const todoItem = createTodoElement(todo);
                todoList.appendChild(todoItem);
            });
        }
        
        function createTodoElement(todo) {
            const todoItem = document.createElement('div');
            todoItem.className = `todo-item mb-2 p-3 bg-white rounded shadow-sm border-start border-3 ${todo.completed ? 'border-success' : 'border-secondary'}`;
            todoItem.style.transition = 'all 0.3s ease';
            
            todoItem.innerHTML = `
                <div class="d-flex align-items-start">
                    <div class="form-check me-3">
                        <input class="form-check-input todo-checkbox" type="checkbox" 
                               id="todo-${todo.id}" ${todo.completed ? 'checked' : ''}
                               style="border-radius: 50%; transform: scale(1.2);"
                               onchange="toggleTodo(${todo.id})">
                        <label class="form-check-label" for="todo-${todo.id}"></label>
                    </div>
                    <div class="flex-grow-1">
                        <p class="mb-1 todo-text ${todo.completed ? 'text-decoration-line-through text-muted' : ''}" 
                           style="font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;">
                            ${escapeHtml(todo.text)}
                        </p>
                        <small class="text-muted">
                            <i class="bi bi-clock me-1"></i>
                            ${todo.created_at}
                        </small>
                    </div>
                    <button class="btn btn-sm btn-outline-danger ms-2" 
                            onclick="deleteTodo(${todo.id})" 
                            title="Eliminar tarea">
                        <i class="bi bi-trash"></i>
                    </button>
                </div>
            `;
            
            return todoItem;
        }
        
        function addNewTodo() {
            const input = document.getElementById('newTodoInput');
            const text = input.value.trim();
            
            if (!text) return;
            
            const addButton = document.getElementById('addTodoButton');
            addButton.disabled = true;
            addButton.innerHTML = '<div class="spinner-border spinner-border-sm" role="status"></div>';
            
            fetch('/api/quick-todos/create/', {
                method: 'POST',
                credentials: 'same-origin',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': getCookie('csrftoken'),
                    'X-Requested-With': 'XMLHttpRequest'
                },
                body: JSON.stringify({ text: text })
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    input.value = '';
                    loadTodos(); // Recargar lista
                } else {
                    showTodoError(data.error || 'Error al crear la tarea');
                }
            })
            .catch(error => {
                console.error('Error creando tarea:', error);
                showTodoError('Error al crear la tarea');
            })
            .finally(() => {
                addButton.disabled = false;
                addButton.innerHTML = '<i class="bi bi-plus-lg"></i>';
            });
        }
        
        function toggleTodo(todoId) {
            fetch(`/api/quick-todos/${todoId}/toggle/`, {
                method: 'POST',
                credentials: 'same-origin',
                headers: {
                    'X-CSRFToken': getCookie('csrftoken'),
                    'X-Requested-With': 'XMLHttpRequest'
                }
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    loadTodos(); // Recargar lista para actualizar el estado
                } else {
                    showTodoError('Error al actualizar la tarea');
                    loadTodos(); // Recargar para revertir el checkbox
                }
            })
            .catch(error => {
                console.error('Error actualizando tarea:', error);
                showTodoError('Error al actualizar la tarea');
                loadTodos(); // Recargar para revertir el checkbox
            });
        }
        
        function deleteTodo(todoId) {
            if (!confirm('¿Estás seguro de que quieres eliminar esta tarea?')) {
                return;
            }
            
            fetch(`/api/quick-todos/${todoId}/delete/`, {
                method: 'DELETE',
                credentials: 'same-origin',
                headers: {
                    'X-CSRFToken': getCookie('csrftoken'),
                    'X-Requested-With': 'XMLHttpRequest'
                }
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    loadTodos(); // Recargar lista
                } else {
                    showTodoError('Error al eliminar la tarea');
                }
            })
            .catch(error => {
                console.error('Error eliminando tarea:', error);
                showTodoError('Error al eliminar la tarea');
            });
        }
        
        function clearCompletedTodos() {
            if (!confirm('¿Estás seguro de que quieres eliminar todas las tareas completadas?')) {
                return;
            }
            
            fetch('/api/quick-todos/clear-completed/', {
                method: 'DELETE',
                credentials: 'same-origin',
                headers: {
                    'X-CSRFToken': getCookie('csrftoken'),
                    'X-Requested-With': 'XMLHttpRequest'
                }
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    loadTodos(); // Recargar lista
                    showTodoSuccess(`Se eliminaron ${data.deleted_count} tarea${data.deleted_count !== 1 ? 's' : ''} completada${data.deleted_count !== 1 ? 's' : ''}`);
                } else {
                    showTodoError('Error al limpiar las tareas completadas');
                }
            })
            .catch(error => {
                console.error('Error limpiando tareas completadas:', error);
                showTodoError('Error al limpiar las tareas completadas');
            });
        }
        
        function updateTodoStats(todos) {
            const statsElement = document.getElementById('todoStats');
            const clearButton = document.getElementById('clearCompletedTodos');
            const badge = document.getElementById('pendingTodosBadge');
            
            const total = todos.length;
            const completed = todos.filter(todo => todo.completed).length;
            const pending = total - completed;
            
            // Actualizar badge del botón
            if (badge) {
                badge.textContent = pending || 0;
                
                // Cambiar color del badge según la cantidad
                badge.className = 'position-absolute top-0 start-0 translate-middle badge rounded-pill';
                if (pending === 0) {
                    badge.classList.add('bg-success');
                } else if (pending < 3) {
                    badge.classList.add('bg-warning');
                } else if (pending < 7) {
                    badge.classList.add('bg-warning');
                    badge.style.backgroundColor = '#fd7e14'; // Color naranja
                } else {
                    badge.classList.add('bg-danger');
                }
                badge.style.fontSize = '0.7em';
                badge.style.color = 'white'; // Asegurar texto blanco
                
                // Actualizar el tooltip del botón
                const button = document.getElementById('quickTodoToggle');
                if (button) {
                    let tooltipText = 'Lista de Tareas Rápidas';
                    if (pending > 0) {
                        tooltipText += ` (${pending} pendiente${pending !== 1 ? 's' : ''})`;
                    }
                    button.setAttribute('title', tooltipText);
                }
            }
            
            if (total === 0) {
                statsElement.textContent = 'Sin tareas';
                clearButton.style.display = 'none';
            } else {
                statsElement.textContent = `${total} tarea${total !== 1 ? 's' : ''} (${pending} pendiente${pending !== 1 ? 's' : ''})`;
                clearButton.style.display = completed > 0 ? 'inline-block' : 'none';
            }
        }
        
        function showTodoError(message) {
            // Simple alert por ahora, se puede mejorar con toast
            alert('❌ ' + message);
        }
        
        function showTodoSuccess(message) {
            // Simple alert por ahora, se puede mejorar con toast
            alert('✅ ' + message);
        }
        
        function escapeHtml(unsafe) {
            return unsafe
                .replace(/&/g, "&amp;")
                .replace(/</g, "&lt;")
                .replace(/>/g, "&gt;")
                .replace(/"/g, "&quot;")
                .replace(/'/g, "&#039;");
        }
        
        function loadPendingTodosCount() {
            // Función para cargar solo el contador de tareas pendientes sin abrir la ventana
            fetch('/api/quick-todos/', {
                method: 'GET',
                credentials: 'same-origin',
                headers: {
                    'X-Requested-With': 'XMLHttpRequest'
                }
            })
            .then(response => response.json())
            .then(data => {
                const todos = data.todos || [];
                updateTodoStats(todos);
            })
            .catch(error => {
                console.error('Error cargando contador de tareas:', error);
                // En caso de error, mantener el badge en 0
                const badge = document.getElementById('pendingTodosBadge');
                if (badge) {
                    badge.textContent = '0';
                    badge.className = 'position-absolute top-0 start-0 translate-middle badge rounded-pill bg-secondary';
                    badge.style.fontSize = '0.7em';
                }
            });
        }

        // Funciones de auto-refresh
        function startAutoRefresh() {
            // Refrescar cada 30 segundos
            autoRefreshInterval = setInterval(() => {
                if (activeUsersSidebarOpen) {
                    loadActiveUsersSidebar();
                }
            }, 30000);
        }

        function stopAutoRefresh() {
            if (autoRefreshInterval) {
                clearInterval(autoRefreshInterval);
                autoRefreshInterval = null;
            }
        }

        // Inicialización cuando se carga la página
        document.addEventListener('DOMContentLoaded', function() {
            // Solo si el usuario está autenticado
            if (document.getElementById('activeUsersSidebarToggle')) {
                // Event listeners para usuarios activos
                document.getElementById('activeUsersSidebarToggle').addEventListener('click', toggleActiveUsersSidebar);
                document.getElementById('closeSidebar').addEventListener('click', closeSidebar);
                document.getElementById('sidebarOverlay').addEventListener('click', closeSidebar);
                document.getElementById('refreshActiveUsers').addEventListener('click', loadActiveUsersSidebar);
                
                // Event listeners para calculadora
                document.getElementById('calculatorToggle').addEventListener('click', toggleCalculator);
                document.getElementById('closeCalculator').addEventListener('click', closeCalculatorWidget);
                document.getElementById('calculatorOverlay').addEventListener('click', closeCalculatorWidget);

                // Event listeners para Quick TODO
                document.getElementById('closeQuickTodo').addEventListener('click', closeQuickTodo);
                document.getElementById('quickTodoOverlay').addEventListener('click', closeQuickTodo);
                document.getElementById('addTodoButton').addEventListener('click', addNewTodo);
                document.getElementById('clearCompletedTodos').addEventListener('click', clearCompletedTodos);
                
                // Enter key para agregar todo
                document.getElementById('newTodoInput').addEventListener('keypress', function(e) {
                    if (e.key === 'Enter') {
                        addNewTodo();
                    }
                });

                // Event listeners para Monitor del Sistema
                document.getElementById('closeSystemMonitor').addEventListener('click', closeSystemMonitor);
                document.getElementById('systemMonitorOverlay').addEventListener('click', closeSystemMonitor);
                document.getElementById('refreshSystemInfo').addEventListener('click', () => {
                    updateSystemInfo();
                    showQuickNotification('Información del sistema actualizada', 'success');
                });
                document.getElementById('pauseSystemMonitor').addEventListener('click', function() {
                    systemMonitorPaused = !systemMonitorPaused;
                    const icon = this.querySelector('i');
                    if (systemMonitorPaused) {
                        icon.className = 'bi bi-play-fill';
                        this.classList.remove('btn-outline-warning');
                        this.classList.add('btn-outline-success');
                        showQuickNotification('Monitoreo pausado', 'warning');
                    } else {
                        icon.className = 'bi bi-pause-fill';
                        this.classList.remove('btn-outline-success');
                        this.classList.add('btn-outline-warning');
                        showQuickNotification('Monitoreo reanudado', 'success');
                    }
                });

                // Event listeners para chat IA
                document.getElementById('closeAIChat').addEventListener('click', closeAIChat);
                document.getElementById('aiChatOverlay').addEventListener('click', closeAIChat);
                
                // Cargar conteo inicial
                loadActiveUsersCount();
                loadPendingTodosCount();
                
                // Recargar conteo cada 2 minutos
                setInterval(loadActiveUsersCount, 120000);
                setInterval(loadPendingTodosCount, 120000);
                
                console.log('[Barra Lateral] Sistema de usuarios activos inicializado');
                console.log('[Calculadora] Sistema de calculadora inicializado');
                console.log('[Quick TODO] Sistema de tareas rápidas inicializado');
            }
        });

        // CSS adicional para efectos hover
        const sidebarStyle = document.createElement('style');
        sidebarStyle.textContent = `
            .hover-bg-light:hover {
                background-color: #f8f9fa !important;
                cursor: pointer;
            }
            
            #activeUsersSidebarToggle {
                transition: right 0.3s ease, transform 0.2s ease;
            }
            
            #activeUsersSidebarToggle:hover {
                transform: translateY(-50%) translateX(-5px);
                box-shadow: 0 8px 25px rgba(0,0,0,0.3) !important;
            }
            
            #calculatorToggle {
                transition: right 0.3s ease, transform 0.2s ease;
            }
            
            #calculatorToggle:hover {
                transform: translateY(-50%) translateX(-5px);
                box-shadow: 0 8px 25px rgba(0,0,0,0.3) !important;
            }
            
            /* Estilos para el scroll de la lista de usuarios */
            #activeUsersListSidebar {
                scrollbar-width: thin;
                scrollbar-color: rgba(40, 167, 69, 0.3) transparent;
            }
            
            #activeUsersListSidebar::-webkit-scrollbar {
                width: 6px;
            }
            
            #activeUsersListSidebar::-webkit-scrollbar-track {
                background: transparent;
            }
            
            #activeUsersListSidebar::-webkit-scrollbar-thumb {
                background-color: rgba(40, 167, 69, 0.3);
                border-radius: 3px;
                transition: background-color 0.2s ease;
            }
            
            #activeUsersListSidebar::-webkit-scrollbar-thumb:hover {
                background-color: rgba(40, 167, 69, 0.5);
            }
            
            /* Animación suave para los elementos de usuario */
            .hover-bg-light {
                transition: all 0.2s ease;
            }
            
            /* Efecto de sombra para los elementos al hacer hover */
            .hover-bg-light:hover {
                box-shadow: 0 2px 8px rgba(0,0,0,0.1);
                transform: translateY(-1px);
            }
            
            /* Estilos para la calculadora */
            .calc-btn {
                height: 50px;
                font-size: 1.1rem;
                font-weight: 500;
                transition: all 0.2s ease;
                border-radius: 6px !important;
            }
            
            .calc-btn:hover {
                transform: translateY(-1px);
                box-shadow: 0 4px 12px rgba(0,0,0,0.15);
            }
            
            .calc-btn:active {
                transform: translateY(0);
                box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            }
            
            /* Botones de números */
            .btn-outline-dark.calc-btn:hover {
                background-color: #343a40;
                border-color: #343a40;
                color: white;
            }
            
            /* Botones de operadores */
            .btn-outline-warning.calc-btn:hover {
                background-color: #ffc107;
                border-color: #ffc107;
                color: #212529;
            }
            
            /* Botón igual */
            .btn-primary.calc-btn:hover {
                background-color: #0056b3;
                border-color: #0056b3;
            }
        `;
        document.head.appendChild(sidebarStyle);
        
        // ===== SISTEMA DE CONTEO DE TICKETS ABIERTOS =====
        
        // Función para cargar el conteo de tickets abiertos
        function loadOpenTicketsCount() {
            console.log('🎫 Cargando conteo de tickets abiertos...');
            
            fetch('/api/open-tickets/count/', {
                method: 'GET',
                credentials: 'same-origin',  // Incluir cookies de sesión
                headers: {
                    'X-Requested-With': 'XMLHttpRequest',
                    'Content-Type': 'application/json',
                }
            })
            .then(response => {
                if (!response.ok) {
                    throw new Error('Error en la respuesta del servidor');
                }
                return response.json();
            })
            .then(data => {
                console.log('📊 Datos de tickets recibidos:', data);
                
                const badge = document.getElementById('openTicketsBadge');
                if (badge) {
                    badge.textContent = data.count || 0;
                    
                    // Actualizar el tooltip del botón
                    const button = document.getElementById('createTicketToggle');
                    if (button) {
                        const isAgent = data.is_agent;
                        const userCompany = data.user_company;
                        let tooltipText = 'Crear Ticket de Soporte';
                        
                        if (isAgent) {
                            tooltipText += ` (${data.count} abiertos en total)`;
                        } else if (userCompany) {
                            tooltipText += ` (${data.count} abiertos en ${userCompany})`;
                        } else {
                            tooltipText += ` (${data.count} abiertos)`;
                        }
                        
                        button.setAttribute('title', tooltipText);
                    }
                    
                    // Cambiar color del badge según la cantidad
                    badge.className = 'position-absolute top-0 start-0 translate-middle badge rounded-pill';
                    if (data.count === 0) {
                        badge.classList.add('bg-success');
                    } else if (data.count < 5) {
                        badge.classList.add('bg-warning');
                    } else if (data.count < 10) {
                        badge.classList.add('bg-orange');
                    } else {
                        badge.classList.add('bg-danger');
                    }
                    badge.style.fontSize = '0.7em';
                    
                    console.log(`✅ Conteo actualizado: ${data.count} tickets abiertos`);
                } else {
                    console.error('❌ Badge de tickets no encontrado');
                }
            })
            .catch(error => {
                console.error('❌ Error al cargar conteo de tickets:', error);
                
                const badge = document.getElementById('openTicketsBadge');
                if (badge) {
                    badge.textContent = '?';
                    badge.className = 'position-absolute top-0 start-0 translate-middle badge rounded-pill bg-secondary';
                    badge.style.fontSize = '0.7em';
                }
            });
        }
        
        // Auto-actualizar conteo de tickets cada 30 segundos
        setInterval(loadOpenTicketsCount, 30000);
        
        // Cargar conteo inicial
        setTimeout(loadOpenTicketsCount, 1000);
    </script>
    {% endif %}
</body>
</html>
