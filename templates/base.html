{% load django_bootstrap5 %}
{% load static %}
{% load project_extras %}
<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    
    <!-- Título dinámico con nombre del usuario -->
    <title>{% block title %}{% if user.is_authenticated %}{{ user.first_name|default:user.username }} - TicketProo{% else %}TicketProo - Sistema de Gestión de Tickets{% endif %}{% endblock %}</title>
    
    <!-- Favicon dinámico -->
    <link rel="icon" id="favicon" href="" type="image/svg+xml">
    
    {% bootstrap_css %}
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.0/font/bootstrap-icons.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link rel="stylesheet" href="{% static 'css/style.css' %}">
</head>
<body class="bg-light">
    {% if user.is_authenticated %}
            {% if is_working %}
                <!-- Navbar verde cuando está trabajando -->
                <nav class="navbar navbar-expand-lg navbar-dark bg-success">
            {% else %}
                <!-- Navbar normal cuando no está trabajando -->
                <nav class="navbar navbar-expand-lg navbar-dark bg-dark">
            {% endif %}
            <div class="container">
                <a class="navbar-brand fw-bold" href="{% url 'home' %}">
                    <i class="bi bi-ticket-perforated"></i> TicketProo
                </a>
            
            <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav">
                <span class="navbar-toggler-icon"></span>
            </button>
            
            <div class="collapse navbar-collapse" id="navbarNav">
                <ul class="navbar-nav me-auto">
                    <li class="nav-item">
                        <a class="nav-link {% if request.resolver_match.url_name == 'dashboard' %}active{% endif %}" 
                           href="{% url 'dashboard' %}">
                            <i class="bi bi-house-door"></i>
                        </a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link {% if request.resolver_match.url_name == 'ticket_list' %}active{% endif %}" 
                           href="{% url 'ticket_list' %}">
                            <i class="bi bi-list-ul"></i> 
                            {% if user.groups.all and user.groups.first.name == 'Agentes' %}
                                Todos
                            {% else %}
                                Mis Tickets
                            {% endif %}
                        </a>
                    </li>
                    <!--
                    <li class="nav-item">
                        <a class="nav-link {% if request.resolver_match.url_name == 'ticket_create' %}active{% endif %}" 
                           href="{% url 'ticket_create' %}">
                            <i class="bi bi-plus-circle"></i>
                        </a>
                    </li>
                    -->
                    
                    <!-- Menú de Chat -->
                    <li class="nav-item dropdown">
                        <a class="nav-link dropdown-toggle {% if 'chat' in request.resolver_match.url_name or 'ai_chat' in request.resolver_match.url_name %}active{% endif %}" 
                           href="#" id="navbarDropdownChat" role="button" data-bs-toggle="dropdown">
                            <i class="bi bi-chat-dots"></i>
                        </a>
                        <ul class="dropdown-menu">
                            <li>
                                <a class="dropdown-item {% if 'chat' in request.resolver_match.url_name and 'ai_chat' not in request.resolver_match.url_name %}active{% endif %}" 
                                   href="{% url 'chat_list' %}">
                                    <i class="bi bi-people"></i> Chat de Usuarios
                                </a>
                            </li>
                            <li>
                                <a class="dropdown-item {% if 'ai_chat' in request.resolver_match.url_name %}active{% endif %}" 
                                   href="{% url 'ai_chat_list' %}">
                                    <i class="bi bi-robot"></i> Chat con IA
                                </a>
                            </li>
                        </ul>
                    </li>
                    
                    <!-- Menú de Empleado - Solo para Agentes y Administradores -->
                    {% if user.is_authenticated %}
                        {% if user.is_staff or user.is_superuser or user.groups.all and user.groups.first.name == 'Agentes' %}
                    <li class="nav-item dropdown">
                        <a class="nav-link dropdown-toggle {% if 'employee_request' in request.resolver_match.url_name or 'ai_manager' in request.resolver_match.url_name or 'employee_dashboard' in request.resolver_match.url_name or 'internal_agreement' in request.resolver_match.url_name or 'training_plan' in request.resolver_match.url_name or 'my_training_progress' in request.resolver_match.url_name or 'ai_recommendation' in request.resolver_match.url_name or 'employee_absence' in request.resolver_match.url_name or 'absence_type' in request.resolver_match.url_name or 'company_protocol' in request.resolver_match.url_name or 'ai_tutor' in request.resolver_match.url_name or 'video_meeting' in request.resolver_match.url_name or 'expense_report' in request.resolver_match.url_name %}active{% endif %}" 
                           href="#" id="navbarDropdownEmployee" role="button" data-bs-toggle="dropdown">
                            <i class="bi bi-person-badge"></i> Empleado
                        </a>
                        <ul class="dropdown-menu">
                            <li>
                                <a class="dropdown-item {% if request.resolver_match.url_name == 'employee_dashboard' %}active{% endif %}" 
                                   href="{% url 'employee_dashboard' %}">
                                    <i class="bi bi-speedometer2"></i> Dashboard de Empleado
                                </a>
                            </li>
                            <li><hr class="dropdown-divider"></li>
                            <li>
                                <a class="dropdown-item {% if request.resolver_match.url_name == 'employee_request_list' %}active{% endif %}" 
                                   href="{% url 'employee_request_list' %}">
                                    <i class="bi bi-file-earmark-text"></i> Solicitudes de Empleados
                                </a>
                            </li>
                            <li>
                                <a class="dropdown-item {% if request.resolver_match.url_name == 'employee_request_create' %}active{% endif %}" 
                                   href="{% url 'employee_request_create' %}">
                                    <i class="bi bi-plus-circle"></i> Nueva Solicitud
                                </a>
                            </li>
                            <li><hr class="dropdown-divider"></li>
                            <li>
                                <a class="dropdown-item {% if 'expense_report' in request.resolver_match.url_name %}active{% endif %}" 
                                   href="{% url 'expense_report_list' %}">
                                    <i class="bi bi-receipt"></i> Rendición de Gastos
                                </a>
                            </li>
                            <li>
                                <a class="dropdown-item {% if 'video_meeting' in request.resolver_match.url_name %}active{% endif %}" 
                                   href="{% url 'video_meeting_list' %}">
                                    <i class="bi bi-camera-video"></i> Reuniones de Video
                                </a>
                            </li>
                            <li>
                                <a class="dropdown-item {% if 'quote_generator' in request.resolver_match.url_name %}active{% endif %}" 
                                   href="{% url 'quote_generator_list' %}">
                                    <i class="bi bi-chat-quote"></i> Generador de Citas IA
                                </a>
                            </li>
                            <li>
                                <a class="dropdown-item {% if 'ai_manager' in request.resolver_match.url_name %}active{% endif %}" 
                                   href="{% url 'ai_manager_list' %}">
                                    <i class="bi bi-robot"></i> AI Managers
                                </a>
                            </li>
                            <li><hr class="dropdown-divider"></li>
                            <li>
                                <a class="dropdown-item {% if 'internal_agreement' in request.resolver_match.url_name %}active{% endif %}" 
                                   href="{% url 'internal_agreement_list' %}">
                                    <i class="bi bi-file-earmark-check"></i> Acuerdos Internos
                                </a>
                            </li>
                            <li>
                                <a class="dropdown-item {% if request.resolver_match.url_name == 'internal_agreement_create' %}active{% endif %}" 
                                   href="{% url 'internal_agreement_create' %}">
                                    <i class="bi bi-plus-circle"></i> Nuevo Acuerdo
                                </a>
                            </li>
                            <li><hr class="dropdown-divider"></li>
                            <li>
                                <a class="dropdown-item {% if 'training_plan' in request.resolver_match.url_name %}active{% endif %}" 
                                   href="{% url 'training_plan_list' %}">
                                    <i class="bi bi-mortarboard"></i> Planes de Capacitación
                                </a>
                            </li>
                            <li>
                                <a class="dropdown-item {% if request.resolver_match.url_name == 'my_training_progress' %}active{% endif %}" 
                                   href="{% url 'my_training_progress' %}">
                                    <i class="bi bi-graph-up"></i> Mi Progreso
                                </a>
                            </li>
                            <li><hr class="dropdown-divider"></li>
                            <li>
                                <a class="dropdown-item {% if 'ai_recommendation' in request.resolver_match.url_name %}active{% endif %}" 
                                   href="{% url 'ai_recommendation_list' %}">
                                    <i class="bi bi-lightbulb"></i> Recomendaciones IA
                                </a>
                            </li>
                            <li><hr class="dropdown-divider"></li>
                            <li>
                                <a class="dropdown-item {% if 'employee_absence' in request.resolver_match.url_name %}active{% endif %}" 
                                   href="{% url 'employee_absence_list' %}">
                                    <i class="bi bi-calendar-x"></i> Gestión de Ausencias
                                </a>
                            </li>
                            <li>
                                <a class="dropdown-item {% if request.resolver_match.url_name == 'employee_absence_calendar' %}active{% endif %}" 
                                   href="{% url 'employee_absence_calendar' %}">
                                    <i class="bi bi-calendar3"></i> Calendario de Ausencias
                                </a>
                            </li>
                            <li>
                                <a class="dropdown-item {% if 'absence_type' in request.resolver_match.url_name %}active{% endif %}" 
                                   href="{% url 'absence_type_list' %}">
                                    <i class="bi bi-gear"></i> Tipos de Ausencias
                                </a>
                            </li>
                            <li><hr class="dropdown-divider"></li>
                            
                            <li>
                                <a class="dropdown-item {% if 'asset' in request.resolver_match.url_name %}active{% endif %}" 
                                   href="{% url 'asset_list' %}">
                                    <i class="bi bi-laptop"></i> Control de Activos
                                </a>
                            </li>

                            <li>
                                <a class="dropdown-item {% if 'ai_tutor' in request.resolver_match.url_name %}active{% endif %}" 
                                   href="{% url 'ai_tutor_list' %}">
                                    <i class="fas fa-robot"></i> Tutor IA
                                </a>
                            </li>

                            <li><hr class="dropdown-divider"></li>
                            
                            <li>
                                <a class="dropdown-item {% if 'company_protocol' in request.resolver_match.url_name %}active{% endif %}" 
                                   href="{% url 'company_protocol_list' %}">
                                    <i class="bi bi-file-text"></i> Protocolos Empresa
                                </a>
                            </li>
                            <li>
                                <a class="dropdown-item {% if request.resolver_match.url_name == 'company_protocol_create' %}active{% endif %}" 
                                   href="{% url 'company_protocol_create' %}">
                                    <i class="bi bi-plus-circle"></i> Nuevo Protocolo
                                </a>
                            </li>
                        </ul>
                    </li>
                        {% endif %}
                    {% endif %}
                    
                    <!-- Menú de Capacitación -->
                    {% if user.is_authenticated %}
                    <li class="nav-item dropdown">
                        <a class="nav-link dropdown-toggle {% if 'course' in request.resolver_match.url_name or 'exam' in request.resolver_match.url_name %}active{% endif %}" 
                           href="#" id="navbarDropdownTraining" role="button" data-bs-toggle="dropdown">
                            <i class="bi bi-book"></i> Capacitación
                        </a>
                        <ul class="dropdown-menu">
                            <li>
                                <a class="dropdown-item {% if request.resolver_match.url_name == 'course_list' %}active{% endif %}" 
                                   href="{% url 'course_list' %}">
                                    <i class="bi bi-collection"></i> Cursos
                                </a>
                            </li>
                            <li>
                                <a class="dropdown-item {% if request.resolver_match.url_name == 'exam_list' %}active{% endif %}" 
                                   href="{% url 'exam_list' %}">
                                    <i class="bi bi-question-circle"></i> Exámenes
                                </a>
                            </li>
                            <li>
                                <a class="dropdown-item {% if request.resolver_match.url_name == 'qr_generator' %}active{% endif %}" 
                                   href="{% url 'qr_generator' %}">
                                    <i class="bi bi-qr-code"></i> Generador QR
                                </a>
                            </li>
                            
                            <!-- Opciones adicionales para Agentes y Profesores -->
                            {% if user|can_manage_courses %}
                            <li><hr class="dropdown-divider"></li>
                            <li class="dropdown-header">
                                Gestión 
                                {% if user.groups.all %}
                                    ({{ user.groups.first.name }})
                                {% endif %}
                            </li>
                            <li>
                                <a class="dropdown-item {% if request.resolver_match.url_name == 'course_create' %}active{% endif %}" 
                                   href="{% url 'course_create' %}">
                                    <i class="bi bi-plus-circle"></i> Crear Curso
                                </a>
                            </li>
                            <li>
                                <a class="dropdown-item {% if request.resolver_match.url_name == 'exam_create' %}active{% endif %}" 
                                   href="{% url 'exam_create' %}">
                                    <i class="bi bi-plus-circle"></i> Crear Examen
                                </a>
                            </li>
                            {% if user.groups.all and user.groups.first.name == 'Agentes' %}
                            <li>
                                <a class="dropdown-item {% if request.resolver_match.url_name == 'exam_attempts_list' %}active{% endif %}" 
                                   href="{% url 'exam_attempts_list' %}">
                                    <i class="bi bi-clipboard-data"></i> Intentos de Exámenes
                                </a>
                            </li>
                            {% endif %}
                            {% endif %}
                        </ul>
                    </li>
                    {% endif %}
                    
                    <!-- Menú de Compartir Archivos - Solo para Agentes y Administradores -->
                    {% if user.is_authenticated %}
                        {% if user.is_staff or user.is_superuser or user.groups.all and user.groups.first.name == 'Agentes' %}
                    <li class="nav-item dropdown">
                        <a class="nav-link dropdown-toggle {% if 'shared_file' in request.resolver_match.url_name or 'form' in request.resolver_match.url_name %}active{% endif %}" 
                           href="#" id="navbarDropdownFiles" role="button" data-bs-toggle="dropdown">
                            <i class="bi bi-folder-symlink"></i> Comp.
                        </a>
                        <ul class="dropdown-menu">
                            <li class="dropdown-header">Archivos</li>
                            <li>
                                <a class="dropdown-item {% if request.resolver_match.url_name == 'shared_files_list' %}active{% endif %}" 
                                   href="{% url 'shared_files_list' %}">
                                    <i class="bi bi-files"></i> Mis Archivos
                                </a>
                            </li>
                            <li>
                                <a class="dropdown-item {% if request.resolver_match.url_name == 'shared_file_upload' %}active{% endif %}" 
                                   href="{% url 'shared_file_upload' %}">
                                    <i class="bi bi-cloud-upload"></i> Subir Archivo
                                </a>
                            </li>
                            <li><hr class="dropdown-divider"></li>
                            <li class="dropdown-header">Grabaciones</li>
                            <li>
                                <a class="dropdown-item {% if request.resolver_match.url_name == 'recordings_list' %}active{% endif %}" 
                                   href="{% url 'recordings_list' %}">
                                    <i class="bi bi-mic"></i> Mis Grabaciones
                                </a>
                            </li>
                            <li>
                                <a class="dropdown-item {% if request.resolver_match.url_name == 'recording_upload' %}active{% endif %}" 
                                   href="{% url 'recording_upload' %}">
                                    <i class="bi bi-mic-fill"></i> Subir Grabación
                                </a>
                            </li>
                            <li><hr class="dropdown-divider"></li>
                            <li class="dropdown-header">Formularios y Encuestas</li>
                            <li>
                                <a class="dropdown-item {% if request.resolver_match.url_name == 'form_list' %}active{% endif %}" 
                                   href="{% url 'form_list' %}">
                                    <i class="bi bi-list-ul"></i> Ver Formularios
                                </a>
                            </li>
                            <li>
                                <a class="dropdown-item {% if request.resolver_match.url_name == 'form_create' %}active{% endif %}" 
                                   href="{% url 'form_create' %}">
                                    <i class="bi bi-plus-circle"></i> Crear Formulario
                                </a>
                            </li>
                            <li><hr class="dropdown-divider"></li>
                            <li class="dropdown-header">Alcances</li>
                            <li>
                                <a class="dropdown-item {% if request.resolver_match.url_name == 'alcance_list' %}active{% endif %}" 
                                   href="{% url 'alcance_list' %}">
                                    <i class="bi bi-bullseye"></i> Ver Alcances
                                </a>
                            </li>
                            <li>
                                <a class="dropdown-item {% if request.resolver_match.url_name == 'alcance_create' %}active{% endif %}" 
                                   href="{% url 'alcance_create' %}">
                                    <i class="bi bi-plus-circle"></i> Crear Alcance
                                </a>
                            </li>
                            <li><hr class="dropdown-divider"></li>
                            <li class="dropdown-header">IA - Image to Prompt</li>
                            <li>
                                <a class="dropdown-item {% if request.resolver_match.url_name == 'image_prompt_list' %}active{% endif %}" 
                                   href="{% url 'image_prompt_list' %}">
                                    <i class="bi bi-list-task"></i> Mis Prompts
                                </a>
                            </li>
                            <li>
                                <a class="dropdown-item {% if request.resolver_match.url_name == 'image_prompt_create' %}active{% endif %}" 
                                   href="{% url 'image_prompt_create' %}">
                                    <i class="bi bi-image"></i> Generar Prompt desde Imagen
                                </a>
                            </li>
                            <li><hr class="dropdown-divider"></li>
                            <li class="dropdown-header">Gerentes IA</li>
                            <li>
                                <a class="dropdown-item {% if 'company_ai_dashboard' in request.resolver_match.url_name %}active{% endif %}" 
                                   href="{% url 'company_ai_dashboard_list' %}">
                                    <i class="bi bi-building"></i> Dashboard Empresarial
                                </a>
                            </li>
                            <li>
                                <a class="dropdown-item {% if 'user_ai_performance' in request.resolver_match.url_name %}active{% endif %}" 
                                   href="{% url 'user_ai_performance_dashboard' %}">
                                    <i class="bi bi-person-check"></i> Desempeño de Usuarios
                                </a>
                            </li>
                            <li>
                                <a class="dropdown-item {% if request.resolver_match.url_name == 'ai_manager_list' %}active{% endif %}" 
                                   href="{% url 'ai_manager_list' %}">
                                    <i class="bi bi-robot"></i> Ver Gerentes IA
                                </a>
                            </li>
                            <li>
                                <a class="dropdown-item {% if request.resolver_match.url_name == 'ai_manager_create' %}active{% endif %}" 
                                   href="{% url 'ai_manager_create' %}">
                                    <i class="bi bi-plus-circle"></i> Crear Gerente IA
                                </a>
                            </li>
                            <li><hr class="dropdown-divider"></li>
                            <li class="dropdown-header">WhatsApp</li>
                            <li>
                                <a class="dropdown-item {% if 'whatsapp' in request.resolver_match.url_name %}active{% endif %}" 
                                   href="{% url 'whatsapp_dashboard' %}">
                                    <i class="fab fa-whatsapp"></i> Dashboard
                                </a>
                            </li>
                            <li>
                                <a class="dropdown-item {% if request.resolver_match.url_name == 'whatsapp_keyword_create' %}active{% endif %}" 
                                   href="{% url 'whatsapp_keyword_create' %}">
                                    <i class="bi bi-plus-circle"></i> Nueva Palabra Clave
                                </a>
                            </li>
                            <li>
                                <a class="dropdown-item {% if request.resolver_match.url_name == 'whatsapp_messages' %}active{% endif %}" 
                                   href="{% url 'whatsapp_messages' %}">
                                    <i class="bi bi-chat-dots"></i> Mensajes
                                </a>
                            </li>
                            <li><hr class="dropdown-divider"></li>
                            <li class="dropdown-header">Acceso Público</li>
                            <li>
                                <a class="dropdown-item {% if request.resolver_match.url_name == 'public_file_upload' %}active{% endif %}" 
                                   href="{% url 'public_file_upload' %}" target="_blank">
                                    <i class="bi bi-globe"></i> Subir Archivo Público
                                </a>
                            </li>
                            <li>
                                <a class="dropdown-item {% if request.resolver_match.url_name == 'public_recording_upload' %}active{% endif %}" 
                                   href="{% url 'public_recording_upload' %}" target="_blank">
                                    <i class="bi bi-broadcast"></i> Subir Grabación Pública
                                </a>
                            </li>
                            <!-- Opciones adicionales para Agentes -->
                            {% if user.groups.all and user.groups.first.name == 'Agentes' %}
                            <li><hr class="dropdown-divider"></li>
                            <li class="dropdown-header">Administración</li>
                            <li>
                                <a class="dropdown-item {% if request.resolver_match.url_name == 'shared_files_stats' %}active{% endif %}" 
                                   href="{% url 'shared_files_stats' %}">
                                    <i class="bi bi-bar-chart"></i> Estadísticas Archivos
                                </a>
                            </li>
                            <li>
                                <a class="dropdown-item {% if request.resolver_match.url_name == 'recordings_stats' %}active{% endif %}" 
                                   href="{% url 'recordings_stats' %}">
                                    <i class="bi bi-graph-up"></i> Estadísticas Grabaciones
                                </a>
                            </li>
                            {% endif %}
                        </ul>
                    </li>
                        {% endif %}
                    {% endif %}
                    
                    <!-- Menú de Formularios -->
                    
                    
                    <!-- Menú de gestión para agentes -->
                    {% if user.groups.all and user.groups.first.name == 'Agentes' %}
                    <li class="nav-item dropdown">
                        <a class="nav-link dropdown-toggle {% if 'user' in request.resolver_match.url_name or 'category' in request.resolver_match.url_name or 'blog' in request.resolver_match.url_name %}active{% endif %}" 
                           href="#" id="navbarDropdownManagement" role="button" data-bs-toggle="dropdown">
                            <i class="bi bi-gear"></i> Gestión
                        </a>
                        <ul class="dropdown-menu">
                            <li>
                                <a class="dropdown-item {% if 'notes' in request.resolver_match.url_name %}active{% endif %}" 
                                   href="{% url 'notes_list' %}">
                                    <i class="bi bi-journal-text"></i> Notas Internas
                                </a>
                            </li>
                            <li>
                                <a class="dropdown-item {% if 'category' in request.resolver_match.url_name %}active{% endif %}" 
                                   href="{% url 'category_list' %}">
                                    <i class="bi bi-tags"></i> Categorías
                                </a>
                            </li>
                            <li>
                                <a class="dropdown-item {% if 'project' in request.resolver_match.url_name %}active{% endif %}" 
                                   href="{% url 'project_list' %}">
                                    <i class="bi bi-folder"></i> Proyectos
                                </a>
                            </li>
                            <li>
                                <a class="dropdown-item {% if 'product' in request.resolver_match.url_name %}active{% endif %}" 
                                   href="{% url 'product_list' %}">
                                    <i class="bi bi-box-seam"></i> Productos
                                </a>
                            </li>
                            <li>
                                <a class="dropdown-item {% if 'company' in request.resolver_match.url_name %}active{% endif %}" 
                                   href="{% url 'company_list' %}">
                                    <i class="bi bi-building"></i> Empresas
                                </a>
                            </li>
                            <li>
                                <a class="dropdown-item {% if 'contacto_web' in request.resolver_match.url_name %}active{% endif %}" 
                                   href="{% url 'contactos_web_list' %}">
                                    <i class="bi bi-envelope-plus"></i> Contactos Web
                                </a>
                            </li>
                            <li>
                                <a class="dropdown-item {% if 'landing_page' in request.resolver_match.url_name %}active{% endif %}" 
                                   href="{% url 'landing_page_list' %}">
                                    <i class="fas fa-rocket"></i> Landing Pages
                                </a>
                            </li>
                            <li>
                                <a class="dropdown-item {% if 'landing_submissions' in request.resolver_match.url_name or 'ai_evaluation' in request.resolver_match.url_name %}active{% endif %}" 
                                   href="{% url 'landing_submissions_list' %}">
                                    <i class="fas fa-robot text-primary"></i> Evaluación IA
                                </a>
                            </li>
                            <li><hr class="dropdown-divider"></li>
                            <li>
                                <a class="dropdown-item {% if 'contact' in request.resolver_match.url_name %}active{% endif %}" 
                                   href="{% url 'contact_list' %}">
                                    <i class="bi bi-person-lines-fill"></i> Contactos
                                </a>
                            </li>
                            <li>
                                <a class="dropdown-item {% if 'crm' in request.resolver_match.url_name or 'opportunity' in request.resolver_match.url_name %}active{% endif %}" 
                                   href="{% url 'crm_dashboard' %}">
                                    <i class="bi bi-graph-up-arrow"></i> CRM
                                </a>
                            </li>
                            <li>
                                <a class="dropdown-item {% if 'my_activities' in request.resolver_match.url_name %}active{% endif %}" 
                                   href="{% url 'my_activities_dashboard' %}">
                                    <i class="fas fa-tasks"></i> Mis Actividades
                                </a>
                            </li>
                            <li>
                                <a class="dropdown-item {% if 'opportunity_status' in request.resolver_match.url_name %}active{% endif %}" 
                                   href="{% url 'opportunity_status_list' %}">
                                    <i class="bi bi-kanban"></i> Estados CRM
                                </a>
                            </li>
                            <li>
                                <a class="dropdown-item {% if 'meeting' in request.resolver_match.url_name %}active{% endif %}" 
                                   href="{% url 'meeting_list' %}">
                                    <i class="bi bi-calendar-event"></i> Reuniones
                                </a>
                            </li>
                            <li><hr class="dropdown-divider"></li>
                            <li>
                                <a class="dropdown-item {% if 'contact_submission' in request.resolver_match.url_name %}active{% endif %}" 
                                   href="{% url 'contact_submissions_list' %}">
                                    <i class="bi bi-envelope-paper"></i> Formularios de Contacto
                                </a>
                            </li>
                            <li><hr class="dropdown-divider"></li>
                            <li class="dropdown-header">Blog</li>
                            <li>
                                <a class="dropdown-item {% if request.resolver_match.url_name == 'blog_post_list_admin' %}active{% endif %}" 
                                   href="{% url 'blog_post_list_admin' %}">
                                    <i class="bi bi-newspaper"></i> Gestionar Blog
                                </a>
                            </li>
                            <li>
                                <a class="dropdown-item {% if request.resolver_match.url_name == 'blog_post_create' %}active{% endif %}" 
                                   href="{% url 'blog_post_create' %}">
                                    <i class="bi bi-plus-circle"></i> Nuevo Artículo
                                </a>
                            </li>
                            <li>
                                <a class="dropdown-item {% if request.resolver_match.url_name == 'blog_category_list' %}active{% endif %}" 
                                   href="{% url 'blog_category_list' %}">
                                    <i class="bi bi-tags"></i> Categorías
                                </a>
                            </li>
                            <li><hr class="dropdown-divider"></li>
                            <li>
                                <a class="dropdown-item {% if request.resolver_match.url_name in 'task_list,task_create,task_detail,task_edit,task_delete,task_toggle_status,task_control_dashboard,task_control_complete,task_control_start,task_control_pause' %}active{% endif %}" 
                                   href="{% url 'task_list' %}">
                                    <i class="bi bi-list-task"></i> Tareas
                                </a>
                            </li>
                            <li>
                                <a class="dropdown-item {% if request.resolver_match.url_name in 'daily_task_management,create_task_session,view_task_session,delete_task_session,toggle_daily_task_completion,daily_task_history' %}active{% endif %}" 
                                   href="{% url 'daily_task_management' %}">
                                    <i class="bi bi-journal-check"></i> Gestiones de Tareas
                                </a>
                            </li>
                            <li><hr class="dropdown-divider"></li>
                            <li>
                                <a class="dropdown-item {% if 'work_order' in request.resolver_match.url_name %}active{% endif %}" 
                                   href="{% url 'work_order_list' %}">
                                    <i class="bi bi-clipboard-check"></i> Órdenes de Trabajo
                                </a>
                            </li>
                            <li><hr class="dropdown-divider"></li>
                            <li class="dropdown-header">Conceptos</li>
                            <li>
                                <a class="dropdown-item {% if 'concept' in request.resolver_match.url_name %}active{% endif %}" 
                                   href="{% url 'concept_list' %}">
                                    <i class="bi bi-lightbulb"></i> Gestionar Conceptos
                                </a>
                            </li>
                            <li>
                                <a class="dropdown-item {% if request.resolver_match.url_name == 'concept_create' %}active{% endif %}" 
                                   href="{% url 'concept_create' %}">
                                    <i class="bi bi-plus-circle"></i> Nuevo Concepto
                                </a>
                            </li>
                        </ul>
                    </li>
                    
                    <!-- Menú QA - Quejas y Sugerencias (Solo para Agentes) -->
                    <li class="nav-item dropdown">
                        <a class="nav-link dropdown-toggle {% if 'qa_' in request.resolver_match.url_name %}active{% endif %}" 
                           href="#" id="navbarDropdownQA" role="button" data-bs-toggle="dropdown">
                            <i class="fas fa-comments"></i> QA
                        </a>
                        <ul class="dropdown-menu">
                            <li class="dropdown-header">Control de Calidad</li>
                            
                            <li>
                                <a class="dropdown-item {% if request.resolver_match.url_name == 'qa_complaint_list' %}active{% endif %}" 
                                   href="{% url 'qa_complaint_list' %}">
                                    <i class="fas fa-list"></i> Gestionar Reportes
                                </a>
                            </li>
                            <li>
                                <a class="dropdown-item {% if request.resolver_match.url_name == 'qa_complaint_create' %}active{% endif %}" 
                                   href="{% url 'qa_complaint_create' %}">
                                    <i class="fas fa-plus-circle"></i> Nuevo Reporte QA
                                </a>
                            </li>
                            <li><hr class="dropdown-divider"></li>
                            <li class="dropdown-header">Cumplimiento</li>
                            <li>
                                <a class="dropdown-item {% if 'monthly_cumplimiento' in request.resolver_match.url_name %}active{% endif %}" 
                                   href="{% url 'monthly_cumplimiento_list' %}">
                                    <i class="fas fa-calendar-check"></i> Cumplimiento Mensual
                                </a>
                            </li>
                            <li><hr class="dropdown-divider"></li>
                            <li class="dropdown-header">Filtros Rápidos</li>
                            <li>
                                <a class="dropdown-item" href="{% url 'qa_complaint_list' %}?status=open">
                                    <i class="fas fa-exclamation-circle text-danger"></i> Reportes Abiertos
                                </a>
                            </li>
                            <li>
                                <a class="dropdown-item" href="{% url 'qa_complaint_list' %}?assigned=me">
                                    <i class="fas fa-user-check text-primary"></i> Mis Asignaciones
                                </a>
                            </li>
                            <li>
                                <a class="dropdown-item" href="{% url 'qa_complaint_list' %}?priority=critical">
                                    <i class="fas fa-exclamation-triangle text-danger"></i> Prioridad Crítica
                                </a>
                            </li>
                            <li>
                                <a class="dropdown-item" href="{% url 'qa_complaint_list' %}?type=complaint">
                                    <i class="fas fa-frown text-warning"></i> Solo Quejas
                                </a>
                            </li>
                            <li>
                                <a class="dropdown-item" href="{% url 'qa_complaint_list' %}?type=suggestion">
                                    <i class="fas fa-lightbulb text-info"></i> Solo Sugerencias
                                </a>
                            </li>
                        </ul>
                    </li>
                    
                    <!-- Menú Herramientas (Solo para Agentes) -->
                    <li class="nav-item dropdown">
                        <a class="nav-link dropdown-toggle" href="#" id="toolsDropdown" role="button" data-bs-toggle="dropdown" aria-expanded="false">
                            <i class="bi bi-tools"></i> Her.
                        </a>
                        <ul class="dropdown-menu" aria-labelledby="toolsDropdown">
                            <li class="dropdown-header">Herramientas de PDF</li>
                            <li>
                                <a class="dropdown-item {% if 'pdf_get_pages' in request.resolver_match.url_name %}active{% endif %}" 
                                   href="{% url 'pdf_get_pages' %}">
                                    <i class="bi bi-file-earmark-pdf"></i> GetPDFPage
                                </a>
                            </li>
                            <li>
                                <a class="dropdown-item {% if 'pdf_join' in request.resolver_match.url_name %}active{% endif %}" 
                                   href="{% url 'pdf_join' %}">
                                    <i class="bi bi-files"></i> JointPDF
                                </a>
                            </li>
                            <li>
                                <a class="dropdown-item {% if 'pdf_split' in request.resolver_match.url_name %}active{% endif %}" 
                                   href="{% url 'pdf_split' %}">
                                    <i class="bi bi-file-earmark-break"></i> Pdf2Pdfs
                                </a>
                            </li>
                            <li><hr class="dropdown-divider"></li>
                            <li class="dropdown-header">Calculadora</li>
                            <li>
                                <a class="dropdown-item {% if 'calculator' in request.resolver_match.url_name %}active{% endif %}" 
                                   href="{% url 'calculator' %}">
                                    <i class="bi bi-calculator"></i> Calculadora
                                </a>
                            </li>
                            <li><hr class="dropdown-divider"></li>
                            <li class="dropdown-header">Comandos</li>
                            <li>
                                <a class="dropdown-item {% if 'command_library' in request.resolver_match.url_name %}active{% endif %}" 
                                   href="{% url 'command_library' %}">
                                    <i class="bi bi-terminal"></i> Biblioteca de Comandos
                                </a>
                            </li>
                            <li><hr class="dropdown-divider"></li>
                            <li class="dropdown-header">Diseño</li>
                            <li>
                                <a class="dropdown-item {% if 'color_picker' in request.resolver_match.url_name %}active{% endif %}" 
                                   href="{% url 'color_picker' %}">
                                    <i class="bi bi-palette"></i> Color Picker
                                </a>
                            </li>
                            <li><hr class="dropdown-divider"></li>
                            <li class="dropdown-header">Redes y Análisis</li>
                            <li>
                                <a class="dropdown-item {% if 'website_tracker' in request.resolver_match.url_name %}active{% endif %}" 
                                   href="{% url 'website_tracker_list' %}">
                                    <i class="bi bi-radar"></i> Rastreador Web
                                </a>
                            </li>
                            <li><hr class="dropdown-divider"></li>
                            <li class="dropdown-header">Proceso de Selección</li>
                            <li>
                                <a class="dropdown-item {% if 'candidate' in request.resolver_match.url_name %}active{% endif %}" 
                                   href="{% url 'candidate_list' %}">
                                    <i class="bi bi-person-check"></i> Candidatos
                                </a>
                            </li>
                            <li>
                                <a class="dropdown-item {% if 'job_application' in request.resolver_match.url_name %}active{% endif %}" 
                                   href="{% url 'job_application_token_list' %}">
                                    <i class="bi bi-briefcase"></i> Enlaces de Aplicación
                                </a>
                            </li>
                            <li><hr class="dropdown-divider"></li>
                            <li class="dropdown-header">Empleados Activos</li>
                            <li>
                                <a class="dropdown-item {% if 'active_employee' in request.resolver_match.url_name %}active{% endif %}" 
                                   href="{% url 'active_employee_list' %}">
                                    <i class="bi bi-people-fill"></i> Empleados
                                </a>
                            </li>
                            <li>
                                <a class="dropdown-item {% if 'employee' in request.resolver_match.url_name and 'active' not in request.resolver_match.url_name and 'candidate' not in request.resolver_match.url_name and 'payroll' not in request.resolver_match.url_name %}active{% endif %}" 
                                   href="{% url 'employee_list' %}">
                                    <i class="bi bi-list-ul"></i> Todos los Registros
                                </a>
                            </li>
                            
                            <li><hr class="dropdown-divider"></li>
                            <li class="dropdown-header">Nóminas</li>
                            <li>
                                <a class="dropdown-item {% if 'payroll' in request.resolver_match.url_name %}active{% endif %}" 
                                   href="{% url 'active_employee_list' %}">
                                    <i class="bi bi-receipt-cutoff"></i> Gestionar Nóminas
                                </a>
                            </li>
                            <li><hr class="dropdown-divider"></li>
                            <li class="dropdown-header">Gestión de Usuarios</li>
                            <li>
                                <a class="dropdown-item {% if request.resolver_match.url_name == 'user_management' %}active{% endif %}" 
                                   href="{% url 'user_management' %}">
                                    <i class="bi bi-people"></i> Usuarios
                                </a>
                            </li>
                            <li>
                                <a class="dropdown-item {% if request.resolver_match.url_name == 'user_create' %}active{% endif %}" 
                                   href="{% url 'user_create' %}">
                                    <i class="bi bi-person-plus"></i> Crear Usuario
                                </a>
                            </li>
                            <li><hr class="dropdown-divider"></li>
                            <li class="dropdown-header">Sistema</li>
                            <li>
                                <a class="dropdown-item {% if 'system_configuration' in request.resolver_match.url_name %}active{% endif %}" 
                                   href="{% url 'system_configuration' %}">
                                    <i class="bi bi-gear-fill"></i> Configuración del Sistema
                                </a>
                            </li>
                            <li>
                                <a class="dropdown-item {% if 'url_manager' in request.resolver_match.url_name %}active{% endif %}" 
                                   href="{% url 'url_manager_list' %}">
                                    <i class="bi bi-link-45deg"></i> Gestión de URLs
                                </a>
                            </li>
                            <li>
                                <a class="dropdown-item {% if 'short_url' in request.resolver_match.url_name %}active{% endif %}" 
                                   href="{% url 'short_url_list' %}">
                                    <i class="bi bi-scissors"></i> Acortador de URLs
                                </a>
                            </li>
                            <li>
                                <a class="dropdown-item {% if 'public_upload' in request.resolver_match.url_name %}active{% endif %}" 
                                   href="{% url 'public_upload_url_list' %}">
                                    <i class="bi bi-cloud-upload"></i> URLs Públicas de Subida
                                </a>
                            </li>
                            <li>
                                <a class="dropdown-item {% if 'time' in request.resolver_match.url_name %}active{% endif %}" 
                                   href="{% url 'time_clock' %}">
                                    <i class="bi bi-clock"></i> Control de Horario
                                </a>
                            </li>
                            <li>
                                <a class="dropdown-item {% if 'attendance' in request.resolver_match.url_name %}active{% endif %}" 
                                   href="{% url 'attendance_overview' %}">
                                    <i class="bi bi-people-fill"></i> Asistencia General
                                </a>
                            </li>
                            <li><hr class="dropdown-divider"></li>
                            <li class="dropdown-header">Juegos</li>
                            <li>
                                <a class="dropdown-item {% if 'tetris' in request.resolver_match.url_name %}active{% endif %}" 
                                   href="{% url 'tetris' %}">
                                    <i class="bi bi-grid-3x3-gap"></i> Tetris
                                </a>
                            </li>
                        </ul>
                    </li>
                    
                    
                    <li class="nav-item dropdown">
                        <a class="nav-link dropdown-toggle" href="#" id="docDropdown" role="button" data-bs-toggle="dropdown" aria-expanded="false">
                            <i class="bi bi-file-earmark-text"></i> Doc
                        </a>
                        <ul class="dropdown-menu" aria-labelledby="docDropdown">
                            <li>
                                <h6 class="dropdown-header">Documentación</h6>
                            </li>
                            <li>
                                <a class="dropdown-item {% if 'document' in request.resolver_match.url_name %}active{% endif %}" 
                                   href="{% url 'document_list' %}">
                                    <i class="bi bi-file-earmark-text"></i> Documentos
                                </a>
                            </li>
                            <li>
                                <a class="dropdown-item {% if 'agreement' in request.resolver_match.url_name %}active{% endif %}" 
                                   href="{% url 'agreement_list' %}">
                                    <i class="bi bi-file-earmark-check"></i> Acuerdos
                                </a>
                            </li>
                            <li>
                                <a class="dropdown-item {% if 'multiple_documentation' in request.resolver_match.url_name %}active{% endif %}" 
                                   href="{% url 'multiple_documentation_list' %}">
                                    <i class="fas fa-folder-open"></i> Documentación Múltiple
                                </a>
                            </li>
                            <li>
                                <a class="dropdown-item {% if 'company_documentation' in request.resolver_match.url_name %}active{% endif %}" 
                                   href="{% url 'company_documentation_list' %}">
                                    <i class="bi bi-collection"></i> Documentaciones de Empresas
                                </a>
                            </li>
                            <li>
                                <a class="dropdown-item {% if 'legal_contract' in request.resolver_match.url_name %}active{% endif %}" 
                                   href="{% url 'legal_contract_list' %}">
                                    <i class="bi bi-file-earmark-ruled"></i> Contratos Legales
                                </a>
                            </li>
                            <li>
                                <a class="dropdown-item {% if 'ai_book' in request.resolver_match.url_name %}active{% endif %}" 
                                   href="{% url 'ai_book_list' %}">
                                    <i class="bi bi-book"></i> Generador de Libros IA
                                </a>
                            </li>
                            <li>
                                <a class="dropdown-item {% if 'ai_article' in request.resolver_match.url_name %}active{% endif %}" 
                                   href="{% url 'ai_article_project_list' %}">
                                    <i class="bi bi-newspaper"></i> Generador de Artículos IA
                                </a>
                            </li>
                            <li>
                                <a class="dropdown-item {% if 'countdown_timer' in request.resolver_match.url_name %}active{% endif %}" 
                                   href="{% url 'countdown_timer_list' %}">
                                    <i class="bi bi-stopwatch"></i> Cuentas Regresivas
                                </a>
                            </li>
                            <li>
                                <a class="dropdown-item {% if 'procedure' in request.resolver_match.url_name %}active{% endif %}" 
                                   href="{% url 'procedure_list' %}">
                                    <i class="bi bi-list-columns-reverse"></i> Procedimientos
                                </a>
                            </li>
                            <li>
                                <a class="dropdown-item {% if 'supplier_contract_review' in request.resolver_match.url_name %}active{% endif %}" 
                                   href="{% url 'supplier_contract_review_list' %}">
                                    <i class="bi bi-shield-check"></i> Revisar Contratos de Proveedores
                                </a>
                            </li>
                            <li>
                                <a class="dropdown-item {% if 'license' in request.resolver_match.url_name %}active{% endif %}" 
                                   href="{% url 'license_list' %}">
                                    <i class="bi bi-key"></i> Control de Licencias
                                </a>
                            </li>
                            <li>
                                <a class="dropdown-item {% if 'paypal_link' in request.resolver_match.url_name %}active{% endif %}" 
                                   href="{% url 'paypal_link_list' %}">
                                    <i class="bi bi-paypal"></i> Enlaces de Pago PayPal
                                </a>
                            </li>
                            <li><hr class="dropdown-divider"></li>
                            <li>
                                <h6 class="dropdown-header">Captura de Leads</h6>
                            </li>
                            <li>
                                <a class="dropdown-item {% if 'contact_generator' in request.resolver_match.url_name %}active{% endif %}" 
                                   href="{% url 'contact_generator_list' %}">
                                    <i class="bi bi-person-plus"></i> Crear Contactos
                                </a>
                            </li>
                            <li>
                                <a class="dropdown-item {% if 'company_request_generator' in request.resolver_match.url_name %}active{% endif %}"
                                   href="{% url 'company_request_generator_list' %}">
                                    <i class="bi bi-file-earmark-text"></i> Crear Solicitudes Empresas
                                </a>
                            </li>
                        </ul>
                    </li>    
                    
                    <!-- Menú Otros (Solo para Agentes) -->
                    <li class="nav-item dropdown">
                        <a class="nav-link dropdown-toggle" href="#" id="reportsDropdown" role="button" data-bs-toggle="dropdown" aria-expanded="false">
                            <i class="bi bi-graph-up"></i> Otros
                        </a>
                        <ul class="dropdown-menu" aria-labelledby="reportsDropdown">
                            <li>
                                <a class="dropdown-item {% if 'daily_report' in request.resolver_match.url_name %}active{% endif %}" 
                                   href="{% url 'daily_report' %}">
                                    <i class="bi bi-calendar-day"></i> Parte Diario
                                </a>
                            </li>
                            <li><hr class="dropdown-divider"></li>
                            <li>
                                <h6 class="dropdown-header">Analytics Web</h6>
                            </li>
                            <li>
                                <a class="dropdown-item {% if 'page_visits_analytics' in request.resolver_match.url_name %}active{% endif %}" 
                                   href="{% url 'page_visits_analytics' %}">
                                    <i class="fas fa-chart-bar"></i> Analytics de Páginas
                                </a>
                            </li>
                            <li>
                                <a class="dropdown-item {% if 'page_visits_detail' in request.resolver_match.url_name %}active{% endif %}" 
                                   href="{% url 'page_visits_detail' %}">
                                    <i class="fas fa-list"></i> Detalle de Visitas
                                </a>
                            </li>
                            <li><hr class="dropdown-divider"></li>
                            <li>
                                <h6 class="dropdown-header">Inteligencia Artificial</h6>
                            </li>
                            <li>
                                <a class="dropdown-item {% if 'ai_blog_configurator' in request.resolver_match.url_name %}active{% endif %}" 
                                   href="{% url 'ai_blog_configurators_list' %}">
                                    <i class="fas fa-robot"></i> Configurador de IA Blog
                                </a>
                            </li>
                            <li><hr class="dropdown-divider"></li>
                            <li>
                                <h6 class="dropdown-header">Documentación</h6>
                            </li>
                            <li>
                                <a class="dropdown-item {% if 'multiple_documentation' in request.resolver_match.url_name %}active{% endif %}" 
                                   href="{% url 'multiple_documentation_list' %}">
                                    <i class="fas fa-folder-open"></i> Documentación Múltiple
                                </a>
                            </li>
                            <li>
                                <a class="dropdown-item {% if 'company_documentation' in request.resolver_match.url_name %}active{% endif %}" 
                                   href="{% url 'company_documentation_list' %}">
                                    <i class="bi bi-collection"></i> Documentaciones de Empresas
                                </a>
                            </li>
                            <li>
                                <a class="dropdown-item {% if 'legal_contract' in request.resolver_match.url_name %}active{% endif %}" 
                                   href="{% url 'legal_contract_list' %}">
                                    <i class="bi bi-file-earmark-ruled"></i> Contratos Legales
                                </a>
                            </li>
                            <li>
                                <a class="dropdown-item {% if 'license' in request.resolver_match.url_name %}active{% endif %}" 
                                   href="{% url 'license_list' %}">
                                    <i class="bi bi-key"></i> Control de Licencias
                                </a>
                            </li>
                            <li>
                                <a class="dropdown-item {% if 'countdown_timer' in request.resolver_match.url_name %}active{% endif %}" 
                                   href="{% url 'countdown_timer_list' %}">
                                    <i class="bi bi-stopwatch"></i> Cuentas Regresivas
                                </a>
                            </li>
                            <li><hr class="dropdown-divider"></li>
                            <li>
                                <h6 class="dropdown-header">Captura de Leads</h6>
                            </li>
                            <li>
                                <a class="dropdown-item {% if 'contact_generator' in request.resolver_match.url_name %}active{% endif %}" 
                                   href="{% url 'contact_generator_list' %}">
                                    <i class="bi bi-person-plus"></i> Crear Contactos
                                </a>
                            </li>
                            <li>
                                <a class="dropdown-item {% if 'company_request_generator' in request.resolver_match.url_name %}active{% endif %}"
                                   href="{% url 'company_request_generator_list' %}">
                                    <i class="bi bi-file-earmark-text"></i> Crear Solicitudes Empresas
                                </a>
                            </li>
                            <li><hr class="dropdown-divider"></li>
                            <li>
                                <h6 class="dropdown-header">Planificación</h6>
                            </li>
                            <li>
                                <a class="dropdown-item {% if 'task_schedule' in request.resolver_match.url_name %}active{% endif %}" 
                                   href="{% url 'task_schedule_list' %}">
                                    <i class="fas fa-tasks"></i> Cronogramas de Tareas
                                </a>
                            </li>
                            <li><hr class="dropdown-divider"></li>
                            <li>
                                <h6 class="dropdown-header">Herramientas</h6>
                            </li>
                            <li>
                                <a class="dropdown-item {% if 'world_clock' in request.resolver_match.url_name %}active{% endif %}" 
                                   href="{% url 'world_clock' %}">
                                    <i class="bi bi-globe"></i> Reloj Mundial
                                </a>
                            </li>
                            <li>
                                <a class="dropdown-item {% if 'financial_actions' in request.resolver_match.url_name %}active{% endif %}" 
                                   href="{% url 'financial_actions_list' %}">
                                    <i class="bi bi-graph-up-arrow"></i> Acciones Financieras
                                </a>
                            </li>
                            <li>
                                <a class="dropdown-item {% if 'client_assistance_dashboard' in request.resolver_match.url_name %}active{% endif %}" 
                                   href="{% url 'client_assistance_dashboard' %}">
                                    <i class="fas fa-chart-line"></i> Dashboard Clientes
                                </a>
                            </li>
                            <li>
                                <a class="dropdown-item {% if 'client_assistance' in request.resolver_match.url_name or 'client_time_entries' in request.resolver_match.url_name %}active{% endif %}" 
                                   href="{% url 'client_assistance_list' %}">
                                    <i class="fas fa-users"></i> Asistencia de Cliente
                                </a>
                            </li>
                            <li><hr class="dropdown-divider"></li>
                            <li>
                                <h6 class="dropdown-header">Productos</h6>
                            </li>
                            <li>
                                <a class="dropdown-item {% if 'product_set' in request.resolver_match.url_name %}active{% endif %}" 
                                   href="{% url 'product_set_list' %}">
                                    <i class="bi bi-box-seam"></i> Conjuntos de Productos
                                </a>
                            </li>
                            
                            <li><hr class="dropdown-divider"></li>
                            <li>
                                <h6 class="dropdown-header">Estimaciones</h6>
                            </li>
                            <li>
                                <a class="dropdown-item {% if 'precotizador' in request.resolver_match.url_name %}active{% endif %}" 
                                   href="{% url 'precotizador_list' %}">
                                    <i class="bi bi-calculator"></i> Precotizador
                                </a>
                            </li>
                        </ul>
                    </li>
                    {% endif %}
                </ul>
                
                <!-- Botones de Control de Horario (solo para agentes) -->
                {% if user.is_authenticated %}
                    {% for group in user.groups.all %}
                        {% if group.name == 'Agentes' %}
                        <ul class="navbar-nav me-auto">
                            {% if is_working %}
                                <li class="nav-item">
                                    <a class="btn btn-danger btn-sm me-2" href="{% url 'time_end_work' %}">
                                        <i class="bi bi-stop-circle"></i>
                                    </a>
                                </li>
                            {% else %}
                                <li class="nav-item">
                                    <a class="btn btn-success btn-sm me-2" href="{% url 'time_start_work' %}">
                                        <i class="bi bi-play-circle"></i>
                                    </a>
                                </li>
                            {% endif %}
                        </ul>
                        {% endif %}
                    {% endfor %}
                {% endif %}
                
                <ul class="navbar-nav">
                    <li class="nav-item dropdown">
                        <a class="nav-link dropdown-toggle" href="#" id="navbarDropdown" role="button" data-bs-toggle="dropdown">
                            <i class="bi bi-person-circle"></i> {{ user.username }}
                        </a>
                        <ul class="dropdown-menu">
                            <li><a class="dropdown-item" href="{% url 'user_profile' %}">
                                <i class="bi bi-person-gear"></i> Mi Perfil
                            </a></li>
                            <li><a class="dropdown-item" href="{% url 'my_notes' %}">
                                <i class="bi bi-journal-text"></i> Mis Notas
                            </a></li>
                            
                            <!-- Menú de Juegos (Para todos los usuarios autenticados) -->
                            <li><hr class="dropdown-divider"></li>
                            <li class="dropdown-header">🎮 Juegos</li>
                            <li><a class="dropdown-item {% if 'tetris' in request.resolver_match.url_name %}active{% endif %}" 
                                   href="{% url 'tetris' %}">
                                <i class="bi bi-grid-3x3-gap"></i> Tetris
                            </a></li>
                            
                            <li><hr class="dropdown-divider"></li>
                            <li><a class="dropdown-item" href="{% url 'logout' %}">
                                <i class="bi bi-box-arrow-right"></i> Cerrar Sesión
                            </a></li>
                        </ul>
                    </li>
                </ul>
            </div>
        </div>
    </nav>
    {% else %}
    <!-- Navbar para usuarios no autenticados -->
    <nav class="navbar navbar-expand-lg navbar-dark bg-primary">
        <div class="container">
            <a class="navbar-brand fw-bold" href="{% url 'contacto_web' %}">
                <i class="bi bi-ticket-perforated"></i> TicketProo
            </a>
            
            <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNavPublic">
                <span class="navbar-toggler-icon"></span>
            </button>
            
            <div class="collapse navbar-collapse" id="navbarNavPublic">
                <ul class="navbar-nav me-auto">
                    <li class="nav-item">
                        <a class="nav-link" href="{% url 'contacto_web' %}">
                            <i class="bi bi-house-door"></i> Inicio
                        </a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="{% url 'contacto_web' %}">
                            <i class="bi bi-envelope"></i> Contáctanos
                        </a>
                    </li>
                </ul>
                
                <ul class="navbar-nav">
                    <li class="nav-item">
                        <a class="nav-link" href="{% url 'login' %}">
                            <i class="bi bi-box-arrow-in-right"></i> Iniciar Sesión
                        </a>
                    </li>
                </ul>
            </div>
        </div>
    </nav>
    {% endif %}

    <main class="container mt-4">
        {% if messages %}
            {% for message in messages %}
                <div class="alert alert-{{ message.tags }} alert-dismissible fade show" role="alert">
                    {{ message }}
                    <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
                </div>
            {% endfor %}
        {% endif %}

        {% block content %}
        {% endblock %}
    </main>

    <!-- Footer simple -->
    <footer class="mt-5 py-4 border-top text-center">
        <div class="container">
            <div class="row">
                <div class="col-12">
                    <p class="text-muted mb-1">&copy; 2025 TicketProo - Sistema de Gestión de Tickets</p>
                    <p class="text-muted small mb-0">Desarrollado por Marlon Falcón Hdez</p>
                </div>
            </div>
        </div>
    </footer>

    {% bootstrap_javascript %}
    
    <!-- Script para favicon dinámico -->
    <script>
        function updateFavicon(isWorking) {
            const favicon = document.getElementById('favicon');
            if (favicon) {
                if (isWorking) {
                    // Favicon verde cuando está trabajando
                    favicon.href = "data:image/svg+xml,%3csvg xmlns='http://www.w3.org/2000/svg' width='32' height='32' viewBox='0 0 32 32'%3e%3ccircle cx='16' cy='16' r='14' fill='%2328a745'/%3e%3crect x='8' y='11' width='16' height='10' rx='1' fill='white'/%3e%3ccircle cx='9' cy='16' r='1' fill='%2328a745'/%3e%3ccircle cx='23' cy='16' r='1' fill='%2328a745'/%3e%3crect x='11' y='13' width='6' height='1' fill='%2328a745'/%3e%3crect x='11' y='15' width='4' height='1' fill='%2328a745'/%3e%3crect x='11' y='17' width='5' height='1' fill='%2328a745'/%3e%3crect x='18' y='13' width='3' height='1' fill='%2328a745'/%3e%3c/svg%3e";
                } else {
                    // Favicon gris cuando no está trabajando
                    favicon.href = "data:image/svg+xml,%3csvg xmlns='http://www.w3.org/2000/svg' width='32' height='32' viewBox='0 0 32 32'%3e%3ccircle cx='16' cy='16' r='14' fill='%23495057'/%3e%3crect x='8' y='11' width='16' height='10' rx='1' fill='white'/%3e%3ccircle cx='9' cy='16' r='1' fill='%23495057'/%3e%3ccircle cx='23' cy='16' r='1' fill='%23495057'/%3e%3crect x='11' y='13' width='6' height='1' fill='%23495057'/%3e%3crect x='11' y='15' width='4' height='1' fill='%23495057'/%3e%3crect x='11' y='17' width='5' height='1' fill='%23495057'/%3e%3crect x='18' y='13' width='3' height='1' fill='%23495057'/%3e%3c/svg%3e";
                }
            }
        }
        
        // Inicializar favicon al cargar la página
        {% if user.is_authenticated %}
            const isWorking = {{ is_working|yesno:"true,false" }};
            updateFavicon(isWorking);
            
            // Actualizar cada 30 segundos
            setInterval(function() {
                // Aquí podrías hacer una llamada AJAX para verificar el estado
                updateFavicon(isWorking);
            }, 30000);
        {% else %}
            // Usuario no autenticado - favicon gris
            updateFavicon(false);
        {% endif %}
    </script>
    
    <!-- Script para fecha y hora en tiempo real -->
    <script>
        function updateDateTime() {
            console.log('=== updateDateTime() ejecutándose ===');
            const now = new Date();
            
            // Configurar opciones para fecha y hora en el ticker
            const dateOptions = { 
                day: '2-digit', 
                month: '2-digit', 
                year: 'numeric' 
            };
            
            const timeOptions = { 
                hour: '2-digit', 
                minute: '2-digit',
                hour12: false
            };
            
            // Formatear fecha y hora
            const formattedDate = now.toLocaleDateString('es-ES', dateOptions);
            const formattedTime = now.toLocaleTimeString('es-ES', timeOptions);
            
            console.log('Fecha formateada:', formattedDate);
            console.log('Hora formateada:', formattedTime);
            
            // Actualizar elementos del DOM
            const dateElement = document.getElementById('current-date');
            const timeElement = document.getElementById('current-time');
            
            console.log('Elemento fecha encontrado:', !!dateElement, dateElement);
            console.log('Elemento hora encontrado:', !!timeElement, timeElement);
            
            if (dateElement) {
                dateElement.textContent = formattedDate;
                console.log('✅ Fecha actualizada:', formattedDate);
            } else {
                console.error('❌ Elemento current-date NO encontrado');
            }
            
            if (timeElement) {
                timeElement.textContent = formattedTime;
                console.log('✅ Hora actualizada:', formattedTime);
            } else {
                console.error('❌ Elemento current-time NO encontrado');
            }
            
            // Verificar si el ticker está visible
            const tickerElement = document.getElementById('financial-ticker-global');
            console.log('Ticker visible:', !!tickerElement, tickerElement ? getComputedStyle(tickerElement).display : 'N/A');
        }
        
        // Ejecutar inmediatamente para test
        console.log('🚀 Iniciando script de fecha/hora...');
        updateDateTime();
        
        // También cuando el DOM esté listo
        document.addEventListener('DOMContentLoaded', function() {
            console.log('📄 DOM cargado, ejecutando updateDateTime...');
            updateDateTime();
            // Actualizar cada minuto
            setInterval(updateDateTime, 60000);
        });
        
        // Y también después de un delay para asegurar que todo esté cargado
        setTimeout(function() {
            console.log('⏰ Timeout ejecutado, ejecutando updateDateTime...');
            updateDateTime();
        }, 2000);
    </script>
    
    <!-- Widget de Chat Flotante -->
    {% if user.is_authenticated %}
    <div id="chat-widget" class="chat-widget">
        <div class="chat-widget-header" onclick="toggleChatWidget()">
            <i class="fas fa-comments"></i>
            <div class="chat-notifications" id="chat-notifications" style="display: none;">
                <span id="notification-count">0</span>
            </div>
        </div>
        
        <div class="chat-widget-body" id="chat-widget-body" style="display: none;">
            <div class="chat-widget-tabs">
                <button class="chat-tab active" onclick="showChatTab('conversations')">
                    Conversaciones
                </button>
                <button class="chat-tab" onclick="showChatTab('users')">
                    Usuarios
                </button>
            </div>
            
            <div class="chat-tab-content" id="conversations-tab">
                <div class="chat-conversations-list" id="chat-conversations">
                    <div class="text-center p-3">
                        <i class="fas fa-spinner fa-spin"></i>
                        <small class="d-block mt-2">Cargando conversaciones...</small>
                    </div>
                </div>
            </div>
            
            <div class="chat-tab-content" id="users-tab" style="display: none;">
                <div class="chat-users-list" id="chat-users">
                    <div class="text-center p-3">
                        <i class="fas fa-spinner fa-spin"></i>
                        <small class="d-block mt-2">Cargando usuarios...</small>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <style>
    .chat-widget {
        position: fixed;
        bottom: 20px;
        left: 20px;
        width: 50px;
        height: 50px;
        z-index: 1050;
        font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
    }
    
    .chat-widget-header {
        background: #2196f3;
        color: white;
        padding: 12px;
        cursor: pointer;
        display: flex;
        align-items: center;
        justify-content: center;
        user-select: none;
        transition: all 0.3s ease;
        width: 50px;
        height: 50px;
        border-radius: 50%;
        position: relative;
    }
    
    .chat-widget-header:hover {
        background: #1976d2;
        transform: scale(1.1);
        box-shadow: 0 4px 15px rgba(33, 150, 243, 0.4);
    }
    .chat-widget.expanded {
        width: 320px;
        height: auto;
        max-height: 500px;
        background: white;
        border-radius: 15px;
        box-shadow: 0 8px 35px rgba(0,0,0,0.15);
        display: flex;
        flex-direction: column;
        overflow: hidden;
        border: 1px solid #e3e6f0;
    }

    .chat-widget.expanded .chat-widget-header {
        border-radius: 15px 15px 0 0;
        width: 100%;
        height: auto;
        padding: 15px 20px;
        justify-content: space-between;
    }

    .chat-widget.expanded .chat-widget-header i {
        font-size: 1.1rem;
    }

    .chat-widget.expanded .chat-widget-header::after {
        content: "Chat";
        margin-left: 10px;
        font-weight: 500;
    }
        font-weight: 600;
        font-size: 1rem;
    }
    
    .chat-notifications {
        background: #ff5722;
        color: white;
        border-radius: 12px;
        width: 20px;
        height: 20px;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 10px;
        font-weight: bold;
        position: absolute;
        top: -5px;
        right: -5px;
        border: 2px solid white;
        animation: pulse 2s infinite;
    }
    }
    
    @keyframes pulse {
        0% { transform: scale(1); }
        50% { transform: scale(1.1); }
        100% { transform: scale(1); }
    }
    
    .chat-widget-body {
        flex: 1;
        display: flex;
        flex-direction: column;
        max-height: 400px;
        background: #f8f9fa;
    }
    
    .chat-widget-tabs {
        display: flex;
        border-bottom: 1px solid #dee2e6;
        background: white;
    }
    
    .chat-tab {
        flex: 1;
        padding: 12px 16px;
        border: none;
        background: none;
        color: #6c757d;
        font-size: 13px;
        cursor: pointer;
        transition: all 0.2s;
        font-weight: 500;
        position: relative;
    }
    
    .chat-tab.active {
        color: #667eea;
        background: #f8f9fa;
    }
    
    .chat-tab.active::after {
        content: '';
        position: absolute;
        bottom: 0;
        left: 0;
        right: 0;
        height: 3px;
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    }
    
    .chat-tab:hover:not(.active) {
        background: #f1f3f4;
        color: #495057;
    }
    
    .chat-tab-content {
        flex: 1;
        overflow-y: auto;
    }
    
    .chat-conversation-item,
    .chat-user-item {
        padding: 12px 16px;
        border-bottom: 1px solid #f1f3f4;
        cursor: pointer;
        transition: all 0.2s;
        display: flex;
        align-items: center;
        text-decoration: none;
        color: inherit;
        background: white;
    }
    
    .chat-conversation-item:hover,
    .chat-user-item:hover {
        background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
        color: inherit;
        text-decoration: none;
        transform: translateX(2px);
    }
    
    .chat-avatar {
        width: 36px;
        height: 36px;
        border-radius: 50%;
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 13px;
        font-weight: bold;
        margin-right: 12px;
        flex-shrink: 0;
        border: 2px solid white;
        box-shadow: 0 2px 8px rgba(0,0,0,0.1);
    }
    
    .chat-info {
        flex: 1;
        min-width: 0;
    }
    
    .chat-name {
        font-size: 14px;
        font-weight: 600;
        margin: 0;
        white-space: nowrap;
        overflow: hidden;
        text-overflow: ellipsis;
        color: #2c3e50;
    }
    
    .chat-last-message {
        font-size: 12px;
        color: #6c757d;
        margin: 2px 0 0 0;
        white-space: nowrap;
        overflow: hidden;
        text-overflow: ellipsis;
    }
    
    .chat-time {
        font-size: 10px;
        color: #6c757d;
        white-space: nowrap;
    }
    
    .chat-unread {
        background: linear-gradient(135deg, #ff6b6b 0%, #ee5a24 100%);
        color: white;
        border-radius: 12px;
        padding: 2px 8px;
        font-size: 10px;
        font-weight: bold;
        margin-left: 8px;
        min-width: 18px;
        text-align: center;
    }
    
    .empty-state {
        text-align: center;
        padding: 40px 20px;
        color: #6c757d;
    }
    
    .empty-state i {
        font-size: 2.5rem;
        margin-bottom: 12px;
        opacity: 0.4;
        color: #667eea;
    }
    
    .empty-state h6 {
        font-weight: 600;
        margin-bottom: 8px;
        color: #495057;
    }
    
    .empty-state p {
        font-size: 12px;
        margin: 0;
    }
    
    .chat-toggle-icon {
        transition: transform 0.3s ease;
    }
    
    .chat-toggle-icon.rotated {
        transform: rotate(180deg);
    }
    </style>
    
    <script>
    let chatWidgetExpanded = false;
    
    function toggleChatWidget() {
        const body = document.getElementById('chat-widget-body');
        const widget = document.getElementById('chat-widget');
        
        if (chatWidgetExpanded) {
            body.style.display = 'none';
            widget.classList.remove('expanded');
            chatWidgetExpanded = false;
        } else {
            body.style.display = 'flex';
            widget.classList.add('expanded');
            chatWidgetExpanded = true;
            loadChatConversations();
        }
    }
    
    function showChatTab(tab) {
        // Actualizar tabs
        document.querySelectorAll('.chat-tab').forEach(t => t.classList.remove('active'));
        
        // Mostrar contenido
        document.querySelectorAll('.chat-tab-content').forEach(content => {
            content.style.display = 'none';
        });
        
        if (tab === 'conversations') {
            document.getElementById('conversations-tab').style.display = 'block';
            document.querySelectorAll('.chat-tab')[0].classList.add('active');
            loadChatConversations();
        } else if (tab === 'users') {
            document.getElementById('users-tab').style.display = 'block';
            document.querySelectorAll('.chat-tab')[1].classList.add('active');
            loadChatUsers();
        }
    }
    
    function loadChatConversations() {
        const container = document.getElementById('chat-conversations');
        container.innerHTML = '<div class="text-center p-3"><i class="fas fa-spinner fa-spin"></i><small class="d-block mt-2">Cargando...</small></div>';
        
        fetch('/chat/')
            .then(response => response.text())
            .then(html => {
                const parser = new DOMParser();
                const doc = parser.parseFromString(html, 'text/html');
                const conversations = doc.querySelectorAll('.conversation-item');
                
                if (conversations.length > 0) {
                    let conversationsHtml = '';
                    conversations.forEach(conv => {
                        const avatar = conv.querySelector('.conversation-avatar');
                        const name = conv.querySelector('.conversation-name').textContent.trim();
                        const preview = conv.querySelector('.conversation-preview');
                        const badge = conv.querySelector('.unread-badge');
                        const href = conv.getAttribute('href');
                        
                        conversationsHtml += `
                            <a href="${href}" class="chat-conversation-item">
                                <div class="chat-avatar">
                                    ${avatar ? avatar.textContent.trim() : name.charAt(0).toUpperCase()}
                                </div>
                                <div class="chat-info">
                                    <div class="chat-name">${name}</div>
                                    ${preview ? `<div class="chat-last-message">${preview.textContent.trim()}</div>` : ''}
                                </div>
                                ${badge ? `<span class="chat-unread">${badge.textContent.trim()}</span>` : ''}
                            </a>
                        `;
                    });
                    container.innerHTML = conversationsHtml;
                } else {
                    container.innerHTML = `
                        <div class="empty-state">
                            <i class="fas fa-comments"></i>
                            <h6>Sin conversaciones</h6>
                            <p>Inicia una nueva conversación</p>
                        </div>
                    `;
                }
            })
            .catch(error => {
                console.error('Error loading conversations:', error);
                container.innerHTML = `
                    <div class="empty-state">
                        <i class="fas fa-exclamation-triangle"></i>
                        <h6>Error al cargar</h6>
                        <p>Intenta de nuevo</p>
                    </div>
                `;
            });
    }
    
    function loadChatUsers() {
        const container = document.getElementById('chat-users');
        container.innerHTML = '<div class="text-center p-3"><i class="fas fa-spinner fa-spin"></i><small class="d-block mt-2">Cargando...</small></div>';
        
        fetch('/chat/users/')
            .then(response => response.text())
            .then(html => {
                const parser = new DOMParser();
                const doc = parser.parseFromString(html, 'text/html');
                const users = doc.querySelectorAll('.user-item');
                
                if (users.length > 0) {
                    let usersHtml = '';
                    users.forEach(user => {
                        const avatar = user.querySelector('.user-avatar');
                        const name = user.querySelector('h6').textContent.trim();
                        const username = user.querySelector('small').textContent.trim();
                        const href = user.getAttribute('href');
                        
                        usersHtml += `
                            <a href="${href}" class="chat-user-item">
                                <div class="chat-avatar">
                                    ${avatar ? avatar.textContent.trim() : name.charAt(0).toUpperCase()}
                                </div>
                                <div class="chat-info">
                                    <div class="chat-name">${name}</div>
                                    <div class="chat-last-message">${username}</div>
                                </div>
                            </a>
                        `;
                    });
                    container.innerHTML = usersHtml;
                } else {
                    container.innerHTML = `
                        <div class="empty-state">
                            <i class="fas fa-users"></i>
                            <h6>Sin usuarios</h6>
                            <p>No hay usuarios disponibles</p>
                        </div>
                    `;
                }
            })
            .catch(error => {
                console.error('Error loading users:', error);
                container.innerHTML = `
                    <div class="empty-state">
                        <i class="fas fa-exclamation-triangle"></i>
                        <h6>Error al cargar</h6>
                        <p>Intenta de nuevo</p>
                    </div>
                `;
            });
    }
    </script>
    {% endif %}
    
    <!-- Botón Flotante de IA Global -->
    {% if user.is_authenticated %}
    <div id="ai-floating-button" class="ai-floating-btn">
        <a href="{% url 'voice_command_interface' %}" 
           class="btn btn-primary btn-lg rounded-circle shadow-lg"
           title="Comandos de Voz IA - Crear tickets hablando">
            <i class="fas fa-microphone-alt"></i>
        </a>
        <div class="ai-floating-tooltip">
            <span>Comandos de Voz IA</span>
        </div>
    </div>
    {% endif %}
    
    {% block extra_js %}
    {% endblock %}
    
    <script>
    // Funcionalidad del botón flotante de IA
    document.addEventListener('DOMContentLoaded', function() {
        const aiButton = document.getElementById('ai-floating-button');
        if (aiButton) {
            const tooltip = aiButton.querySelector('.ai-floating-tooltip');
            
            // Mostrar tooltip al hacer hover
            aiButton.addEventListener('mouseenter', function() {
                tooltip.classList.add('show');
            });
            
            aiButton.addEventListener('mouseleave', function() {
                tooltip.classList.remove('show');
            });
            
            // Animación de pulso cada 30 segundos para recordar al usuario
            setInterval(function() {
                aiButton.classList.add('pulse-animation');
                setTimeout(() => {
                    aiButton.classList.remove('pulse-animation');
                }, 2000);
            }, 30000);
        }
    });
    </script>
    
    <style>
    /* Estilo del botón flotante de IA */
    .ai-floating-btn {
        position: fixed;
        right: 30px;
        bottom: 30px;
        z-index: 1000;
        transition: all 0.3s ease;
    }

    .ai-floating-btn .btn {
        width: 60px;
        height: 60px;
        display: flex;
        align-items: center;
        justify-content: center;
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        border: none;
        color: white;
        font-size: 1.5rem;
        transition: all 0.3s ease;
        position: relative;
        overflow: hidden;
    }

    .ai-floating-btn .btn:hover {
        transform: scale(1.1);
        box-shadow: 0 8px 25px rgba(102, 126, 234, 0.4);
        background: linear-gradient(135deg, #764ba2 0%, #667eea 100%);
    }

    .ai-floating-btn .btn:before {
        content: '';
        position: absolute;
        top: 50%;
        left: 50%;
        width: 0;
        height: 0;
        border-radius: 50%;
        background: rgba(255, 255, 255, 0.3);
        transition: all 0.6s ease;
        transform: translate(-50%, -50%);
    }

    .ai-floating-btn .btn:hover:before {
        width: 120%;
        height: 120%;
    }

    /* Tooltip del botón */
    .ai-floating-tooltip {
        position: absolute;
        right: 70px;
        top: 50%;
        transform: translateY(-50%);
        background: rgba(0, 0, 0, 0.8);
        color: white;
        padding: 8px 12px;
        border-radius: 6px;
        font-size: 14px;
        white-space: nowrap;
        opacity: 0;
        pointer-events: none;
        transition: all 0.3s ease;
    }

    .ai-floating-tooltip:after {
        content: '';
        position: absolute;
        left: 100%;
        top: 50%;
        transform: translateY(-50%);
        border: 6px solid transparent;
        border-left-color: rgba(0, 0, 0, 0.8);
    }

    .ai-floating-tooltip.show {
        opacity: 1;
        transform: translateY(-50%) translateX(-10px);
    }

    /* Animación de pulso */
    .ai-floating-btn.pulse-animation .btn {
        animation: pulse-glow 2s ease-in-out;
    }

    @keyframes pulse-glow {
        0% {
            box-shadow: 0 4px 15px rgba(102, 126, 234, 0.3);
        }
        50% {
            box-shadow: 0 8px 30px rgba(102, 126, 234, 0.6);
            transform: scale(1.05);
        }
        100% {
            box-shadow: 0 4px 15px rgba(102, 126, 234, 0.3);
        }
    }

    /* Responsivo */
    @media (max-width: 768px) {
        .ai-floating-btn {
            right: 20px;
            bottom: 20px;
        }
        
        .ai-floating-btn .btn {
            width: 50px;
            height: 50px;
            font-size: 1.2rem;
        }
        
        .ai-floating-tooltip {
            display: none; /* Ocultar tooltip en móviles */
        }
    }

    /* Asegurar que esté por encima de otros elementos */
    .ai-floating-btn {
        z-index: 9999;
    }
    
    /* Estilos para el ticker financiero */
    #financial-ticker-global {
        position: fixed;
        bottom: 0;
        left: 0;
        right: 0;
        z-index: 1000;
        height: 40px;
        overflow: hidden;
        background: linear-gradient(90deg, #1a1a1a 0%, #2d2d2d 100%);
        border-top: 1px solid #444;
    }

    .ticker-content-global {
        animation: none;
        transition: all 0.5s ease-in-out;
        height: 40px;
        display: flex;
        align-items: center;
    }

    .ticker-item-global {
        min-width: 100%;
        white-space: nowrap;
        display: flex;
        align-items: center;
        padding: 0 20px;
    }

    /* Animación suave para cambios */
    .ticker-content-global {
        opacity: 1;
        transition: opacity 0.3s ease-in-out;
    }

    .ticker-fade-global {
        opacity: 0.7;
    }

    /* Ajustar el padding bottom del main para que no se superponga con el ticker */
    main.container {
        padding-bottom: 60px;
    }

    /* Responsivo para el ticker */
    @media (max-width: 768px) {
        #financial-ticker-global {
            height: 35px;
        }
        
        .ticker-content-global {
            height: 35px;
        }
        
        .ticker-item-global {
            padding: 0 15px;
            font-size: 0.9rem;
        }
        
        main.container {
            padding-bottom: 55px;
        }
    }
    </style>

    <!-- Ticker de Acciones Financieras Global -->
    {% if user.is_authenticated %}
    <div id="financial-ticker-global" class="bg-dark text-white">
        <div class="d-flex align-items-center h-100">
            <div class="me-3 ps-3">
                <i class="bi bi-graph-up-arrow"></i>
                <small class="fw-bold">MERCADOS:</small>
            </div>
            <div class="flex-grow-1">
                <div id="financial-ticker" class="d-flex align-items-center h-100">
                    <div class="ticker-content-global d-flex align-items-center">
                        <!-- Las acciones se cargarán aquí via JavaScript -->
                        <span class="text-muted">Cargando datos del mercado...</span>
                    </div>
                </div>
            </div>
            {% if is_agent %}
            <div class="me-3">
                <a href="{% url 'financial_actions_list' %}" class="btn btn-sm btn-outline-light" title="Configurar Acciones">
                    <i class="bi bi-gear"></i>
                </a>
                <button onclick="refreshFinancialTicker()" class="btn btn-sm btn-outline-light ms-2" title="Actualizar Acciones">
                    <i class="bi bi-arrow-clockwise"></i>
                </button>
            </div>
            {% endif %}
            <!-- Fecha y hora minimalista -->
            <div class="pe-3 text-end">
                <small class="text-white-50">
                    Fecha: <span id="current-date"></span> | Hora: <span id="current-time"></span>
                </small>
            </div>
        </div>
    </div>

    <script>
    // Ticker de acciones financieras global - v2.0
    console.log('Iniciando ticker financiero v2.0...');
    
    let tickerDataGlobal = [];
    let currentTickerIndexGlobal = 0;

    function loadTickerDataGlobal() {
        console.log('Cargando datos del ticker...');
        
        fetch('{% url "financial_actions_ticker_data" %}?t=' + Date.now())
            .then(response => {
                console.log('Respuesta API:', response.status);
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                return response.json();
            })
            .then(data => {
                console.log('Datos recibidos:', data);
                tickerDataGlobal = data.actions || [];
                
                const tickerContent = document.querySelector('#financial-ticker .ticker-content-global');
                if (!tickerContent) {
                    console.error('Elemento ticker no encontrado');
                    return;
                }
                
                if (tickerDataGlobal.length > 0) {
                    console.log(`${tickerDataGlobal.length} acciones cargadas`);
                    updateTickerGlobal();
                } else {
                    console.log('No hay acciones activas');
                    tickerContent.innerHTML = '<span class="text-muted">No hay acciones configuradas</span>';
                }
            })
            .catch(error => {
                console.error('Error del ticker:', error);
                const tickerContent = document.querySelector('#financial-ticker .ticker-content-global');
                if (tickerContent) {
                    tickerContent.innerHTML = '<span class="text-danger">Error cargando datos</span>';
                }
            });
    }

    function updateTickerGlobal() {
        if (tickerDataGlobal.length === 0) {
            console.log('No hay datos para mostrar');
            return;
        }
        
        const action = tickerDataGlobal[currentTickerIndexGlobal];
        const tickerContent = document.querySelector('#financial-ticker .ticker-content-global');
        
        if (!tickerContent) {
            console.error('Elemento ticker no encontrado en update');
            return;
        }
        
        let changeIcon = '●';
        let changeClass = 'text-muted';
        
        if (action.is_positive_change) {
            changeIcon = '▲';
            changeClass = 'text-success';
        } else if (action.is_negative_change) {
            changeIcon = '▼';
            changeClass = 'text-danger';
        }
        
        let changeText = '';
        if (action.previous_price !== null) {
            const priceChange = parseFloat(action.price_change) || 0;
            const priceChangePercent = parseFloat(action.price_change_percent) || 0;
            const sign = priceChange >= 0 ? '+' : '';
            changeText = `<span class="${changeClass} ms-2">
                ${changeIcon} ${sign}${priceChange.toFixed(4)} (${sign}${priceChangePercent.toFixed(2)}%)
            </span>`;
        }
        
        const html = `
            <div class="d-flex align-items-center ticker-item-global">
                <span class="fw-bold me-2">${action.symbol}</span>
                <span class="me-2">${parseFloat(action.current_price).toFixed(4)} ${action.currency}</span>
                ${changeText}
                <span class="text-muted ms-3 small">${action.name}</span>
            </div>
        `;
        
        console.log(`Mostrando: ${action.symbol} - ${action.current_price}`);
        tickerContent.innerHTML = html;
        
        // Pasar al siguiente elemento
        currentTickerIndexGlobal = (currentTickerIndexGlobal + 1) % tickerDataGlobal.length;
    }

    // Inicializar cuando el DOM esté listo
    document.addEventListener('DOMContentLoaded', function() {
        const tickerElement = document.getElementById('financial-ticker-global');
        if (tickerElement) {
            console.log('Ticker element encontrado, iniciando...');
            
            // Cargar datos iniciales
            loadTickerDataGlobal();
            
            // Rotar ticker cada 5 segundos
            setInterval(updateTickerGlobal, 5000);
            
            // Recargar datos cada 30 segundos
            setInterval(loadTickerDataGlobal, 30000);
        } else {
            console.log('Ticker element no encontrado');
        }
    });
    
    // Función para actualizar manualmente el ticker
    function refreshFinancialTicker() {
        console.log('Actualizando ticker manualmente...');
        const button = event.target.closest('button');
        const icon = button.querySelector('i');
        
        // Cambiar icono a spinner
        icon.className = 'bi bi-arrow-repeat';
        icon.style.animation = 'spin 1s linear infinite';
        
        // Cargar datos nuevos
        loadTickerDataGlobal();
        
        // Restaurar icono después de 2 segundos
        setTimeout(() => {
            icon.className = 'bi bi-arrow-clockwise';
            icon.style.animation = '';
        }, 2000);
    }
    
    // CSS para la animación del spinner
    const style = document.createElement('style');
    style.textContent = `
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
    `;
    document.head.appendChild(style);
    </script>
    {% endif %}
</body>
</html>
